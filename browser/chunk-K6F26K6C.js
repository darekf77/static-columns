import{a as Gl}from"./chunk-WXE6BMS3.js";import{$ as Fs,Jc as Ul,Kc as Vl,Lc as Wl,Mc as Ql,Nc as Go,Oc as y,Pc as Ls,Qc as ln,Rc as It,Sc as Kn,Tc as lt,Uc as Cr,Wc as Jo,Xc as F,c as zn,d as Oe,i as Qe,k as cn,l as Hn,q as Bs}from"./chunk-LZQOYT4N.js";import{a as oe,b as je,d as Tr,e as on,f as jl,g as wt}from"./chunk-VB56BUGO.js";var ec=on((Vs,Xo)=>{(function(a,e){typeof Vs=="object"&&typeof Xo<"u"?e(Vs):typeof define=="function"&&define.amd?define(["exports"],e):(a=a||self,e(a.Diff={}))})(Vs,function(a){"use strict";function e(){}e.prototype={diff:function(g,N){var M=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},B=M.callback;typeof M=="function"&&(B=M,M={}),this.options=M;var P=this;function W(_){return B?(setTimeout(function(){B(void 0,_)},0),!0):_}g=this.castInput(g),N=this.castInput(N),g=this.removeEmpty(this.tokenize(g)),N=this.removeEmpty(this.tokenize(N));var b=N.length,C=g.length,R=1,A=b+C,j=[{newPos:-1,components:[]}],Y=this.extractCommon(j[0],N,g,0);if(j[0].newPos+1>=b&&Y+1>=C)return W([{value:this.join(N),count:N.length}]);function pe(){for(var _=-1*R;_<=R;_+=2){var U=void 0,Q=j[_-1],z=j[_+1],se=(z?z.newPos:0)-_;Q&&(j[_-1]=void 0);var he=Q&&Q.newPos+1<b,be=z&&0<=se&&se<C;if(!he&&!be){j[_]=void 0;continue}if(!he||be&&Q.newPos<z.newPos?(U=n(z),P.pushComponent(U.components,void 0,!0)):(U=Q,U.newPos++,P.pushComponent(U.components,!0,void 0)),se=P.extractCommon(U,N,g,_),U.newPos+1>=b&&se+1>=C)return W(t(P,U.components,N,g,P.useLongestToken));j[_]=U}R++}if(B)(function _(){setTimeout(function(){if(R>A)return B();pe()||_()},0)})();else for(;R<=A;){var ee=pe();if(ee)return ee}},pushComponent:function(g,N,M){var B=g[g.length-1];B&&B.added===N&&B.removed===M?g[g.length-1]={count:B.count+1,added:N,removed:M}:g.push({count:1,added:N,removed:M})},extractCommon:function(g,N,M,B){for(var P=N.length,W=M.length,b=g.newPos,C=b-B,R=0;b+1<P&&C+1<W&&this.equals(N[b+1],M[C+1]);)b++,C++,R++;return R&&g.components.push({count:R}),g.newPos=b,C},equals:function(g,N){return this.options.comparator?this.options.comparator(g,N):g===N||this.options.ignoreCase&&g.toLowerCase()===N.toLowerCase()},removeEmpty:function(g){for(var N=[],M=0;M<g.length;M++)g[M]&&N.push(g[M]);return N},castInput:function(g){return g},tokenize:function(g){return g.split("")},join:function(g){return g.join("")}};function t(w,g,N,M,B){for(var P=0,W=g.length,b=0,C=0;P<W;P++){var R=g[P];if(R.removed){if(R.value=w.join(M.slice(C,C+R.count)),C+=R.count,P&&g[P-1].added){var j=g[P-1];g[P-1]=g[P],g[P]=j}}else{if(!R.added&&B){var A=N.slice(b,b+R.count);A=A.map(function(pe,ee){var _=M[C+ee];return _.length>pe.length?_:pe}),R.value=w.join(A)}else R.value=w.join(N.slice(b,b+R.count));b+=R.count,R.added||(C+=R.count)}}var Y=g[W-1];return W>1&&typeof Y.value=="string"&&(Y.added||Y.removed)&&w.equals("",Y.value)&&(g[W-2].value+=Y.value,g.pop()),g}function n(w){return{newPos:w.newPos,components:w.components.slice(0)}}var s=new e;function i(w,g,N){return s.diff(w,g,N)}function r(w,g){if(typeof w=="function")g.callback=w;else if(w)for(var N in w)w.hasOwnProperty(N)&&(g[N]=w[N]);return g}var o=/^[A-Za-z\xC0-\u02C6\u02C8-\u02D7\u02DE-\u02FF\u1E00-\u1EFF]+$/,c=/\S/,l=new e;l.equals=function(w,g){return this.options.ignoreCase&&(w=w.toLowerCase(),g=g.toLowerCase()),w===g||this.options.ignoreWhitespace&&!c.test(w)&&!c.test(g)},l.tokenize=function(w){for(var g=w.split(/(\s+|[()[\]{}'"]|\b)/),N=0;N<g.length-1;N++)!g[N+1]&&g[N+2]&&o.test(g[N])&&o.test(g[N+2])&&(g[N]+=g[N+2],g.splice(N+1,2),N--);return g};function u(w,g,N){return N=r(N,{ignoreWhitespace:!0}),l.diff(w,g,N)}function h(w,g,N){return l.diff(w,g,N)}var d=new e;d.tokenize=function(w){var g=[],N=w.split(/(\n|\r\n)/);N[N.length-1]||N.pop();for(var M=0;M<N.length;M++){var B=N[M];M%2&&!this.options.newlineIsToken?g[g.length-1]+=B:(this.options.ignoreWhitespace&&(B=B.trim()),g.push(B))}return g};function f(w,g,N){return d.diff(w,g,N)}function p(w,g,N){var M=r(N,{ignoreWhitespace:!0});return d.diff(w,g,M)}var m=new e;m.tokenize=function(w){return w.split(/(\S.+?[.!?])(?=\s+|$)/)};function x(w,g,N){return m.diff(w,g,N)}var S=new e;S.tokenize=function(w){return w.split(/([{}:;,]|\s+)/)};function G(w,g,N){return S.diff(w,g,N)}function D(w){return typeof Symbol=="function"&&typeof Symbol.iterator=="symbol"?D=function(g){return typeof g}:D=function(g){return g&&typeof Symbol=="function"&&g.constructor===Symbol&&g!==Symbol.prototype?"symbol":typeof g},D(w)}function q(w){return J(w)||re(w)||le()}function J(w){if(Array.isArray(w)){for(var g=0,N=new Array(w.length);g<w.length;g++)N[g]=w[g];return N}}function re(w){if(Symbol.iterator in Object(w)||Object.prototype.toString.call(w)==="[object Arguments]")return Array.from(w)}function le(){throw new TypeError("Invalid attempt to spread non-iterable instance")}var ue=Object.prototype.toString,de=new e;de.useLongestToken=!0,de.tokenize=d.tokenize,de.castInput=function(w){var g=this.options,N=g.undefinedReplacement,M=g.stringifyReplacer,B=M===void 0?function(P,W){return typeof W>"u"?N:W}:M;return typeof w=="string"?w:JSON.stringify(T(w,null,null,B),B,"  ")},de.equals=function(w,g){return e.prototype.equals.call(de,w.replace(/,([\r\n])/g,"$1"),g.replace(/,([\r\n])/g,"$1"))};function E(w,g,N){return de.diff(w,g,N)}function T(w,g,N,M,B){g=g||[],N=N||[],M&&(w=M(B,w));var P;for(P=0;P<g.length;P+=1)if(g[P]===w)return N[P];var W;if(ue.call(w)==="[object Array]"){for(g.push(w),W=new Array(w.length),N.push(W),P=0;P<w.length;P+=1)W[P]=T(w[P],g,N,M,B);return g.pop(),N.pop(),W}if(w&&w.toJSON&&(w=w.toJSON()),D(w)==="object"&&w!==null){g.push(w),W={},N.push(W);var b=[],C;for(C in w)w.hasOwnProperty(C)&&b.push(C);for(b.sort(),P=0;P<b.length;P+=1)C=b[P],W[C]=T(w[C],g,N,M,C);g.pop(),N.pop()}else W=w;return W}var O=new e;O.tokenize=function(w){return w.slice()},O.join=O.removeEmpty=function(w){return w};function k(w,g,N){return O.diff(w,g,N)}function V(w){var g=arguments.length>1&&arguments[1]!==void 0?arguments[1]:{},N=w.split(/\r\n|[\n\v\f\r\x85]/),M=w.match(/\r\n|[\n\v\f\r\x85]/g)||[],B=[],P=0;function W(){var R={};for(B.push(R);P<N.length;){var A=N[P];if(/^(\-\-\-|\+\+\+|@@)\s/.test(A))break;var j=/^(?:Index:|diff(?: -r \w+)+)\s+(.+?)\s*$/.exec(A);j&&(R.index=j[1]),P++}for(b(R),b(R),R.hunks=[];P<N.length;){var Y=N[P];if(/^(Index:|diff|\-\-\-|\+\+\+)\s/.test(Y))break;if(/^@@/.test(Y))R.hunks.push(C());else{if(Y&&g.strict)throw new Error("Unknown line "+(P+1)+" "+JSON.stringify(Y));P++}}}function b(R){var A=/^(---|\+\+\+)\s+(.*)$/.exec(N[P]);if(A){var j=A[1]==="---"?"old":"new",Y=A[2].split("	",2),pe=Y[0].replace(/\\\\/g,"\\");/^".*"$/.test(pe)&&(pe=pe.substr(1,pe.length-2)),R[j+"FileName"]=pe,R[j+"Header"]=(Y[1]||"").trim(),P++}}function C(){for(var R=P,A=N[P++],j=A.split(/@@ -(\d+)(?:,(\d+))? \+(\d+)(?:,(\d+))? @@/),Y={oldStart:+j[1],oldLines:+j[2]||1,newStart:+j[3],newLines:+j[4]||1,lines:[],linedelimiters:[]},pe=0,ee=0;P<N.length&&!(N[P].indexOf("--- ")===0&&P+2<N.length&&N[P+1].indexOf("+++ ")===0&&N[P+2].indexOf("@@")===0);P++){var _=N[P].length==0&&P!=N.length-1?" ":N[P][0];if(_==="+"||_==="-"||_===" "||_==="\\")Y.lines.push(N[P]),Y.linedelimiters.push(M[P]||`
`),_==="+"?pe++:_==="-"?ee++:_===" "&&(pe++,ee++);else break}if(!pe&&Y.newLines===1&&(Y.newLines=0),!ee&&Y.oldLines===1&&(Y.oldLines=0),g.strict){if(pe!==Y.newLines)throw new Error("Added line count did not match for hunk at line "+(R+1));if(ee!==Y.oldLines)throw new Error("Removed line count did not match for hunk at line "+(R+1))}return Y}for(;P<N.length;)W();return B}function me(w,g,N){var M=!0,B=!1,P=!1,W=1;return function b(){if(M&&!P){if(B?W++:M=!1,w+W<=N)return W;P=!0}if(!B)return P||(M=!0),g<=w-W?-W++:(B=!0,b())}}function fe(w,g){var N=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{};if(typeof g=="string"&&(g=V(g)),Array.isArray(g)){if(g.length>1)throw new Error("applyPatch only works with a single input.");g=g[0]}var M=w.split(/\r\n|[\n\v\f\r\x85]/),B=w.match(/\r\n|[\n\v\f\r\x85]/g)||[],P=g.hunks,W=N.compareLine||function(wr,Jn,qs,Qt){return Jn===Qt},b=0,C=N.fuzzFactor||0,R=0,A=0,j,Y;function pe(wr,Jn){for(var qs=0;qs<wr.lines.length;qs++){var Qt=wr.lines[qs],Er=Qt.length>0?Qt[0]:" ",kl=Qt.length>0?Qt.substr(1):Qt;if(Er===" "||Er==="-"){if(!W(Jn+1,M[Jn],Er,kl)&&(b++,b>C))return!1;Jn++}}return!0}for(var ee=0;ee<P.length;ee++){for(var _=P[ee],U=M.length-_.oldLines,Q=0,z=A+_.oldStart-1,se=me(z,R,U);Q!==void 0;Q=se())if(pe(_,z+Q)){_.offset=A+=Q;break}if(Q===void 0)return!1;R=_.offset+_.oldStart+_.oldLines}for(var he=0,be=0;be<P.length;be++){var Re=P[be],ke=Re.oldStart+Re.offset+he-1;he+=Re.newLines-Re.oldLines,ke<0&&(ke=0);for(var tt=0;tt<Re.lines.length;tt++){var nt=Re.lines[tt],_t=nt.length>0?nt[0]:" ",$s=nt.length>0?nt.substr(1):nt,br=Re.linedelimiters[tt];if(_t===" ")ke++;else if(_t==="-")M.splice(ke,1),B.splice(ke,1);else if(_t==="+")M.splice(ke,0,$s),B.splice(ke,0,br),ke++;else if(_t==="\\"){var Gn=Re.lines[tt-1]?Re.lines[tt-1][0]:null;Gn==="+"?j=!0:Gn==="-"&&(Y=!0)}}}if(j)for(;!M[M.length-1];)M.pop(),B.pop();else Y&&(M.push(""),B.push(`
`));for(var Wt=0;Wt<M.length-1;Wt++)M[Wt]=M[Wt]+B[Wt];return M.join("")}function we(w,g){typeof w=="string"&&(w=V(w));var N=0;function M(){var B=w[N++];if(!B)return g.complete();g.loadFile(B,function(P,W){if(P)return g.complete(P);var b=fe(W,B,g);g.patched(B,b,function(C){if(C)return g.complete(C);M()})})}M()}function Ae(w,g,N,M,B,P,W){W||(W={}),typeof W.context>"u"&&(W.context=4);var b=f(N,M,W);b.push({value:"",lines:[]});function C(Q){return Q.map(function(z){return" "+z})}for(var R=[],A=0,j=0,Y=[],pe=1,ee=1,_=function(z){var se=b[z],he=se.lines||se.value.replace(/\n$/,"").split(`
`);if(se.lines=he,se.added||se.removed){var be;if(!A){var Re=b[z-1];A=pe,j=ee,Re&&(Y=W.context>0?C(Re.lines.slice(-W.context)):[],A-=Y.length,j-=Y.length)}(be=Y).push.apply(be,q(he.map(function(Wt){return(se.added?"+":"-")+Wt}))),se.added?ee+=he.length:pe+=he.length}else{if(A)if(he.length<=W.context*2&&z<b.length-2){var ke;(ke=Y).push.apply(ke,q(C(he)))}else{var tt,nt=Math.min(he.length,W.context);(tt=Y).push.apply(tt,q(C(he.slice(0,nt))));var _t={oldStart:A,oldLines:pe-A+nt,newStart:j,newLines:ee-j+nt,lines:Y};if(z>=b.length-2&&he.length<=W.context){var $s=/\n$/.test(N),br=/\n$/.test(M),Gn=he.length==0&&Y.length>_t.oldLines;!$s&&Gn&&Y.splice(_t.oldLines,0,"\\ No newline at end of file"),(!$s&&!Gn||!br)&&Y.push("\\ No newline at end of file")}R.push(_t),A=0,j=0,Y=[]}pe+=he.length,ee+=he.length}},U=0;U<b.length;U++)_(U);return{oldFileName:w,newFileName:g,oldHeader:B,newHeader:P,hunks:R}}function $e(w,g,N,M,B,P,W){var b=Ae(w,g,N,M,B,P,W),C=[];w==g&&C.push("Index: "+w),C.push("==================================================================="),C.push("--- "+b.oldFileName+(typeof b.oldHeader>"u"?"":"	"+b.oldHeader)),C.push("+++ "+b.newFileName+(typeof b.newHeader>"u"?"":"	"+b.newHeader));for(var R=0;R<b.hunks.length;R++){var A=b.hunks[R];C.push("@@ -"+A.oldStart+","+A.oldLines+" +"+A.newStart+","+A.newLines+" @@"),C.push.apply(C,A.lines)}return C.join(`
`)+`
`}function yt(w,g,N,M,B,P){return $e(w,w,g,N,M,B,P)}function Vt(w,g){return w.length!==g.length?!1:X(w,g)}function X(w,g){if(g.length>w.length)return!1;for(var N=0;N<g.length;N++)if(g[N]!==w[N])return!1;return!0}function Ke(w){var g=an(w.lines),N=g.oldLines,M=g.newLines;N!==void 0?w.oldLines=N:delete w.oldLines,M!==void 0?w.newLines=M:delete w.newLines}function nn(w,g,N){w=Ce(w,N),g=Ce(g,N);var M={};(w.index||g.index)&&(M.index=w.index||g.index),(w.newFileName||g.newFileName)&&(Pt(w)?Pt(g)?(M.oldFileName=gt(M,w.oldFileName,g.oldFileName),M.newFileName=gt(M,w.newFileName,g.newFileName),M.oldHeader=gt(M,w.oldHeader,g.oldHeader),M.newHeader=gt(M,w.newHeader,g.newHeader)):(M.oldFileName=w.oldFileName,M.newFileName=w.newFileName,M.oldHeader=w.oldHeader,M.newHeader=w.newHeader):(M.oldFileName=g.oldFileName||w.oldFileName,M.newFileName=g.newFileName||w.newFileName,M.oldHeader=g.oldHeader||w.oldHeader,M.newHeader=g.newHeader||w.newHeader)),M.hunks=[];for(var B=0,P=0,W=0,b=0;B<w.hunks.length||P<g.hunks.length;){var C=w.hunks[B]||{oldStart:1/0},R=g.hunks[P]||{oldStart:1/0};if(Un(C,R))M.hunks.push(Ps(C,W)),B++,b+=C.newLines-C.oldLines;else if(Un(R,C))M.hunks.push(Ps(R,b)),P++,W+=R.newLines-R.oldLines;else{var A={oldStart:Math.min(C.oldStart,R.oldStart),oldLines:0,newStart:Math.min(C.newStart+W,R.oldStart+b),newLines:0,lines:[]};Ye(A,C.oldStart,C.lines,R.oldStart,R.lines),P++,B++,M.hunks.push(A)}}return M}function Ce(w,g){if(typeof w=="string"){if(/^@@/m.test(w)||/^Index:/m.test(w))return V(w)[0];if(!g)throw new Error("Must provide a base reference or pass in a patch");return Ae(void 0,void 0,g,w)}return w}function Pt(w){return w.newFileName&&w.newFileName!==w.oldFileName}function gt(w,g,N){return g===N?g:(w.conflict=!0,{mine:g,theirs:N})}function Un(w,g){return w.oldStart<g.oldStart&&w.oldStart+w.oldLines<g.oldStart}function Ps(w,g){return{oldStart:w.oldStart,oldLines:w.oldLines,newStart:w.newStart+g,newLines:w.newLines,lines:w.lines}}function Ye(w,g,N,M,B){var P={offset:g,lines:N,index:0},W={offset:M,lines:B,index:0};for(Is(w,P,W),Is(w,W,P);P.index<P.lines.length&&W.index<W.lines.length;){var b=P.lines[P.index],C=W.lines[W.index];if((b[0]==="-"||b[0]==="+")&&(C[0]==="-"||C[0]==="+"))_s(w,P,W);else if(b[0]==="+"&&C[0]===" "){var R;(R=w.lines).push.apply(R,q(ct(P)))}else if(C[0]==="+"&&b[0]===" "){var A;(A=w.lines).push.apply(A,q(ct(W)))}else b[0]==="-"&&C[0]===" "?bt(w,P,W):C[0]==="-"&&b[0]===" "?bt(w,W,P,!0):b===C?(w.lines.push(b),P.index++,W.index++):sn(w,ct(P),ct(W))}rn(w,P),rn(w,W),Ke(w)}function _s(w,g,N){var M=ct(g),B=ct(N);if(Vn(M)&&Vn(B)){if(X(M,B)&&Wn(N,M,M.length-B.length)){var P;(P=w.lines).push.apply(P,q(M));return}else if(X(B,M)&&Wn(g,B,B.length-M.length)){var W;(W=w.lines).push.apply(W,q(B));return}}else if(Vt(M,B)){var b;(b=w.lines).push.apply(b,q(M));return}sn(w,M,B)}function bt(w,g,N,M){var B=ct(g),P=Ds(N,B);if(P.merged){var W;(W=w.lines).push.apply(W,q(P.merged))}else sn(w,M?P:B,M?B:P)}function sn(w,g,N){w.conflict=!0,w.lines.push({conflict:!0,mine:g,theirs:N})}function Is(w,g,N){for(;g.offset<N.offset&&g.index<g.lines.length;){var M=g.lines[g.index++];w.lines.push(M),g.offset++}}function rn(w,g){for(;g.index<g.lines.length;){var N=g.lines[g.index++];w.lines.push(N)}}function ct(w){for(var g=[],N=w.lines[w.index][0];w.index<w.lines.length;){var M=w.lines[w.index];if(N==="-"&&M[0]==="+"&&(N="+"),N===M[0])g.push(M),w.index++;else break}return g}function Ds(w,g){for(var N=[],M=[],B=0,P=!1,W=!1;B<g.length&&w.index<w.lines.length;){var b=w.lines[w.index],C=g[B];if(C[0]==="+")break;if(P=P||b[0]!==" ",M.push(C),B++,b[0]==="+")for(W=!0;b[0]==="+";)N.push(b),b=w.lines[++w.index];C.substr(1)===b.substr(1)?(N.push(b),w.index++):W=!0}if((g[B]||"")[0]==="+"&&P&&(W=!0),W)return N;for(;B<g.length;)M.push(g[B++]);return{merged:M,changes:N}}function Vn(w){return w.reduce(function(g,N){return g&&N[0]==="-"},!0)}function Wn(w,g,N){for(var M=0;M<N;M++){var B=g[g.length-N+M].substr(1);if(w.lines[w.index+M]!==" "+B)return!1}return w.index+=N,!0}function an(w){var g=0,N=0;return w.forEach(function(M){if(typeof M!="string"){var B=an(M.mine),P=an(M.theirs);g!==void 0&&(B.oldLines===P.oldLines?g+=B.oldLines:g=void 0),N!==void 0&&(B.newLines===P.newLines?N+=B.newLines:N=void 0)}else N!==void 0&&(M[0]==="+"||M[0]===" ")&&N++,g!==void 0&&(M[0]==="-"||M[0]===" ")&&g++}),{oldLines:g,newLines:N}}function Qn(w){for(var g=[],N,M,B=0;B<w.length;B++)N=w[B],N.added?M=1:N.removed?M=-1:M=0,g.push([M,N.value]);return g}function yr(w){for(var g=[],N=0;N<w.length;N++){var M=w[N];M.added?g.push("<ins>"):M.removed&&g.push("<del>"),g.push(gr(M.value)),M.added?g.push("</ins>"):M.removed&&g.push("</del>")}return g.join("")}function gr(w){var g=w;return g=g.replace(/&/g,"&amp;"),g=g.replace(/</g,"&lt;"),g=g.replace(/>/g,"&gt;"),g=g.replace(/"/g,"&quot;"),g}a.Diff=e,a.diffChars=i,a.diffWords=u,a.diffWordsWithSpace=h,a.diffLines=f,a.diffTrimmedLines=p,a.diffSentences=x,a.diffCss=G,a.diffJson=E,a.diffArrays=k,a.structuredPatch=Ae,a.createTwoFilesPatch=$e,a.createPatch=yt,a.applyPatch=fe,a.applyPatches=we,a.parsePatch=V,a.merge=nn,a.convertChangesToDMP=Qn,a.convertChangesToXML=yr,a.canonicalize=T,Object.defineProperty(a,"__esModule",{value:!0})})});var Bc=on((Fp,qc)=>{var pn=1e3,mn=pn*60,yn=mn*60,Jt=yn*24,Qu=Jt*7,Gu=Jt*365.25;qc.exports=function(a,e){e=e||{};var t=typeof a;if(t==="string"&&a.length>0)return Ju(a);if(t==="number"&&isFinite(a))return e.long?Hu(a):zu(a);throw new Error("val is not a non-empty string or a valid number. val="+JSON.stringify(a))};function Ju(a){if(a=String(a),!(a.length>100)){var e=/^(-?(?:\d+)?\.?\d+) *(milliseconds?|msecs?|ms|seconds?|secs?|s|minutes?|mins?|m|hours?|hrs?|h|days?|d|weeks?|w|years?|yrs?|y)?$/i.exec(a);if(e){var t=parseFloat(e[1]),n=(e[2]||"ms").toLowerCase();switch(n){case"years":case"year":case"yrs":case"yr":case"y":return t*Gu;case"weeks":case"week":case"w":return t*Qu;case"days":case"day":case"d":return t*Jt;case"hours":case"hour":case"hrs":case"hr":case"h":return t*yn;case"minutes":case"minute":case"mins":case"min":case"m":return t*mn;case"seconds":case"second":case"secs":case"sec":case"s":return t*pn;case"milliseconds":case"millisecond":case"msecs":case"msec":case"ms":return t;default:return}}}}function zu(a){var e=Math.abs(a);return e>=Jt?Math.round(a/Jt)+"d":e>=yn?Math.round(a/yn)+"h":e>=mn?Math.round(a/mn)+"m":e>=pn?Math.round(a/pn)+"s":a+"ms"}function Hu(a){var e=Math.abs(a);return e>=Jt?ri(a,e,Jt,"day"):e>=yn?ri(a,e,yn,"hour"):e>=mn?ri(a,e,mn,"minute"):e>=pn?ri(a,e,pn,"second"):a+" ms"}function ri(a,e,t,n){var s=e>=t*1.5;return Math.round(a/t)+" "+n+(s?"s":"")}});var Lc=on((Lp,Fc)=>{function Ku(a){t.debug=t,t.default=t,t.coerce=c,t.disable=r,t.enable=s,t.enabled=o,t.humanize=Bc(),t.destroy=l,Object.keys(a).forEach(u=>{t[u]=a[u]}),t.names=[],t.skips=[],t.formatters={};function e(u){let h=0;for(let d=0;d<u.length;d++)h=(h<<5)-h+u.charCodeAt(d),h|=0;return t.colors[Math.abs(h)%t.colors.length]}t.selectColor=e;function t(u){let h,d=null,f,p;function m(...x){if(!m.enabled)return;let S=m,G=Number(new Date),D=G-(h||G);S.diff=D,S.prev=h,S.curr=G,h=G,x[0]=t.coerce(x[0]),typeof x[0]!="string"&&x.unshift("%O");let q=0;x[0]=x[0].replace(/%([a-zA-Z%])/g,(re,le)=>{if(re==="%%")return"%";q++;let ue=t.formatters[le];if(typeof ue=="function"){let de=x[q];re=ue.call(S,de),x.splice(q,1),q--}return re}),t.formatArgs.call(S,x),(S.log||t.log).apply(S,x)}return m.namespace=u,m.useColors=t.useColors(),m.color=t.selectColor(u),m.extend=n,m.destroy=t.destroy,Object.defineProperty(m,"enabled",{enumerable:!0,configurable:!1,get:()=>d!==null?d:(f!==t.namespaces&&(f=t.namespaces,p=t.enabled(u)),p),set:x=>{d=x}}),typeof t.init=="function"&&t.init(m),m}function n(u,h){let d=t(this.namespace+(typeof h>"u"?":":h)+u);return d.log=this.log,d}function s(u){t.save(u),t.namespaces=u,t.names=[],t.skips=[];let h=(typeof u=="string"?u:"").trim().replace(/\s+/g,",").split(",").filter(Boolean);for(let d of h)d[0]==="-"?t.skips.push(d.slice(1)):t.names.push(d)}function i(u,h){let d=0,f=0,p=-1,m=0;for(;d<u.length;)if(f<h.length&&(h[f]===u[d]||h[f]==="*"))h[f]==="*"?(p=f,m=d,f++):(d++,f++);else if(p!==-1)f=p+1,m++,d=m;else return!1;for(;f<h.length&&h[f]==="*";)f++;return f===h.length}function r(){let u=[...t.names,...t.skips.map(h=>"-"+h)].join(",");return t.enable(""),u}function o(u){for(let h of t.skips)if(i(u,h))return!1;for(let h of t.names)if(i(u,h))return!0;return!1}function c(u){return u instanceof Error?u.stack||u.message:u}function l(){console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`.")}return t.enable(t.load()),t}Fc.exports=Ku});var kc=on((Ve,ai)=>{Ve.formatArgs=Zu;Ve.save=Xu;Ve.load=eh;Ve.useColors=Yu;Ve.storage=th();Ve.destroy=(()=>{let a=!1;return()=>{a||(a=!0,console.warn("Instance method `debug.destroy()` is deprecated and no longer does anything. It will be removed in the next major version of `debug`."))}})();Ve.colors=["#0000CC","#0000FF","#0033CC","#0033FF","#0066CC","#0066FF","#0099CC","#0099FF","#00CC00","#00CC33","#00CC66","#00CC99","#00CCCC","#00CCFF","#3300CC","#3300FF","#3333CC","#3333FF","#3366CC","#3366FF","#3399CC","#3399FF","#33CC00","#33CC33","#33CC66","#33CC99","#33CCCC","#33CCFF","#6600CC","#6600FF","#6633CC","#6633FF","#66CC00","#66CC33","#9900CC","#9900FF","#9933CC","#9933FF","#99CC00","#99CC33","#CC0000","#CC0033","#CC0066","#CC0099","#CC00CC","#CC00FF","#CC3300","#CC3333","#CC3366","#CC3399","#CC33CC","#CC33FF","#CC6600","#CC6633","#CC9900","#CC9933","#CCCC00","#CCCC33","#FF0000","#FF0033","#FF0066","#FF0099","#FF00CC","#FF00FF","#FF3300","#FF3333","#FF3366","#FF3399","#FF33CC","#FF33FF","#FF6600","#FF6633","#FF9900","#FF9933","#FFCC00","#FFCC33"];function Yu(){if(typeof window<"u"&&window.process&&(window.process.type==="renderer"||window.process.__nwjs))return!0;if(typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/(edge|trident)\/(\d+)/))return!1;let a;return typeof document<"u"&&document.documentElement&&document.documentElement.style&&document.documentElement.style.WebkitAppearance||typeof window<"u"&&window.console&&(window.console.firebug||window.console.exception&&window.console.table)||typeof navigator<"u"&&navigator.userAgent&&(a=navigator.userAgent.toLowerCase().match(/firefox\/(\d+)/))&&parseInt(a[1],10)>=31||typeof navigator<"u"&&navigator.userAgent&&navigator.userAgent.toLowerCase().match(/applewebkit\/(\d+)/)}function Zu(a){if(a[0]=(this.useColors?"%c":"")+this.namespace+(this.useColors?" %c":" ")+a[0]+(this.useColors?"%c ":" ")+"+"+ai.exports.humanize(this.diff),!this.useColors)return;let e="color: "+this.color;a.splice(1,0,e,"color: inherit");let t=0,n=0;a[0].replace(/%[a-zA-Z%]/g,s=>{s!=="%%"&&(t++,s==="%c"&&(n=t))}),a.splice(n,0,e)}Ve.log=console.debug||console.log||(()=>{});function Xu(a){try{a?Ve.storage.setItem("debug",a):Ve.storage.removeItem("debug")}catch{}}function eh(){let a;try{a=Ve.storage.getItem("debug")||Ve.storage.getItem("DEBUG")}catch{}return!a&&typeof process<"u"&&"env"in process&&(a=process.env.DEBUG),a}function th(){try{return localStorage}catch{}}ai.exports=Lc()(Ve);var{formatters:nh}=ai.exports;nh.j=function(a){try{return JSON.stringify(a)}catch(e){return"[UnexpectedJSONParseError]: "+e.message}}});var jc=on(()=>{});var Pl=on(()=>{var Ol;(function(a){(function(e){var t=typeof globalThis=="object"?globalThis:typeof global=="object"?global:typeof self=="object"?self:typeof this=="object"?this:o(),n=s(a);typeof t.Reflect<"u"&&(n=s(t.Reflect,n)),e(n,t),typeof t.Reflect>"u"&&(t.Reflect=a);function s(c,l){return function(u,h){Object.defineProperty(c,u,{configurable:!0,writable:!0,value:h}),l&&l(u,h)}}function i(){try{return Function("return this;")()}catch{}}function r(){try{return(0,eval)("(function() { return this; })()")}catch{}}function o(){return i()||r()}})(function(e,t){var n=Object.prototype.hasOwnProperty,s=typeof Symbol=="function",i=s&&typeof Symbol.toPrimitive<"u"?Symbol.toPrimitive:"@@toPrimitive",r=s&&typeof Symbol.iterator<"u"?Symbol.iterator:"@@iterator",o=typeof Object.create=="function",c={__proto__:[]}instanceof Array,l=!o&&!c,u={create:o?function(){return W(Object.create(null))}:c?function(){return W({__proto__:null})}:function(){return W({})},has:l?function(b,C){return n.call(b,C)}:function(b,C){return C in b},get:l?function(b,C){return n.call(b,C)?b[C]:void 0}:function(b,C){return b[C]}},h=Object.getPrototypeOf(Function),d=typeof Map=="function"&&typeof Map.prototype.entries=="function"?Map:M(),f=typeof Set=="function"&&typeof Set.prototype.entries=="function"?Set:B(),p=typeof WeakMap=="function"?WeakMap:P(),m=s?Symbol.for("@reflect-metadata:registry"):void 0,x=gr(),S=w(x);function G(b,C,R,A){if(X(R)){if(!_s(b))throw new TypeError;if(!sn(C))throw new TypeError;return O(b,C)}else{if(!_s(b))throw new TypeError;if(!Ce(C))throw new TypeError;if(!Ce(A)&&!X(A)&&!Ke(A))throw new TypeError;return Ke(A)&&(A=void 0),R=Ye(R),k(b,C,R,A)}}e("decorate",G);function D(b,C){function R(A,j){if(!Ce(A))throw new TypeError;if(!X(j)&&!Is(j))throw new TypeError;Ae(b,C,A,j)}return R}e("metadata",D);function q(b,C,R,A){if(!Ce(R))throw new TypeError;return X(A)||(A=Ye(A)),Ae(b,C,R,A)}e("defineMetadata",q);function J(b,C,R){if(!Ce(C))throw new TypeError;return X(R)||(R=Ye(R)),V(b,C,R)}e("hasMetadata",J);function re(b,C,R){if(!Ce(C))throw new TypeError;return X(R)||(R=Ye(R)),me(b,C,R)}e("hasOwnMetadata",re);function le(b,C,R){if(!Ce(C))throw new TypeError;return X(R)||(R=Ye(R)),fe(b,C,R)}e("getMetadata",le);function ue(b,C,R){if(!Ce(C))throw new TypeError;return X(R)||(R=Ye(R)),we(b,C,R)}e("getOwnMetadata",ue);function de(b,C){if(!Ce(b))throw new TypeError;return X(C)||(C=Ye(C)),$e(b,C)}e("getMetadataKeys",de);function E(b,C){if(!Ce(b))throw new TypeError;return X(C)||(C=Ye(C)),yt(b,C)}e("getOwnMetadataKeys",E);function T(b,C,R){if(!Ce(C))throw new TypeError;if(X(R)||(R=Ye(R)),!Ce(C))throw new TypeError;X(R)||(R=Ye(R));var A=N(C,R,!1);return X(A)?!1:A.OrdinaryDeleteMetadata(b,C,R)}e("deleteMetadata",T);function O(b,C){for(var R=b.length-1;R>=0;--R){var A=b[R],j=A(C);if(!X(j)&&!Ke(j)){if(!sn(j))throw new TypeError;C=j}}return C}function k(b,C,R,A){for(var j=b.length-1;j>=0;--j){var Y=b[j],pe=Y(C,R,A);if(!X(pe)&&!Ke(pe)){if(!Ce(pe))throw new TypeError;A=pe}}return A}function V(b,C,R){var A=me(b,C,R);if(A)return!0;var j=Qn(C);return Ke(j)?!1:V(b,j,R)}function me(b,C,R){var A=N(C,R,!1);return X(A)?!1:Un(A.OrdinaryHasOwnMetadata(b,C,R))}function fe(b,C,R){var A=me(b,C,R);if(A)return we(b,C,R);var j=Qn(C);if(!Ke(j))return fe(b,j,R)}function we(b,C,R){var A=N(C,R,!1);if(!X(A))return A.OrdinaryGetOwnMetadata(b,C,R)}function Ae(b,C,R,A){var j=N(R,A,!0);j.OrdinaryDefineOwnMetadata(b,C,R,A)}function $e(b,C){var R=yt(b,C),A=Qn(b);if(A===null)return R;var j=$e(A,C);if(j.length<=0)return R;if(R.length<=0)return j;for(var Y=new f,pe=[],ee=0,_=R;ee<_.length;ee++){var U=_[ee],Q=Y.has(U);Q||(Y.add(U),pe.push(U))}for(var z=0,se=j;z<se.length;z++){var U=se[z],Q=Y.has(U);Q||(Y.add(U),pe.push(U))}return pe}function yt(b,C){var R=N(b,C,!1);return R?R.OrdinaryOwnMetadataKeys(b,C):[]}function Vt(b){if(b===null)return 1;switch(typeof b){case"undefined":return 0;case"boolean":return 2;case"string":return 3;case"symbol":return 4;case"number":return 5;case"object":return b===null?1:6;default:return 6}}function X(b){return b===void 0}function Ke(b){return b===null}function nn(b){return typeof b=="symbol"}function Ce(b){return typeof b=="object"?b!==null:typeof b=="function"}function Pt(b,C){switch(Vt(b)){case 0:return b;case 1:return b;case 2:return b;case 3:return b;case 4:return b;case 5:return b}var R=C===3?"string":C===5?"number":"default",A=ct(b,i);if(A!==void 0){var j=A.call(b,R);if(Ce(j))throw new TypeError;return j}return gt(b,R==="default"?"number":R)}function gt(b,C){if(C==="string"){var R=b.toString;if(bt(R)){var A=R.call(b);if(!Ce(A))return A}var j=b.valueOf;if(bt(j)){var A=j.call(b);if(!Ce(A))return A}}else{var j=b.valueOf;if(bt(j)){var A=j.call(b);if(!Ce(A))return A}var Y=b.toString;if(bt(Y)){var A=Y.call(b);if(!Ce(A))return A}}throw new TypeError}function Un(b){return!!b}function Ps(b){return""+b}function Ye(b){var C=Pt(b,3);return nn(C)?C:Ps(C)}function _s(b){return Array.isArray?Array.isArray(b):b instanceof Object?b instanceof Array:Object.prototype.toString.call(b)==="[object Array]"}function bt(b){return typeof b=="function"}function sn(b){return typeof b=="function"}function Is(b){switch(Vt(b)){case 3:return!0;case 4:return!0;default:return!1}}function rn(b,C){return b===C||b!==b&&C!==C}function ct(b,C){var R=b[C];if(R!=null){if(!bt(R))throw new TypeError;return R}}function Ds(b){var C=ct(b,r);if(!bt(C))throw new TypeError;var R=C.call(b);if(!Ce(R))throw new TypeError;return R}function Vn(b){return b.value}function Wn(b){var C=b.next();return C.done?!1:C}function an(b){var C=b.return;C&&C.call(b)}function Qn(b){var C=Object.getPrototypeOf(b);if(typeof b!="function"||b===h||C!==h)return C;var R=b.prototype,A=R&&Object.getPrototypeOf(R);if(A==null||A===Object.prototype)return C;var j=A.constructor;return typeof j!="function"||j===b?C:j}function yr(){var b;!X(m)&&typeof t.Reflect<"u"&&!(m in t.Reflect)&&typeof t.Reflect.defineMetadata=="function"&&(b=g(t.Reflect));var C,R,A,j=new p,Y={registerProvider:pe,getProvider:_,setProvider:Q};return Y;function pe(z){if(!Object.isExtensible(Y))throw new Error("Cannot add provider to a frozen registry.");switch(!0){case b===z:break;case X(C):C=z;break;case C===z:break;case X(R):R=z;break;case R===z:break;default:A===void 0&&(A=new f),A.add(z);break}}function ee(z,se){if(!X(C)){if(C.isProviderFor(z,se))return C;if(!X(R)){if(R.isProviderFor(z,se))return C;if(!X(A))for(var he=Ds(A);;){var be=Wn(he);if(!be)return;var Re=Vn(be);if(Re.isProviderFor(z,se))return an(he),Re}}}if(!X(b)&&b.isProviderFor(z,se))return b}function _(z,se){var he=j.get(z),be;return X(he)||(be=he.get(se)),X(be)&&(be=ee(z,se),X(be)||(X(he)&&(he=new d,j.set(z,he)),he.set(se,be))),be}function U(z){if(X(z))throw new TypeError;return C===z||R===z||!X(A)&&A.has(z)}function Q(z,se,he){if(!U(he))throw new Error("Metadata provider not registered.");var be=_(z,se);if(be!==he){if(!X(be))return!1;var Re=j.get(z);X(Re)&&(Re=new d,j.set(z,Re)),Re.set(se,he)}return!0}}function gr(){var b;return!X(m)&&Ce(t.Reflect)&&Object.isExtensible(t.Reflect)&&(b=t.Reflect[m]),X(b)&&(b=yr()),!X(m)&&Ce(t.Reflect)&&Object.isExtensible(t.Reflect)&&Object.defineProperty(t.Reflect,m,{enumerable:!1,configurable:!1,writable:!1,value:b}),b}function w(b){var C=new p,R={isProviderFor:function(U,Q){var z=C.get(U);return X(z)?!1:z.has(Q)},OrdinaryDefineOwnMetadata:pe,OrdinaryHasOwnMetadata:j,OrdinaryGetOwnMetadata:Y,OrdinaryOwnMetadataKeys:ee,OrdinaryDeleteMetadata:_};return x.registerProvider(R),R;function A(U,Q,z){var se=C.get(U),he=!1;if(X(se)){if(!z)return;se=new d,C.set(U,se),he=!0}var be=se.get(Q);if(X(be)){if(!z)return;if(be=new d,se.set(Q,be),!b.setProvider(U,Q,R))throw se.delete(Q),he&&C.delete(U),new Error("Wrong provider for target.")}return be}function j(U,Q,z){var se=A(Q,z,!1);return X(se)?!1:Un(se.has(U))}function Y(U,Q,z){var se=A(Q,z,!1);if(!X(se))return se.get(U)}function pe(U,Q,z,se){var he=A(z,se,!0);he.set(U,Q)}function ee(U,Q){var z=[],se=A(U,Q,!1);if(X(se))return z;for(var he=se.keys(),be=Ds(he),Re=0;;){var ke=Wn(be);if(!ke)return z.length=Re,z;var tt=Vn(ke);try{z[Re]=tt}catch(nt){try{an(be)}finally{throw nt}}Re++}}function _(U,Q,z){var se=A(Q,z,!1);if(X(se)||!se.delete(U))return!1;if(se.size===0){var he=C.get(Q);X(he)||(he.delete(z),he.size===0&&C.delete(he))}return!0}}function g(b){var C=b.defineMetadata,R=b.hasOwnMetadata,A=b.getOwnMetadata,j=b.getOwnMetadataKeys,Y=b.deleteMetadata,pe=new p,ee={isProviderFor:function(_,U){var Q=pe.get(_);return!X(Q)&&Q.has(U)?!0:j(_,U).length?(X(Q)&&(Q=new f,pe.set(_,Q)),Q.add(U),!0):!1},OrdinaryDefineOwnMetadata:C,OrdinaryHasOwnMetadata:R,OrdinaryGetOwnMetadata:A,OrdinaryOwnMetadataKeys:j,OrdinaryDeleteMetadata:Y};return ee}function N(b,C,R){var A=x.getProvider(b,C);if(!X(A))return A;if(R){if(x.setProvider(b,C,S))return S;throw new Error("Illegal state.")}}function M(){var b={},C=[],R=(function(){function ee(_,U,Q){this._index=0,this._keys=_,this._values=U,this._selector=Q}return ee.prototype["@@iterator"]=function(){return this},ee.prototype[r]=function(){return this},ee.prototype.next=function(){var _=this._index;if(_>=0&&_<this._keys.length){var U=this._selector(this._keys[_],this._values[_]);return _+1>=this._keys.length?(this._index=-1,this._keys=C,this._values=C):this._index++,{value:U,done:!1}}return{value:void 0,done:!0}},ee.prototype.throw=function(_){throw this._index>=0&&(this._index=-1,this._keys=C,this._values=C),_},ee.prototype.return=function(_){return this._index>=0&&(this._index=-1,this._keys=C,this._values=C),{value:_,done:!0}},ee})(),A=(function(){function ee(){this._keys=[],this._values=[],this._cacheKey=b,this._cacheIndex=-2}return Object.defineProperty(ee.prototype,"size",{get:function(){return this._keys.length},enumerable:!0,configurable:!0}),ee.prototype.has=function(_){return this._find(_,!1)>=0},ee.prototype.get=function(_){var U=this._find(_,!1);return U>=0?this._values[U]:void 0},ee.prototype.set=function(_,U){var Q=this._find(_,!0);return this._values[Q]=U,this},ee.prototype.delete=function(_){var U=this._find(_,!1);if(U>=0){for(var Q=this._keys.length,z=U+1;z<Q;z++)this._keys[z-1]=this._keys[z],this._values[z-1]=this._values[z];return this._keys.length--,this._values.length--,rn(_,this._cacheKey)&&(this._cacheKey=b,this._cacheIndex=-2),!0}return!1},ee.prototype.clear=function(){this._keys.length=0,this._values.length=0,this._cacheKey=b,this._cacheIndex=-2},ee.prototype.keys=function(){return new R(this._keys,this._values,j)},ee.prototype.values=function(){return new R(this._keys,this._values,Y)},ee.prototype.entries=function(){return new R(this._keys,this._values,pe)},ee.prototype["@@iterator"]=function(){return this.entries()},ee.prototype[r]=function(){return this.entries()},ee.prototype._find=function(_,U){if(!rn(this._cacheKey,_)){this._cacheIndex=-1;for(var Q=0;Q<this._keys.length;Q++)if(rn(this._keys[Q],_)){this._cacheIndex=Q;break}}return this._cacheIndex<0&&U&&(this._cacheIndex=this._keys.length,this._keys.push(_),this._values.push(void 0)),this._cacheIndex},ee})();return A;function j(ee,_){return ee}function Y(ee,_){return _}function pe(ee,_){return[ee,_]}}function B(){var b=(function(){function C(){this._map=new d}return Object.defineProperty(C.prototype,"size",{get:function(){return this._map.size},enumerable:!0,configurable:!0}),C.prototype.has=function(R){return this._map.has(R)},C.prototype.add=function(R){return this._map.set(R,R),this},C.prototype.delete=function(R){return this._map.delete(R)},C.prototype.clear=function(){this._map.clear()},C.prototype.keys=function(){return this._map.keys()},C.prototype.values=function(){return this._map.keys()},C.prototype.entries=function(){return this._map.entries()},C.prototype["@@iterator"]=function(){return this.keys()},C.prototype[r]=function(){return this.keys()},C})();return b}function P(){var b=16,C=u.create(),R=A();return(function(){function _(){this._key=A()}return _.prototype.has=function(U){var Q=j(U,!1);return Q!==void 0?u.has(Q,this._key):!1},_.prototype.get=function(U){var Q=j(U,!1);return Q!==void 0?u.get(Q,this._key):void 0},_.prototype.set=function(U,Q){var z=j(U,!0);return z[this._key]=Q,this},_.prototype.delete=function(U){var Q=j(U,!1);return Q!==void 0?delete Q[this._key]:!1},_.prototype.clear=function(){this._key=A()},_})();function A(){var _;do _="@@WeakMap@@"+ee();while(u.has(C,_));return C[_]=!0,_}function j(_,U){if(!n.call(_,R)){if(!U)return;Object.defineProperty(_,R,{value:u.create()})}return _[R]}function Y(_,U){for(var Q=0;Q<U;++Q)_[Q]=Math.random()*255|0;return _}function pe(_){if(typeof Uint8Array=="function"){var U=new Uint8Array(_);return typeof crypto<"u"?crypto.getRandomValues(U):typeof msCrypto<"u"?msCrypto.getRandomValues(U):Y(U,_),U}return Y(new Array(_),_)}function ee(){var _=pe(b);_[6]=_[6]&79|64,_[8]=_[8]&191|128;for(var U="",Q=0;Q<b;++Q){var z=_[Q];(Q===4||Q===6||Q===8)&&(U+="-"),z<16&&(U+="0"),U+=z.toString(16).toLowerCase()}return U}}function W(b){return b.__=void 0,delete b.__,b}})})(Ol||(Ol={}))});var Et;(function(a){class e{}a.ParamConfig=e;class t{constructor(){this.parameters={}}}a.MethodConfig=t;class n{constructor(){this.singleton=void 0,this.injections=[],this.vChildren=[],this.methods={}}}a.ClassConfig=n})(Et||(Et={}));var Ee={MODELS_MAPPING:Symbol(),DEFAULT_MODEL:Symbol(),STORAGE:"classesstorage",CLASSES:"classes",ClassNameStaticProperty:ln.ClassNameStaticProperty};function ks(){return y.cloneDeep({[Ee.CLASSES]:[]})}function Yn(a){return typeof a=="string"?Yn()[a]:(typeof ks.prototype[Ee.STORAGE]>"u"&&(ks.prototype[Ee.STORAGE]=ks()),ks.prototype[Ee.STORAGE])}function zo(){return Yn()[Ee.CLASSES]}function js(a,e,t){let{classFamily:n,uniqueKey:s,classNameInBrowser:i,singleton:r}=t||{classFamily:void 0,uniqueKey:"id",classNameInBrowser:void 0,singleton:void 0,autoinstance:!1};if(!y.isUndefined(r)&&y.isBoolean(r)&&r&&(r="first-instance"),s||(s="id"),a){let l=y.first(Pe.getClassConfig(a));l.className=e,l.uniqueKey=s,l.classNameInBrowser=i}let o=zo().find(l=>l.className===e);if(o)o.target=a;else{let l={className:e,classNameInBrowser:i,target:a,uniqueKey:s,classFamily:n};y.isUndefined(n)&&Object.defineProperty(l,"classFamily",{get:function(){let u=Object.getPrototypeOf(a);if(!y.isFunction(u)||u.name==="Object"||u.name==="")return e;let h=Pe.getClassName(u);return Pe.getClassFamilyByClassName(h)}}),zo().push(l)}let c=a;if(r==="first-instance"||r==="last-instance"){let l={decoratedConstructor:function(...u){let h=c.apply(this,u);return(!ye.getSingleton(c)||r==="last-instance")&&(ye.setSingletonObj(c,this),ye.setSingletonObj(l.decoratedConstructor,this)),h}};return l.decoratedConstructor.prototype=c.prototype,Object.keys(c).forEach(u=>{l.decoratedConstructor[u]=c[u]}),Object.defineProperty(l.decoratedConstructor,"name",{value:e,configurable:!0}),l.decoratedConstructor}else if(r==="autoinstance"){let l=new c;ye.setSingletonObj(c,l)}}var Tt={configs:[],classes:[]};var Ho=`[typescript-class-helpers][getClassName(...)](PRODUCTION MODE ERROR)
Please use decoartor @CLASSNAME for each entity or controller
This is preventing class name problem in minified code.

import { CLASS } from 'typescript-class-helpers';

@CLASS.NAME('ExampleClass')
class ExampleClass {
  ...
}
`;function Zn(){return Yn()[Ee.CLASSES]}var Pe;(function(a){function e(l,u=[],h){if(!y.isFunction(l))throw`[typescript-class-helper][getClassConfig] Cannot get class config from: ${l}`;let d,f=Object.getPrototypeOf(l),p=y.isFunction(f)&&f.name!=="";if(Tt.classes.includes(l)?d=Tt.configs[Tt.classes.findIndex(m=>m===l)]:(d=new Et.ClassConfig,d.classReference=l,Tt.classes.push(l)),Tt.configs[Tt.classes.findIndex(m=>m===l)]=d,h){let m=Tt.configs[Tt.classes.findIndex(x=>x===h)];d.vChildren.includes(m)||d.vChildren.push(m),m.vParent=d}return u.push(d),p?e(f,u,l):u}a.getClassConfig=e;function t(l,u){return function(h){return js(h,l,u)}}a.CLASSNAME=t;function n(l,u=!1){if(y.isNil(l))return;if(y.isString(l))return F.log(`[typescript-class-helpers][getClassName] target is string: '${l}', produciton: ${u}`),l;if(l===Date)return"Date";if(l===FormData)return"FormData";if(!y.isFunction(l)){F.log("[typescript-class-helpers][getClassName] target is not a class");return}if(l[Ee.ClassNameStaticProperty])return l[Ee.ClassNameStaticProperty];let h=e(l),d=y.first(h),f=d?.classNameInBrowser;if(F.isBrowser&&y.isString(f))return f;let p=d?.className;if(typeof p=="string")return p;if(u)throw console.log("class without @CLASS.NAME deocrator",l),new Error(Ho);return l.name?.startsWith("class_")?"":l.name}a.getClassName=n;function s(l){let u=Be.getNameFromObject(l),h=Zn().find(d=>d.className===u);if(h)return h.uniqueKey}a.getObjectIndexPropertyValue=s;function i(l){let u=Zn().find(h=>h.className===l);if(u)return u.classFamily}a.getClassFamilyByClassName=i;function r(l){let u=Be.getNameFromObject(l),h=Zn().find(d=>d.className===u);if(h)return h.classFamily}a.getObjectClassFamily=r;function o(l){let u=Be.getNameFromObject(l),h=Zn().find(d=>d.className===u);if(h&&y.isString(h.uniqueKey))return l[h.uniqueKey]}a.getObjectIndexValue=o;function c(l){let u;if(Array.isArray(l)){if(l.length!==1)throw`Mapping error... please use proper class names:
  {
    propertyObject: 'MyClassName',
    propertyWithArray: ['MyClassName']
  }

        `;l=l[0]}typeof l=="function"&&(u=l),l==="Date"&&(u=Date),l==="FormData"&&(u=FormData);let h=Zn().find(d=>d.className===l);return h&&(u=h.target),u}a.getClassBy=c})(Pe||(Pe={}));var Jl=new RegExp(/(?:this\.)(.+?(?= ))/g);function Nr(a,e=!1){var t=[];if(e){var n=Object.getPrototypeOf(a.prototype);n&&(t=t.concat(Nr(n.constructor,e)))}let i=a.toString().match(Jl)||[];return t=t.concat(i),t.map(r=>r.replace("this.","").replace(".","").replace(")","").replace("(",""))}function Ko(a){let e={};if(a){a[Ee.DEFAULT_MODEL]&&Object.keys(a[Ee.DEFAULT_MODEL]).filter(s=>!y.isFunction(a[Ee.DEFAULT_MODEL][s])).forEach(s=>e[s]=null);let n=a[Ee.MODELS_MAPPING];y.isArray(n)?n.forEach(s=>{Object.keys(s).forEach(i=>{e[i]=null})}):n&&Object.keys(n).forEach(s=>{e[s]=null})}let t=Object.keys(e).filter(n=>!!n);return t=(t.includes("id")?[]:["id"]).concat(t),t}var Be=class{static getBy(e){return Pe.getClassBy(e)}static getFromObject(e){if(y.isUndefined(e)||y.isNull(e))return;if(e.constructor)return e.constructor;let t=Object.getPrototypeOf(e);return t&&t.constructor}static getName(e,t=!1){return Pe.getClassName(e,t)}static getNameFromObject(e){let t=this.getFromObject(e);return this.getName(t)}static getConfigs(e){return Pe.getClassConfig(e)}static describeProperites(e){let t=Nr(e),n=Ko(e),s={};return t.concat(n).forEach(i=>s[i]=i),Object.keys(s).filter(i=>!!i).filter(i=>typeof e.prototype[i]!="function")}},zl=["length","name","arguments","caller","constructor","apply","bind","call","toString","__defineGetter__","__defineSetter__","hasOwnProperty","__lookupGetter__","__lookupSetter__","isPrototypeOf","propertyIsEnumerable","valueOf","__proto__","toLocaleString"],Yo=(a,e=[])=>{if(!a)return e;let t=y.isFunction(a),n=t?a:Object.getPrototypeOf(a),s=t?a?.prototype:a,i=Object.getPrototypeOf(s||{});return y.uniq([...Object.getOwnPropertyNames(s||{}),...Object.getOwnPropertyNames(i||{}),...Object.keys(s||{}),...Object.keys(i||{})]).filter(o=>!!o&&!zl.includes(o)).filter(o=>typeof s[o]=="function").forEach(o=>e.push(o)),!n||!n.constructor||n?.constructor?.name==="Object"?e:Yo(Object.getPrototypeOf(n),e)},ye={NAME:Pe.CLASSNAME,setName:js,getBy:Be.getBy,getSingleton(a){if(typeof a!="function"){console.error("[typescript-class-helpers][setSingletonObj] Type of target is not a function");return}return Be.getConfigs(a)[0].singleton},setSingletonObj(a,e){if(typeof a!="function"){console.error("[typescript-class-helpers][setSingletonObj] Type of target is not a function");return}if(Array.isArray(e)){console.error("[typescript-class-helpers][setSingletonObj] Singleton instance cant be an array");return}if(typeof e!="object"){console.error("[typescript-class-helpers][setSingletonObj] Singleton instance cant must be a object");return}let t=ye.getName(a),n=Be.getConfigs(a)[0];n.singleton&&console.warn(`[typescript-class-helpers] You are trying to set singleton of "${t}" second time with different object.`),n.singleton=e},getConfigs:Be.getConfigs,getConfig:a=>y.first(Be.getConfigs(a)),getMethodsNames(a){return Yo(a)},getFromObject:Be.getFromObject,getName:Be.getName,getNameFromObject:Be.getNameFromObject,describeProperites:Be.describeProperites,OBJECT:a=>({get indexValue(){return Pe.getObjectIndexValue(a)},get indexProperty(){return Pe.getObjectIndexPropertyValue(a)},get isClassObject(){if(!y.isObject(a)||y.isArray(a)||y.isRegExp(a)||y.isBuffer(a)||y.isArrayBuffer(a))return!1;if(y.isDate(a))return!0;let e=ye.getNameFromObject(a);return y.isString(e)&&e!=="Object"},isEqual:(e,t=!1)=>{if(!ye.OBJECT(a).isClassObject||!ye.OBJECT(e).isClassObject)return!1;if(a===e)return!0;let n=Pe.getObjectIndexValue(a),s=Pe.getObjectIndexValue(e),i=Pe.getObjectClassFamily(a),r=Pe.getObjectClassFamily(e);return!y.isString(i)||!y.isString(r)||i!==r||!ye.OBJECT(a).isClassObject||!ye.OBJECT(e).isClassObject?!1:y.isNumber(n)&&y.isNumber(s)||y.isString(n)&&y.isString(s)?n===s:t?y.isEqual(n,s):!1}})};function Zo(a,e,t){let n=a.v;if(y.isArray(n))return n.map((s,i)=>({v:s,p:`${e}[${i}]`,parent:a,isGetter:!1}));if(y.isObject(n)){let s=t?Object.getOwnPropertyNames(n):[],i=[];for(let r in n)y.isObject(n)&&y.isFunction(n.hasOwnProperty)&&n.hasOwnProperty(r)&&(y.pull(s,r),i.push({v:n[r],p:`${e===""?"":`${e}.`}${r}`,parent:a,isGetter:!1}));if(t){for(let r=0;r<s.length;r++)if(y.isObject(n)){let o=s[r];i.push({v:n[o],p:`${e===""?"":`${e}.`}${o}`,parent:a,isGetter:!0})}}return i}return[]}var Us=class{static get Walk(){let e=this;return{Object(t,n,s){y.isUndefined(s)&&(s={}),s.hasIterator=y.isFunction(n),y.isUndefined(s.breadthWalk)&&(s.breadthWalk=!1);let{circural:i}=e._walk(t,t,n,void 0,s);return{circs:i}},ObjectBy(t,n,s,i){y.isFunction(s)&&s(n,"",e._changeValue(n,t,!0));let r=n[t];return e.Walk.Object(r,s,i)}}}static _changeValue(e,t,n=!1,s){var{contextPath:i,property:r}=this._prepareParams(t),o=y.get(e,i);return c=>{i===""&&(n=!0),n?e[r]=c:o&&(o[r]=c),s&&(s._valueChanged=!0)}}static _prepareParams(e){let t=this._Helpers.Path.getContextPath(e),n=this._Helpers.Path.getPropertyPath(e,t);return y.isString(n)&&n.trim()!==""&&!y.isNaN(Number(n))&&(n=Number(n)),{contextPath:t,property:n}}static get _Helpers(){return{get Path(){return{getPropertyPath(e,t){return e.replace(t,"").replace(/^\./,"").replace(/\[/,"").replace(/\]/,"")},getContextPath(e){let t;return e.endsWith("]")?t=e.replace(/\[(\"|\')?[0-9]+(\"|\')?\]$/,""):t=e.replace(/\.([a-zA-Z0-9]|\$|\_|\@|\-|\/|\:)+$/,""),t===e?"":t}}}}}static _shoudlReturn(e=[],t=[],n){let s=!1;return n.replace(/^\[(\'|\")?[0-9]*(\'|\")?\]/,"").trim()!==""&&(n=n.replace(/^\[(\'|\")?[0-9]*(\'|\")?\]\./,""),s=y.isArray(e)&&e.length>0&&!e.find(i=>n.startsWith(i))||y.isArray(t)&&t.length>0&&!!t.find(i=>n.startsWith(i))),s}static prepareOptions(e,t,n){if(e._exit)return;y.isUndefined(e.walkGetters)&&(e.walkGetters=!0),y.isUndefined(e.checkCircural)&&(e.checkCircural=!1),y.isUndefined(e.isGetter)&&(e.isGetter=!1),y.isUndefined(e._valueChanged)&&(e._valueChanged=!1),y.isUndefined(e._exit)&&(e._exit=!1),y.isUndefined(e.exit)&&(e.exit=()=>{e._exit=!0}),y.isUndefined(e._skip)&&(e._skip=!1),y.isUndefined(e.skipObject)&&(e.skipObject=()=>{e._skip=!0}),e.checkCircural&&(y.isUndefined(e.db)&&(e.db={}),y.isUndefined(e.stack)&&(e.stack=[]),y.isUndefined(e.circural)&&(e.circural=[]));let{db:s,stack:i}=e;if(e.isCircural=!1,e.checkCircural&&y.isObject(t)){let r=ye.OBJECT(t).indexValue;if(ye.OBJECT(t).isClassObject&&!y.isUndefined(r)){let c=`${ye.getNameFromObject(t)}.id_${r}`,l=y.get(s,c);if(l&&ye.OBJECT(l.target).isEqual(t)){let u={pathToObj:n,circuralTargetPath:l.path};e.circural.push(u),e.isCircural=!0}else y.set(s,c,{path:n,target:t})}else{let o=i.find(c=>c.target==t);if(y.isUndefined(o))i.push({path:n,target:t});else{let c={pathToObj:n,circuralTargetPath:o.path};e.circural.push(c),e.isCircural=!0}}}return e}static _walk(e,t,n,s="",i,r=0){if(i||(i={}),!i.breadthWalk){if(i=this.prepareOptions(i,t,s),this._shoudlReturn(i.include,i.exclude,s))return;if(i.hasIterator&&s!==""&&n(t,s,this._changeValue(e,s,!1,i),i),i._valueChanged&&(t=y.get(e,s)),i._valueChanged=!1,i.isCircural&&(i._skip=!0),i._skip){i._skip=!1;return}}if(i.breadthWalk){let o=[{v:e,p:s,parent:void 0}];for(;o.length>0;){let c=o.shift();if(this._shoudlReturn(i.include,i.exclude,c.p))continue;let{v:l,p:u}=c;if(i=this.prepareOptions(i,l,u),i._exit)return console.log("EXIT"),i;if(i.hasIterator&&u!==""&&n(l,u,this._changeValue(e,u,!1,i),i),i._valueChanged&&(c.v=y.get(e,u)),i._valueChanged=!1,!i.isCircural){if(i._skip){i._skip=!1;continue}(y.isArray(l)||y.isObject(l))&&(o=o.concat(Zo(c,u,i.walkGetters)))}}}else{let{walkGetters:o}=i;if(Array.isArray(t))t.forEach((c,l)=>{this._walk(e,t[l],n,`${s}[${l}]`,i,r+1)});else if(y.isObject(t)){let c=o?Object.getOwnPropertyNames(t):[];for(let l in t)if(y.isObject(t)&&t.hasOwnProperty(l)){y.pull(c,l);let u=l;i.isGetter=!1,u.includes(".")&&(u=`['${u}']`),this._walk(e,t[u],n,`${s===""?"":`${s}.`}${u}`,i,r+1)}if(o){for(let l=0;l<c.length;l++)if(y.isObject(t)){let u=c[l];i.isGetter=!0,this._walk(e,t[u],n,`${s===""?"":`${s}.`}${u}`,i,r+1)}}}i._exit&&e===t&&(i._exit=!1)}return i}},Gt={Object:Us.Walk.Object,ObjectBy:Us.Walk.ObjectBy};var Ze=class{static structureArray(e,t){let n=[],{include:s,exclude:i}=t||{};return Gt.Object(e,(r,o)=>{y.isUndefined(r)||n.push(o)},{include:s,exclude:i,checkCircural:!0}),n}static cleaned(e,t,n){let s=y.isArray(e)?[]:{},i=ye.OBJECT(e).isClassObject&&ye.getFromObject(e),{exclude:r,include:o,breadthWalk:c}=n||{exclude:[],include:[],breadthWalk:!1},{circs:l}=Gt.Object(e,(u,h,d,f)=>{y.isObject(u)&&f.isCircural?y.set(s,h,null):y.set(s,h,y.cloneDeep(u))},{include:o,exclude:r,breadthWalk:c,checkCircural:!0});return y.isFunction(t)&&t(l),y.isFunction(i)?y.merge(new i,s):s}static stringify(e,t,n,s){let i=this.cleaned(e,s);return JSON.stringify(i,t,n)}static parse(e,t=[]){let n=JSON.parse(e);return y.isArray(t)&&t.forEach(({circuralTargetPath:s,pathToObj:i})=>{if(s==="")y.set(n,i,n);else{let r=y.get(n,s);y.set(n,i,r)}}),n}};var un=class a{static get Instance(){return a.__instance||(a.__instance=new a),a.__instance}constructor(){}read(e){var t=new RegExp("(?:^|; )"+encodeURIComponent(e)+"=([^;]*)").exec(document.cookie);return t?t[1]:null}write(e,t,n){n||(n=365*20);var s=new Date;s.setTime(s.getTime()+n*24*60*60*1e3);var i="; expires="+s.toUTCString();document.cookie=e+"="+t+i+"; path=/"}remove(e){this.write(e,"",-1)}};var sc=wt(ec());var te=(function(a){return a[a.DATA=0]="DATA",a[a.INFO=1]="INFO",a[a.WARN=2]="WARN",a[a.ERROR=3]="ERROR",a[a.SUCCESS=4]="SUCCESS",a[a.TASK_STARTED=5]="TASK_STARTED",a[a.TASK_DONE=6]="TASK_DONE",a[a.__NOTHING=7]="__NOTHING",a})(te||{}),Ct={[te.DATA]:"log",[te.INFO]:"info",[te.WARN]:"warn",[te.ERROR]:"error",[te.SUCCESS]:"success",[te.TASK_STARTED]:"taskstarted",[te.TASK_DONE]:"taskdone",[te.__NOTHING]:""},vr=[Ct[te.DATA],Ct[te.TASK_STARTED],Ct[te.TASK_DONE],Ct[te.INFO],Ct[te.SUCCESS],Ct[te.WARN],Ct[te.ERROR]];var ut=class{static msg(e,t,n,s,i,r,o){if(o)return;let c="gray";if(i===te.INFO&&(c="deepskyblue"),i===te.ERROR&&(c="red"),i===te.WARN&&(c="orange"),r){let l=r-n.length;if(l>0)for(let u=0;u<l;u++)n+=" "}if(F.isBrowser)if(document.documentMode||/Edge/.test(navigator.userAgent)){if(typeof e=="string"){let u="[[ "+n+" ]] "+e+" ";t.unshift(u)}else{let u="[[ "+n+"]] ";t.push(e),t.unshift(u)}i===te.INFO?console.info.apply(console,t):i===te.ERROR?console.error.apply(console,t):i===te.WARN?console.warn.apply(console,t):console.log.apply(console,t)}else{if(typeof e=="string"){let u="%c "+n+"  %c "+e+" ",h="background: "+s+";color:white; border: 1px solid "+s+"; ",d="border: 1px solid "+c+"; ";t.unshift(d),t.unshift(h),t.unshift(u)}else{let u="%c "+n+" ",h="background: "+s+";color:white; border: 1px solid "+c+"; ";t.push(e),t.unshift(h),t.unshift(u)}console.log.apply(console,t)}}};var Ws=class{setLevel(e){return this._level=e,this}get isProductionMode(){return!this.developmentMode}setProductionMode(e){return this.developmentMode=!e,this}mute(){return this.isMuted=!0,this}constructor(e,t,n,s,i,r){this.name=e,this.color=t,this.developmentMode=n,this.allowed=s,this.isMuted=i,this.fixedWidth=r,this.d=(o,...c)=>this._data(o,c),this.er=(o,...c)=>this._error(o,c),this.i=(o,...c)=>this._info(o,c),this.w=(o,...c)=>this._warn(o,c),this.data=(o,...c)=>this._data(o,c),this.error=(o,...c)=>this._error(o,c),this.info=(o,...c)=>this._info(o,c),this.success=(o,...c)=>this._success(o,c),this.taskStarted=(o,...c)=>this._taskStarted(o,c),this.taskDone=(o,...c)=>this._taskDone(o,c),this.warn=(o,...c)=>this._warn(o,c)}onlyWhen(e){typeof e=="function"?this.isMuted=!e():typeof e=="boolean"&&(this.isMuted=!e)}_data(e,...t){return this.isMuted?this:this.allowed.length>=1&&F.contain(this.allowed,te.__NOTHING)&&!F.contain(this.allowed,te.DATA)?this:((this.allowed.length===0||F.contain(this.allowed,te.DATA))&&ut.msg.apply(void 0,[e,...t,this.name,this.color,te.DATA,this.fixedWidth,this.isProductionMode]),this)}_error(e,...t){return this.isMuted?this:this.allowed.length>=1&&F.contain(this.allowed,te.__NOTHING)&&!F.contain(this.allowed,te.ERROR)?this:((this.allowed.length===0||F.contain(this.allowed,te.ERROR))&&ut.msg.apply(void 0,[e,...t,this.name,this.color,te.ERROR,this.fixedWidth,this.isProductionMode]),this)}_info(e,...t){return this.isMuted?this:this.allowed.length>=1&&F.contain(this.allowed,te.__NOTHING)&&!F.contain(this.allowed,te.INFO)?this:((this.allowed.length===0||F.contain(this.allowed,te.INFO))&&ut.msg.apply(void 0,[e,...t,this.name,this.color,te.INFO,this.fixedWidth,this.isProductionMode]),this)}_success(e,...t){return this.isMuted?this:this.allowed.length>=1&&F.contain(this.allowed,te.__NOTHING)&&!F.contain(this.allowed,te.SUCCESS)?this:((this.allowed.length===0||F.contain(this.allowed,te.SUCCESS))&&ut.msg.apply(void 0,[e,...t,this.name,this.color,te.SUCCESS,this.fixedWidth,this.isProductionMode]),this)}_taskStarted(e,...t){return this.isMuted?this:this.allowed.length>=1&&F.contain(this.allowed,te.__NOTHING)&&!F.contain(this.allowed,te.TASK_STARTED)?this:((this.allowed.length===0||F.contain(this.allowed,te.TASK_STARTED))&&ut.msg.apply(void 0,[e,...t,this.name,this.color,te.TASK_STARTED,this.fixedWidth,this.isProductionMode]),this)}_taskDone(e,...t){return this.isMuted?this:this.allowed.length>=1&&F.contain(this.allowed,te.__NOTHING)&&!F.contain(this.allowed,te.TASK_DONE)?this:((this.allowed.length===0||F.contain(this.allowed,te.TASK_DONE))&&ut.msg.apply(void 0,[e,...t,this.name,this.color,te.TASK_DONE,this.fixedWidth,this.isProductionMode]),this)}_warn(e,...t){return this.isMuted?this:this.allowed.length>=1&&F.contain(this.allowed,te.__NOTHING)&&!F.contain(this.allowed,te.WARN)?this:((this.allowed.length===0||F.contain(this.allowed,te.WARN))&&ut.msg.apply(void 0,[e,...t,this.name,this.color,te.WARN,this.fixedWidth,this.isProductionMode]),this)}};var tc=(()=>{class a{constructor(){this._logOnly=!1,this._logModules=!1,this.isDevelopmentMode=!0,this.modeIsSet=!1,this.fixedWidth=0,this.instances={},this.levels=[],this.modules=[]}static get instance(){return a._instance||(a._instance=new a),a._instance}static{this.Logger=Ws}static create(t,...n){return a.instance.create(t,...n)}static{this.consolelogfn={}}static disableLogs(t=te.__NOTHING){vr.reverse().find(n=>(this.consolelogfn[n]||(this.consolelogfn[n]=console[n]),console[n]=()=>{},n===Ct[t]))}static enableLogs(){vr.forEach(t=>{console[t]=this.consolelogfn[t]})}setProductionMode(){if(this.modeIsSet)throw this.modeIsSet=!1,"[ng2-logger] Production mode is already set";this.modeIsSet=!0,setTimeout(()=>{this.modeIsSet&&console!==void 0&&console.clear!==void 0&&(console.clear(),console.log=()=>{},console.error=()=>{},console.warn=()=>{},console.info=()=>{})}),this.isDevelopmentMode=!1}onlyModules(...t){if(this._logModules)throw"[ng2-logger] You should use funcion onlyModules only once";this._logModules||(this._logModules=!0),t.length!==0&&(this.modules=t,this.muteAllOtherModules())}onlyLevel(...t){if(this._logOnly)throw"[ng2-logger] You should use funcion onlyLevel only once";this._logOnly||(this._logOnly=!0),this.levels=Array.isArray(t)?t:[t];for(let n in this.instances)if(this.instances.hasOwnProperty(n)){let s=this.instances[n];s.allowed=this.levels}}create(t,...n){let s;return Array.isArray(this.levels)&&this.levels.length>0&&(n=this.levels),this.instances[t]===void 0?(s=new a.Logger(t,nc(),this.isDevelopmentMode,n,this.isMutedModule(t),this.levels.length>0?this.fixedWidth:void 0),this.instances[t]=s):s=this.instances[t],s}isMutedModule(t){return this.modules.length==0?!1:!F.contain(this.modules,t)}muteAllOtherModules(){for(var t in this.instances)F.contain(this.modules,t)||this.instances[t].mute()}}return a})();function nc(){let a="012345".split(""),e="#";e+=a[Math.round(Math.random()*5)],a="0123456789ABCDEF".split("");for(let t=0;t<5;t++)e+=a[Math.round(Math.random()*15)];return e===void 0?nc():e}var Nt;(function(a){function e(h,d=!1){if(y.isUndefined(h))return;let f=n(y.isArray(h)?y.first(h):h,!d);return d&&(f=y.merge(r(h),f)),f}a.decode=e;function t(h,d,f=[]){if(y.isString(h)||y.isBoolean(h)||y.isNumber(h))return h;if(d[""]){let m=s(ye.getBy(d[""]));d=y.merge(d,m)}let p;return y.isArray(f)&&f.length>0?p=c(h,d,f):p=l(h,d),p}a.encode=t;function n(h,d=!1){let f=ye.getFromObject(h);return s(f)}function s(h){if(!y.isFunction(h)||h===Object)return{};let d=ye.getName(h),f=y.isArray(h[Ee.MODELS_MAPPING])?h[Ee.MODELS_MAPPING]:[{"":d}],p={},m=f.filter(x=>!y.isUndefined(x[""])&&x[""]!==d).map(x=>x[""]);return f.reverse().forEach(x=>{x=y.cloneDeep(x),Object.keys(x).forEach(S=>{let G=x[S],D=y.isArray(G),q=D?y.first(G):G;m.includes(q)&&(x[S]=D?[d]:d)}),p=y.merge(p,x)}),p[""]=d,p}a.getModelsMapping=s;function i(h,d,f={}){if(!h||Array.isArray(h)||typeof h!="object")return;let p=Object.getPrototypeOf(h);if(!p)return;let m=ye.getName(p.constructor),x=ye.getBy(m);if(!x){m!=="Object"&&lt.isBrowser&&console.error(`Cannot resolve class "${m}" while mapping.`);return}f[d]||(f[d]=ye.getName(x))}function r(h,d="",f={},p=0){if(h!=null){if(Array.isArray(h))return h.forEach(x=>r(x,d,f,p)),f;if(++p!==16){i(h,d,f);for(var m in h)if(y.isFunction(h.hasOwnProperty)&&h.hasOwnProperty(m)){let x=h[m];if(Array.isArray(x)&&x.length>0)x.forEach((S,G)=>{let D=[d,m].filter(q=>q.trim()!="").join(".");r(S,D,f,p)});else if(typeof x=="object"){let S=[d,m].filter(G=>G.trim()!="").join(".");i(x,S,f),r(x,S,f,p)}}return f}}}function o(h){if(!y.isString(h))return;let d=/\[([0-9a-zA-Z]|\'|\")*\]/g;return h=h.replace(d,"").replace("..","."),h.startsWith(".")&&(h=h.slice(1)),h}function c(h,d={},f=[]){let p=!y.isArray(h)&&ye.getBy(d[""]);return Gt.Object(h,(m,x,S)=>{if(!y.isUndefined(m)&&!y.isNull(m)){let G=o(x);if(!y.isUndefined(d[G])){let D=y.isArray(d[G]);if(!D){let q=D?y.first(d[G]):d[G],J=ye.getBy(q);y.isFunction(J)&&S(y.merge(new J,m))}}}}),f.forEach(m=>{let x=y.get(h,m.circuralTargetPath);y.set(h,m.pathToObj,x)}),y.isFunction(p)&&(h=y.merge(new p,h)),h}function l(h,d={}){if(Array.isArray(h))return h.map(p=>l(p,d));let f=ye.getBy(d[""]);for(let p in h)if(h.hasOwnProperty(p)){if(y.isArray(h[p]))h[p]=h[p].map(m=>{let x=s(ye.getBy(d[p]));return l(m,x)});else if(y.isObject(h[p])){let m=s(ye.getBy(d[p]));h[p]=l(h[p],m)}}return Object.keys(d).filter(p=>p!==""&&p.split(".").length>=2).forEach(p=>{let m=s(ye.getBy(d[p])),x=y.get(h,p);if(!y.isUndefined(x)){let S=l(x,m);y.set(h,p,S)}}),f?y.merge(new f,h):h}function u(h,d){return function(f){if(y.isArray(f[Ee.MODELS_MAPPING])||(f[Ee.MODELS_MAPPING]=[]),f[Ee.MODELS_MAPPING].push({"":ye.getName(f)}),y.isObject(d)&&(f[Ee.MODELS_MAPPING]=f[Ee.MODELS_MAPPING].concat(d),Object.keys(d).forEach(p=>{let m=d;if(y.isUndefined(m)||y.isFunction(m))throw`


            Class: '${f.name}'
[ng2rest] Bad mapping value for path: ${p} , please use type: <string> or [<string>]
`})),y.isObject(h)){let p={};ye.describeProperites(f).filter(S=>/^([a-zA-Z0-9]|\_|\#)+$/.test(S)).forEach(S=>{h[S]?console.warn(`

            CONFLICT: default value for property: "${S}"
            in class "${f.name}" already defined as typescript
            default class proprty value.

            `):p[S]=null}),f[Ee.DEFAULT_MODEL]=y.merge(p,h);let x=Object.keys(f[Ee.DEFAULT_MODEL]).filter(S=>!!Object.getOwnPropertyDescriptor(f.prototype,S));y.merge(f.prototype,y.omit(f[Ee.DEFAULT_MODEL],x))}}}a.DefaultModelWithMapping=u})(Nt||(Nt={}));var hf=tc.create("[ng2-rest] params",te.__NOTHING);function ic(a){return new RegExp("/:[a-zA-Z]*","g").test(a.replace("://",""))}function rc(a){return a.match(new RegExp("[a-z-A-Z]*/:","g")).map(t=>t.replace("/:",""))}function Hl(a){return a.charAt(a.length-1)!=="/"&&(a=`${a}/`),a.match(new RegExp(":[a-zA-Z]*/","g")).map(n=>n.replace(":","").replace("/","")).filter(n=>n.trim()!=="")}function ac(a,e){return a.charAt(0)!=="/"&&(a="/"+a),e.filter(n=>{let s="/"+n,i=a.indexOf(s);return i+s.length<a.length&&a.charAt(i+s.length)!=="/"?!1:i!==-1?(a=a.replace(new RegExp("/"+n,"g"),""),!0):!1}).length===e.length}function Kl(a){let e="";for(let t=0;t<a;t++)e+="*";return e}function oc(a,e){let t={},n=Hl(e);n.forEach(i=>{e=e.replace(`:${i}`,Kl(i.length))});let s;return(0,sc.diffChars)(e,a).forEach(i=>{i.added&&(isNaN(Number(i.value))?i.value.trim()==="true"?t[s]=!0:i.value.trim()==="false"?t[s]=!1:t[s]=decodeURIComponent(i.value):t[s]=Number(i.value),s=void 0);let r=i.value.replace(":","");i.removed&&(s=n.shift())}),t}var cc=/[^\..]+(\.[^\..]+)+/g;function Xn(a,e,t){if(e.length===0)return t.join("/");let n=e.pop(),s=n.match(/:[a-zA-Z0-9\.]+/)[0].replace(":",""),i=cc.test(s),r=n.match(/[a-zA-Z0-9]+\//)[0].replace("/","");if(a===void 0||(i?y.get(a,s)===void 0:a[s]===void 0)||s==="undefined")return t.length=0,t.unshift(r),Xn(a,e,t);if(i){let o=n.replace(new RegExp(`:${s}`,"g"),`${y.get(a,s)}`);return t.unshift(o),Xn(a,e,t)}else{let o=n.replace(new RegExp(`:${s}`,"g"),`${a[s]}`);return t.unshift(o),Xn(a,e,t)}}function lc(a,e){let t=/\[\[([^\..]+\.[^\..]+)+\]\]/g;e=e.split("/").map(l=>{if(l.startsWith(":")){let h=l.slice(1);return t.test(h)&&(h=h.replace("[[",""),h=h.replace("]]","")),`:${h}`}return l}).join("/");let n={start:e.charAt(0)==="/",end:e.charAt(e.length-1)==="/"},s=e.match(/(\/:[a-zA-Z0-9\.]+){2,10}/g);if(s&&Array.isArray(s)&&s.length===1)return s[0].match(/\/:[a-zA-Z0-9\.]+/g).forEach(h=>{let d=h.replace("/:","");cc.test(d)?e=e.replace(h,`/${y.get(a,d)}`):e=e.replace(h,`/${a[d]}`)}),e;let i=e.match(/[a-zA-Z0-9]+\/:[a-zA-Z0-9\.]+/g);if(!i||Array.isArray(i)&&i.length===0)return e;n.end||(e=`${e}/`);let r=!/:[a-zA-Z0-9\.]+\/$/g.test(e)&&/[a-zA-Z0-9]+\/$/g.test(e),o=(i.length>1?i.join("/"):i[0])+(r?"/"+e.match(/[a-zA-Z0-9]+\/$/g)[0]:"/"),c=e.replace(o,"");return r?(e=e.replace(/\/$/g,"/:undefined"),i=e.match(/[a-zA-Z0-9]+\/:[a-zA-Z0-9\.]+/g),e=Xn(a,i,[])):e=Xn(a,i,[]),e=c+e,e.charAt(e.length-1)!=="/"&&n.end&&(e=`${e}/`),e.charAt(0)!=="/"&&n.start&&(e=`/${e}`),e}function uc(a,e=!1){let t=[];return!a||!(a instanceof Array)||a.length===0||(a.forEach(s=>{if(JSON.stringify(s)!=="{}"){let i=[],r=s;for(let o in r)if(r[o]===void 0&&delete r[o],r.hasOwnProperty(o)&&typeof o=="string"&&o!=="regex"&&!(r[o]instanceof RegExp)){if(o.length>0&&o[0]==="/"){let l=o.slice(1,o.length-1);s[l]=s[o],s[o]=void 0,o=l}if(o.length>0&&o[o.length-1]==="/"){let l=o.slice(0,o.length-2);s[l]=s[o],s[o]=void 0,o=l}s[o]instanceof Object&&(s[o]=JSON.stringify(s[o])),s[o]=e?s[o]:encodeURIComponent(s[o]),s.regex!==void 0&&s.regex instanceof RegExp&&(s.regex.test(s[o])||console.warn(`Data: ${s[o]} incostistent with regex ${s.regex.source}`)),i.push(`${o}=${s[o]}`)}t.push(i.join("&"))}}),t.join().trim().trim()==="")?"":`?${t.join("&")}`}var Qs=class{handle(e){return Hn(It.request(e))}},hc=(a,e)=>a.reduceRight((t,n)=>({handle:s=>n.intercept({req:s,next:t})}),e);var Rr=class{};var xr=class extends Rr{},st;(function(a){a.MethodConfig=Et.MethodConfig,a.ClassConfig=Et.ClassConfig,a.ParamConfig=Et.ParamConfig;class e{toJSON(o,c){c=c||{isJSONArray:!1};let l=c.isJSONArray?[]:{};if(typeof o=="string")try{let u=JSON.parse(o);return typeof u=="string"&&u.trim().startsWith("{")&&(u=JSON.parse(u)),c.parsingError&&u[ln.TaonHttpErrorCustomProp]?y.merge(new xr,u):u}catch{}else if(typeof o=="object")return o;return l}}a.BaseBody=e;class t extends e{constructor(o,c=!1,l,u){super(),this.responseText=o,this.isArray=c,this.entity=l,this.circular=u}get blob(){return this.responseText}get booleanValue(){if(!F.isBlob(this.responseText))return["ok","true"].includes(this.responseText?.trim())}get numericValue(){if(!F.isBlob(this.responseText))return Number(this.responseText?.trim())}get rawJson(){if(!F.isBlob(this.responseText)){let o=this.toJSON(this.responseText,{isJSONArray:this.isArray});return this.circular&&Array.isArray(this.circular)&&(o=Ze.parse(JSON.stringify(o),this.circular)),o}}get json(){if(F.isBlob(this.responseText))return;if(this.entity&&typeof this.entity=="function")return this.entity();if(this.entity&&typeof this.entity=="object"){let l=this.toJSON(this.responseText,{isJSONArray:this.isArray});return Nt.encode(l,this.entity,this.circular)}let c=this.toJSON(this.responseText,{isJSONArray:this.isArray});return this.circular&&Array.isArray(this.circular)&&(c=Ze.parse(JSON.stringify(c),this.circular)),c}get text(){if(!F.isBlob(this.responseText))return this.responseText.replace(/^\"/,"").replace(/\"$/,"")}}a.HttpBody=t;class n extends e{constructor(o){super(),this.data=o}get json(){return this.toJSON(this.data,{parsingError:!0})}get text(){return this.data}}a.ErrorBody=n;class s{static{this.cookies=un.Instance}get cookies(){return s.cookies}constructor(o,c,l,u=!1){this.responseText=o,this.headers=c,this.statusCode=l,this.isArray=u}}a.BaseResponse=s;class i extends s{constructor(o,c,l,u,h,d,f,p=!1){super(c,l,u,p),this.sourceRequest=o,this.responseText=c,this.headers=l,this.statusCode=u,this.entity=h,this.circular=d,this.jobid=f,this.isArray=p,this.init()}init(){if(typeof this.entity=="string"){let o=this.headers?.getAll(this.entity);o&&(this.entity=JSON.parse(o.join()))}if(typeof this.circular=="string"){let o=this.headers?.getAll(this.circular);o&&(this.circular=JSON.parse(o.join()))}this.body=new t(this.responseText,this.isArray,this.entity,this.circular)}}a.HttpResponse=i})(st||(st={}));var Gs=class extends st.BaseResponse{constructor(e,t,n,s,i,r){super(t,n,s),this.message=e,this.jobid=i,this.sourceRequest=r,this.body=new st.ErrorBody(t)}};var Se=class a{static from(e){if(e)return new a(e)}constructor(e){this._headers=new Map,this._normalizedNames=new Map,e instanceof a?e.forEach((t,n)=>{t.forEach(s=>this.set(n,s))}):Object.keys(e).forEach(t=>{let n=Array.isArray(e[t])?e[t]:[e[t]];this.delete(t),n.forEach(s=>this.set(t,s))})}static fromResponseHeaderString(e){let t=new a;return e.split(`
`).forEach(n=>{let s=n.indexOf(":");if(s>0){let i=n.slice(0,s),r=n.slice(s+1).trim();t.set(i,r)}}),t}append(e,t){let n=this.getAll(e);n===null?this.set(e,t):n.push(t)}delete(e){let t=e.toLowerCase();this._normalizedNames.delete(t),this._headers.delete(t)}forEach(e){this._headers.forEach((t,n)=>e(t,this._normalizedNames.get(n),this._headers))}get(e){let t=this.getAll(e);return t===null?null:t.length>0?t[0]:null}has(e){return this._headers.has(e.toLowerCase())}keys(){return Array.from(this._normalizedNames.values())}set(e,t){Array.isArray(t)?t.length&&this._headers.set(e.toLowerCase(),[t.join(",")]):this._headers.set(e.toLowerCase(),[t]),this.mayBeSetNormalizedName(e)}values(){return Array.from(this._headers.values())}toJSON(){let e={};return this._headers,this._headers.forEach((t,n)=>{let s=[];t.forEach(i=>s.push(...i.split(","))),e[this._normalizedNames.get(n)]=s}),e}getAll(e){return this.has(e)?this._headers.get(e.toLowerCase()):null}mayBeSetNormalizedName(e){let t=e.toLowerCase();this._normalizedNames.has(t)||this._normalizedNames.set(t,e)}};var Yl="jobID",es="customObs",Sr="cancelFn",Js="isCanceled",dc=(()=>{class a{constructor(){this.subjectInuUse={},this.meta={},this.interceptors=new Map,this.methodsInterceptors=new Map,this.replaySubjects={}}static{this.jobId=0}handlerResult(t,n){y.isUndefined(t)&&(t={});let{res:s,jobid:i,isArray:r,method:o}=t;if(typeof s!="object")throw new Error("No resposnse for request. ");if(F.isBrowser&&(s.headers=Se.from(s.headers)),s.error){this.subjectInuUse[i].error(new Gs(s.error,s.data,s.headers,s.code,i,n));return}let c=this.meta[i].entity,l=this.meta[i].circular,u=Ge._listenSuccess,h=new st.HttpResponse(n,s.data,s.headers,s.code,c,l,i,r);u.next(h),this.subjectInuUse[i].next(h),this.meta[i]=void 0,this.subjectInuUse[i].complete()}async req(t,n,s,i,r,o=!1,c,l){let h=It.CancelToken.source();this.subjectInuUse[r][Sr]=h.cancel;var d;if(c){if(typeof c=="object")d={data:c.data,status:c.code,headers:c.headers,statusText:c.error,config:{}};else if(typeof c=="function"){let S=c(t,n,s,i);d={data:S.data,status:S.code,headers:S.headers,statusText:S.error,config:{}}}}let f=ye.getNameFromObject(i)==="FormData",p=f?i:void 0,m=s.toJSON(),x=m.responsetypeaxios?m.responsetypeaxios:"text";try{if(!d){let S=oe({url:t,method:n,data:i,responseType:x,headers:m,cancelToken:h.token},l||{});f&&(S.maxBodyLength=1/0);let G=new URL(t),D=new Qs,q=Array.from(this.interceptors.entries()).map(([ue,de])=>de),J=Array.from(this.methodsInterceptors.entries()).filter(([ue])=>{let de=`-${n?.toUpperCase()}-${G.pathname}`;return ue.endsWith(de)}).map(([ue,de])=>de),re=[...q,...J],le=hc(re,D);d=await Bs(le.handle(S))}if(this.subjectInuUse[r][Js])return;this.handlerResult({res:{code:d.status,data:d.data,isArray:o,jobid:r,headers:Se.from(d.headers)},method:n,jobid:r,isArray:o},{url:t,body:i,method:n,isArray:o})}catch(S){if(this.subjectInuUse[r][Js])return;if(typeof S=="object"&&S.response&&S.response.data){let D=S.response.data,q=S.response.data.message||"",J=(D.stack||"").split(`
`);Ge._listenErrors.next({msg:q,stack:J,data:S.response.data})}let G=S&&S.response?`[${S.response.statusText}]: `:"";this.handlerResult({res:{code:S&&S.response?S.response.status:void 0,error:`${G}${S.message}`,data:S&&S.response?JSON.stringify(S.response.data):void 0,isArray:o,jobid:r,headers:Se.from(S&&S.response&&S.response.headers)},method:n,jobid:r,isArray:o},{url:t,body:i,isArray:o,method:n})}}getReplay(t,n,s){let i;y.isUndefined(this.replaySubjects[n.endpoint])&&(this.replaySubjects[n.endpoint]={}),y.isUndefined(this.replaySubjects[n.endpoint][n.path])&&(this.replaySubjects[n.endpoint][n.path]={}),y.isUndefined(this.replaySubjects[n.endpoint][n.path][t])&&(this.replaySubjects[n.endpoint][n.path][t]={});let r=Object.keys(this.replaySubjects[n.endpoint][n.path][t]).length+(s?0:1);if(s&&r===0)return i;if(y.isUndefined(this.replaySubjects[n.endpoint][n.path][t][r])&&(this.replaySubjects[n.endpoint][n.path][t][r]={subject:new Oe,data:void 0}),i=this.replaySubjects[n.endpoint][n.path][t][r],!y.isNumber(i.id)){a.jobId===Number.MAX_SAFE_INTEGER&&(a.jobId=0);let o=a.jobId++;i.id=o;let c=i.subject;c[Yl]=o,this.meta[o]=n,this.subjectInuUse[o]=c,this.subjectInuUse[o][es]=new zn(l=>{l.add(()=>{this.subjectInuUse[o][Js]||(this.subjectInuUse[o][Js]=!0,typeof this.subjectInuUse[o][Sr]=="function"&&this.subjectInuUse[o][Sr]("[ng2-rest] on purpose canceled http request"))});let u=c.subscribe({next:h=>l.next(h),error:h=>l.error(h),complete:()=>{setTimeout(()=>{u.unsubscribe(),l.complete()})}})})}return i}generalReq(t,n,s,i,r,o,c,l){let u=this.getReplay(t,r,!1);u.data={url:n,body:s,headers:i,isArray:o},((d,f,p,m,x,S,G,D,q)=>{setTimeout(()=>d.req(f,p,m,x,S,G,D,q))})(this,n,t,i,s,u.id,o,c,l);let h=Bs(u.subject[es]);return h.observable=u.subject[es],h}get(t,n,s,i,r,o,c){return this.generalReq("get",t,n,s,i,r,o,c)}head(t,n,s,i,r,o,c){return this.generalReq("head",t,n,s,i,r,o,c)}delete(t,n,s,i,r,o,c){return this.generalReq("delete",t,n,s,i,r,o,c)}post(t,n,s,i,r,o,c){return this.generalReq("post",t,n,s,i,r,o,c)}put(t,n,s,i,r,o,c){return this.generalReq("put",t,n,s,i,r,o,c)}patch(t,n,s,i,r,o,c){return this.generalReq("patch",t,n,s,i,r,o,c)}jsonp(t,n,s,i,r,o,c){let l="jsonp";if(lt.isSSRMode){let f=Promise.resolve();return f.observable=new zn,console.warn("Cannot perform jsonp request in SSR mode"),f}let u=this.getReplay("jsonp",i,!1),h=u.id;setTimeout(()=>{t.endsWith("/")&&(t=t.slice(0,t.length-1));let p="cb_"+Math.round(1e4*Math.random()),m=globalThis;m[p]=S=>{this.handlerResult({res:{data:S,isArray:r},method:l,jobid:h,isArray:r},{url:t,body:n,isArray:r,method:l})};let x=document.createElement("script");x.src=`${t}?callback=${p}`,document.body.appendChild(x),document.body.removeChild(x)});let d=Bs(u.subject[es]);return d.observable=u.subject[es],d}}return a})();var Mr={APPLICATION_JSON:Se.from({"Content-Type":"application/json",Accept:"application/json"}),APPLICATINO_VND_API_JSON:Se.from({"Content-Type":"application/vnd.api+json",Accept:"application/vnd.api+json"})};var zs=class{mock(e){if(typeof e=="function"||typeof e=="object")this.mockHttp=e;else throw`[ng2-rest]
      .model(...)
      .mock( < BAD MOCK DATA > )
      ...
      `;return this}get endpoint(){let e=this.__meta_endpoint;return this.restQueryParams!==void 0&&this._endpointRest!==void 0&&typeof this._endpointRest=="string"&&this._endpointRest.trim()!==""&&(e=this._endpointRest),e}set __rest_endpoint(e){this._endpointRest=e,e===void 0?this.restQueryParams=void 0:this.restQueryParams=oc(e,this.__meta_endpoint)}creatUrl(e,t=!1){return`${this.endpoint}${uc(e,t)}`}get headers(){return this._headers}constructor(e,t,n,s){this.request=t,this.meta=n,this.customContentType=s,this._headers=Se.from(Mr.APPLICATION_JSON),this.array={get:(i,r=void 0,o)=>this.req("get",i,r,o,!0),head:(i,r=void 0,o)=>this.req("head",i,r,o,!0),post:(i,r,o)=>this.req("post",i,r,o,!0),put:(i,r,o)=>this.req("put",i,r,o,!0),patch:(i,r,o)=>this.req("patch",i,r,o,!0),delete:(i,r,o)=>this.req("delete",i,r,o,!0),jsonp:(i,r,o)=>this.req("jsonp",i,r,o,!0)},this.__meta_endpoint=e}req(e,t,n,s,i=!1){s=s||{};let r=this.creatUrl(n,!!s.doNotSerializeParams),c=ye.getNameFromObject(t)==="FormData"?t:t?JSON.stringify(t):void 0;if(this.customContentType){let u=this.customContentType.keys();this._headers.keys().filter(d=>!u.includes(d)).forEach(d=>{this.customContentType.set(d,this._headers.get(d))}),this._headers=this.customContentType}else this._headers=Se.from(Mr.APPLICATION_JSON);let l=this.request[e.toLowerCase()](r,c,this.headers,this.meta,i,this.mockHttp,s);return this.mockHttp=void 0,l}get(e,t,n){return this.req("get",e,t,n)}head(e,t,n){return this.req("head",e,t,n)}post(e,t,n){return this.req("post",e,t,n)}put(e,t,n){return this.req("put",e,t,n)}patch(e,t,n){return this.req("patch",e,t,n)}delete(e,t,n){return this.req("delete",e,t,n)}jsonp(e,t,n){return this.req("jsonp",e,t,n)}};var Ge=class a{static{this._listenErrors=new Oe}static{this._listenSuccess=new Oe}static get listenErrors(){return this._listenErrors.asObservable()}static get listenSuccessOperations(){return this._listenSuccess.asObservable()}static{this.enableWarnings=!0}checkNestedModels(e,t){for(let n in t)if(t.hasOwnProperty(n)){let s=t[n];if(ic(n)){let i=rc(n);if(ac(e,i)){e=n;break}}}return e}static{this.instance=new a}static{this.endpoints={}}static getModel(e,t){if(t=a.prepareModel(t),!a.endpoints[e])return;let s=a.endpoints[e].models[t];return a.endpoints[e].models[t]}static{this.request=new dc}static create(e,t,n,s,i){let r=new RegExp("((/:)[a-z]+)+","g"),c=(t.match(r)||[]).join();if((c.match(new RegExp(":","g"))||[]).length>=2&&t.search(c)!==-1)throw new Error(`

Bad rest model: ${t}

Do not create rest models like this:    /book/author/:bookid/:authorid
Instead use nested approach:            /book/:bookid/author/:authorid
            `);return a.map(e,e),a.instance.add(e,t||"",n,s,i),{model:u=>a.instance.api(e,lc(u,t)),get headers(){return a.getModel(e,t).headers}}}static reset(){a.endpoints={}}constructor(){}static{this.Cookies=un.Instance}static map(e,t){let n=/(http|https):\/\/(\w+:{0,1}\w*)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&%!\-\/]))?/,s=e;if(!n.test(t))throw`Url address is not correct: ${t}`;return t.charAt(t.length-1)==="/"&&(t=t.slice(0,t.length-1)),a.endpoints[s]!==void 0?!1:(a.endpoints[s]={url:t,models:{},entity:null},!0)}static prepareModel(e){return e.charAt(e.length-1)==="/"&&(e=e.slice(0,e.length-1)),e.charAt(0)==="/"&&(e=e.slice(1,e.length)),e}add(e,t,n,s,i){t=a.prepareModel(t);let r;if(r=e.toString(),a.endpoints[r]===void 0){console.error("Endpoint is not mapped ! Cannot add model "+t);return}if(a.endpoints[r].models[t]!==void 0){a.enableWarnings&&console.warn(`Model '${t}' is already defined in endpoint: `+a.endpoints[r].url);return}a.endpoints[r].models[t]=new zs(a.endpoints[r].url+"/"+t,a.request,{endpoint:r,path:t,entity:n,circular:s},i)}api(e,t){t.charAt(0)==="/"&&(t=t.slice(1,t.length));let n=e.toString();if(a.endpoints[n]===void 0)throw`Endpoint: ${e} is not mapped ! Cannot add model: ${t}`;let s=a.endpoints[n].models,i=t;if(t=this.checkNestedModels(t,s),a.endpoints[n].models[t]===void 0)throw`Model '${t}' is undefined in endpoint: ${a.endpoints[n].url} `;let r=a.endpoints[e.toString()].models[t];if(i!==t){let o=a.endpoints[e.toString()].url;r.__rest_endpoint=`${o}/${i}`}else r.__rest_endpoint=void 0;return r}};var Tc=wt(Ul(),1),H=wt(Vl(),1),Kf=wt(Wl(),1),Yf=wt(Ql(),1),Zf=wt(Go(),1);var Cc=!1;Cc=!0;var Zl="",Xl=Zl,eu=Cc?"taon":Xl,Ys={black(a){console.log(a)},gray(a){console.log(a)},red(a){console.log(a)},green(a){console.log(a)},italic(a){console.log(a)},magenta(a){console.log(a)},bold(a){console.log(a)},underline(a){console.log(a)}},Nc=new Map,Hs=Object.keys(Ys).map(a=>(Nc.set(Ys[a],a),Ys[a]));for(let a=0;a<Hs.length;a++){let e=Hs[a];for(let t=0;t<Hs.length;t++){let n=Hs[t];e[Nc.get(n)]=n}}var tu=Ys;function vt(a){if(typeof a!="string")throw new TypeError("[taon-core] Path must be a string. Received "+JSON.stringify(a))}function nu(a,e){for(var t="",n=0,s=-1,i=0,r,o=0;o<=a.length;++o){if(o<a.length)r=a.charCodeAt(o);else{if(r===47)break;r=47}if(r===47){if(!(s===o-1||i===1))if(s!==o-1&&i===2){if(t.length<2||n!==2||t.charCodeAt(t.length-1)!==46||t.charCodeAt(t.length-2)!==46){if(t.length>2){var c=t.lastIndexOf("/");if(c!==t.length-1){c===-1?(t="",n=0):(t=t.slice(0,c),n=t.length-1-t.lastIndexOf("/")),s=o,i=0;continue}}else if(t.length===2||t.length===1){t="",n=0,s=o,i=0;continue}}e&&(t.length>0?t+="/..":t="..",n=2)}else t.length>0?t+="/"+a.slice(s+1,o):t=a.slice(s+1,o),n=o-s-1;s=o,i=0}else r===46&&i!==-1?++i:i=-1}return t}function su(a,e){var t=e.dir||e.root,n=e.base||(e.name||"")+(e.ext||"");return t?t===e.root?t+n:t+a+n:n}var Zs={resolve:function(e){return e},normalize:function(e){if(vt(e),e.length===0)return".";var t=e.charCodeAt(0)===47,n=e.charCodeAt(e.length-1)===47;return e=nu(e,!t),e.length===0&&!t&&(e="."),e.length>0&&n&&(e+="/"),t?"/"+e:e},isAbsolute:function(e){return vt(e),e.length>0&&e.charCodeAt(0)===47},join:function(){if(arguments.length===0)return".";for(var e,t=0;t<arguments.length;++t){var n=arguments[t];vt(n),n.length>0&&(e===void 0?e=n:e+="/"+n)}return e===void 0?".":Zs.normalize(e)},relative:function(e,t){if(vt(e),vt(t),e===t||(e=Zs.resolve(e),t=Zs.resolve(t),e===t))return"";for(var n=1;n<e.length&&e.charCodeAt(n)===47;++n);for(var s=e.length,i=s-n,r=1;r<t.length&&t.charCodeAt(r)===47;++r);for(var o=t.length,c=o-r,l=i<c?i:c,u=-1,h=0;h<=l;++h){if(h===l){if(c>l){if(t.charCodeAt(r+h)===47)return t.slice(r+h+1);if(h===0)return t.slice(r+h)}else i>l&&(e.charCodeAt(n+h)===47?u=h:h===0&&(u=0));break}var d=e.charCodeAt(n+h),f=t.charCodeAt(r+h);if(d!==f)break;d===47&&(u=h)}var p="";for(h=n+u+1;h<=s;++h)(h===s||e.charCodeAt(h)===47)&&(p.length===0?p+="..":p+="/..");return p.length>0?p+t.slice(r+u):(r+=u,t.charCodeAt(r)===47&&++r,t.slice(r))},_makeLong:function(e){return e},dirname:function(e){if(vt(e),e.length===0)return".";for(var t=e.charCodeAt(0),n=t===47,s=-1,i=!0,r=e.length-1;r>=1;--r)if(t=e.charCodeAt(r),t===47){if(!i){s=r;break}}else i=!1;return s===-1?n?"/":".":n&&s===1?"//":e.slice(0,s)},basename:function(e,t){if(t!==void 0&&typeof t!="string")throw new TypeError('"ext" argument must be a string');vt(e);var n=0,s=-1,i=!0,r;if(t!==void 0&&t.length>0&&t.length<=e.length){if(t.length===e.length&&t===e)return"";var o=t.length-1,c=-1;for(r=e.length-1;r>=0;--r){var l=e.charCodeAt(r);if(l===47){if(!i){n=r+1;break}}else c===-1&&(i=!1,c=r+1),o>=0&&(l===t.charCodeAt(o)?--o===-1&&(s=r):(o=-1,s=c))}return n===s?s=c:s===-1&&(s=e.length),e.slice(n,s)}else{for(r=e.length-1;r>=0;--r)if(e.charCodeAt(r)===47){if(!i){n=r+1;break}}else s===-1&&(i=!1,s=r+1);return s===-1?"":e.slice(n,s)}},extname:function(e){vt(e);for(var t=-1,n=0,s=-1,i=!0,r=0,o=e.length-1;o>=0;--o){var c=e.charCodeAt(o);if(c===47){if(!i){n=o+1;break}continue}s===-1&&(i=!1,s=o+1),c===46?t===-1?t=o:r!==1&&(r=1):t!==-1&&(r=-1)}return t===-1||s===-1||r===0||r===1&&t===s-1&&t===n+1?"":e.slice(t,s)},format:function(e){if(e===null||typeof e!="object")throw new TypeError('The "pathObject" argument must be of type Object. Received type '+typeof e);return su("/",e)},parse:function(e){vt(e);var t={root:"",dir:"",base:"",ext:"",name:""};if(e.length===0)return t;var n=e.charCodeAt(0),s=n===47,i;s?(t.root="/",i=1):i=0;for(var r=-1,o=0,c=-1,l=!0,u=e.length-1,h=0;u>=i;--u){if(n=e.charCodeAt(u),n===47){if(!l){o=u+1;break}continue}c===-1&&(l=!1,c=u+1),n===46?r===-1?r=u:h!==1&&(h=1):r!==-1&&(h=-1)}return r===-1||c===-1||h===0||h===1&&r===c-1&&r===o+1?c!==-1&&(o===0&&s?t.base=t.name=e.slice(1,c):t.base=t.name=e.slice(o,c)):(o===0&&s?(t.name=e.slice(1,r),t.base=e.slice(1,c)):(t.name=e.slice(o,r),t.base=e.slice(o,c)),t.ext=e.slice(r,c)),o>0?t.dir=e.slice(0,o-1):s&&(t.dir="/"),t},sep:"/",delimiter:":",win32:{normalize:a=>a},posix:null},iu=!1,ru;ru=Tc.default;var dt;dt=Zs;var au;au=tu;var ou;var dn=a=>{if(Array.isArray(a)&&(a=a.join("/")),typeof a!="string")return a;typeof a=="string"&&/^[A-Z]\:/.test(a)&&(a=H.lowerFirst(a));let e=/^\\\\\?\\/.test(a),t=/[^\u0000-\u0080]+/.test(a);if(e&&(console.warn(`[taon-core][crossPlatformPath]: Path starts with \\\\,
    this is not supported in crossPlatformPath`),iu&&console.trace(`path: "${a}"`)),t){let i=a.match(/[^\u0000-\u0080]+/g)||"";ae.logWarn(`[taon-core][crossPlatformPath]: path below contains non-ascii characters (${i}):
"${a}"`),ae.logWarn(a)}return a=(a||"").replace(/\\/g,"/").replace(/\/\//g,"/").replace(/\/\//g,"/"),!1&&/^(\/)[a-zA-Z]\:/.test(a)&&(a=a.slice(1)),a},Rt;(function(a){a.InstalationTypeArr=["-g","--save","--save-dev"];let e;(function(t){t.MAJOR="major",t.MINOR="minor",t.PATCH="patch"})(e=a.ReleaseVersionTypeEnum||(a.ReleaseVersionTypeEnum={})),a.NpmSpecialVersions=["latest","next","beta","alpha","rc","lts"],a.EnvironmentName=Object.freeze({__:"__",LOCALHOST:"localhost",DEV:"dev",STAGE:"stage",PROD:"prod",TEST:"test",QA:"qa",SANDBOX:"sandbox",UAT:"uat",PREPROD:"preprod",DEMO:"demo",DOCS:"docs",STATIC_PAGES:"static-pages",CI:"ci",TRAINING:"training"}),a.ImageFileExtensionArr=["jpg","jpeg","png","svg"],a.BaseProjectTypeArr=["typescript","angular","angular-lib","unknown","unknown-npm-project"],a.mimeTypes={".aac":"audio/aac",".abw":"application/x-abiword",".arc":"application/x-freearc",".avi":"video/x-msvideo",".azw":"application/vnd.amazon.ebook",".bin":"application/octet-stream",".bmp":"image/bmp",".bz":"application/x-bzip",".bz2":"application/x-bzip2",".csh":"application/x-csh",".css":"text/css",".csv":"text/csv",".doc":"application/msword",".docx":"application/vnd.openxmlformats-officedocument.wordprocessingml.document",".eot":"application/vnd.ms-fontobject",".epub":"application/epub+zip",".gz":"application/gzip",".gif":"image/gif",".htm":"text/html",".html":"text/html",".ico":"image/vnd.microsoft.icon",".ics":"text/calendar",".jar":"application/java-archive",".jpeg":"image/jpeg",".jpg":"image/jpeg",".js":"text/javascript",".json":"application/json",".jsonld":"application/ld+json",".mid":"application/midi",".midi":"application/midi",".mjs":"text/javascript",".mp3":"audio/mpeg",".mp4":"video/mp4",".mpeg":"video/mpeg",".mpkg":"application/vnd.apple.installer+xml",".odp":"application/vnd.oasis.opendocument.presentation",".ods":"application/vnd.oasis.opendocument.spreadsheet",".odt":"application/vnd.oasis.opendocument.text",".oga":"audio/ogg",".ogg":"audio/ogg",".ogv":"video/ogg",".ogx":"application/ogg",".opus":"audio/opus",".otf":"font/otf",".png":"image/png",".pdf":"application/pdf",".php":"application/php",".ppt":"application/vnd.ms-powerpoint",".pptx":"application/vnd.openxmlformats-officedocument.presentationml.presentation",".rar":"application/vnd.rar",".rtf":"application/rtf",".sh":"application/x-sh",".svg":"image/svg+xml",".swf":"application/x-shockwave-flash",".tar":"application/x-tar",".tif":"image/tiff",".tiff":"image/tiff",".ts":"video/mp2t",".ttf":"font/ttf",".txt":"text/plain",".vsd":"application/vnd.visio",".wav":"audio/wav",".weba":"audio/webm",".webm":"video/webm",".webp":"image/webp",".woff":"font/woff",".woff2":"font/woff2",".xhtml":"application/xhtml+xml",".xls":"application/vnd.ms-excel",".xlsx":"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",".xml":"application/xml",".xul":"application/vnd.mozilla.xul+xml",".zip":"application/zip",".3gp":"video/3gpp",".3g2":"video/3gpp2",".7z":"application/x-7z-compressed"},a.MediaTypeAllArr=["text","image","audio","video","font","application","multipart","message","model"],a.MimeTypesObj=a.mimeTypes,a.tagForTaskName="@updateValueWithPortNumForTaskName",a.OrignalClassKey="$$originalClass$$",a.localhostIp127="127.0.0.1",a.localhostDomain="localhost",a.SPECIAL_WORKER_READY_MESSAGE="$$$ WORKER_READY $$$",a.SPECIAL_APP_READY_MESSAGE="$$$ APP_READY $$$",a.ClassNameStaticProperty="$$className$$",a.TaonHttpErrorCustomProp="$$taonError$$",a.pathToChildren="path-to-children",a.parentLocation="parent-location"})(Rt||(Rt={}));var cu="taon-containers";var lu="taon",uu=".taon",hu=".tnp",tp=`https://github.com/darekf77/${lu}.git`,np=`https://github.com/darekf77/${cu}.git`;var Ar={_gitignore:".gitignore",_npmrc:".npmrc",_npmignore:".npmignore",tslint_json:"tslint.json",_editorconfig:".editorconfig",_angularCli_json:".angular-cli.json",_vscode_launch_json:".vscode/launch.json"},du=oe({_bowerrc:".bowerrc",bower_json:"bower.json",controllers_ts:"controllers.ts",entities_ts:"entities.ts",angular_json:"angular.json",autob_actions_js:"auto-actions.js",local_config_js:"local-config.js",build_config_js:"build-config.js",local_config:"local-config",start_backend_ts:"start.backend.ts",docs_config_jsonc:"docs-config.jsonc",package_json:"package.json",taon_jsonc:"taon.jsonc",firedev_jsonc:"firedev.jsonc",firedev_json:"firedev.json",package_json__tnp_json:"package.json_tnp.json",package_json__tnp_json5:"package.json_tnp.json5",package_json__devDependencies_json:"package.json_devDependencies.json",devDependencies_json:"devDependencies.json",yarn_lock:"yarn.lock",package_lock_json:"package-lock.json",tnpEnvironment_json:"tmp-environment.json",environment:"environment",environment_js:"environment.js",tmp_transaction_pid_txt:"tmp-transaction-pid.txt",manifest_webmanifest:"manifest.webmanifest",public_api_d_ts:"public-api.d.ts",public_api_ts:"public-api.ts",public_api:"public-api",_babelrc:".babelrc",index:"index",index_d_ts:"index.d.ts",index_ts:"index.ts",index_js:"index.js",cli_js:"cli.js",cli_ts:"cli.ts",index_js_map:"index.js.map",db_json:"db.json",db_for_tests_json:"db-for-tests.json",tmpDockerImageId:"tmp-docker-image-id",tmp_recent_json:"recent.json",tsconfig_json:"tsconfig.json",tsconfig_lib_json:"tsconfig.lib.json",README_MD:"README.md",server_key:"server.key",server_cert:"server.cert",server_chain_cert:"server-chain.cert",meta_config_md:"meta-content.md",logo_png:"logo.png",logo_svg:"logo.svg",ric_proj_json:"ric-project.json",linked_projects_json:"linked-projects.json",docker_compose_yml:"docker-compose.yml",compose_yml:"docker-compose.yml"},Ar),vc={vendor:"vendor",docs:"docs",dist:"dist",tmp:"tmp",tmpDistRelease:"tmp-dist-release",tempSrc:"tmp-src",tempSrcDist:"tmp-src-dist",previewDistApp:"dist-app",preview:"preview",browser:"browser",websql:"websql",_browser:".browser",module:"module",backup:"backup",node_modules:"node_modules",local_release:"local_release",client:"client",tnp_tests_context:"tmp-tests-context",tmpPackage:"tmp-package",tmpScenarios:"tmp-scenarios",tmpTestsEnvironments:"tmp-tests-environments",testsEnvironments:"tests-environments"},fu=oe({scripts:"scripts",scenarios:"scenarios",bower:"bower",src:"src",out:"out",app:"app",lib:"lib",tests:"tests",libraries:"libraries",libs:"libs",source:"source",custom:"custom",migrations:"migrations",components:"components",assets:"assets",generated:"generated",apps:"apps",shared:"shared",container:"container",bin:"bin",_bin:".bin",_vscode:".vscode",project:"project",projects:"projects",external:"external",tmpDist:"tmp-dist",tmpFor(a){return`tmp-src-${a}`},targetProjects:{DEFAULT_PATH_GENERATED:"tmp-target-projects/generated",DEFAULT_PATH_ORIGINS:"tmp-target-projects/origins"}},vc),pu=[],Rc=["js","ts","tsx"].map(a=>`.${a}`),Dr=["html"].map(a=>`.${a}`),xc=["scss","sass"].map(a=>`.${a}`),$r=[...xc,...["css","less"].map(a=>`.${a}`)],mu=[...$r,...Dr,...Rc],sp={TS_JS_SCSS_SASS:{START:new RegExp("\\/\\/\\s*\\#region"),END:new RegExp("\\/\\/\\s*\\#endregion"),EXT:[...Rc,...xc]},HTML:{START:new RegExp("\\<\\!\\-\\-\\s*\\#region"),END:new RegExp("\\<\\!\\-\\-\\s*\\#endregion"),EXT:Dr},CSS:{START:new RegExp("\\/\\*\\s*\\#region"),END:new RegExp("\\/\\*\\s*\\#endregion"),EXT:$r}},yu=["backend.ts"].map(a=>`.${a}`),ip=["subscriber.ts","test.ts"].map(a=>`.${a}`),Sc=["browser.ts","component.ts","container.ts","directive.ts","pipe.ts","module.ts","service.ts","store.ts","actions.ts","action.ts","effects.ts","effect.ts","reducers.ts","reducer.ts","selectors.ts","selector.ts","routes.ts","resolver.ts","resolvers.ts","guard.ts","guards.ts","store.ts","spec.ts","e2e.ts","cy.ts","e2e-spec.ts"].map(a=>`.${a}`),rp=["routes.ts"].map(a=>`.${a}`),ap=[...Dr,...$r,...Sc],op=[...mu.map(a=>`app${a}`),...Sc.map(a=>`app${a}`),"app.models.ts","app.env.ts","app.constants.ts","app.hosts.ts","app.electron.ts","app.vscode.ts","app.mobile.ts","app.context.ts","app.worker.ts"];var gu=["copyto","copy","melt","push","pul","soft","pull","app","apps","dist","bundle","libs","lib","src","bin","source","migrations","assets","assets-for","browser","websql","compiled","docs","environments","env","projects","plugins","_"],cp=[...gu,...yu];var Ks=!1,Xs;(function(a){a.wait=c=>new Promise((l,u)=>{setTimeout(()=>{l(void 0)},c*1e3)}),a.waitMilliseconds=c=>new Promise((l,u)=>{setTimeout(()=>{l(void 0)},c)}),a.uniqArray=(c,l)=>{var u={};return c.filter(h=>!!h).filter(function(h){return u.hasOwnProperty(l?h[l]:h)?!1:u[l?h[l]:h]=!0})},a.sortKeys=c=>H.isArray(c)?c.map(a.sortKeys):H.isObject(c)?H.fromPairs(H.keys(c).sort().map(l=>[l,a.sortKeys(c[l])])):c,a.escapeStringForRegEx=(c,l)=>(l=l||{},l?.skipEscapeSlashAndDash?c.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"):c.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"));function e(c){let l=/\u001b\[[0-9;]*m/g;return c.replace(l,"")}a.removeChalkSpecialChars=e,a.fullDateTime=()=>{},a.fullDate=()=>{};let t=[];a.getFreePort=async c=>{};let n=(c,l)=>{},s=c=>{};a.requireUncached=c=>{},a.camelize=(c="")=>(c=c.replace(/\W/g,"").toLowerCase(),c.replace(/(?:^\w|[A-Z]|\b\w)/g,function(l,u){return u==0?l.toLowerCase():l.toUpperCase()}).replace(/\s+/g,""));let i;(function(c){c.Blob="Blob",c.File="File",c.string="string"})(i=a.DbBinaryFormatEnum||(a.DbBinaryFormatEnum={}));let r;(function(c){async function l(E,T){return new Blob([E],{type:T})}c.arrayBufferToBlob=l;async function u(E){return await new Promise((T,O)=>{let k=new FileReader;k.addEventListener("loadend",()=>{T(k.result)}),k.addEventListener("error",O),k.readAsArrayBuffer(E)})}c.blobToArrayBuffer=u;function h(E){return new Promise((T,O)=>{let k=new FileReader;k.onloadend=()=>T(k.result),k.readAsDataURL(E)})}c.blobToBase64=h;async function d(E,T){let O,k;if(!T){let X=/^data:(.+?);base64,(.+)$/.exec(E);if(!X)throw new Error(`[taon-framework][base64toBlob] Not a base64 blob [${E}]`);var[V,me,fe]=X;O=me,k=fe}O=T||O||"",E=T?E:k;let we=1024,Ae=atob(E),$e=Ae.length,yt=Math.ceil($e/we),Vt=new Array(yt);for(let X=0;X<yt;++X){let Ke=X*we,nn=Math.min(Ke+we,$e),Ce=new Array(nn-Ke);for(let Pt=Ke,gt=0;Pt<nn;++gt,++Pt)Ce[gt]=Ae[Pt].charCodeAt(0);Vt[X]=new Uint8Array(Ce)}return new Blob(Vt,{type:O})}c.base64toBlob=d;async function f(E){let T;return T=await(async()=>Ks?await d(E):E)(),T}c.base64toDbBinaryFormat=f;async function p(E){let T;return T=await(async()=>Ks?await h(E):E)(),T}c.dbBinaryFormatToBase64=p;async function m(E){let T;return T=await(async()=>Ks?await D(E):E)(),T}c.textToDbBinaryFormat=m;async function x(E){let T;return T=await(async()=>Ks?await q(E):E)(),T}c.dbBinaryFormatToText=x;async function S(E){return new Blob([new Uint8Array(await E.arrayBuffer())],{type:E.type})}c.fileToBlob=S;async function G(E,T="my-file-name"){return T||(T="nonamefile"+new Date().getTime()),new File([E],T)}c.blobToFile=G;async function D(E,T="text/plain"){return new Blob([E],{type:T})}c.textToBlob=D;async function q(E){return await E.text()}c.blobToText=q;async function J(E,T){let O=dt.extname(T),k=Rt.mimeTypes[O],V=new Blob([E],{type:k});return await G(V,T)}c.textToFile=J;async function re(E){return await E.text()}c.fileToText=re;async function le(E){return new Blob([JSON.stringify(E,null,2)],{type:"application/json"})}c.jsonToBlob=le;async function ue(E){return JSON.parse(await E.text())}c.blobToJson=ue;async function de(E){return(await It({url:E,method:"get",responseType:"blob"})).data}c.getBlobFrom=de})(r=a.binary||(a.binary={}));let o;(function(c){function l(u){return parseInt(u?.toString()?.replace("px",""))}c.numValue=l})(o=a.css||(a.css={}))})(Xs||(Xs={}));var Or;(function(a){a.startAsync=async(s,i,r)=>{},a.startAsyncChildProcessCommandUntil=async(s,i)=>{},a.getGitBashPath=()=>{},a.startInNewTerminalWindow=(s,i)=>{},a.getBashOrShellName=()=>"browser",a.getUsageForPid=async s=>{};async function e(s){}async function t(s){}async function n(s){}a.getChildPidsOnce=n,a.getCurrentProcessAndChildUsage=async()=>{},a.killAllJava=async()=>{},a.killProcess=async s=>{},a.killProcessOnPort=async s=>{if(!s||isNaN(s)||it.isBrowser)return ae.warn(`[UtilsProcess.killProcessOnPort]: Invalid port number: ${s}`),!1},a.killAllOtherNodeProcesses=async()=>{},a.isNodeVersionOk=s=>{if(!globalThis||!globalThis.process||!globalThis.process.version)return!1;s=s||{},s.required=s.required||"18.0.0";let i=globalThis.process.version.replace(/^v/,""),[r,o,c]=i.split(".").map(Number),[l,u,h]=s.required.replace(/^v/,"").split(".").map(Number),d=r>l||r===l&&o>u||r===l&&o===u&&c>=h;if(s?.log&&console.log(d?`\u2705 Node.js version OK (required \u2265 ${s.required}, current ${i})`:`\u274C Node.js version too low (required \u2265 ${s.required}, current ${i})`),s?.throwErrorIfNotOk&&!d)throw new Error(`Node.js version too low (required \u2265 ${s.required}, current ${i})`);return d},a.getPathOfExecutable=async s=>{}})(Or||(Or={}));var fc;(function(a){class e{get maxBuffer(){}get env(){}constructor(n,s,i={}){this.command=n,this.args=s,this.execProcOptions=i,this.stdoutFromCommand="",this.stderrFromCommand=""}async getOutput(n){}async getStdoutWithoutShowingOrThrow(){let{stdout:n}=await this.getOutput();return n}async waitUntilDoneOrThrow(n){}}a.spawnAsync=(t,n)=>{n=n||{},n.cwd=dn(n.cwd||process.cwd());let[s,...i]=t.split(" ");return new e(s,i)},a.spawnAdminSudo=async(t,n)=>{},a.executeUntilEndOrThrow=async({command:t,cwd:n})=>{},a.getStdoutWithoutShowingOrThrow=async({command:t,cwd:n})=>{}})(fc||(fc={}));var pc;(function(a){let e;(function(i){i.NotInstalled="NotInstalled",i.Disabled="Disabled",i.Enabled_ForceNewWindow="Enabled_ForceNewWindow",i.Enabled_Inline="Enabled_Inline",i.Unknown="Unknown"})(e||(e={})),a.isCurrentProcessElevated=async()=>await ou();let t={[e.NotInstalled]:"sudo is not installed",[e.Disabled]:"sudo is disabled",[e.Enabled_ForceNewWindow]:"sudo enabled \u2192 opens new window (ForceNewWindow)",[e.Enabled_Inline]:"sudo enabled \u2192 inline mode (runs in same window)",[e.Unknown]:"sudo present but status unknown"};async function n(){}async function s(){}a.getStatus=s,a.isInProperModeForTaon=async({displayErrorMessage:i=!1})=>{}})(pc||(pc={}));var fn;(function(a){a.IGNORE_FOLDERS_FILES_PATTERNS=["**/node_modules/**","**/.git/**/**",`**/${uu}/**`,`**/${hu}/**`,"**/tmp-*","**/tmp-*/**"],a.readFile=(t,n)=>{},a.writeFile=(t,n,s)=>{};let e=(t,n)=>{};a.getFilesFrom=(t,n)=>{},a.getFoldersFrom=(t,n)=>{}})(fn||(fn={}));var mc;(function(a){a.IGNORE_FOLDERS_FILES_PATTERNS=fn.IGNORE_FOLDERS_FILES_PATTERNS;let e=async(c,l)=>{},t=async(c,l)=>{};async function n(c,l={}){return null}let s=async(c,l)=>{},i=async(c,l,u)=>{},r=async c=>{},o=async c=>{}})(mc||(mc={}));var it;(function(a){a.isRunningInBrowser=()=>!0,a.isRunningInNode=()=>!1,a.isRunningInWebSQL=()=>!0,a.isRunningInSSRMode=()=>typeof globalThis.window>"u",a.isRunningInElectron=()=>!!(typeof process<"u"&&process?.versions?.electron||typeof globalThis<"u"&&globalThis?.process?.type==="renderer"||typeof navigator=="object"&&typeof navigator.userAgent=="string"&&/Electron/i.test(navigator.userAgent)),a.isRunningInVscodeExtension=()=>{},a.isRunningInWsl=()=>!1;let e=()=>{},t=p=>{};a.isRunningInWindowsPowerShell=()=>t(["powershell.exe","pwsh.exe"])!==void 0,a.isRunningInWindowsCmd=()=>t(["cmd.exe"])!==void 0,a.isRunningInDocker=()=>!1,a.isRunningInLinuxGraphicsCapableEnvironment=()=>{},a.isRunningInOsWithGraphicsCapableEnvironment=()=>{},a.isRunningInCliMode=()=>!1,a.isRunningInMochaTest=()=>!1;let n=(p,m)=>{};a.isPortInUse=async(p,m)=>{},a.isDockerAvailable=async()=>{if(a.isBrowser)return!1},a.openFolderInVSCode=p=>{},a.openFolderInFileExplorer=p=>{},a.getRealHomeDir=()=>"",a.isRunningNodeDebugger=()=>!1,a.isNodeVersionOk=Or.isNodeVersionOk,a.isElectron=a.isRunningInElectron(),a.isBrowser=a.isRunningInBrowser(),a.isNode=a.isRunningInNode(),a.isWebSQL=a.isRunningInWebSQL(),a.isVscodeExtension=a.isRunningInVscodeExtension(),a.isSSRMode=a.isRunningInSSRMode();let s=!1;a.isRunningInWindows=s;let i=async p=>{},r=p=>{},o=async p=>{},c=p=>{},l=async p=>{},u=async p=>{},h=p=>{},d=p=>{};a.commandExistsAsync=async p=>{},a.commandExistsSync=p=>a.isRunningInWindows?d(p):h(p),a.pipxPackageExists=p=>{},a.pipxNestedPackageExists=(p,m)=>{};let f=p=>p.replace(/-/g,"_");a.pythonModuleExists=async(p,m="python3")=>{}})(it||(it={}));var ei;(function(a){a.wait=Xs.wait,a.waitMilliseconds=Xs.waitMilliseconds,a.isVerboseModeTaon=()=>{},a.waitForUserAnyKey=async(n,s)=>{},a.getTerminalHeight=()=>{},a.clearConsole=()=>{};let e=n=>{};a.multiselect=async n=>{},a.multiselectActionAndExecute=async(n,s)=>{},a.selectActionAndExecute=async(n,s)=>{},a.select=async n=>{},a.pipeEnterToStdin=()=>{},a.input=async({defaultValue:n,question:s,required:i,validate:r})=>{},a.confirm=async n=>{},a.pressAnyKeyToContinueAsync=n=>{},a.pressAnyKeyToTryAgainErrorOccurred=async n=>{},a.pressAnyKey=n=>{},a.previewLongList=async(n,s="List")=>{},a.previewLongListGitLogLike=async n=>{},a.drawBigText=async(n,s)=>{};let t=async()=>{}})(ei||(ei={}));var ts;(function(a){a.getAtrributiesFromJsonWithComments=(t,n)=>{let s=n.split(`
`),r=t.split(".").reduce((u,h)=>{if(u.length===0)return[h];let d=u[u.length-1];return d.startsWith("['")&&h.endsWith("']")||d.startsWith('["')&&h.endsWith('"]')?u[u.length-1]=[d,h].join("."):u.push(h),u},[]).pop().replace(/^\["(.+)"\]$/,"$1"),o="",c=[],l=[];for(let u of s){let h=u.trim();if(h.startsWith("//"))l.push(h);else if(h.startsWith('"')||h.startsWith("'")){let d=h.match(/["']([^"']+)["']\s*:/);if(d){let f=d[1];if(o=o?`${o}.${f.includes(".")?`['${f}']`:f}`:f,o.endsWith(r)&&!o.endsWith("/"+r)||o.endsWith(`['${r}']`)){c=e(l);break}l=[]}}}return c},a.getAttributiesFromComment=(t,n=[])=>{let s=/@(\w+)(?:\s*=\s*(?:"([^"]*)"|'([^']*)'|([^\s@]+)))?/g,i;for(;(i=s.exec(t))!==null;){let[,r,o,c,l]=i,u=o??c??l,h=n.find(d=>d.name===`@${r}`);h?u!==void 0&&(Array.isArray(h.value)?h.value.push(u):h.value=[h.value,u]):n.push({name:`@${r}`,value:u!==void 0?u:!0})}return n.forEach(r=>{Array.isArray(r.value)&&r.value.length===1&&(r.value=r.value[0])}),n};let e=t=>{let n=[];for(let s of t)a.getAttributiesFromComment(s,n);return n};a.readJson=(t,n={},s=!1)=>{},a.readJsonWithComments=(t,n={})=>{}})(ts||(ts={}));var yc;(function(a){let e="xxxxx",n="IxIxI";a.embedData=(s,i,r)=>{r=r||{};let o=dt.extname(i),c=dt.basename(i,o);return`${Object.entries(s).map(([u,h])=>(r.keysMap&&r.keysMap[u]&&(u=r.keysMap[u]),`${u}...${h??""}`)).join(n)}${e}${r.skipAddingBasenameAtEnd?"":c}${o}`},a.extractData=(s,i)=>{i=i||{};let r=dt.extname(s),c=r.includes("|")||r.includes("-")?s:dt.basename(s,r),l=c.lastIndexOf(e),u=l>=0?c.substring(0,l):c,h={},d=0;for(;d<=u.length;){let f=u.indexOf(n,d),p=f===-1?u.substring(d):u.substring(d,f);if(p){let m=p.indexOf("...");if(m>-1){let x=p.substring(0,m),S=p.substring(m+3),G=i.keysMap?Object.keys(i.keysMap||{}).find(D=>i.keysMap[D]===x):x;h[G]=S}}if(f===-1)break;d=f+n.length}return h},a.getOnlyMetadataString=s=>{let i=dt.extname(s),r=dt.basename(s,i),o=r.lastIndexOf(e);if(o===-1)return"";let c=r.substring(0,o);return c.trim()?c:""}})(yc||(yc={}));var gc;(function(a){let e=t=>{let n=t.trim().replace(/^"|"$/g,"");return n.toLowerCase()==="true"?!0:n.toLowerCase()==="false"?!1:!isNaN(Number(n))&&n!==""?Number(n):n};a.setValueToDotFile=(t,n,s)=>{},a.setCommentToKeyInDotFile=(t,n,s)=>{},a.getValueFromDotFile=(t,n)=>{},a.addCommentAtTheBeginningOfDotFile=(t,n)=>{},a.setValuesKeysFromObject=(t,n,s)=>{},a.getValuesKeysAsJsonObject=t=>{},a.getCommentsKeysAsJsonObject=t=>{}})(gc||(gc={}));var Dt=(function(a){return a.SIMULATE_DOMAIN_TAG="@simulatedDomainByTaon",a.getPath=()=>dn(""),a.getLines=()=>{},a.getTokensData=e=>{},a.specificEntryExists=(e,t)=>{},a.getEntriesByDomain=e=>{},a.getEntryByComment=e=>{},a.getEntriesByIp=e=>{},a.removeEntryByDomain=e=>{},a.simulateDomain=async(e,t)=>{},a})(Dt||{}),bc;(function(a){async function e(i,r=3e3){}a.checkPing=e,a.checkIfServerPings=async(i,r=3e3)=>{},a.checkIfServerOnline=async(i,r=80,o=3e3)=>{},a.isValidIp=i=>H.isString(i)?(i=i.trim(),i==="localhost"?!0:/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(i)):!1,a.isValidDomain=(i,r)=>{if(!i||typeof i!="string")return!1;let c=!!r?.shouldIncludeProtocol?/^(https?:\/\/)([a-zA-Z0-9-]{1,63}\.)+[a-zA-Z]{2,}$/:/^([a-zA-Z0-9-]{1,63}\.)+[a-zA-Z]{2,}$/;return typeof r?.shouldIncludeProtocol=="string"&&r?.shouldIncludeProtocol==="http"&&!i.startsWith("http://")||typeof r?.shouldIncludeProtocol=="string"&&r?.shouldIncludeProtocol==="https"&&!i.startsWith("https://")?!1:c.test(i.trim())},a.urlParse=(i,r)=>{r=r||{};let o,c=r.httpsIfNotProvided?"https:":"http:";if(i instanceof URL)o=i;else if(H.isNumber(i))o=new URL(`${c}//localhost:${i}`);else if(!H.isNaN(Number(i)))o=new URL(`${c}//localhost:${Number(i)}`);else if(H.isString(i)){try{o=new URL(i)}catch{}if(a.isValidIp(i))try{o=new URL(`${c}//${i}`)}catch{ae.warn(`Not able to get port from ${i}`)}if(r.forceDomain){let l=i;o=new URL(l.startsWith("http")?l:`http://${i}`)}}return o},a.getEtcHostsPath=Dt.getPath,a.SIMULATE_DOMAIN_TAG=Dt.SIMULATE_DOMAIN_TAG,a.setEtcHost=(i,r="127.0.0.1",o="")=>{},a.getEtcHostEntriesByDomain=Dt.getEntriesByDomain,a.getEtcHostEntryByComment=Dt.getEntryByComment,a.getEtcHostEntryByIp=Dt.getEntriesByIp,a.removeEtcHost=Dt.removeEntryByDomain,a.etcHostHasProperLocalhostIp4Entry=()=>{},a.etcHostHasProperLocalhostIp6Entry=()=>{},a.simulateDomain=Dt.simulateDomain;let t=i=>{let r=i.toLowerCase();return r.includes("virtual")||r.includes("vmware")||r.includes("vbox")||r.includes("hyper-v")||r.includes("wsl")||r.includes("docker")||r.includes("veth")||r.includes("default switch")},n=i=>{let r=i.toLowerCase();return t(r)?"virtual":r.includes("eth")||r.includes("en")||r.includes("lan")?"lan":r.includes("wl")||r.includes("wi-fi")||r.includes("wifi")?"wifi":"other"},s=(i,r)=>{let o={lan:1,wifi:2,other:3,virtual:4},c=o[i.type],l=o[r.type];if(c!==l)return c-l;let u=i.interfaceName.toLowerCase(),h=r.interfaceName.toLowerCase(),d=p=>p.includes("ethernet")&&!p.includes("vethernet")?0:1,f=d(u)-d(h);return f!==0?f:u.localeCompare(h)};a.getLocalIpAddresses=async()=>{},a.getFirstIpV4LocalActiveIpAddress=async()=>{},a.getCurrentPublicIpAddress=async()=>{}})(bc||(bc={}));var wc;(function(a){let e="file.log";a.baseDirTaonProcessLogs=()=>dn([it.getRealHomeDir(),".taon","log-files-for"]),a.getLogsFiles=(s,i)=>{};class t{get processLogFilename(){return this._processLogFilename}get processLogAbsFilePath(){return this._logFilePath}constructor(i,r){this.dataForFilename=i,this.options=r,this._logFilePath=null,this.writeStream=null,this._processLogFilename=null,this.lastNLinesFromStderr=[],this.lastNLinesFromStdout=[],this.lastNLinesFromOfOutput=[]}startLogging(i,r){}stopLogging(){}update(i,r){}}a.ProcessFileLogger=t,a.createStickyTopBox=s=>{};let n=s=>{}})(wc||(wc={}));var Ec;(function(a){let e=Symbol("cliMethod"),t="unknownclass";a.staticClassNameProperty=Rt.ClassNameStaticProperty,a.decoratorMethod=n=>(s,i,r)=>{},a.getFrom=(n,s)=>{}})(Ec||(Ec={}));var Pr=class{get isBrowser(){return it.isRunningInBrowser()}get isWebSQL(){return it.isRunningInWebSQL()}get isNode(){return it.isRunningInNode()}get isElectron(){return it.isRunningInElectron()}contain(e,t){return e.filter(n=>n instanceof RegExp?n.test(t):!!(n===t||t.match&&typeof t.match=="function"&&t.match(n))).length>0}},lp={LAST_ERROR:Symbol(),LAST_INFO:Symbol(),LAST_WARN:Symbol(),LAST_LOG:Symbol(),LAST_SUCCESS:Symbol(),LAST_TASK_STARTED:Symbol(),LAST_TASK_DONE:Symbol()},up={LAST_ERROR:Symbol(),LAST_INFO:Symbol(),LAST_WARN:Symbol(),LAST_LOG:Symbol(),LAST_SUCCESS:Symbol(),LAST_TASK_STARTED:Symbol(),LAST_TASK_DONE:Symbol()},hp={LAST_ERROR:Symbol(),LAST_INFO:Symbol(),LAST_WARN:Symbol(),LAST_LOG:Symbol(),LAST_SUCCESS:Symbol(),LAST_TASK_STARTED:Symbol(),LAST_TASK_DONE:Symbol()};var _r=class extends Pr{msgCacheClear(){}renderError(e){this.isBrowser&&console.error(e)}throw(e){throw new Error(e)}stopApplication(e){throw this.isBrowser&&(document.body.innerHTML="<h1>Application has encountered an error and stopped.</h1>",document.body.style.pointerEvents="none"),new Error(e)}tryCatchError(e){ae.error(e,!0,!0)}error(e,t=!1,n=!1){if(ae.isBrowser){console.error(e);return}}info(e,t=!1){if(ae.isBrowser){console.info(e);return}}success(e){if(ae.isBrowser){console.info(e);return}}taskStarted(e,t=!1){if(ae.isBrowser){console.info(e);return}}taskDone(e,t=!1){if(ae.isBrowser){console.info(e);return}}get isVerboseMode(){return!0}log(e,t=0){if(ae.isBrowser){console.log(e);return}}logSuccess(e){}logInfo(e,t=!1){}logError(e,t=!1,n=!1){}logWarn(e,t=!1){}warn(e,t=!1){if(ae.isBrowser){console.warn(e);return}}},hn={},ht={},Ir=class a extends _r{static get InstanceCore(){return a._instanceCore||(a._instanceCore=new a),a._instanceCore}constructor(){super(),this.bigMaxBuffer=2024*500}get isWsl(){return it.isRunningInWsl()}isRunningInDocker(){return it.isRunningInDocker()}isRunningInLinuxGraphicsCapableEnvironment(){return it.isRunningInLinuxGraphicsCapableEnvironment()}clearConsole(){return ei.clearConsole()}mediaTypeFromSrc(e){let t=dt.extname(e),n=Rt.mimeTypes[t];return H.first(n?.split("/"))}sleep(e=1){}removeIfExists(e){}relative(e,t){return dn(dt.relative(e,t))}removeFileIfExists(e){}removeFolderIfExists(e){}removeEmptyLineFromString(e){let t=(e||"").split(`
`),n=!1;return t.filter(s=>s.trim()===""?n?!1:(n=!0,!0):(n=!1,!0)).join(`
`)}tryRemoveDir(e,t=!1,n=!1){}removeSymlinks(e,t){}remove(e,t=!1){}get isRunningInGitBash(){}get isSupportedTaonTerminal(){return!1}isClass(e){let t=!1;return typeof e=="function"&&(t=!!e.prototype&&Object.getOwnPropertyNames(e.prototype).filter(n=>n!=="constructor").length>0),t}isBlob(e){return e instanceof Blob}removeSlashAtEnd(e){return e=e?.endsWith("/")?e.slice(0,e.length-1):e,e}removeSlashAtBegin(e){return e=e?.startsWith("/")?e.slice(1):e,e}stringify(e){return JSON.stringify(e,null,2)}async runSyncOrAsync(e){if(H.isUndefined(e))return;let t,{functionFn:n,context:s,arrayOfParams:i}=e;return t=n.apply(s,i),t instanceof Promise&&(t=Promise.resolve(t)),t}isSymlinkThatMatchesUrl(e,t,n=!1){}isSymlinkFileExitedOrUnexisted(e){}isUnexistedLink(e){}isExistedSymlink(e){}exists(e){}_fixCommand(e){return(e.startsWith("tnp ")||e.startsWith("taon "))&&e.search("-spinner=false")===-1&&e.search("-spinner=off")===-1&&(e=`${e} -spinner=false`),global.skipCoreCheck&&(e.startsWith("tnp ")||e.startsWith("taon "))&&(e=`${e} --skipCoreCheck`),e}command(e){return e=ae._fixCommand(e),{}}async wait(e){await ei.wait(e)}async timeout(e){return await ae.wait(e)}async commandOutputAsStringAsync(e,t=dn(process.cwd()),n){}commandOutputAsString(e,t=dn(process.cwd()),n){}async killProcessByPort(e,t){}async killOnPort(e,t){return await ae.killProcessByPort(e,t)}killProcess(e){if(hn[e]){let t=hn[e].ppid;if(ht[t]){let n=ht[t].childProcesses;ht[t].childProcesses=n.filter(s=>s!==e)}delete hn[e]}if(ht[e]){let t=ht[e].childProcesses;for(let n=0;n<t.length;n++){let s=t[n];delete hn[s]}delete ht[e]}}run(e,t){return e=ae._fixCommand(e),{sync(){},async(n=!1,s){if(s){let i=new Oe,r=new Oe,o=new Oe,c=[],l={stdout:{on(d,f){d=="data"&&c.push(i.subscribe(p=>{f(p)}))}},stderr:{on(d,f){d=="data"&&c.push(r.subscribe(p=>{f(p)}))}},on(d,f){d=="exit"&&c.push(o.subscribe(p=>{f(p)}))},ppid:void 0,pid:void 0};l.pid=Math.round(Math.random()*900)+100,l.ppid=l.pid+9999,hn[l.pid]=l,ht[l.ppid]||(ht[l.ppid]={childProcesses:[]}),ht[l.ppid].childProcesses.push(l.pid);let u=()=>H.isNil(hn[l.pid])||H.isNil(ht[l.ppid]);return ae.runSyncOrAsync({functionFn:s,arrayOfParams:[d=>{setTimeout(()=>{i.next(d)})},d=>{setTimeout(()=>{r.next(d)})},()=>u()]}).then(d=>{H.isNil(d)&&(d=0),setTimeout(()=>{o.next(d),c.forEach(f=>f.unsubscribe())})}).catch(d=>{console.error(d),console.error("Something wrong with your mock funciton"),o.next(1),c.forEach(f=>f.unsubscribe())}),l}},asyncAsPromise(){},unitlOutput(n){},unitlOutputContains(n,s,i=0,r){}}}async questionYesNo(e,t,n,s=!0){}values(e){if(H.isObject(e)&&!Array.isArray(e)){let t=[];for(let n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.push(e[n]);return t}return[]}isFile(e){}async tryReadFile(e,t=void 0,n=!1){}readFile(e,t=void 0,n=!1){return fn.readFile(e,{defaultValueWhenNotExists:t,notTrim:n})}readJson(e,t={},n=!1){return ts.readJson(e,t,n)}readJson5(e,t={}){return ts.readJsonWithComments(e,t)}readJsonC(e,t={}){return ts.readJsonWithComments(e,t)}replaceLinesInFile(e,t){}getFilesFrom(e,t){return fn.getFilesFrom(e,t)}getFoldersFrom(e,t){return fn.getFoldersFrom(e,t)}hideNodeWarnings(){}};var bu,dp={dirnameForTnp:bu,packagesThat:{areTrustedForPatchUpdate:pu},regexString:{pathPartStringRegex:"(/([a-zA-Z0-9]|\\-|\\_|\\+|\\.)*)"},placeholders:{forProjectsInEnvironmentFile:"//<PLACEHOLDER_FOR_PROJECTS>"},frameworkName:eu,startPort:6001,frameworks:["bootstrap","ionic","material"],folder:fu,tempFolders:vc,filesNotAllowedToClean:Object.keys(Ar).map(a=>Ar[a]),file:du,reservedArgumentsNamesUglify:["reservedExpOne","reservedExpSec"],localLibs:[],helpAlias:["-h","--help","-help","help"]},ae=Ir.InstanceCore;var wu=Math.pow(10,8)*24*60*60*1e3,mp=-wu;var qr=6e4,Br=36e5;var Eu=3600;var Mc=Eu*24,yp=Mc*7,Tu=Mc*365.2425,Cu=Tu/12,gp=Cu*3,Fr=Symbol.for("constructDateFrom");function ti(a,e){return typeof a=="function"?a(e):a&&typeof a=="object"&&Fr in a?a[Fr](e):a instanceof Date?new a.constructor(e):new Date(e)}function Lr(a,e){return ti(e||a,a)}function Ac(a,e){let t=()=>ti(e?.in,NaN),n=e?.additionalDigits??2,s=xu(a),i;if(s.date){let l=Su(s.date,n);i=Mu(l.restDateString,l.year)}if(!i||isNaN(+i))return t();let r=+i,o=0,c;if(s.time&&(o=Au(s.time),isNaN(o)))return t();if(s.timezone){if(c=Ou(s.timezone),isNaN(c))return t()}else{let l=new Date(r+o),u=Lr(0,e?.in);return u.setFullYear(l.getUTCFullYear(),l.getUTCMonth(),l.getUTCDate()),u.setHours(l.getUTCHours(),l.getUTCMinutes(),l.getUTCSeconds(),l.getUTCMilliseconds()),u}return Lr(r+o+c,e?.in)}var ni={dateTimeDelimiter:/[T ]/,timeZoneDelimiter:/[Z ]/i,timezone:/([Z+-].*)$/},Nu=/^-?(?:(\d{3})|(\d{2})(?:-?(\d{2}))?|W(\d{2})(?:-?(\d{1}))?|)$/,vu=/^(\d{2}(?:[.,]\d*)?)(?::?(\d{2}(?:[.,]\d*)?))?(?::?(\d{2}(?:[.,]\d*)?))?$/,Ru=/^([+-])(\d{2})(?::?(\d{2}))?$/;function xu(a){let e={},t=a.split(ni.dateTimeDelimiter),n;if(t.length>2)return e;if(/:/.test(t[0])?n=t[0]:(e.date=t[0],n=t[1],ni.timeZoneDelimiter.test(e.date)&&(e.date=a.split(ni.timeZoneDelimiter)[0],n=a.substr(e.date.length,a.length))),n){let s=ni.timezone.exec(n);s?(e.time=n.replace(s[1],""),e.timezone=s[1]):e.time=n}return e}function Su(a,e){let t=new RegExp("^(?:(\\d{4}|[+-]\\d{"+(4+e)+"})|(\\d{2}|[+-]\\d{"+(2+e)+"})$)"),n=a.match(t);if(!n)return{year:NaN,restDateString:""};let s=n[1]?parseInt(n[1]):null,i=n[2]?parseInt(n[2]):null;return{year:i===null?s:i*100,restDateString:a.slice((n[1]||n[2]).length)}}function Mu(a,e){if(e===null)return new Date(NaN);let t=a.match(Nu);if(!t)return new Date(NaN);let n=!!t[4],s=ns(t[1]),i=ns(t[2])-1,r=ns(t[3]),o=ns(t[4]),c=ns(t[5])-1;if(n)return $u(e,o,c)?Pu(e,o,c):new Date(NaN);{let l=new Date(0);return!Iu(e,i,r)||!Du(e,s)?new Date(NaN):(l.setUTCFullYear(e,i,Math.max(s,r)),l)}}function ns(a){return a?parseInt(a):1}function Au(a){let e=a.match(vu);if(!e)return NaN;let t=kr(e[1]),n=kr(e[2]),s=kr(e[3]);return qu(t,n,s)?t*Br+n*qr+s*1e3:NaN}function kr(a){return a&&parseFloat(a.replace(",","."))||0}function Ou(a){if(a==="Z")return 0;let e=a.match(Ru);if(!e)return 0;let t=e[1]==="+"?-1:1,n=parseInt(e[2]),s=e[3]&&parseInt(e[3])||0;return Bu(n,s)?t*(n*Br+s*qr):NaN}function Pu(a,e,t){let n=new Date(0);n.setUTCFullYear(a,0,4);let s=n.getUTCDay()||7,i=(e-1)*7+t+1-s;return n.setUTCDate(n.getUTCDate()+i),n}var _u=[31,null,31,30,31,30,31,31,30,31,30,31];function Oc(a){return a%400===0||a%4===0&&a%100!==0}function Iu(a,e,t){return e>=0&&e<=11&&t>=1&&t<=(_u[e]||(Oc(a)?29:28))}function Du(a,e){return e>=1&&e<=(Oc(a)?366:365)}function $u(a,e,t){return e>=1&&e<=53&&t>=0&&t<=6}function qu(a,e,t){return a===24?e===0&&t===0:t>=0&&t<60&&e>=0&&e<60&&a>=0&&a<25}function Bu(a,e){return e>=0&&e<=59}var jr;(function(a){class e{}a.ParamConfig=e;class t{constructor(){this.parameters={}}}a.MethodConfig=t;class n{constructor(){this.singleton=void 0,this.injections=[],this.vChildren=[],this.methods={}}}a.ClassConfig=n})(jr||(jr={}));var Xe={MODELS_MAPPING:Symbol(),DEFAULT_MODEL:Symbol(),STORAGE:"classesstorage",CLASSES:"classes",ClassNameStaticProperty:Rt.ClassNameStaticProperty};function si(){return H.cloneDeep({[Xe.CLASSES]:[]})}function Ur(a){return typeof a=="string"?Ur()[a]:(typeof si.prototype[Xe.STORAGE]>"u"&&(si.prototype[Xe.STORAGE]=si()),si.prototype[Xe.STORAGE])}function Pc(){return Ur()[Xe.CLASSES]}function _c(a,e,t){let{classFamily:n,uniqueKey:s,classNameInBrowser:i,singleton:r}=t||{classFamily:void 0,uniqueKey:"id",classNameInBrowser:void 0,singleton:void 0,autoinstance:!1};if(!H.isUndefined(r)&&H.isBoolean(r)&&r&&(r="first-instance"),s||(s="id"),a){let l=H.first(Fe.getClassConfig(a));l.className=e,l.uniqueKey=s,l.classNameInBrowser=i}let o=Pc().find(l=>l.className===e);if(o)o.target=a;else{let l={className:e,classNameInBrowser:i,target:a,uniqueKey:s,classFamily:n};H.isUndefined(n)&&Object.defineProperty(l,"classFamily",{get:function(){let u=Object.getPrototypeOf(a);if(!H.isFunction(u)||u.name==="Object"||u.name==="")return e;let h=Fe.getClassName(u);return Fe.getClassFamilyByClassName(h)}}),Pc().push(l)}let c=a;if(r==="first-instance"||r==="last-instance"){let l={decoratedConstructor:function(...u){let h=c.apply(this,u);return(!xe.getSingleton(c)||r==="last-instance")&&(xe.setSingletonObj(c,this),xe.setSingletonObj(l.decoratedConstructor,this)),h}};return l.decoratedConstructor.prototype=c.prototype,Object.keys(c).forEach(u=>{l.decoratedConstructor[u]=c[u]}),Object.defineProperty(l.decoratedConstructor,"name",{value:e,configurable:!0}),l.decoratedConstructor}else if(r==="autoinstance"){let l=new c;xe.setSingletonObj(c,l)}}var $t={configs:[],classes:[]},Fu=`[typescript-class-helpers][getClassName(...)](PRODUCTION MODE ERROR)
Please use decoartor @CLASSNAME for each entity or controller
This is preventing class name problem in minified code.

import { CLASS } from 'typescript-class-helpers';

@CLASS.NAME('ExampleClass')
class ExampleClass {
  ...
}
`;function ss(){return Ur()[Xe.CLASSES]}var Fe;(function(a){function e(l,u=[],h){if(!H.isFunction(l))throw`[typescript-class-helper][getClassConfig] Cannot get class config from: ${l}`;let d,f=Object.getPrototypeOf(l),p=H.isFunction(f)&&f.name!=="";if($t.classes.includes(l)?d=$t.configs[$t.classes.findIndex(m=>m===l)]:(d=new jr.ClassConfig,d.classReference=l,$t.classes.push(l)),$t.configs[$t.classes.findIndex(m=>m===l)]=d,h){let m=$t.configs[$t.classes.findIndex(x=>x===h)];d.vChildren.includes(m)||d.vChildren.push(m),m.vParent=d}return u.push(d),p?e(f,u,l):u}a.getClassConfig=e;function t(l,u){return function(h){return _c(h,l,u)}}a.CLASSNAME=t;function n(l,u=!1){if(H.isNil(l))return;if(H.isString(l))return ae.log(`[typescript-class-helpers][getClassName] target is string: '${l}', produciton: ${u}`),l;if(l===Date)return"Date";if(l===FormData)return"FormData";if(!H.isFunction(l)){ae.log("[typescript-class-helpers][getClassName] target is not a class");return}if(l[Xe.ClassNameStaticProperty])return l[Xe.ClassNameStaticProperty];let h=e(l),d=H.first(h),f=d?.classNameInBrowser;if(ae.isBrowser&&H.isString(f))return f;let p=d?.className;if(typeof p=="string")return p;if(u)throw console.log("class without @CLASS.NAME deocrator",l),new Error(Fu);return l.name?.startsWith("class_")?"":l.name}a.getClassName=n;function s(l){let u=Ue.getNameFromObject(l),h=ss().find(d=>d.className===u);if(h)return h.uniqueKey}a.getObjectIndexPropertyValue=s;function i(l){let u=ss().find(h=>h.className===l);if(u)return u.classFamily}a.getClassFamilyByClassName=i;function r(l){let u=Ue.getNameFromObject(l),h=ss().find(d=>d.className===u);if(h)return h.classFamily}a.getObjectClassFamily=r;function o(l){let u=Ue.getNameFromObject(l),h=ss().find(d=>d.className===u);if(h&&H.isString(h.uniqueKey))return l[h.uniqueKey]}a.getObjectIndexValue=o;function c(l){let u;if(Array.isArray(l)){if(l.length!==1)throw`Mapping error... please use proper class names:
  {
    propertyObject: 'MyClassName',
    propertyWithArray: ['MyClassName']
  }

        `;l=l[0]}typeof l=="function"&&(u=l),l==="Date"&&(u=Date),l==="FormData"&&(u=FormData);let h=ss().find(d=>d.className===l);return h&&(u=h.target),u}a.getClassBy=c})(Fe||(Fe={}));var Lu=new RegExp(/(?:this\.)(.+?(?= ))/g);function Ic(a,e=!1){var t=[];if(e){var n=Object.getPrototypeOf(a.prototype);n&&(t=t.concat(Ic(n.constructor,e)))}let i=a.toString().match(Lu)||[];return t=t.concat(i),t.map(r=>r.replace("this.","").replace(".","").replace(")","").replace("(",""))}function ku(a){let e={};if(a){a[Xe.DEFAULT_MODEL]&&Object.keys(a[Xe.DEFAULT_MODEL]).filter(s=>!H.isFunction(a[Xe.DEFAULT_MODEL][s])).forEach(s=>e[s]=null);let n=a[Xe.MODELS_MAPPING];H.isArray(n)?n.forEach(s=>{Object.keys(s).forEach(i=>{e[i]=null})}):n&&Object.keys(n).forEach(s=>{e[s]=null})}let t=Object.keys(e).filter(n=>!!n);return t=(t.includes("id")?[]:["id"]).concat(t),t}var Ue=class{static getBy(e){return Fe.getClassBy(e)}static getFromObject(e){if(H.isUndefined(e)||H.isNull(e))return;if(e.constructor)return e.constructor;let t=Object.getPrototypeOf(e);return t&&t.constructor}static getName(e,t=!1){return Fe.getClassName(e,t)}static getNameFromObject(e){let t=this.getFromObject(e);return this.getName(t)}static getConfigs(e){return Fe.getClassConfig(e)}static describeProperites(e){let t=Ic(e),n=ku(e),s={};return t.concat(n).forEach(i=>s[i]=i),Object.keys(s).filter(i=>!!i).filter(i=>typeof e.prototype[i]!="function")}},ju=["length","name","arguments","caller","constructor","apply","bind","call","toString","__defineGetter__","__defineSetter__","hasOwnProperty","__lookupGetter__","__lookupSetter__","isPrototypeOf","propertyIsEnumerable","valueOf","__proto__","toLocaleString"],Dc=(a,e=[])=>{if(!a)return e;let t=H.isFunction(a),n=t?a:Object.getPrototypeOf(a),s=t?a?.prototype:a,i=Object.getPrototypeOf(s||{});return H.uniq([...Object.getOwnPropertyNames(s||{}),...Object.getOwnPropertyNames(i||{}),...Object.keys(s||{}),...Object.keys(i||{})]).filter(o=>!!o&&!ju.includes(o)).filter(o=>typeof s[o]=="function").forEach(o=>e.push(o)),!n||!n.constructor||n?.constructor?.name==="Object"?e:Dc(Object.getPrototypeOf(n),e)},xe={NAME:Fe.CLASSNAME,setName:_c,getBy:Ue.getBy,getSingleton(a){if(typeof a!="function"){console.error("[typescript-class-helpers][setSingletonObj] Type of target is not a function");return}return Ue.getConfigs(a)[0].singleton},setSingletonObj(a,e){if(typeof a!="function"){console.error("[typescript-class-helpers][setSingletonObj] Type of target is not a function");return}if(Array.isArray(e)){console.error("[typescript-class-helpers][setSingletonObj] Singleton instance cant be an array");return}if(typeof e!="object"){console.error("[typescript-class-helpers][setSingletonObj] Singleton instance cant must be a object");return}let t=xe.getName(a),n=Ue.getConfigs(a)[0];n.singleton&&console.warn(`[typescript-class-helpers] You are trying to set singleton of "${t}" second time with different object.`),n.singleton=e},getConfigs:Ue.getConfigs,getConfig:a=>H.first(Ue.getConfigs(a)),getMethodsNames(a){return Dc(a)},getFromObject:Ue.getFromObject,getName:Ue.getName,getNameFromObject:Ue.getNameFromObject,describeProperites:Ue.describeProperites,OBJECT:a=>({get indexValue(){return Fe.getObjectIndexValue(a)},get indexProperty(){return Fe.getObjectIndexPropertyValue(a)},get isClassObject(){if(!H.isObject(a)||H.isArray(a)||H.isRegExp(a)||H.isBuffer(a)||H.isArrayBuffer(a))return!1;if(H.isDate(a))return!0;let e=xe.getNameFromObject(a);return H.isString(e)&&e!=="Object"},isEqual:(e,t=!1)=>{if(!xe.OBJECT(a).isClassObject||!xe.OBJECT(e).isClassObject)return!1;if(a===e)return!0;let n=Fe.getObjectIndexValue(a),s=Fe.getObjectIndexValue(e),i=Fe.getObjectClassFamily(a),r=Fe.getObjectClassFamily(e);return!H.isString(i)||!H.isString(r)||i!==r||!xe.OBJECT(a).isClassObject||!xe.OBJECT(e).isClassObject?!1:H.isNumber(n)&&H.isNumber(s)||H.isString(n)&&H.isString(s)?n===s:t?H.isEqual(n,s):!1}})};var _e=[];for(let a=0;a<256;++a)_e.push((a+256).toString(16).slice(1));function $c(a,e=0){return(_e[a[e+0]]+_e[a[e+1]]+_e[a[e+2]]+_e[a[e+3]]+"-"+_e[a[e+4]]+_e[a[e+5]]+"-"+_e[a[e+6]]+_e[a[e+7]]+"-"+_e[a[e+8]]+_e[a[e+9]]+"-"+_e[a[e+10]]+_e[a[e+11]]+_e[a[e+12]]+_e[a[e+13]]+_e[a[e+14]]+_e[a[e+15]]).toLowerCase()}var Vr,Uu=new Uint8Array(16);function Wr(){if(!Vr){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");Vr=crypto.getRandomValues.bind(crypto)}return Vr(Uu)}var Vu=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),Qr={randomUUID:Vu};function Wu(a,e,t){if(Qr.randomUUID&&!e&&!a)return Qr.randomUUID();a=a||{};let n=a.random??a.rng?.()??Wr();if(n.length<16)throw new Error("Random bytes length must be >= 16");if(n[6]=n[6]&15|64,n[8]=n[8]&63|128,e){if(t=t||0,t<0||t+16>e.length)throw new RangeError(`UUID byte range ${t}:${t+15} is out of buffer bounds`);for(let s=0;s<16;++s)e[t+s]=n[s];return e}return $c(n)}var ii=Wu;var xt=wt(kc(),1);var go=Rt.OrignalClassKey,Cn=class{static getInheritanceTree(e){let t=[e],n=s=>{let i=Object.getPrototypeOf(s);i&&i.name&&(t.push(i),n(i))};return n(e),t}static isInherited(e,t){return e.prototype instanceof t}static filterByTarget(e,t){return t?e.filter(n=>n.target&&t.indexOf(n.target)!==-1):e}},li=class{constructor(){this.tables=[],this.trees=[],this.entityRepositories=[],this.transactionEntityManagers=[],this.transactionRepositories=[],this.namingStrategies=[],this.entitySubscribers=[],this.indices=[],this.uniques=[],this.checks=[],this.exclusions=[],this.columns=[],this.generations=[],this.relations=[],this.joinColumns=[],this.joinTables=[],this.entityListeners=[],this.relationCounts=[],this.relationIds=[],this.embeddeds=[],this.inheritances=[],this.discriminatorValues=[]}filterTables(e){return this.filterByTarget(this.tables,e)}filterColumns(e){return this.filterByTargetAndWithoutDuplicateProperties(this.columns,e)}findGenerated(e,t){return this.generations.find(n=>(Array.isArray(e)?e.indexOf(n.target)!==-1:n.target===e)&&n.propertyName===t)}findTree(e){return this.trees.find(t=>Array.isArray(e)?e.indexOf(t.target)!==-1:t.target===e)}filterRelations(e){return this.filterByTargetAndWithoutDuplicateRelationProperties(this.relations,e)}filterRelationIds(e){return this.filterByTargetAndWithoutDuplicateProperties(this.relationIds,e)}filterRelationCounts(e){return this.filterByTargetAndWithoutDuplicateProperties(this.relationCounts,e)}filterIndices(e){return this.indices.filter(t=>Array.isArray(e)?e.indexOf(t.target)!==-1:t.target===e)}filterUniques(e){return this.uniques.filter(t=>Array.isArray(e)?e.indexOf(t.target)!==-1:t.target===e)}filterChecks(e){return this.checks.filter(t=>Array.isArray(e)?e.indexOf(t.target)!==-1:t.target===e)}filterExclusions(e){return this.exclusions.filter(t=>Array.isArray(e)?e.indexOf(t.target)!==-1:t.target===e)}filterListeners(e){return this.filterByTarget(this.entityListeners,e)}filterEmbeddeds(e){return this.filterByTargetAndWithoutDuplicateEmbeddedProperties(this.embeddeds,e)}findJoinTable(e,t){return this.joinTables.find(n=>n.target===e&&n.propertyName===t)}filterJoinColumns(e,t){return this.joinColumns.filter(n=>n.target===e&&n.propertyName===t)}filterSubscribers(e){return this.filterByTarget(this.entitySubscribers,e)}filterNamingStrategies(e){return this.filterByTarget(this.namingStrategies,e)}filterTransactionEntityManagers(e,t){return this.transactionEntityManagers.filter(n=>(Array.isArray(e)?e.indexOf(n.target)!==-1:n.target===e)&&n.methodName===t)}filterTransactionRepository(e,t){return this.transactionRepositories.filter(n=>(Array.isArray(e)?e.indexOf(n.target)!==-1:n.target===e)&&n.methodName===t)}filterSingleTableChildren(e){return this.tables.filter(t=>typeof t.target=="function"&&typeof e=="function"&&Cn.isInherited(t.target,e)&&t.type==="entity-child")}findInheritanceType(e){return this.inheritances.find(t=>t.target===e)}findDiscriminatorValue(e){return this.discriminatorValues.find(t=>t.target===e)}filterByTarget(e,t){return e.filter(n=>Array.isArray(t)?t.indexOf(n.target)!==-1:n.target===t)}filterByTargetAndWithoutDuplicateProperties(e,t){let n=[];return e.forEach(s=>{(Array.isArray(t)?t.indexOf(s.target)!==-1:s.target===t)&&(n.find(r=>r.propertyName===s.propertyName)||n.push(s))}),n}filterByTargetAndWithoutDuplicateRelationProperties(e,t){let n=[];return e.forEach(s=>{if(Array.isArray(t)?t.indexOf(s.target)!==-1:s.target===t){let r=n.findIndex(o=>o.propertyName===s.propertyName);if(Array.isArray(t)&&r!==-1&&t.indexOf(s.target)<t.indexOf(n[r].target)){let o=Object.create(n[r]);o.type=s.type,n[r]=o}else r===-1&&n.push(s)}}),n}filterByTargetAndWithoutDuplicateEmbeddedProperties(e,t){let n=[];return e.forEach(s=>{(Array.isArray(t)?t.indexOf(s.target)!==-1:s.target===t)&&(n.find(o=>o.prefix===s.prefix&&o.propertyName===s.propertyName)||n.push(s))}),n}},zr;zr=a=>a;var De;De={blueBright(a){return a},white(a){return a},gray(a){return a},magenta(a){return a},magentaBright(a){return a},yellow(a){return a},red(a){return a},bgRed(a){return a},underline(a){return a},black(a){return a}};Object.keys(De).forEach(a=>{Object.keys(De).forEach(e=>{De[a][e]=De[a]})});var Te=class{static get type(){return"browser"}static getGlobalVariable(){return globalThis}static load(e){try{switch(e){case"spanner":return;case"mongodb":return;case"@sap/hana-client":return;case"hdb-pool":return;case"mysql":return;case"mysql2":return;case"oracledb":return;case"pg":return;case"pg-native":return;case"pg-query-stream":return;case"typeorm-aurora-data-api-driver":return;case"redis":return;case"ioredis":return;case"better-sqlite3":return;case"sqlite3":return;case"sql.js":return Gl();case"mssql":return;case"react-native-sqlite-storage":return}}catch{return}throw new TypeError(`Invalid Package for PlatformTools.load: ${e}`)}static pathNormalize(e){}static pathExtname(e){}static pathResolve(e){}static fileExist(e){}static readFileSync(e){}static appendFileSync(e,t){}static async writeFile(e,t){return new Promise((n,s)=>{})}static dotenv(e){}static getEnvVariable(e){}static highlightSql(e){let t={keyword:De.blueBright,literal:De.blueBright,string:De.white,type:De.magentaBright,built_in:De.magentaBright,comment:De.gray};return zr(e,{theme:t,language:"sql"})}static highlightJson(e){return zr(e,{language:"json"})}static logInfo(e,t){console.log(De.gray.underline(e),t)}static logError(e,t){console.log(De.underline.red(e),t)}static logWarn(e,t){console.log(De.underline.yellow(e),t)}static log(e){console.log(De.underline(e))}static warn(e){return De.yellow(e)}static logCmdErr(e,t){console.log(De.black.bgRed(e)),t&&console.error(t)}},v=class extends Error{get name(){return this.constructor.name}constructor(e){super(e),Object.setPrototypeOf?Object.setPrototypeOf(this,new.target.prototype):this.__proto__=new.target.prototype}};var gn=class extends v{constructor(e){super(`Internal error. Subject ${e.metadata.targetName} must have an identifier to perform operation.`)}},Hr=class extends v{constructor(e){super(`Cannot create a "${e}" connection because connection to the database already established.`)}},qt=class extends v{constructor(){super("Locking not supported on given driver.")}};var Kr=class extends v{constructor(e,t){super();let n=e.primaryColumns.reduce((s,i,r)=>(i.setEntityValue(s,r+1),s),{});this.message=`Cannot use given entity id "${t}" because "${e.targetName}" contains multiple primary columns, you must provide object in following form: ${JSON.stringify(n)} as an id.`}};var Yr=class extends v{constructor(e){super(`Cannot ${e}, given value must be instance of entity class, instead object literal is given. Or you must specify an entity target to method call.`)}},ls=class extends v{constructor(){super('Cannot perform update query because update values are not defined. Call "qb.set(...)" method to specify updated values.')}},Zr=class extends v{constructor(e){super(`Tree repositories are not supported in ${e.options.type} driver.`)}},ui=class extends v{constructor(e){super(`Custom repository ${typeof e=="function"?e.name:e.constructor.name} was not found. Did you forgot to put @EntityRepository decorator on it?`)}},hi=class extends v{constructor(){super("Transaction is not started yet, start transaction before committing or rolling it back.")}},Xr=class extends v{constructor(){super("Transaction already started for the given connection, commit current transaction before starting a new one.")}},ne=class{static isObject(e){return e!==null&&typeof e=="object"}static assign(e,...t){for(let n of t)for(let s of Object.getOwnPropertyNames(n))e[s]=n[s]}static mixedListToArray(e){return e!==null&&typeof e=="object"?Object.keys(e).map(t=>e[t]):e}},$=class{static isEntityMetadata(e){return this.check(e,"EntityMetadata")}static isColumnMetadata(e){return this.check(e,"ColumnMetadata")}static isQueryBuilder(e){return this.check(e,"QueryBuilder")||this.check(e,"SelectQueryBuilder")||this.check(e,"InsertQueryBuilder")||this.check(e,"DeleteQueryBuilder")||this.check(e,"UpdateQueryBuilder")||this.check(e,"SoftDeleteQueryBuilder")||this.check(e,"RelationQueryBuilder")}static isSelectQueryBuilder(e){return this.check(e,"SelectQueryBuilder")}static isInsertQueryBuilder(e){return this.check(e,"InsertQueryBuilder")}static isDeleteQueryBuilder(e){return this.check(e,"DeleteQueryBuilder")}static isUpdateQueryBuilder(e){return this.check(e,"UpdateQueryBuilder")}static isSoftDeleteQueryBuilder(e){return this.check(e,"SoftDeleteQueryBuilder")}static isRelationQueryBuilder(e){return this.check(e,"RelationQueryBuilder")}static isBrackets(e){return this.check(e,"Brackets")||this.check(e,"NotBrackets")}static isNotBrackets(e){return this.check(e,"NotBrackets")}static isSubject(e){return this.check(e,"Subject")}static isRdbmsSchemaBuilder(e){return this.check(e,"RdbmsSchemaBuilder")}static isSqljsEntityManager(e){return this.check(e,"SqljsEntityManager")}static isEntitySchema(e){return this.check(e,"EntitySchema")}static isBaseEntityConstructor(e){return typeof e=="function"&&typeof e.hasId=="function"&&typeof e.save=="function"&&typeof e.useDataSource=="function"}static isFindOperator(e){return this.check(e,"FindOperator")||this.check(e,"EqualOperator")}static isEqualOperator(e){return this.check(e,"EqualOperator")}static isQuery(e){return this.check(e,"Query")}static isTable(e){return this.check(e,"Table")}static isTableCheck(e){return this.check(e,"TableCheck")}static isTableColumn(e){return this.check(e,"TableColumn")}static isTableExclusion(e){return this.check(e,"TableExclusion")}static isTableForeignKey(e){return this.check(e,"TableForeignKey")}static isTableIndex(e){return this.check(e,"TableIndex")}static isTableUnique(e){return this.check(e,"TableUnique")}static isView(e){return this.check(e,"View")}static isDataSource(e){return this.check(e,"DataSource")}static check(e,t){return typeof e=="object"&&e!==null&&e["@instanceof"]===Symbol.for(t)}},us=class extends v{constructor(e,t){super(),this.message=`Could not find any entity of type "${this.stringifyTarget(e)}" matching: ${this.stringifyCriteria(t)}`}stringifyTarget(e){return $.isEntitySchema(e)?e.options.name:typeof e=="function"||ne.isObject(e)&&"name"in e?e.name:e}stringifyCriteria(e){try{return JSON.stringify(e,null,4)}catch{}return""+e}},ea=class extends v{constructor(e){super(),this.message=`No metadata for "${this.stringifyTarget(e)}" was found.`}stringifyTarget(e){return $.isEntitySchema(e)?e.options.name:typeof e=="function"||ne.isObject(e)&&"name"in e?e.name:e}},ta=class extends v{constructor(e,t){super(`Cannot ${e}, given value must be an entity, instead "${t}" is given.`)}},di=class extends v{constructor(e,t,n){super(`The optimistic lock on entity ${e} failed, version ${t} was expected, but is actually ${n}.`)}},fi=class extends v{constructor(){super("Your database does not support LIMIT on UPDATE statements.")}};var na=class extends v{constructor(e){super(`Custom entity repository ${typeof e=="function"?e.name:e.constructor.name}  cannot inherit Repository class without entity being set in the @EntityRepository decorator.`)}},pi=class extends v{constructor(){super("Database connection provided by a query runner was already released, cannot continue to use its querying methods anymore.")}},mi=class extends v{constructor(e){super(`Cannot attach entity "${e}" to its parent. Please make sure parent is saved in the database before saving children nodes.`)}},is=class extends v{constructor(e){super(`Custom repository ${typeof e=="function"?e.name:e.constructor.name} does not have managed entity. Did you forget to specify entity for it @EntityRepository(MyEntity)? `)}},sa=class extends v{constructor(e){super(`Entity "${e.name}" does not have delete date columns.`)}};var ia=class extends v{constructor(e){super(`Circular relations detected: ${e}. To resolve this issue you need to set nullable: true somewhere in this dependency structure.`)}},Rn=class extends v{constructor(){super("OUTPUT or RETURNING clause only supported by Microsoft SQL Server or PostgreSQL or MariaDB databases.")}};var ra=class extends v{constructor(e){super(`Entity "${e.name}" does not have a primary column. Primary column is required to have in all your entities. Use @PrimaryColumn decorator to add a primary column to your entity.`)}},pt=class a extends v{constructor(e,t){super(e),Object.setPrototypeOf(this,a.prototype),this.message=`Property "${e}" was not found in "${t.targetName}". Make sure your query is correct.`}},aa=class extends v{constructor(e,t=[]){super(`Wrong driver: "${e}" given. Supported drivers are: ${t.map(n=>`"${n}"`).join(", ")}.`)}},xn=class extends v{constructor(e,t){super(`${e} package has not been found installed. Try to install it: npm install ${t} --save`)}};var oa=class extends v{constructor(e){super(`Entity ${e} does not have version or update date columns.`)}},ca=class extends v{constructor(){super('Cannot perform insert query because values are not defined. Call "qb.values(...)" method to specify inserted values.')}},bn=class extends v{constructor(){super("The optimistic lock can be used only with getOne() method.")}};var Ft=class extends v{constructor(e){super(`Driver option (${e}) is not set. Please set it to perform connection to the database.`)}},la=class extends v{constructor(e){super(),e.length===1?this.message=`Relation "${e[0]}" was not found; please check if it is correct and really exists in your entity.`:this.message=`Relations ${e.map(t=>`"${t}"`).join(", ")} were not found; please check if relations are correct and they exist in your entities.`}};var ua=class extends v{constructor(){super("An open transaction is required for pessimistic lock.")}};var ha=class extends v{constructor(e,t,n){super();let s=typeof t=="string"?t:t.name;this.message=`Data type "${s}" in "${e.entityMetadata.targetName}.${e.propertyName}" is not supported by "${n}" database.`}},da=class extends v{constructor(e){super(`Array initializations are not allowed in entity relations. Please remove array initialization (= []) from "${e.entityMetadata.targetName}#${e.propertyPath}". This is ORM requirement to make relations to work properly. Refer docs for more information.`)}};var Sn=class extends v{constructor(e,t,n){if(super(n.toString().replace(/^error: /,"").replace(/^Error: /,"").replace(/^Request/,"")),this.query=e,this.parameters=t,this.driverError=n,n){let s=n,{name:i}=s,r=Tr(s,["name"]);ne.assign(this,oe({},r))}}},fa=class extends v{constructor(){super("Entity manager is not using single database connection and cannot be released. Only entity managers created by connection#createEntityManagerWithSingleDatabaseConnection methods have a single database connection and they should be released.")}};var pa=class extends v{constructor(e){super(`Removed entity "${e.metadata.name}" is also scheduled for update operation. Make sure you are not updating and removing same object (note that update or remove may be executed by cascade operations).`)}};var ma=class extends v{constructor(e,t){super(`Column type for ${e.constructor.name}#${t} is not defined and cannot be guessed. Make sure you have turned on an "emitDecoratorMetadata": true option in tsconfig.json. Also make sure you have imported "reflect-metadata" on top of the main entry file in your application (before any entity imported).If you are using JavaScript instead of TypeScript you must explicitly provide a column type.`)}},Mn=class extends v{constructor(){super("Query runner already released. Cannot run queries anymore.")}},ya=class extends v{constructor(){super("RDBMS does not support OFFSET without LIMIT in SELECT statements. You must use limit in conjunction with offset function (or take in conjunction with skip function if you are using pagination).")}},zt=class extends v{constructor(e){super(`Cannot execute operation on "${e}" connection because connection is not yet established.`)}},ga=class extends v{constructor(e){super(`Option "${e}" is not set in your connection options, please define "${e}" option in your connection options or ormconfig.json`)}};var ft=class{static sha1(e){let t=function(J,re){return J<<re|J>>>32-re},n=function(J){let re="",le,ue;for(le=7;le>=0;le--)ue=J>>>le*4&15,re+=ue.toString(16);return re},s,i,r,o=new Array(80),c=1732584193,l=4023233417,u=2562383102,h=271733878,d=3285377520,f,p,m,x,S,G;e=encodeURIComponent(e);let D=e.length,q=[];for(i=0;i<D-3;i+=4)r=e.charCodeAt(i)<<24|e.charCodeAt(i+1)<<16|e.charCodeAt(i+2)<<8|e.charCodeAt(i+3),q.push(r);switch(D%4){case 0:i=2147483648;break;case 1:i=e.charCodeAt(D-1)<<24|8388608;break;case 2:i=e.charCodeAt(D-2)<<24|e.charCodeAt(D-1)<<16|32768;break;case 3:i=e.charCodeAt(D-3)<<24|e.charCodeAt(D-2)<<16|e.charCodeAt(D-1)<<8|128;break}for(q.push(i);q.length%16!==14;)q.push(0);for(q.push(D>>>29),q.push(D<<3&4294967295),s=0;s<q.length;s+=16){for(i=0;i<16;i++)o[i]=q[s+i];for(i=16;i<=79;i++)o[i]=t(o[i-3]^o[i-8]^o[i-14]^o[i-16],1);for(f=c,p=l,m=u,x=h,S=d,i=0;i<=19;i++)G=t(f,5)+(p&m|~p&x)+S+o[i]+1518500249&4294967295,S=x,x=m,m=t(p,30),p=f,f=G;for(i=20;i<=39;i++)G=t(f,5)+(p^m^x)+S+o[i]+1859775393&4294967295,S=x,x=m,m=t(p,30),p=f,f=G;for(i=40;i<=59;i++)G=t(f,5)+(p&m|p&x|m&x)+S+o[i]+2400959708&4294967295,S=x,x=m,m=t(p,30),p=f,f=G;for(i=60;i<=79;i++)G=t(f,5)+(p^m^x)+S+o[i]+3395469782&4294967295,S=x,x=m,m=t(p,30),p=f,f=G;c=c+f&4294967295,l=l+p&4294967295,u=u+m&4294967295,h=h+x&4294967295,d=d+S&4294967295}return G=n(c)+n(l)+n(u)+n(h)+n(d),G.toLowerCase()}};function Gr(a,e=!1){return a.replace(/^([A-Z])|[\s-_](\w)/g,function(t,n,s,i){return e===!0&&i===0?n:s?s.toUpperCase():n.toLowerCase()})}function Uc(a){return a.replace(/([A-Z])([A-Z])([a-z])/g,"$1_$2$3").replace(/([a-z0-9])([A-Z])/g,"$1_$2").toLowerCase()}function sh(a){return a.replace(/\w\S*/g,e=>e.charAt(0).toUpperCase()+e.substr(1).toLowerCase())}function Gc(a,e={}){let{segmentLength:t=4,separator:n="__",termLength:s=2}=e;return a.split(n).reduce((o,c)=>{let l=c.replace(/([a-z\xE0-\xFF])([A-Z\xC0-\xDF])/g,"$1 $2").split(" "),u=l.length>1?s:t,h=l.map(d=>d.substr(0,u)).join("");return o.push(h),o},[]).join(n)}var ba=class{constructor(){this.nestedSetColumnNames={left:"nsleft",right:"nsright"},this.materializedPathColumnName="mpath"}getTableName(e){return typeof e!="string"&&(e=e.name),e.split(".").pop()}tableName(e,t){return t||Uc(e)}closureJunctionTableName(e){return e+"_closure"}columnName(e,t,n){let s=t||e;return n.length?Gr(n.join("_"))+sh(s):s}relationName(e){return e}primaryKeyName(e,t){let n=[...t];n.sort();let r=`${this.getTableName(e).replace(".","_")}_${n.join("_")}`;return"PK_"+ft.sha1(r).substr(0,27)}uniqueConstraintName(e,t){let n=[...t];n.sort();let r=`${this.getTableName(e).replace(".","_")}_${n.join("_")}`;return"UQ_"+ft.sha1(r).substr(0,27)}relationConstraintName(e,t,n){let s=[...t];s.sort();let o=`${this.getTableName(e).replace(".","_")}_${s.join("_")}`;return n&&(o+=`_${n}`),"REL_"+ft.sha1(o).substr(0,26)}defaultConstraintName(e,t){let i=`${this.getTableName(e).replace(".","_")}_${t}`;return"DF_"+ft.sha1(i).substr(0,27)}foreignKeyName(e,t,n,s){let i=[...t];i.sort();let c=`${this.getTableName(e).replace(".","_")}_${i.join("_")}`;return"FK_"+ft.sha1(c).substr(0,27)}indexName(e,t,n){let s=[...t];s.sort();let o=`${this.getTableName(e).replace(".","_")}_${s.join("_")}`;return n&&(o+=`_${n}`),"IDX_"+ft.sha1(o).substr(0,26)}checkConstraintName(e,t,n){let r=`${this.getTableName(e).replace(".","_")}_${t}`,o="CHK_"+ft.sha1(r).substr(0,26);return n?`${o}_ENUM`:o}exclusionConstraintName(e,t){let i=`${this.getTableName(e).replace(".","_")}_${t}`;return"XCL_"+ft.sha1(i).substr(0,26)}joinColumnName(e,t){return Gr(e+"_"+t)}joinTableName(e,t,n,s){return Uc(e+"_"+n.replace(/\./gi,"_")+"_"+t)}joinTableColumnDuplicationPrefix(e,t){return e+"_"+t}joinTableColumnName(e,t,n){return Gr(e+"_"+(n||t))}joinTableInverseColumnName(e,t,n){return this.joinTableColumnName(e,t,n)}prefixTableName(e,t){return e+t}eagerJoinRelationAlias(e,t){return e+"_"+t.replace(".","_")}},Ht=class a{constructor(e){this["@instanceof"]=Symbol.for("TableColumn"),this.isNullable=!1,this.isGenerated=!1,this.isPrimary=!1,this.isUnique=!1,this.isArray=!1,this.length="",this.zerofill=!1,this.unsigned=!1,e&&(this.name=e.name,this.type=e.type||"",this.length=e.length||"",this.width=e.width,this.charset=e.charset,this.collation=e.collation,this.precision=e.precision,this.scale=e.scale,this.zerofill=e.zerofill||!1,this.unsigned=this.zerofill?!0:e.unsigned||!1,this.default=e.default,this.onUpdate=e.onUpdate,this.isNullable=e.isNullable||!1,this.isGenerated=e.isGenerated||!1,this.generationStrategy=e.generationStrategy,this.generatedIdentity=e.generatedIdentity,this.isPrimary=e.isPrimary||!1,this.isUnique=e.isUnique||!1,this.isArray=e.isArray||!1,this.comment=e.comment,this.enum=e.enum,this.enumName=e.enumName,this.primaryKeyConstraintName=e.primaryKeyConstraintName,this.asExpression=e.asExpression,this.generatedType=e.generatedType,this.spatialFeatureType=e.spatialFeatureType,this.srid=e.srid)}clone(){return new a({name:this.name,type:this.type,length:this.length,width:this.width,charset:this.charset,collation:this.collation,precision:this.precision,scale:this.scale,zerofill:this.zerofill,unsigned:this.unsigned,enum:this.enum,enumName:this.enumName,primaryKeyConstraintName:this.primaryKeyConstraintName,asExpression:this.asExpression,generatedType:this.generatedType,default:this.default,onUpdate:this.onUpdate,isNullable:this.isNullable,isGenerated:this.isGenerated,generationStrategy:this.generationStrategy,generatedIdentity:this.generatedIdentity,isPrimary:this.isPrimary,isUnique:this.isUnique,isArray:this.isArray,comment:this.comment,spatialFeatureType:this.spatialFeatureType,srid:this.srid})}},Lt=class a{constructor(e){this["@instanceof"]=Symbol.for("TableIndex"),this.columnNames=[],this.name=e.name,this.columnNames=e.columnNames,this.isUnique=!!e.isUnique,this.isSpatial=!!e.isSpatial,this.isFulltext=!!e.isFulltext,this.isNullFiltered=!!e.isNullFiltered,this.parser=e.parser,this.where=e.where?e.where:""}clone(){return new a({name:this.name,columnNames:[...this.columnNames],isUnique:this.isUnique,isSpatial:this.isSpatial,isFulltext:this.isFulltext,isNullFiltered:this.isNullFiltered,parser:this.parser,where:this.where})}static create(e){return new a({name:e.name,columnNames:e.columns.map(t=>t.databaseName),isUnique:e.isUnique,isSpatial:e.isSpatial,isFulltext:e.isFulltext,isNullFiltered:e.isNullFiltered,parser:e.parser,where:e.where})}},hs=class a{constructor(e){this["@instanceof"]=Symbol.for("TableForeignKey"),this.columnNames=[],this.referencedColumnNames=[],this.name=e.name,this.columnNames=e.columnNames,this.referencedColumnNames=e.referencedColumnNames,this.referencedDatabase=e.referencedDatabase,this.referencedSchema=e.referencedSchema,this.referencedTableName=e.referencedTableName,this.onDelete=e.onDelete,this.onUpdate=e.onUpdate,this.deferrable=e.deferrable}clone(){return new a({name:this.name,columnNames:[...this.columnNames],referencedColumnNames:[...this.referencedColumnNames],referencedDatabase:this.referencedDatabase,referencedSchema:this.referencedSchema,referencedTableName:this.referencedTableName,onDelete:this.onDelete,onUpdate:this.onUpdate,deferrable:this.deferrable})}static create(e,t){return new a({name:e.name,columnNames:e.columnNames,referencedColumnNames:e.referencedColumnNames,referencedDatabase:e.referencedEntityMetadata.database,referencedSchema:e.referencedEntityMetadata.schema,referencedTableName:e.referencedTablePath,onDelete:e.onDelete,onUpdate:e.onUpdate,deferrable:e.deferrable})}},Nn=class{static createTableColumnOptions(e,t){return{name:e.databaseName,length:t.getColumnLength(e),width:e.width,charset:e.charset,collation:e.collation,precision:e.precision,scale:e.scale,zerofill:e.zerofill,unsigned:e.unsigned,asExpression:e.asExpression,generatedType:e.generatedType,default:t.normalizeDefault(e),onUpdate:e.onUpdate,comment:e.comment,isGenerated:e.isGenerated,generationStrategy:e.generationStrategy,generatedIdentity:e.generatedIdentity,isNullable:e.isNullable,type:t.normalizeType(e),isPrimary:e.isPrimary,isUnique:t.normalizeIsUnique(e),isArray:e.isArray||!1,enum:e.enum?e.enum.map(n=>n+""):e.enum,enumName:e.enumName,primaryKeyConstraintName:e.primaryKeyConstraintName,spatialFeatureType:e.spatialFeatureType,srid:e.srid}}},Kt=class a{constructor(e){this["@instanceof"]=Symbol.for("TableUnique"),this.columnNames=[],this.name=e.name,this.columnNames=e.columnNames,this.deferrable=e.deferrable}clone(){return new a({name:this.name,columnNames:[...this.columnNames],deferrable:this.deferrable})}static create(e){return new a({name:e.name,columnNames:e.columns.map(t=>t.databaseName),deferrable:e.deferrable})}},An=class a{constructor(e){this["@instanceof"]=Symbol.for("TableCheck"),this.columnNames=[],this.name=e.name,this.columnNames=e.columnNames,this.expression=e.expression}clone(){return new a({name:this.name,columnNames:this.columnNames?[...this.columnNames]:[],expression:this.expression})}static create(e){return new a({name:e.name,expression:e.expression})}},ds=class a{constructor(e){this["@instanceof"]=Symbol.for("TableExclusion"),this.name=e.name,this.expression=e.expression}clone(){return new a({name:this.name,expression:this.expression})}static create(e){return new a({name:e.name,expression:e.expression})}},St=class a{constructor(e){this["@instanceof"]=Symbol.for("Table"),this.columns=[],this.indices=[],this.foreignKeys=[],this.uniques=[],this.checks=[],this.exclusions=[],this.justCreated=!1,this.withoutRowid=!1,e&&(this.database=e.database,this.schema=e.schema,this.name=e.name,e.columns&&(this.columns=e.columns.map(t=>new Ht(t))),e.indices&&(this.indices=e.indices.map(t=>new Lt(t))),e.foreignKeys&&(this.foreignKeys=e.foreignKeys.map(t=>new hs(je(oe({},t),{referencedDatabase:t?.referencedDatabase||e.database,referencedSchema:t?.referencedSchema||e.schema})))),e.uniques&&(this.uniques=e.uniques.map(t=>new Kt(t))),e.checks&&(this.checks=e.checks.map(t=>new An(t))),e.exclusions&&(this.exclusions=e.exclusions.map(t=>new ds(t))),e.justCreated!==void 0&&(this.justCreated=e.justCreated),e.withoutRowid&&(this.withoutRowid=e.withoutRowid),this.engine=e.engine)}get primaryColumns(){return this.columns.filter(e=>e.isPrimary)}clone(){return new a({schema:this.schema,database:this.database,name:this.name,columns:this.columns.map(e=>e.clone()),indices:this.indices.map(e=>e.clone()),foreignKeys:this.foreignKeys.map(e=>e.clone()),uniques:this.uniques.map(e=>e.clone()),checks:this.checks.map(e=>e.clone()),exclusions:this.exclusions.map(e=>e.clone()),justCreated:this.justCreated,withoutRowid:this.withoutRowid,engine:this.engine})}addColumn(e){this.columns.push(e)}removeColumn(e){let t=this.columns.find(n=>n.name===e.name);t&&this.columns.splice(this.columns.indexOf(t),1)}addUniqueConstraint(e){if(this.uniques.push(e),e.columnNames.length===1){let t=this.columns.find(n=>n.name===e.columnNames[0]);t&&(t.isUnique=!0)}}removeUniqueConstraint(e){let t=this.uniques.find(n=>n.name===e.name);if(t&&(this.uniques.splice(this.uniques.indexOf(t),1),t.columnNames.length===1)){let n=this.columns.find(s=>s.name===t.columnNames[0]);n&&(n.isUnique=!1)}}addCheckConstraint(e){this.checks.push(e)}removeCheckConstraint(e){let t=this.checks.find(n=>n.name===e.name);t&&this.checks.splice(this.checks.indexOf(t),1)}addExclusionConstraint(e){this.exclusions.push(e)}removeExclusionConstraint(e){let t=this.exclusions.find(n=>n.name===e.name);t&&this.exclusions.splice(this.exclusions.indexOf(t),1)}addForeignKey(e){this.foreignKeys.push(e)}removeForeignKey(e){let t=this.foreignKeys.find(n=>n.name===e.name);t&&this.foreignKeys.splice(this.foreignKeys.indexOf(t),1)}addIndex(e,t=!1){if(this.indices.push(e),e.columnNames.length===1&&e.isUnique&&t){let n=this.columns.find(s=>s.name===e.columnNames[0]);n&&(n.isUnique=!0)}}removeIndex(e,t=!1){let n=this.indices.find(s=>s.name===e.name);if(n&&(this.indices.splice(this.indices.indexOf(n),1),n.columnNames.length===1&&n.isUnique&&t)){let s=this.columns.find(i=>i.name===n.columnNames[0]);s&&(s.isUnique=this.indices.some(i=>i.columnNames.length===1&&i.columnNames[0]===s.name&&!!n.isUnique))}}findColumnByName(e){return this.columns.find(t=>t.name===e)}findColumnIndices(e){return this.indices.filter(t=>!!t.columnNames.find(n=>n===e.name))}findColumnForeignKeys(e){return this.foreignKeys.filter(t=>!!t.columnNames.find(n=>n===e.name))}findColumnUniques(e){return this.uniques.filter(t=>!!t.columnNames.find(n=>n===e.name))}findColumnChecks(e){return this.checks.filter(t=>!!t.columnNames.find(n=>n===e.name))}static create(e,t){let n=e.database===t.database?void 0:e.database,s=e.schema===t.options.schema?void 0:e.schema,i={database:e.database,schema:e.schema,name:t.buildTableName(e.tableName,s,n),withoutRowid:e.withoutRowid,engine:e.engine,columns:e.columns.filter(r=>r&&!r.isVirtualProperty).map(r=>Nn.createTableColumnOptions(r,t)),indices:e.indices.filter(r=>r.synchronize===!0).map(r=>Lt.create(r)),uniques:e.uniques.map(r=>Kt.create(r)),checks:e.checks.map(r=>An.create(r)),exclusions:e.exclusions.map(r=>ds.create(r))};return new a(i)}},yi=class{constructor(e,t,n,s){this.id=e,this.timestamp=t,this.name=n,this.instance=s}},rs=class{constructor(e,t){this.connection=e,this.queryRunner=t,this.transaction="all";let{schema:n}=this.connection.driver.options,s=this.connection.driver.database;this.migrationsDatabase=s,this.migrationsSchema=n,this.migrationsTableName=e.options.migrationsTableName||"migrations",this.migrationsTable=this.connection.driver.buildTableName(this.migrationsTableName,n,s)}async executeMigration(e){return this.withQueryRunner(async t=>{await this.createMigrationsTableIfNotExist(t);let n=this.connection.driver.createSchemaBuilder();return $.isRdbmsSchemaBuilder(n)&&await n.createMetadataTableIfNecessary(t),await t.beforeMigration(),await e.instance.up(t),await t.afterMigration(),await this.insertExecutedMigration(t,e),e})}async getAllMigrations(){return Promise.resolve(this.getMigrations())}async getExecutedMigrations(){return this.withQueryRunner(async e=>(await this.createMigrationsTableIfNotExist(e),await this.loadExecutedMigrations(e)))}async getPendingMigrations(){let e=await this.getAllMigrations(),t=await this.getExecutedMigrations();return e.filter(n=>!t.find(s=>s.name===n.name))}insertMigration(e){return this.withQueryRunner(t=>this.insertExecutedMigration(t,e))}deleteMigration(e){return this.withQueryRunner(t=>this.deleteExecutedMigration(t,e))}async showMigrations(){let e=!1,t=this.queryRunner||this.connection.createQueryRunner();await this.createMigrationsTableIfNotExist(t);let n=await this.loadExecutedMigrations(t),s=this.getMigrations();for(let i of s)n.find(o=>o.name===i.name)?this.connection.logger.logSchemaBuild(`[X] ${i.name}`):(e=!0,this.connection.logger.logSchemaBuild(`[ ] ${i.name}`));return this.queryRunner||await t.release(),e}async executePendingMigrations(){let e=this.queryRunner||this.connection.createQueryRunner();await this.createMigrationsTableIfNotExist(e);let t=this.connection.driver.createSchemaBuilder();$.isRdbmsSchemaBuilder(t)&&await t.createMetadataTableIfNecessary(e);let n=await this.loadExecutedMigrations(e),s=this.getLatestTimestampMigration(n),i=this.getMigrations(),r=[],o=i.filter(l=>!n.find(h=>h.name===l.name));if(!o.length)return this.connection.logger.logSchemaBuild("No migrations are pending"),this.queryRunner||await e.release(),[];this.connection.logger.logSchemaBuild(`${n.length} migrations are already loaded in the database.`),this.connection.logger.logSchemaBuild(`${i.length} migrations were found in the source code.`),s&&this.connection.logger.logSchemaBuild(`${s.name} is the last executed migration. It was executed on ${new Date(s.timestamp).toString()}.`),this.connection.logger.logSchemaBuild(`${o.length} migrations are new migrations must be executed.`);let c=!1;this.transaction==="all"&&!e.isTransactionActive&&(await e.startTransaction(),c=!0);try{for(let l of o){if(this.fake){await this.insertExecutedMigration(e,l);continue}this.transaction==="each"&&!e.isTransactionActive&&(await e.startTransaction(),c=!0),await l.instance.up(e).catch(u=>{throw this.connection.logger.logMigration(`Migration "${l.name}" failed, error: ${u?.message}`),u}).then(async()=>{await this.insertExecutedMigration(e,l),this.transaction==="each"&&c&&await e.commitTransaction()}).then(()=>{r.push(l),this.connection.logger.logSchemaBuild(`Migration ${l.name} has been ${this.fake?"(fake)":""} executed successfully.`)})}this.transaction==="all"&&c&&await e.commitTransaction()}catch(l){if(c)try{await e.rollbackTransaction()}catch{}throw l}finally{this.queryRunner||await e.release()}return r}async undoLastMigration(){let e=this.queryRunner||this.connection.createQueryRunner();await this.createMigrationsTableIfNotExist(e);let t=this.connection.driver.createSchemaBuilder();$.isRdbmsSchemaBuilder(t)&&await t.createMetadataTableIfNecessary(e);let n=await this.loadExecutedMigrations(e),s=this.getLatestExecutedMigration(n);if(!s){this.connection.logger.logSchemaBuild("No migrations was found in the database. Nothing to revert!");return}let r=this.getMigrations().find(c=>c.name===s.name);if(!r)throw new v(`No migration ${s.name} was found in the source code. Make sure you have this migration in your codebase and its included in the connection options.`);this.connection.logger.logSchemaBuild(`${n.length} migrations are already loaded in the database.`),this.connection.logger.logSchemaBuild(`${s.name} is the last executed migration. It was executed on ${new Date(s.timestamp).toString()}.`),this.connection.logger.logSchemaBuild("Now reverting it...");let o=!1;this.transaction!=="none"&&!e.isTransactionActive&&(await e.startTransaction(),o=!0);try{this.fake||(await e.beforeMigration(),await r.instance.down(e),await e.afterMigration()),await this.deleteExecutedMigration(e,r),this.connection.logger.logSchemaBuild(`Migration ${r.name} has been ${this.fake?"(fake)":""} reverted successfully.`),o&&await e.commitTransaction()}catch(c){if(o)try{await e.rollbackTransaction()}catch{}throw c}finally{this.queryRunner||await e.release()}}async createMigrationsTableIfNotExist(e){if(this.connection.driver.options.type==="mongodb")return;await e.hasTable(this.migrationsTable)||await e.createTable(new St({database:this.migrationsDatabase,schema:this.migrationsSchema,name:this.migrationsTable,columns:[{name:"id",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.migrationId}),isGenerated:!0,generationStrategy:"increment",isPrimary:!0,isNullable:!1},{name:"timestamp",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.migrationTimestamp}),isPrimary:!1,isNullable:!1},{name:"name",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.migrationName}),isNullable:!1}]}))}async loadExecutedMigrations(e){if(this.connection.driver.options.type!=="mongodb")return(await this.connection.manager.createQueryBuilder(e).select().orderBy(this.connection.driver.escape("id"),"DESC").from(this.migrationsTable,this.migrationsTableName).getRawMany()).map(n=>new yi(parseInt(n.id),parseInt(n.timestamp),n.name))}getMigrations(){let e=this.connection.migrations.map(t=>{let n=t.name||t.constructor.name,s=parseInt(n.substr(-13),10);if(!s||isNaN(s))throw new v(`${n} migration name is wrong. Migration class name should have a JavaScript timestamp appended.`);return new yi(void 0,s,n,t)});return this.checkForDuplicateMigrations(e),e.sort((t,n)=>t.timestamp-n.timestamp)}checkForDuplicateMigrations(e){let t=e.map(s=>s.name),n=Array.from(new Set(t.filter((s,i)=>t.indexOf(s)<i)));if(n.length>0)throw Error(`Duplicate migrations: ${n.join(", ")}`)}getLatestTimestampMigration(e){let t=e.map(n=>n).sort((n,s)=>(n.timestamp-s.timestamp)*-1);return t.length>0?t[0]:void 0}getLatestExecutedMigration(e){return e.length>0?e[0]:void 0}async insertExecutedMigration(e,t){let n={};this.connection.driver.options.type==="mssql"||(n.timestamp=t.timestamp,n.name=t.name),this.connection.driver.options.type==="mongodb"||await e.manager.createQueryBuilder().insert().into(this.migrationsTable).values(n).execute()}async deleteExecutedMigration(e,t){let n={};if(this.connection.driver.options.type==="mssql"||(n.timestamp=t.timestamp,n.name=t.name),this.connection.driver.options.type!=="mongodb"){let s=e.manager.createQueryBuilder();await s.delete().from(this.migrationsTable).where(`${s.escape("timestamp")} = :timestamp`).andWhere(`${s.escape("name")} = :name`).setParameters(n).execute()}}async withQueryRunner(e){let t=this.queryRunner||this.connection.createQueryRunner();try{return e(t)}finally{this.queryRunner||await t.release()}}};function oi(a,e,t){let n=[],s={};return function i(r){s[r]=!0,n.push(r),a[r].forEach(function(o){if(!s[o])i(o);else if(n.indexOf(o)>=0)throw n.push(o),new v(`Dependency Cycle Found: ${n.join(" -> ")}`)}),n.pop(),(!e||a[r].length===0)&&t.indexOf(r)===-1&&t.push(r)}}var wa=class{constructor(){this.nodes={},this.outgoingEdges={},this.incomingEdges={}}addNode(e,t){this.hasNode(e)||(arguments.length===2?this.nodes[e]=t:this.nodes[e]=e,this.outgoingEdges[e]=[],this.incomingEdges[e]=[])}removeNode(e){this.hasNode(e)&&(delete this.nodes[e],delete this.outgoingEdges[e],delete this.incomingEdges[e],[this.incomingEdges,this.outgoingEdges].forEach(function(t){Object.keys(t).forEach(function(n){let s=t[n].indexOf(e);s>=0&&t[n].splice(s,1)},this)}))}hasNode(e){return this.nodes.hasOwnProperty(e)}getNodeData(e){if(this.hasNode(e))return this.nodes[e];throw new v(`Node does not exist: ${e}`)}setNodeData(e,t){if(this.hasNode(e))this.nodes[e]=t;else throw new v(`Node does not exist: ${e}`)}addDependency(e,t){if(!this.hasNode(e))throw new v(`Node does not exist: ${e}`);if(!this.hasNode(t))throw new v(`Node does not exist: ${t}`);return this.outgoingEdges[e].indexOf(t)===-1&&this.outgoingEdges[e].push(t),this.incomingEdges[t].indexOf(e)===-1&&this.incomingEdges[t].push(e),!0}removeDependency(e,t){let n;this.hasNode(e)&&(n=this.outgoingEdges[e].indexOf(t),n>=0&&this.outgoingEdges[e].splice(n,1)),this.hasNode(t)&&(n=this.incomingEdges[t].indexOf(e),n>=0&&this.incomingEdges[t].splice(n,1))}dependenciesOf(e,t){if(this.hasNode(e)){let n=[];oi(this.outgoingEdges,t,n)(e);let i=n.indexOf(e);return i>=0&&n.splice(i,1),n}else throw new v(`Node does not exist: ${e}`)}dependantsOf(e,t){if(this.hasNode(e)){let n=[];oi(this.incomingEdges,t,n)(e);let i=n.indexOf(e);return i>=0&&n.splice(i,1),n}else throw new v(`Node does not exist: ${e}`)}overallOrder(e){let t=this,n=[],s=Object.keys(this.nodes);if(s.length===0)return n;{let i=oi(this.outgoingEdges,!1,[]);s.forEach(function(o){i(o)});let r=oi(this.outgoingEdges,e,n);return s.filter(function(o){return t.incomingEdges[o].length===0}).forEach(function(o){r(o)}),n}}},Ea=class{static isGreaterOrEqual(e,t){let n=Vc(e),s=Vc(t);return n[0]>s[0]||n[0]===s[0]&&n[1]>s[1]||n[0]===s[0]&&n[1]===s[1]&&n[2]>=s[2]}};function Vc(a=""){let e=[0,0,0];return a.split(".").forEach((t,n)=>e[n]=parseInt(t,10)),e}var L=class{static isSQLiteFamily(e){return["sqlite","cordova","react-native","nativescript","sqljs","expo","better-sqlite3","capacitor"].includes(e.options.type)}static isMySQLFamily(e){return["mysql","mariadb"].includes(e.options.type)}static isReleaseVersionOrGreater(e,t){return e.version!=null&&Ea.isGreaterOrEqual(e.version,t)}static isPostgresFamily(e){return["postgres","aurora-postgres"].includes(e.options.type)}static buildDriverOptions(e,t){if(e.url){let n=this.parseConnectionUrl(e.url);t&&t.useSid&&n.database&&(n.sid=n.database);for(let s of Object.keys(n))typeof n[s]>"u"&&delete n[s];return Object.assign({},e,n)}return Object.assign({},e)}static buildMongoDBDriverOptions(e,t){if(e.url){let n=this.parseMongoDBConnectionUrl(e.url);t&&t.useSid&&n.database&&(n.sid=n.database);for(let s of Object.keys(n))typeof n[s]>"u"&&delete n[s];return Object.assign({},e,n)}return Object.assign({},e)}static buildAlias({maxAliasLength:e},t,...n){typeof t=="string"?(n.unshift(t),t={shorten:!1,joiner:"_"}):t=Object.assign({shorten:!1,joiner:"_"},t);let s=n.length===1?n[0]:n.join(t.joiner);if(e&&e>0&&s.length>e){if(t.shorten===!0){let i=Gc(s);if(i.length<e)return i}return void 0}return s}static buildColumnAlias({maxAliasLength:e},t,...n){return this.buildAlias({maxAliasLength:e},t,...n)}static parseConnectionUrl(e){let t=e.split(":")[0],n=e.indexOf("//"),s=e.substr(n+2),i=s.indexOf("/"),r=i!==-1?s.substr(0,i):s,o=i!==-1?s.substr(i+1):void 0;o&&o.indexOf("?")!==-1&&(o=o.substr(0,o.indexOf("?")));let c=r.lastIndexOf("@"),l=r.substr(0,c),u=r.substr(c+1),h=l,d="",f=l.indexOf(":");f!==-1&&(h=l.substr(0,f),d=l.substr(f+1));let[p,m]=u.split(":");return{type:t,host:p,username:decodeURIComponent(h),password:decodeURIComponent(d),port:m?parseInt(m):void 0,database:o||void 0}}static parseMongoDBConnectionUrl(e){let t=e.split(":")[0],n=e.indexOf("//"),s=e.substr(n+2),i=s.indexOf("/"),r=i!==-1?s.substr(0,i):s,o=i!==-1?s.substr(i+1):void 0,c="",l,u,h,d,f={};if(o&&o.indexOf("?")!==-1){c=o.substr(o.indexOf("?")+1,o.length);let J=c.split("&"),re,le;J.forEach(ue=>{re=ue.split("=")[0],le=ue.split("=")[1],f[re]=le}),d=f.replicaSet,o=o.substr(0,o.indexOf("?"))}let p=r.lastIndexOf("@"),m=r.substr(0,p),x=r.substr(p+1),S=m,G="",D=m.indexOf(":");D!==-1&&(S=m.substr(0,D),G=m.substr(D+1)),d?h=x:[l,u]=x.split(":");let q={type:t,host:l,hostReplicaSet:h,username:decodeURIComponent(S),password:decodeURIComponent(G),port:u?parseInt(u):void 0,database:o||void 0};for(let[J,re]of Object.entries(f))q[J]=re;return q}},Ta=class{validateMany(e,t){e.forEach(n=>this.validate(n,e,t)),this.validateDependencies(e),this.validateEagerRelations(e)}validate(e,t,n){if(!e.primaryColumns.length&&!e.isJunction)throw new ra(e);if(e.primaryColumns.length>1&&!e.primaryColumns.every((r,o,c)=>r.primaryKeyConstraintName===c[0].primaryKeyConstraintName))throw new v(`Entity ${e.name} has multiple primary columns with different constraint names. Constraint names should be the equal.`);if(e.inheritancePattern==="STI"||e.tableType==="entity-child"){if(!e.discriminatorColumn)throw new v(`Entity ${e.name} using single-table inheritance, it should also have a discriminator column. Did you forget to put discriminator column options?`);if(typeof e.discriminatorValue>"u")throw new v(`Entity ${e.name} has an undefined discriminator value. Discriminator value should be defined.`);let i=t.find(r=>r!==e&&(r.inheritancePattern==="STI"||r.tableType==="entity-child")&&r.tableName===e.tableName&&r.discriminatorValue===e.discriminatorValue&&r.inheritanceTree.some(o=>e.inheritanceTree.indexOf(o)!==-1));if(i)throw new v(`Entities ${e.name} and ${i.name} have the same discriminator values. Make sure they are different while using the @ChildEntity decorator.`)}if(e.relationCounts.forEach(i=>{if(i.relation.isManyToOne||i.relation.isOneToOne)throw new v("Relation count can not be implemented on ManyToOne or OneToOne relations.")}),n.options.type!=="mongodb"&&e.columns.filter(i=>!i.isVirtualProperty).forEach(i=>{let r=n.normalizeType(i);if(n.supportedDataTypes.indexOf(r)===-1)throw new ha(i,r,n.options.type);if(i.length&&n.withLengthColumnTypes.indexOf(r)===-1)throw new v(`Column ${i.propertyName} of Entity ${e.name} does not support length property.`);if(i.type==="enum"&&!i.enum&&!i.enumName)throw new v(`Column "${i.propertyName}" of Entity "${e.name}" is defined as enum, but missing "enum" or "enumName" properties.`)}),(L.isMySQLFamily(n)||n.options.type==="aurora-mysql")&&e.columns.filter(r=>r.isGenerated&&r.generationStrategy!=="uuid").length>1)throw new v(`Error in ${e.name} entity. There can be only one auto-increment column in MySql table.`);if(L.isMySQLFamily(n)&&t.filter(r=>r.database).length===0&&!n.database)throw new ga("database");if(n.options.type==="mssql"&&e.columns.filter(r=>r.charset).length>1)throw new v("Character set specifying is not supported in Sql Server");if(n.options.type==="postgres"){let i=e.columns.find(r=>r.asExpression&&(!r.generatedType||r.generatedType==="VIRTUAL"));if(i)throw new v(`Column "${i.propertyName}" of Entity "${e.name}" is defined as VIRTUAL, but Postgres supports only STORED generated columns.`)}let s=e.create(void 0,{fromDeserializer:!0});e.relations.forEach(i=>{if(i.isManyToMany||i.isOneToMany){if(i.persistenceEnabled===!1)return;let r=i.getEntityValue(s);if(Array.isArray(r))throw new da(i)}}),e.relations.forEach(i=>{}),e.relations.forEach(i=>{if(i.isCascadeRemove&&i.inverseRelation&&i.inverseRelation.isCascadeRemove)throw new v(`Relation ${e.name}#${i.propertyName} and ${i.inverseRelation.entityMetadata.name}#${i.inverseRelation.propertyName} both has cascade remove set. This may lead to unexpected circular removals. Please set cascade remove only from one side of relationship.`)}),e.eagerRelations.forEach(i=>{})}validateDependencies(e){let t=new wa;e.forEach(n=>{t.addNode(n.name)}),e.forEach(n=>{n.relationsWithJoinColumns.filter(s=>!s.isNullable).forEach(s=>{t.addDependency(n.name,s.inverseEntityMetadata.name)})});try{t.overallOrder()}catch(n){throw new ia(n.toString().replace("Error: Dependency Cycle Found: ",""))}}validateEagerRelations(e){e.forEach(t=>{t.eagerRelations.forEach(n=>{if(n.inverseRelation&&n.inverseRelation.isEager)throw new v(`Circular eager relations are disallowed. ${t.targetName}#${n.propertyPath} contains "eager: true", and its inverse side ${n.inverseEntityMetadata.targetName}#${n.inverseRelation.propertyPath} contains "eager: true" as well. Remove "eager: true" from one side of the relation.`)})})}},Le=class a{static isFindOneOptions(e){let t=e;return t&&(Array.isArray(t.select)||Array.isArray(t.relations)||typeof t.select=="object"||typeof t.relations=="object"||typeof t.where=="object"||typeof t.join=="object"||typeof t.order=="object"||typeof t.cache=="object"||typeof t.cache=="boolean"||typeof t.cache=="number"||typeof t.comment=="string"||typeof t.lock=="object"||typeof t.loadRelationIds=="object"||typeof t.loadRelationIds=="boolean"||typeof t.loadEagerRelations=="boolean"||typeof t.withDeleted=="boolean"||typeof t.relationLoadStrategy=="string"||typeof t.transaction=="boolean")}static isFindManyOptions(e){let t=e;return t&&(this.isFindOneOptions(t)||typeof t.skip=="number"||typeof t.take=="number"||typeof t.skip=="string"||typeof t.take=="string")}static extractFindManyOptionsAlias(e){if(this.isFindManyOptions(e)&&e.join)return e.join.alias}static applyOptionsToTreeQueryBuilder(e,t){if(t?.relations){let n=[...t.relations];if(a.applyRelationsRecursively(e,n,e.expressionMap.mainAlias.name,e.expressionMap.mainAlias.metadata,""),n.length>0)throw new la(n)}return e}static applyRelationsRecursively(e,t,n,s,i){let r=[];if(i){let o=new RegExp("^"+i.replace(".","\\.")+"\\.");r=t.filter(c=>c.match(o)).map(c=>c.replace(o,"")).filter(c=>s.findRelationWithPropertyPath(c))}else r=t.filter(o=>s.findRelationWithPropertyPath(o));r.forEach(o=>{let c=L.buildAlias(e.connection.driver,{joiner:"__"},n,o),l=n+"."+o;e.leftJoinAndSelect(l,c),t.splice(t.indexOf(i?i+"."+o:o),1);let u=e.expressionMap.joinAttributes.find(d=>d.entityOrProperty===l);this.applyRelationsRecursively(e,t,u.alias.name,u.metadata,i?i+"."+o:o);let h=s.relations.find(d=>d.propertyName===o);h&&this.joinEagerRelations(e,c,h.inverseEntityMetadata)})}static joinEagerRelations(e,t,n){n.eagerRelations.forEach(s=>{let i=L.buildAlias(e.connection.driver,e.connection.namingStrategy.eagerJoinRelationAlias(t,s.propertyPath)),r=!0;for(let c of e.expressionMap.joinAttributes)if(!(c.condition!==void 0||c.mapToProperty!==void 0||c.isMappingMany!==void 0||c.direction!=="LEFT"||c.entityOrProperty!==`${t}.${s.propertyPath}`)){r=!1,i=c.alias.name;break}r&&e.leftJoin(t+"."+s.propertyPath,i);let o=!0;for(let c of e.expressionMap.selects)if(!(c.aliasName!==void 0||c.virtual!==void 0||c.selection!==i)){o=!1;break}o&&e.addSelect(i),this.joinEagerRelations(e,i,s.inverseEntityMetadata)})}},wn=class a{static createRelationMaps(e,t,n,s){return s.map(i=>{let r=t.treeParentRelation.joinColumns[0],o=r.givenDatabaseName||r.databaseName,c=i[n+"_"+t.primaryColumns[0].databaseName],l=i[n+"_"+o];return{id:e.connection.driver.prepareHydratedValue(c,t.primaryColumns[0]),parentId:e.connection.driver.prepareHydratedValue(l,r)}})}static buildChildrenEntityTree(e,t,n,s,i){let r=e.treeChildrenRelation.propertyName;if(i.depth===0){t[r]=[];return}let o=e.primaryColumns[0].getEntityValue(t),c=s.filter(u=>u.parentId===o),l=new Set(c.map(u=>u.id));t[r]=n.filter(u=>l.has(e.primaryColumns[0].getEntityValue(u))),t[r].forEach(u=>{a.buildChildrenEntityTree(e,u,n,s,je(oe({},i),{depth:i.depth-1}))})}static buildParentEntityTree(e,t,n,s){let i=e.treeParentRelation.propertyName,r=e.primaryColumns[0].getEntityValue(t),o=s.find(l=>l.id===r),c=n.find(l=>o?e.primaryColumns[0].getEntityValue(l)===o.parentId:!1);c&&(t[i]=c,a.buildParentEntityTree(e,t[i],n,s))}},gi=class{get metadata(){return this.manager.connection.getMetadata(this.target)}constructor(e,t,n){this.target=e,this.manager=t,this.queryRunner=n}createQueryBuilder(e,t){return this.manager.createQueryBuilder(this.metadata.target,e||this.metadata.targetName,t||this.queryRunner)}hasId(e){return this.manager.hasId(this.metadata.target,e)}getId(e){return this.manager.getId(this.metadata.target,e)}create(e){return this.manager.create(this.metadata.target,e)}merge(e,...t){return this.manager.merge(this.metadata.target,e,...t)}preload(e){return this.manager.preload(this.metadata.target,e)}save(e,t){return this.manager.save(this.metadata.target,e,t)}remove(e,t){return this.manager.remove(this.metadata.target,e,t)}softRemove(e,t){return this.manager.softRemove(this.metadata.target,e,t)}recover(e,t){return this.manager.recover(this.metadata.target,e,t)}insert(e){return this.manager.insert(this.metadata.target,e)}update(e,t){return this.manager.update(this.metadata.target,e,t)}upsert(e,t){return this.manager.upsert(this.metadata.target,e,t)}delete(e){return this.manager.delete(this.metadata.target,e)}softDelete(e){return this.manager.softDelete(this.metadata.target,e)}restore(e){return this.manager.restore(this.metadata.target,e)}count(e){return this.manager.count(this.metadata.target,e)}countBy(e){return this.manager.countBy(this.metadata.target,e)}async find(e){return this.manager.find(this.metadata.target,e)}async findBy(e){return this.manager.findBy(this.metadata.target,e)}findAndCount(e){return this.manager.findAndCount(this.metadata.target,e)}findAndCountBy(e){return this.manager.findAndCountBy(this.metadata.target,e)}async findByIds(e){return this.manager.findByIds(this.metadata.target,e)}async findOne(e){return this.manager.findOne(this.metadata.target,e)}async findOneBy(e){return this.manager.findOneBy(this.metadata.target,e)}async findOneById(e){return this.manager.findOneById(this.metadata.target,e)}async findOneOrFail(e){return this.manager.findOneOrFail(this.metadata.target,e)}async findOneByOrFail(e){return this.manager.findOneByOrFail(this.metadata.target,e)}query(e,t){return this.manager.query(e,t)}clear(){return this.manager.clear(this.metadata.target)}increment(e,t,n){return this.manager.increment(this.metadata.target,e,t,n)}decrement(e,t,n){return this.manager.decrement(this.metadata.target,e,t,n)}extend(e){let t=this.constructor,{target:n,manager:s,queryRunner:i}=this,r=new class extends t{}(n,s,i);return Object.assign(r,e),r}},Ca=class extends gi{async findTrees(e){let t=await this.findRoots(e);return await Promise.all(t.map(n=>this.findDescendantsTree(n,e))),t}findRoots(e){let t=o=>this.manager.connection.driver.escape(o),n=o=>this.manager.connection.driver.escape(o),s=this.metadata.treeParentRelation.joinColumns[0],i=s.givenDatabaseName||s.databaseName,r=this.createQueryBuilder("treeEntity");return Le.applyOptionsToTreeQueryBuilder(r,e),r.where(`${t("treeEntity")}.${n(i)} IS NULL`).getMany()}findDescendants(e,t){let n=this.createDescendantsQueryBuilder("treeEntity","treeClosure",e);return Le.applyOptionsToTreeQueryBuilder(n,t),n.getMany()}async findDescendantsTree(e,t){let n=this.createDescendantsQueryBuilder("treeEntity","treeClosure",e);Le.applyOptionsToTreeQueryBuilder(n,t);let s=await n.getRawAndEntities(),i=wn.createRelationMaps(this.manager,this.metadata,"treeEntity",s.raw);return wn.buildChildrenEntityTree(this.metadata,e,s.entities,i,oe({depth:-1},t)),e}countDescendants(e){return this.createDescendantsQueryBuilder("treeEntity","treeClosure",e).getCount()}createDescendantsQueryBuilder(e,t,n){let s=i=>this.manager.connection.driver.escape(i);if(this.metadata.treeType==="closure-table"){let i=this.metadata.closureJunctionTable.descendantColumns.map(c=>s(t)+"."+s(c.propertyPath)+" = "+s(e)+"."+s(c.referencedColumn.propertyPath)).join(" AND "),r={},o=this.metadata.closureJunctionTable.ancestorColumns.map(c=>(r[c.referencedColumn.propertyName]=c.referencedColumn.getEntityValue(n),s(t)+"."+s(c.propertyPath)+" = :"+c.referencedColumn.propertyName)).join(" AND ");return this.createQueryBuilder(e).innerJoin(this.metadata.closureJunctionTable.tableName,t,i).where(o).setParameters(r)}else if(this.metadata.treeType==="nested-set"){let i=e+"."+this.metadata.nestedSetLeftColumn.propertyPath+" BETWEEN joined."+this.metadata.nestedSetLeftColumn.propertyPath+" AND joined."+this.metadata.nestedSetRightColumn.propertyPath,r={},o=this.metadata.treeParentRelation.joinColumns.map(c=>{let l=c.referencedColumn.propertyPath.replace(".","_");return r[l]=c.referencedColumn.getEntityValue(n),"joined."+c.referencedColumn.propertyPath+" = :"+l}).join(" AND ");return this.createQueryBuilder(e).innerJoin(this.metadata.targetName,"joined",i).where(o,r)}else if(this.metadata.treeType==="materialized-path")return this.createQueryBuilder(e).where(i=>{let r=i.subQuery().select(`${this.metadata.targetName}.${this.metadata.materializedPathColumn.propertyPath}`,"path").from(this.metadata.target,this.metadata.targetName).whereInIds(this.metadata.getEntityIdMap(n));return L.isSQLiteFamily(this.manager.connection.driver)?`${e}.${this.metadata.materializedPathColumn.propertyPath} LIKE ${r.getQuery()} || '%'`:`${e}.${this.metadata.materializedPathColumn.propertyPath} LIKE NULLIF(CONCAT(${r.getQuery()}, '%'), '%')`});throw new v("Supported only in tree entities")}findAncestors(e,t){let n=this.createAncestorsQueryBuilder("treeEntity","treeClosure",e);return Le.applyOptionsToTreeQueryBuilder(n,t),n.getMany()}async findAncestorsTree(e,t){let n=this.createAncestorsQueryBuilder("treeEntity","treeClosure",e);Le.applyOptionsToTreeQueryBuilder(n,t);let s=await n.getRawAndEntities(),i=wn.createRelationMaps(this.manager,this.metadata,"treeEntity",s.raw);return wn.buildParentEntityTree(this.metadata,e,s.entities,i),e}countAncestors(e){return this.createAncestorsQueryBuilder("treeEntity","treeClosure",e).getCount()}createAncestorsQueryBuilder(e,t,n){if(this.metadata.treeType==="closure-table"){let s=this.metadata.closureJunctionTable.ancestorColumns.map(o=>t+"."+o.propertyPath+" = "+e+"."+o.referencedColumn.propertyPath).join(" AND "),i={},r=this.metadata.closureJunctionTable.descendantColumns.map(o=>(i[o.referencedColumn.propertyName]=o.referencedColumn.getEntityValue(n),t+"."+o.propertyPath+" = :"+o.referencedColumn.propertyName)).join(" AND ");return this.createQueryBuilder(e).innerJoin(this.metadata.closureJunctionTable.tableName,t,s).where(r).setParameters(i)}else if(this.metadata.treeType==="nested-set"){let s="joined."+this.metadata.nestedSetLeftColumn.propertyPath+" BETWEEN "+e+"."+this.metadata.nestedSetLeftColumn.propertyPath+" AND "+e+"."+this.metadata.nestedSetRightColumn.propertyPath,i={},r=this.metadata.treeParentRelation.joinColumns.map(o=>{let c=o.referencedColumn.propertyPath.replace(".","_");return i[c]=o.referencedColumn.getEntityValue(n),"joined."+o.referencedColumn.propertyPath+" = :"+c}).join(" AND ");return this.createQueryBuilder(e).innerJoin(this.metadata.targetName,"joined",s).where(r,i)}else if(this.metadata.treeType==="materialized-path")return this.createQueryBuilder(e).where(s=>{let i=s.subQuery().select(`${this.metadata.targetName}.${this.metadata.materializedPathColumn.propertyPath}`,"path").from(this.metadata.target,this.metadata.targetName).whereInIds(this.metadata.getEntityIdMap(n));return L.isSQLiteFamily(this.manager.connection.driver)?`${i.getQuery()} LIKE ${e}.${this.metadata.materializedPathColumn.propertyPath} || '%'`:`${i.getQuery()} LIKE CONCAT(${e}.${this.metadata.materializedPathColumn.propertyPath}, '%')`});throw new v("Supported only in tree entities")}extend(e){let t=this.constructor,{target:n,manager:s,queryRunner:i}=this,r=new class extends t{}(n,s,i);return Object.assign(r,e),r}},Na=class{transform(e,t,n,s=!1){return this.groupAndTransform(e,t,n,s),e}groupAndTransform(e,t,n,s=!1){n.nonVirtualColumns.forEach(i=>{let r=i.getEntityValue(t);r!==void 0&&i.setEntityValue(e,r)}),n.relations.length&&n.relations.forEach(i=>{let r=i.getEntityValue(e),o=i.getEntityValue(t,s);if(o!==void 0)if(i.isOneToMany||i.isManyToMany){if(!Array.isArray(o))return;r||(r=[],i.setEntityValue(e,r)),o.forEach(c=>{let l=r.find(u=>i.inverseEntityMetadata.compareEntities(c,u));l||(l=i.inverseEntityMetadata.create(void 0,{fromDeserializer:!0}),r.push(l)),this.groupAndTransform(l,c,i.inverseEntityMetadata,s)})}else{if(!ne.isObject(o)){ne.isObject(r)||i.setEntityValue(e,o);return}r||(r=i.inverseEntityMetadata.create(void 0,{fromDeserializer:!0}),i.setEntityValue(e,r)),this.groupAndTransform(r,o,i.inverseEntityMetadata,s)}})}},va=class{constructor(e,t,n,s){this.plainEntity=e,this.metadata=t,this.parentLoadMapItem=n,this.relation=s}get target(){return this.metadata.target}get id(){return this.metadata.getEntityIdMixedMap(this.plainEntity)}},Ra=class{constructor(){this.loadMapItems=[]}get mainLoadMapItem(){return this.loadMapItems.find(e=>!e.relation&&!e.parentLoadMapItem)}addLoadMap(e){this.loadMapItems.find(n=>n.target===e.target&&n.id===e.id)||this.loadMapItems.push(e)}fillEntities(e,t){t.forEach(n=>{let s=this.loadMapItems.find(i=>i.target===e&&i.metadata.compareEntities(n,i.plainEntity));s&&(s.entity=n)})}groupByTargetIds(){let e=[];return this.loadMapItems.forEach(t=>{let n=e.find(s=>s.target===t.target);n||(n={target:t.target,ids:[]},e.push(n)),n.ids.push(t.id)}),e}},xa=class{constructor(e){this.manager=e}async transform(e,t){if(!t.hasAllPrimaryKeys(e))return Promise.reject("Given object does not have a primary column, cannot transform it to database entity.");let n=new Ra,s=(i,r,o,c)=>{let l=new va(i,r,o,c);n.addLoadMap(l),r.extractRelationValuesFromEntity(i,t.relations).filter(u=>u!=null).forEach(([u,h,d])=>s(h,d,l,u))};return s(e,t),await Promise.all(n.groupByTargetIds().map(i=>this.manager.findByIds(i.target,i.ids).then(r=>n.fillEntities(i.target,r)))),n.loadMapItems.forEach(i=>{!i.relation||!i.entity||!i.parentLoadMapItem||!i.parentLoadMapItem.entity||(i.relation.isManyToMany||i.relation.isOneToMany?(i.parentLoadMapItem.entity[i.relation.propertyName]||(i.parentLoadMapItem.entity[i.relation.propertyName]=[]),i.parentLoadMapItem.entity[i.relation.propertyName].push(i.entity)):i.parentLoadMapItem.entity[i.relation.propertyName]=i.entity)}),n.mainLoadMapItem?n.mainLoadMapItem.entity:void 0}},Sa=class{get repository(){let e=this.getCustomRepositoryTarget(this);if(!e)throw new is(this.constructor);return this.manager.getRepository(e)}get treeRepository(){let e=this.getCustomRepositoryTarget(this);if(!e)throw new is(this.constructor);return this.manager.getTreeRepository(e)}createQueryBuilder(e){let t=this.getCustomRepositoryTarget(this.constructor);if(!t)throw new is(this.constructor);return this.manager.getRepository(t).createQueryBuilder(e)}createQueryBuilderFor(e,t){return this.getRepositoryFor(e).createQueryBuilder(t)}getRepositoryFor(e){return this.manager.getRepository(e)}getTreeRepositoryFor(e){return this.manager.getTreeRepository(e)}getCustomRepositoryTarget(e){let t=ze().entityRepositories.find(n=>n.target===(typeof e=="function"?e:e.constructor));if(!t)throw new ui(e);return t.entity}},bi=class{constructor(e){this.subjects=[...e],this.metadatas=this.getUniqueMetadatas(this.subjects)}sort(e){if(!this.metadatas.length)return this.subjects;let t=[];if(e==="delete"){let o=this.subjects.filter(c=>!c.entity&&!c.databaseEntity);t.push(...o),this.removeAlreadySorted(o)}let n=this.getNonNullableDependencies(),s=this.toposort(n);e==="insert"&&(s=s.reverse()),s.forEach(o=>{let c=this.subjects.filter(l=>l.metadata.targetName===o||l.metadata.parentEntityMetadata?.targetName===o);t.push(...c),this.removeAlreadySorted(c)});let i=this.getDependencies(),r=this.toposort(i);return e==="insert"&&(r=r.reverse()),r.forEach(o=>{let c=this.subjects.filter(l=>l.metadata.targetName===o);t.push(...c),this.removeAlreadySorted(c)}),t.push(...this.subjects),t}removeAlreadySorted(e){e.forEach(t=>{this.subjects.splice(this.subjects.indexOf(t),1)})}getUniqueMetadatas(e){let t=[];return e.forEach(n=>{t.indexOf(n.metadata)===-1&&t.push(n.metadata)}),t}getNonNullableDependencies(){return this.metadatas.reduce((e,t)=>(t.relationsWithJoinColumns.forEach(n=>{n.isNullable||e.push([t.targetName,n.inverseEntityMetadata.targetName])}),e),[])}getDependencies(){return this.metadatas.reduce((e,t)=>(t.relationsWithJoinColumns.forEach(n=>{n.inverseEntityMetadata!==t&&e.push([t.targetName,n.inverseEntityMetadata.targetName])}),e),[])}toposort(e){function t(l){let u=[];for(let h=0,d=l.length;h<d;h++){let f=l[h];u.indexOf(f[0])<0&&u.push(f[0]),u.indexOf(f[1])<0&&u.push(f[1])}return u}let n=t(e),s=n.length,i=new Array(s),r={},o=s;for(;o--;)r[o]||c(n[o],o,[]);function c(l,u,h){if(h.indexOf(l)>=0)throw new v("Cyclic dependency: "+JSON.stringify(l));if(!~n.indexOf(l))throw new v("Found unknown node. Make sure to provided all involved nodes. Unknown node: "+JSON.stringify(l));if(r[u])return;r[u]=!0;let d=e.filter(function(f){return f[0]===l});if(u=d.length){let f=h.concat(l);do{let p=d[--u][1];c(p,n.indexOf(p),f)}while(u)}i[--s]=l}return i}},Ne=class{static normalizeHydratedDate(e){return e&&(typeof e=="string"?new Date(e):e)}static mixedDateToDateString(e){return e instanceof Date?this.formatZerolessValue(e.getFullYear(),4)+"-"+this.formatZerolessValue(e.getMonth()+1)+"-"+this.formatZerolessValue(e.getDate()):e}static mixedDateToDate(e,t=!1,n=!0){let s=typeof e=="string"?Ac(e):e;return t&&(s=new Date(s.getUTCFullYear(),s.getUTCMonth(),s.getUTCDate(),s.getUTCHours(),s.getUTCMinutes(),s.getUTCSeconds(),s.getUTCMilliseconds())),n||s.setUTCMilliseconds(0),s}static mixedDateToTimeString(e,t=!1){return e instanceof Date?this.formatZerolessValue(e.getHours())+":"+this.formatZerolessValue(e.getMinutes())+(t?"":":"+this.formatZerolessValue(e.getSeconds())):e}static mixedTimeToDate(e){if(typeof e=="string"){let[t,n,s]=e.split(":"),i=new Date;return t&&i.setHours(parseInt(t)),n&&i.setMinutes(parseInt(n)),s&&i.setSeconds(parseInt(s)),i}return e}static mixedTimeToString(e,t=!1){return e=e instanceof Date?e.getHours()+":"+e.getMinutes()+(t?"":":"+e.getSeconds()):e,typeof e=="string"?e.split(":").map(n=>n.length===1?"0"+n:n).join(":"):e}static mixedDateToDatetimeString(e,t){if(typeof e=="string"&&(e=new Date(e)),e instanceof Date){let n=this.formatZerolessValue(e.getFullYear(),4)+"-"+this.formatZerolessValue(e.getMonth()+1)+"-"+this.formatZerolessValue(e.getDate())+" "+this.formatZerolessValue(e.getHours())+":"+this.formatZerolessValue(e.getMinutes())+":"+this.formatZerolessValue(e.getSeconds());t&&(n+=`.${this.formatMilliseconds(e.getMilliseconds())}`),e=n}return e}static mixedDateToUtcDatetimeString(e){return typeof e=="string"&&(e=new Date(e)),e instanceof Date?this.formatZerolessValue(e.getUTCFullYear(),4)+"-"+this.formatZerolessValue(e.getUTCMonth()+1)+"-"+this.formatZerolessValue(e.getUTCDate())+" "+this.formatZerolessValue(e.getUTCHours())+":"+this.formatZerolessValue(e.getUTCMinutes())+":"+this.formatZerolessValue(e.getUTCSeconds())+"."+this.formatMilliseconds(e.getUTCMilliseconds()):e}static simpleArrayToString(e){return Array.isArray(e)?e.map(t=>String(t)).join(","):e}static stringToSimpleArray(e){return typeof e=="string"?e.length>0?e.split(","):[]:e}static simpleJsonToString(e){return JSON.stringify(e)}static stringToSimpleJson(e){return typeof e=="string"?JSON.parse(e):e}static simpleEnumToString(e){return""+e}static stringToSimpleEnum(e,t){return t.enum&&!isNaN(e)&&t.enum.indexOf(parseInt(e))>=0&&(e=parseInt(e)),e}static formatZerolessValue(e,t=2){return`${"0".repeat(t)}${e}`.slice(-t)}static formatMilliseconds(e){return e<10?"00"+e:e<100?"0"+e:String(e)}},ce=class a{static chunk(e,t){return Array.from(Array(Math.ceil(e.length/t)),(n,s)=>e.slice(s*t,s*t+t))}static splitClassesAndStrings(e){return[e.filter(t=>typeof t!="string"),e.filter(t=>typeof t=="string")]}static groupBy(e,t){return e.reduce((n,s)=>{let i=t(s),r=n.find(o=>o.id===i);return r||(r={id:i,items:[]},n.push(r)),r.items.push(s),n},[])}static uniq(e,t){return e.reduce((n,s)=>{let i=!1;if(typeof t=="function"){let r=t(s);i=!!n.find(o=>t(o)===r)}else typeof t=="string"?i=!!n.find(r=>r[t]===s[t]):i=n.indexOf(s)!==-1;return i||n.push(s),n},[])}static isPlainObject(e){return e==null?!1:!e.constructor||e.constructor===Object}static mergeArrayKey(e,t,n,s){if(s.has(n)){e[t]=s.get(n);return}if(!(n instanceof Promise)){if(!this.isPlainObject(n)&&!Array.isArray(n)){e[t]=n;return}e[t]||(e[t]=Array.isArray(n)?[]:{}),s.set(n,e[t]),this.merge(e[t],n,s),s.delete(n)}}static mergeObjectKey(e,t,n,s){if(s.has(n)){Object.assign(e,{[t]:s.get(n)});return}if(!(n instanceof Promise)){if(!this.isPlainObject(n)&&!Array.isArray(n)){Object.assign(e,{[t]:n});return}e[t]||Object.assign(e,{[t]:Array.isArray(n)?[]:{}}),s.set(n,e[t]),this.merge(e[t],n,s),s.delete(n)}}static merge(e,t,n=new Map){if(this.isPlainObject(e)&&this.isPlainObject(t))for(let s of Object.keys(t))s!=="__proto__"&&this.mergeObjectKey(e,s,t[s],n);if(Array.isArray(e)&&Array.isArray(t))for(let s=0;s<t.length;s++)this.mergeArrayKey(e,s,t[s],n)}static mergeDeep(e,...t){if(!t.length)return e;for(let n of t)a.merge(e,n);return e}static deepCompare(...e){let t,n,s,i;if(arguments.length<1)return!0;for(t=1,n=arguments.length;t<n;t++)if(s=[],i=[],!this.compare2Objects(s,i,arguments[0],arguments[t]))return!1;return!0}static deepValue(e,t){let n=t.split(".");for(let s=0,i=n.length;s<i;s++)e=e[n[s]];return e}static replaceEmptyObjectsWithBooleans(e){for(let t in e)e[t]&&typeof e[t]=="object"&&(Object.keys(e[t]).length===0?e[t]=!0:this.replaceEmptyObjectsWithBooleans(e[t]))}static propertyPathsToTruthyObject(e){let t={};for(let n of e){let s=n.split(".");if(!s.length)continue;(!t[s[0]]||t[s[0]]===!0)&&(t[s[0]]={});let i=t[s[0]];for(let[r,o]of s.entries())r!==0&&(i[o]?i=i[o]:r===s.length-1?(i[o]={},i=null):(i[o]={},i=i[o]))}return this.replaceEmptyObjectsWithBooleans(t),t}static compareIds(e,t){return e==null||t===void 0||t===null?!1:(typeof e.id=="string"&&typeof t.id=="string"||typeof e.id=="number"&&typeof t.id=="number")&&Object.keys(e).length===1&&Object.keys(t).length===1?e.id===t.id:a.deepCompare(e,t)}static toBoolean(e){return typeof e=="boolean"?e:typeof e=="string"?e==="true"||e==="1":typeof e=="number"?e>0:!1}static zipObject(e,t){return e.reduce((n,s,i)=>(n[s]=t[i],n),{})}static isArraysEqual(e,t){return e.length!==t.length?!1:e.every(n=>t.indexOf(n)!==-1)}static areMutuallyExclusive(...e){return!e.some(n=>{let s=e.filter(i=>i!==n);return n.some(i=>s.some(r=>r.includes(i)))})}static compare2Objects(e,t,n,s){let i;if(Number.isNaN(n)&&Number.isNaN(s)||n===s)return!0;if(n===null||s===null||n===void 0||s===void 0)return!1;if((typeof n.equals=="function"||typeof n.equals=="function")&&n.equals(s))return!0;if(typeof n=="function"&&typeof s=="function"||n instanceof Date&&s instanceof Date||n instanceof RegExp&&s instanceof RegExp||typeof n=="string"&&typeof s=="string"||typeof n=="number"&&typeof s=="number")return n.toString()===s.toString();if(!(typeof n=="object"&&typeof s=="object")||n.isPrototypeOf(s)||s.isPrototypeOf(n)||n.constructor!==s.constructor||n.prototype!==s.prototype||e.indexOf(n)>-1||t.indexOf(s)>-1)return!1;for(i in s){if(s.hasOwnProperty(i)!==n.hasOwnProperty(i))return!1;if(typeof s[i]!=typeof n[i])return!1}for(i in n){if(s.hasOwnProperty(i)!==n.hasOwnProperty(i))return!1;if(typeof s[i]!=typeof n[i])return!1;switch(typeof n[i]){case"object":case"function":if(e.push(n),t.push(s),!this.compare2Objects(e,t,n[i],s[i]))return!1;e.pop(),t.pop();break;default:if(n[i]!==s[i])return!1;break}}return!0}},Bt=class{static transformFrom(e,t){return Array.isArray(e)?e.slice().reverse().reduce((s,i)=>i.from(s),t):e.from(t)}static transformTo(e,t){return Array.isArray(e)?e.reduce((n,s)=>s.to(n),t):e.to(t)}},Ma=class{compute(e){e.forEach(t=>{this.computeDiffColumns(t),this.computeDiffRelationalColumns(e,t)})}computeDiffColumns(e){e.entity&&e.metadata.columns.forEach(t=>{if(t.isVirtual||t.isDiscriminator)return;let n=e.changeMaps.find(i=>i.column===t);n&&e.changeMaps.splice(e.changeMaps.indexOf(n),1);let s=t.getEntityValue(e.entity);if(s!==void 0){if(e.databaseEntity){let i=t.type!=="json"&&t.type!=="jsonb",r=t.getEntityValue(e.databaseEntity,i);if(t.relationMetadata){let c=t.relationMetadata.getEntityValue(e.entity);if(c!=null)return}let o=s;if(s!==null){switch(t.type){case"date":o=Ne.mixedDateToDateString(s);break;case"time":case"time with time zone":case"time without time zone":case"timetz":o=Ne.mixedDateToTimeString(s);break;case"datetime":case"datetime2":case Date:case"timestamp":case"timestamp without time zone":case"timestamp with time zone":case"timestamp with local time zone":case"timestamptz":o=Ne.mixedDateToUtcDatetimeString(s),r=Ne.mixedDateToUtcDatetimeString(r);break;case"json":case"jsonb":if(ce.deepCompare(s,r))return;break;case"simple-array":o=Ne.simpleArrayToString(s),r=Ne.simpleArrayToString(r);break;case"simple-enum":o=Ne.simpleEnumToString(s),r=Ne.simpleEnumToString(r);break;case"simple-json":o=Ne.simpleJsonToString(s),r=Ne.simpleJsonToString(r);break}t.transformer&&(o=Bt.transformTo(t.transformer,s))}if(o===r)return}e.diffColumns.push(t),e.changeMaps.push({column:t,value:s})}})}computeDiffRelationalColumns(e,t){t.entity&&t.metadata.relationsWithJoinColumns.forEach(n=>{let s=n.getEntityValue(t.entity);if(s===void 0)return;if(t.databaseEntity){let o=s;o!==null&&ne.isObject(o)&&(o=n.getRelationIdMap(o));let c=n.getEntityValue(t.databaseEntity);if(ce.compareIds(o,c))return;t.diffRelations.push(n)}let i=e.find(o=>o.mustBeInserted&&o.entity===s);i&&(s=i);let r=t.changeMaps.find(o=>o.relation===n);r?r.value=s:t.changeMaps.push({relation:n,value:s})})}},Yt=class{constructor(){this.count=0,this.promises=[]}async wait(){return this.promises.length>0&&await Promise.all(this.promises),this}},wi=class extends v{constructor(){super("Nested sets do not support multiple root entities.")}};var as=class{constructor(e){this.queryRunner=e}async insert(e){let t=l=>this.queryRunner.connection.driver.escape(l),n=this.getTableName(e.metadata.tablePath),s=t(e.metadata.nestedSetLeftColumn.databaseName),i=t(e.metadata.nestedSetRightColumn.databaseName),r=e.metadata.treeParentRelation.getEntityValue(e.entity);!r&&e.parentSubject&&e.parentSubject.entity&&(r=e.parentSubject.insertedValueSet?e.parentSubject.insertedValueSet:e.parentSubject.entity);let o=e.metadata.getEntityIdMap(r),c;if(o&&(c=await this.queryRunner.manager.createQueryBuilder().select(e.metadata.targetName+"."+e.metadata.nestedSetRightColumn.propertyPath,"right").from(e.metadata.target,e.metadata.targetName).whereInIds(o).getRawOne().then(l=>{let u=l?l.right:void 0;return typeof u=="string"?parseInt(u):u})),c!==void 0)await this.queryRunner.query(`UPDATE ${n} SET ${s} = CASE WHEN ${s} > ${c} THEN ${s} + 2 ELSE ${s} END,${i} = ${i} + 2 WHERE ${i} >= ${c}`),ce.mergeDeep(e.insertedValueSet,e.metadata.nestedSetLeftColumn.createValueMap(c),e.metadata.nestedSetRightColumn.createValueMap(c+1));else{if(!await this.isUniqueRootEntity(e,r))throw new wi;ce.mergeDeep(e.insertedValueSet,e.metadata.nestedSetLeftColumn.createValueMap(1),e.metadata.nestedSetRightColumn.createValueMap(2))}}async update(e){let t=e.metadata.treeParentRelation.getEntityValue(e.entity);!t&&e.parentSubject&&e.parentSubject.entity&&(t=e.parentSubject.entity);let n=e.databaseEntity;if(!n&&t&&(n=e.metadata.treeChildrenRelation.getEntityValue(t).find(o=>Object.entries(e.identifier).every(([c,l])=>o[c]===l))),n===void 0||t===void 0)return;let s=e.metadata.treeParentRelation.getEntityValue(n),i=e.metadata.getEntityIdMap(s),r=e.metadata.getEntityIdMap(t);if(!ce.compareIds(i,r)){if(t){let o=p=>this.queryRunner.connection.driver.escape(p),c=this.getTableName(e.metadata.tablePath),l=o(e.metadata.nestedSetLeftColumn.databaseName),u=o(e.metadata.nestedSetRightColumn.databaseName),h=e.metadata.getEntityIdMap(n),d;h&&(d=(await this.getNestedSetIds(e.metadata,h))[0]);let f;if(r&&(f=(await this.getNestedSetIds(e.metadata,r))[0]),d!==void 0&&f!==void 0){let p=f.left>d.left,m=d.right-d.left+1,x;p?x=f.left-d.right:x=f.right-d.left;let S=`WHEN ${l} >= ${d.left} AND ${l} < ${d.right} THEN ${l} + ${x} `,G=`WHEN ${u} > ${d.left} AND ${u} <= ${d.right} THEN ${u} + ${x} `;p?await this.queryRunner.query(`UPDATE ${c} SET ${l} = CASE WHEN ${l} > ${d.right} AND ${l} <= ${f.left} THEN ${l} - ${m} `+S+`ELSE ${l} END, ${u} = CASE WHEN ${u} > ${d.right} AND ${u} < ${f.left} THEN ${u} - ${m} `+G+`ELSE ${u} END`):await this.queryRunner.query(`UPDATE ${c} SET ${l} = CASE WHEN ${l} < ${d.left} AND ${l} > ${f.right} THEN ${l} + ${m} `+S+`ELSE ${l} END, ${u} = CASE WHEN ${u} < ${d.left} AND ${u} >= ${f.right} THEN ${u} + ${m} `+G+`ELSE ${u} END`)}}else if(!await this.isUniqueRootEntity(e,t))throw new wi}}async remove(e){Array.isArray(e)||(e=[e]);let t=e[0].metadata,n=l=>this.queryRunner.connection.driver.escape(l),s=this.getTableName(t.tablePath),i=n(t.nestedSetLeftColumn.databaseName),r=n(t.nestedSetRightColumn.databaseName),o=[];for(let l of e){let u=t.getEntityIdMap(l.entity);u&&o.push(u)}let c=await this.getNestedSetIds(t,o);for(let l of c){let u=l.right-l.left+1;await this.queryRunner.query(`UPDATE ${s} SET ${i} = CASE WHEN ${i} > ${l.left} THEN ${i} - ${u} ELSE ${i} END, ${r} = CASE WHEN ${r} > ${l.right} THEN ${r} - ${u} ELSE ${r} END`)}}getNestedSetIds(e,t){let n={left:`${e.targetName}.${e.nestedSetLeftColumn.propertyPath}`,right:`${e.targetName}.${e.nestedSetRightColumn.propertyPath}`},s=this.queryRunner.manager.createQueryBuilder();return Object.entries(n).forEach(([i,r])=>{s.addSelect(r,i)}),s.from(e.target,e.targetName).whereInIds(t).orderBy(n.right,"DESC").getRawMany().then(i=>{let r=[];for(let o of i){let c={};for(let l of Object.keys(n)){let u=o?o[l]:void 0;c[l]=typeof u=="string"?parseInt(u):u}r.push(c)}return r})}async isUniqueRootEntity(e,t){let n=l=>this.queryRunner.connection.driver.escape(l),s=this.getTableName(e.metadata.tablePath),i=[],r=e.metadata.treeParentRelation.joinColumns.map(l=>{let u=n(l.databaseName),h=l.getEntityValue(t);if(h==null)return`${u} IS NULL`;i.push(h);let d=this.queryRunner.connection.driver.createParameter("entity_"+l.databaseName,i.length-1);return`${u} = ${d}`}).join(" AND "),o="count",c=await this.queryRunner.query(`SELECT COUNT(1) AS ${n(o)} FROM ${s} WHERE ${r}`,i,!0);return parseInt(c.records[0][o])===0}getTableName(e){return e.split(".").map(t=>t===""?t:this.queryRunner.connection.driver.escape(t)).join(".")}},os=class{constructor(e){this.queryRunner=e}async insert(e){let t={};e.metadata.closureJunctionTable.ancestorColumns.forEach(s=>{t[s.databaseName]=e.identifier}),e.metadata.closureJunctionTable.descendantColumns.forEach(s=>{t[s.databaseName]=e.identifier}),await this.queryRunner.manager.createQueryBuilder().insert().into(e.metadata.closureJunctionTable.tablePath).values(t).updateEntity(!1).callListeners(!1).execute();let n=e.metadata.treeParentRelation.getEntityValue(e.entity);if(!n&&e.parentSubject&&e.parentSubject.entity&&(n=e.parentSubject.insertedValueSet?e.parentSubject.insertedValueSet:e.parentSubject.entity),n){let s=h=>this.queryRunner.connection.driver.escape(h),i=this.getTableName(e.metadata.closureJunctionTable.tablePath),r=[],o=e.metadata.closureJunctionTable.ancestorColumns.map(h=>s(h.databaseName)),c=e.metadata.closureJunctionTable.descendantColumns.map(h=>s(h.databaseName)),l=e.metadata.primaryColumns.map(h=>(r.push(h.getEntityValue(e.insertedValueSet?e.insertedValueSet:e.entity)),this.queryRunner.connection.driver.createParameter("child_entity_"+h.databaseName,r.length-1))),u=e.metadata.closureJunctionTable.descendantColumns.map(h=>{let d=s(h.databaseName),f=h.referencedColumn.getEntityValue(n);if(!f)throw new mi(e.metadata.name);r.push(f);let p=this.queryRunner.connection.driver.createParameter("parent_entity_"+h.referencedColumn.databaseName,r.length-1);return`${d} = ${p}`});await this.queryRunner.query(`INSERT INTO ${i} (${[...o,...c].join(", ")}) SELECT ${o.join(", ")}, ${l.join(", ")} FROM ${i} WHERE ${u.join(" AND ")}`,r)}}async update(e){let t=e.metadata.treeParentRelation.getEntityValue(e.entity);!t&&e.parentSubject&&e.parentSubject.entity&&(t=e.parentSubject.entity);let n=e.databaseEntity;if(!n&&t&&(n=e.metadata.treeChildrenRelation.getEntityValue(t).find(f=>Object.entries(e.identifier).every(([p,m])=>f[p]===m))),n===void 0||t===void 0)return;let s=e.metadata.treeParentRelation.getEntityValue(n),i=e.metadata.getEntityIdMap(s),r=e.metadata.getEntityIdMap(t);if(ce.compareIds(i,r))return;let o=f=>this.queryRunner.connection.driver.escape(f),c=e.metadata.closureJunctionTable,l=c.ancestorColumns.map(f=>o(f.databaseName)),u=c.descendantColumns.map(f=>o(f.databaseName)),h=(f,p)=>{let m=`sub${p}`,x=f.createQueryBuilder().select(u.join(", ")).from(c.tablePath,m);for(let S of c.ancestorColumns)x.andWhere(`${o(m)}.${o(S.databaseName)} = :value_${S.referencedColumn.databaseName}`);return f.createQueryBuilder().select(u.join(", ")).from(`(${x.getQuery()})`,p).setParameters(x.getParameters()).getQuery()},d={};for(let f of e.metadata.primaryColumns)d[`value_${f.databaseName}`]=n[f.databaseName];if(await this.queryRunner.manager.createQueryBuilder().delete().from(c.tablePath).where(f=>`(${u.join(", ")}) IN (${h(f,"descendant")})`).andWhere(f=>`(${l.join(", ")}) NOT IN (${h(f,"ancestor")})`).setParameters(d).execute(),t){let f=[],p=this.getTableName(c.tablePath),m=o("supertree"),x=o("subtree"),S=[...l.map(q=>`${m}.${q}`),...u.map(q=>`${x}.${q}`)],G=e.metadata.closureJunctionTable.ancestorColumns.map(q=>{let J=o(q.databaseName),re=q.referencedColumn.getEntityValue(n);f.push(re);let le=this.queryRunner.connection.driver.createParameter("entity_"+q.referencedColumn.databaseName,f.length-1);return`${x}.${J} = ${le}`}),D=e.metadata.closureJunctionTable.descendantColumns.map(q=>{let J=o(q.databaseName),re=q.referencedColumn.getEntityValue(t);if(!re)throw new mi(e.metadata.name);f.push(re);let le=this.queryRunner.connection.driver.createParameter("parent_entity_"+q.referencedColumn.databaseName,f.length-1);return`${m}.${J} = ${le}`});await this.queryRunner.query(`INSERT INTO ${p} (${[...l,...u].join(", ")}) SELECT ${S.join(", ")} FROM ${p} AS ${m}, ${p} AS ${x} WHERE ${[...G,...D].join(" AND ")}`,f)}}async remove(e){if(this.queryRunner.connection.driver.options.type!=="mssql")return;Array.isArray(e)||(e=[e]);let t=c=>this.queryRunner.connection.driver.escape(c),n=e.map(c=>c.identifier),s=e[0].metadata.closureJunctionTable,i=c=>c.map(l=>{let u=n.map(h=>h[l.referencedColumn.databaseName]);return`${t(l.databaseName)} IN (${u.join(", ")})`}).join(" AND "),r=i(s.ancestorColumns),o=i(s.descendantColumns);await this.queryRunner.manager.createQueryBuilder().delete().from(s.tablePath).where(r).orWhere(o).execute()}getTableName(e){return e.split(".").map(t=>t===""?t:this.queryRunner.connection.driver.escape(t)).join(".")}},Ei=class{constructor(e){this.queryRunner=e}async insert(e){let t=e.metadata.treeParentRelation.getEntityValue(e.entity);!t&&e.parentSubject&&e.parentSubject.entity&&(t=e.parentSubject.insertedValueSet?e.parentSubject.insertedValueSet:e.parentSubject.entity);let n=e.metadata.getEntityIdMap(t),s="";n&&(s=await this.getEntityPath(e,n));let i=e.metadata.treeParentRelation.joinColumns.map(r=>r.referencedColumn.getEntityValue(e.insertedValueSet)).join("_");await this.queryRunner.manager.createQueryBuilder().update(e.metadata.target).set({[e.metadata.materializedPathColumn.propertyPath]:s+i+"."}).where(e.identifier).execute()}async update(e){let t=e.metadata.treeParentRelation.getEntityValue(e.entity);!t&&e.parentSubject&&e.parentSubject.entity&&(t=e.parentSubject.entity);let n=e.databaseEntity;!n&&t&&(n=e.metadata.treeChildrenRelation.getEntityValue(t).find(h=>Object.entries(e.identifier).every(([d,f])=>h[d]===f)));let s=e.metadata.treeParentRelation.getEntityValue(n),i=e.metadata.getEntityIdMap(s),r=e.metadata.getEntityIdMap(t);if(ce.compareIds(i,r))return;let o="";r&&(o=await this.getEntityPath(e,r));let c="";i&&(c=await this.getEntityPath(e,i)||"");let l=e.metadata.treeParentRelation.joinColumns.map(h=>h.referencedColumn.getEntityValue(n)).join("_"),u=e.metadata.materializedPathColumn.propertyPath;await this.queryRunner.manager.createQueryBuilder().update(e.metadata.target).set({[u]:()=>`REPLACE(${u}, '${c}${l}.', '${o}${l}.')`}).where(`${u} LIKE :path`,{path:`${c}${l}.%`}).execute()}getEntityPath(e,t){return this.queryRunner.manager.createQueryBuilder().select(e.metadata.targetName+"."+e.metadata.materializedPathColumn.propertyPath,"path").from(e.metadata.target,e.metadata.targetName).whereInIds(t).getRawOne().then(n=>n?n.path:"")}},Aa=class{constructor(e,t,n){this.hasExecutableOperations=!1,this.insertSubjects=[],this.updateSubjects=[],this.removeSubjects=[],this.softRemoveSubjects=[],this.recoverSubjects=[],this.queryRunner=e,this.allSubjects=t,this.options=n,this.validate(),this.recompute()}async execute(){let e;(!this.options||this.options.listeners!==!1)&&(e=this.broadcastBeforeEventsForAll(),e.promises.length>0&&await Promise.all(e.promises)),e&&e.count>0&&(this.insertSubjects.forEach(t=>t.recompute()),this.updateSubjects.forEach(t=>t.recompute()),this.removeSubjects.forEach(t=>t.recompute()),this.softRemoveSubjects.forEach(t=>t.recompute()),this.recoverSubjects.forEach(t=>t.recompute()),this.recompute()),this.insertSubjects=new bi(this.insertSubjects).sort("insert"),await this.executeInsertOperations(),this.updateSubjects=this.allSubjects.filter(t=>t.mustBeUpdated),await this.executeUpdateOperations(),this.removeSubjects=new bi(this.removeSubjects).sort("delete"),await this.executeRemoveOperations(),this.softRemoveSubjects=this.allSubjects.filter(t=>t.mustBeSoftRemoved),await this.executeSoftRemoveOperations(),this.recoverSubjects=this.allSubjects.filter(t=>t.mustBeRecovered),await this.executeRecoverOperations(),await this.updateSpecialColumnsInPersistedEntities(),(!this.options||this.options.listeners!==!1)&&(e=this.broadcastAfterEventsForAll(),e.promises.length>0&&await Promise.all(e.promises))}validate(){this.allSubjects.forEach(e=>{if(e.mustBeUpdated&&e.mustBeRemoved)throw new pa(e)})}recompute(){new Ma().compute(this.allSubjects),this.insertSubjects=this.allSubjects.filter(e=>e.mustBeInserted),this.updateSubjects=this.allSubjects.filter(e=>e.mustBeUpdated),this.removeSubjects=this.allSubjects.filter(e=>e.mustBeRemoved),this.softRemoveSubjects=this.allSubjects.filter(e=>e.mustBeSoftRemoved),this.recoverSubjects=this.allSubjects.filter(e=>e.mustBeRecovered),this.hasExecutableOperations=this.insertSubjects.length>0||this.updateSubjects.length>0||this.removeSubjects.length>0||this.softRemoveSubjects.length>0||this.recoverSubjects.length>0}broadcastBeforeEventsForAll(){let e=new Yt;return this.insertSubjects.length&&this.insertSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastBeforeInsertEvent(e,t.metadata,t.entity)),this.updateSubjects.length&&this.updateSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastBeforeUpdateEvent(e,t.metadata,t.entity,t.databaseEntity,t.diffColumns,t.diffRelations)),this.removeSubjects.length&&this.removeSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastBeforeRemoveEvent(e,t.metadata,t.entity,t.databaseEntity)),this.softRemoveSubjects.length&&this.softRemoveSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastBeforeSoftRemoveEvent(e,t.metadata,t.entity,t.databaseEntity)),this.recoverSubjects.length&&this.recoverSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastBeforeRecoverEvent(e,t.metadata,t.entity,t.databaseEntity)),e}broadcastAfterEventsForAll(){let e=new Yt;return this.insertSubjects.length&&this.insertSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastAfterInsertEvent(e,t.metadata,t.entity)),this.updateSubjects.length&&this.updateSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastAfterUpdateEvent(e,t.metadata,t.entity,t.databaseEntity,t.diffColumns,t.diffRelations)),this.removeSubjects.length&&this.removeSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastAfterRemoveEvent(e,t.metadata,t.entity,t.databaseEntity)),this.softRemoveSubjects.length&&this.softRemoveSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastAfterSoftRemoveEvent(e,t.metadata,t.entity,t.databaseEntity)),this.recoverSubjects.length&&this.recoverSubjects.forEach(t=>this.queryRunner.broadcaster.broadcastAfterRecoverEvent(e,t.metadata,t.entity,t.databaseEntity)),e}async executeInsertOperations(){let[e,t]=this.groupBulkSubjects(this.insertSubjects,"insert");for(let n of t){let s=e[n],i=[],r=[],o=[];if(this.queryRunner.connection.driver.options.type==="mongodb"?s.forEach(c=>{c.metadata.createDateColumn&&c.entity&&(c.entity[c.metadata.createDateColumn.databaseName]=new Date),c.metadata.updateDateColumn&&c.entity&&(c.entity[c.metadata.updateDateColumn.databaseName]=new Date),c.createValueSetAndPopChangeMap(),r.push(c),i.push(c.entity)}):this.queryRunner.connection.driver.options.type==="oracle"?s.forEach(c=>{o.push(c)}):s.forEach(c=>{c.changeMaps.length===0||c.metadata.treeType||this.queryRunner.connection.driver.options.type==="oracle"||this.queryRunner.connection.driver.options.type==="sap"?o.push(c):(r.push(c),i.push(c.createValueSetAndPopChangeMap()))}),i.length>0){let c=await this.queryRunner.manager.createQueryBuilder().insert().into(s[0].metadata.target).values(i).updateEntity(!(this.options&&this.options.reload===!1)).callListeners(!1).execute();r.forEach((l,u)=>{l.identifier=c.identifiers[u],l.generatedMap=c.generatedMaps[u],l.insertedValueSet=i[u]})}if(o.length>0)for(let c of o)c.insertedValueSet=c.createValueSetAndPopChangeMap(),c.metadata.treeType==="nested-set"&&await new as(this.queryRunner).insert(c),await this.queryRunner.manager.createQueryBuilder().insert().into(c.metadata.target).values(c.insertedValueSet).updateEntity(!(this.options&&this.options.reload===!1)).callListeners(!1).execute().then(l=>{c.identifier=l.identifiers[0],c.generatedMap=l.generatedMaps[0]}),c.metadata.treeType==="closure-table"?await new os(this.queryRunner).insert(c):c.metadata.treeType==="materialized-path"&&await new Ei(this.queryRunner).insert(c);s.forEach(c=>{c.generatedMap&&c.metadata.columns.forEach(l=>{let u=l.getEntityValue(c.generatedMap);if(u!=null){let h=this.queryRunner.connection.driver.prepareHydratedValue(u,l);l.setEntityValue(c.generatedMap,h)}})})}}async executeUpdateOperations(){let e=async i=>{if(!i.identifier)throw new gn(i);{let r=i.createValueSetAndPopChangeMap();switch(i.metadata.treeType){case"nested-set":await new as(this.queryRunner).update(i);break;case"closure-table":await new os(this.queryRunner).update(i);break;case"materialized-path":await new Ei(this.queryRunner).update(i);break}let o=this.queryRunner.manager.createQueryBuilder().update(i.metadata.target).set(r).updateEntity(!(this.options&&this.options.reload===!1)).callListeners(!1);i.entity?o.whereEntity(i.identifier):o.where(i.identifier);let l=(await o.execute()).generatedMaps[0];l&&(i.metadata.columns.forEach(u=>{let h=u.getEntityValue(l);if(h!=null){let d=this.queryRunner.connection.driver.prepareHydratedValue(h,u);u.setEntityValue(l,d)}}),i.generatedMap||(i.generatedMap={}),Object.assign(i.generatedMap,l))}},t=[],n=[];for(let i of this.updateSubjects)i.metadata.treeType==="nested-set"?t.push(i):n.push(i);let s=new Promise(async(i,r)=>{for(let o of t)try{await e(o)}catch(c){r(c)}i()});await Promise.all([...n.map(e),s])}async executeRemoveOperations(){let[e,t]=this.groupBulkSubjects(this.removeSubjects,"delete");for(let n of t){let s=e[n],i=s.map(r=>{if(!r.identifier)throw new gn(r);return r.identifier});switch(s[0].metadata.treeType){case"nested-set":await new as(this.queryRunner).remove(s);break;case"closure-table":await new os(this.queryRunner).remove(s);break}await this.queryRunner.manager.createQueryBuilder().delete().from(s[0].metadata.target).where(i).callListeners(!1).execute()}}cloneMongoSubjectEntity(e){let t={};if(e.entity)for(let n of e.metadata.columns)ce.mergeDeep(t,n.getEntityValueMap(e.entity));return t}async executeSoftRemoveOperations(){await Promise.all(this.softRemoveSubjects.map(async e=>{if(!e.identifier)throw new gn(e);let t;{let n=this.queryRunner.manager.createQueryBuilder().softDelete().from(e.metadata.target).updateEntity(!(this.options&&this.options.reload===!1)).callListeners(!1);e.entity?n.whereEntity(e.identifier):n.where(e.identifier),t=await n.execute()}e.generatedMap=t.generatedMaps[0],e.generatedMap&&e.metadata.columns.forEach(n=>{let s=n.getEntityValue(e.generatedMap);if(s!=null){let i=this.queryRunner.connection.driver.prepareHydratedValue(s,n);n.setEntityValue(e.generatedMap,i)}})}))}async executeRecoverOperations(){await Promise.all(this.recoverSubjects.map(async e=>{if(!e.identifier)throw new gn(e);let t;{let n=this.queryRunner.manager.createQueryBuilder().restore().from(e.metadata.target).updateEntity(!(this.options&&this.options.reload===!1)).callListeners(!1);e.entity?n.whereEntity(e.identifier):n.where(e.identifier),t=await n.execute()}e.generatedMap=t.generatedMaps[0],e.generatedMap&&e.metadata.columns.forEach(n=>{let s=n.getEntityValue(e.generatedMap);if(s!=null){let i=this.queryRunner.connection.driver.prepareHydratedValue(s,n);n.setEntityValue(e.generatedMap,i)}})}))}updateSpecialColumnsInPersistedEntities(){this.insertSubjects.length&&this.updateSpecialColumnsInInsertedAndUpdatedEntities(this.insertSubjects),this.updateSubjects.length&&this.updateSpecialColumnsInInsertedAndUpdatedEntities(this.updateSubjects),this.softRemoveSubjects.length&&this.updateSpecialColumnsInInsertedAndUpdatedEntities(this.softRemoveSubjects),this.recoverSubjects.length&&this.updateSpecialColumnsInInsertedAndUpdatedEntities(this.recoverSubjects),this.removeSubjects.length&&this.removeSubjects.forEach(e=>{e.entity&&e.metadata.primaryColumns.forEach(t=>{t.setEntityValue(e.entity,void 0)})}),this.allSubjects.forEach(e=>{e.entity&&e.metadata.relationIds.forEach(t=>{t.setValue(e.entity)})})}updateSpecialColumnsInInsertedAndUpdatedEntities(e){e.forEach(t=>{t.entity&&(t.metadata.columns.forEach(n=>{t.metadata.childEntityMetadatas.length>0&&t.metadata.childEntityMetadatas.map(s=>s.target).indexOf(n.target)!==-1||n.isVirtual||(n.isNullable&&n.getEntityValue(t.entity)===void 0&&n.setEntityValue(t.entity,null),t.updatedRelationMaps.length>0&&t.updatedRelationMaps.forEach(s=>{s.relation.joinColumns.forEach(i=>{i.isVirtual!==!0&&i.setEntityValue(t.entity,ne.isObject(s.value)?i.referencedColumn.getEntityValue(s.value):s.value)})}))}),t.generatedMap&&this.queryRunner.manager.merge(t.metadata.target,t.entity,t.generatedMap))})}groupBulkSubjects(e,t){let n={},s=[],i=e.some(o=>o.metadata.getInsertionReturningColumns().length>0),r=t==="delete"||this.queryRunner.connection.driver.isReturningSqlSupported("insert")||i===!1;return e.forEach((o,c)=>{let l=r||o.metadata.isJunction?o.metadata.name:o.metadata.name+"_"+c;n[l]?n[l].push(o):(n[l]=[o],s.push(l))}),[n,s]}},at=class{constructor(e){this["@instanceof"]=Symbol.for("Subject"),this.identifier=void 0,this.entityWithFulfilledIds=void 0,this.databaseEntityLoaded=!1,this.changeMaps=[],this.canBeInserted=!1,this.canBeUpdated=!1,this.mustBeRemoved=!1,this.canBeSoftRemoved=!1,this.canBeRecovered=!1,this.updatedRelationMaps=[],this.diffColumns=[],this.diffRelations=[],this.metadata=e.metadata,this.entity=e.entity,this.parentSubject=e.parentSubject,e.canBeInserted!==void 0&&(this.canBeInserted=e.canBeInserted),e.canBeUpdated!==void 0&&(this.canBeUpdated=e.canBeUpdated),e.mustBeRemoved!==void 0&&(this.mustBeRemoved=e.mustBeRemoved),e.canBeSoftRemoved!==void 0&&(this.canBeSoftRemoved=e.canBeSoftRemoved),e.canBeRecovered!==void 0&&(this.canBeRecovered=e.canBeRecovered),e.identifier!==void 0&&(this.identifier=e.identifier),e.changeMaps!==void 0&&this.changeMaps.push(...e.changeMaps),this.recompute()}get mustBeInserted(){return this.canBeInserted&&!this.databaseEntity}get mustBeUpdated(){return this.canBeUpdated&&this.identifier&&(this.databaseEntityLoaded===!1||this.databaseEntityLoaded&&this.databaseEntity)&&this.changeMaps.length>0}get mustBeSoftRemoved(){return this.canBeSoftRemoved&&this.identifier&&(this.databaseEntityLoaded===!1||this.databaseEntityLoaded&&this.databaseEntity)}get mustBeRecovered(){return this.canBeRecovered&&this.identifier&&(this.databaseEntityLoaded===!1||this.databaseEntityLoaded&&this.databaseEntity)}createValueSetAndPopChangeMap(){let e=[],t=this.changeMaps.reduce((n,s)=>{let i=s.value;$.isSubject(i)&&(i=i.insertedValueSet?i.insertedValueSet:i.entity);let r;if(this.metadata.isJunction&&s.column)r=s.column.createValueMap(s.column.referencedColumn.getEntityValue(i));else if(s.column)r=s.column.createValueMap(i);else if(s.relation)if(ne.isObject(i)){let o=s.relation.getRelationIdMap(i);if(o===void 0)return e.push(s),this.canBeUpdated=!0,n;r=s.relation.createValueMap(o),this.updatedRelationMaps.push({relation:s.relation,value:o})}else r=s.relation.createValueMap(i),this.updatedRelationMaps.push({relation:s.relation,value:i});return ce.mergeDeep(n,r),n},{});return this.changeMaps=e,t}recompute(){this.entity?(this.entityWithFulfilledIds=Object.assign({},this.entity),this.parentSubject&&this.metadata.primaryColumns.forEach(e=>{if(e.relationMetadata&&e.relationMetadata.inverseEntityMetadata===this.parentSubject.metadata){let t=e.referencedColumn.getEntityValue(this.parentSubject.entity);e.setEntityValue(this.entityWithFulfilledIds,t)}}),this.identifier=this.metadata.getEntityIdMap(this.entityWithFulfilledIds)):this.databaseEntity&&(this.identifier=this.metadata.getEntityIdMap(this.databaseEntity))}},Zt=class a{constructor(e){this["@instanceof"]=Symbol.for("EntityMetadata"),this.childEntityMetadatas=[],this.inheritanceTree=[],this.tableType="regular",this.withoutRowid=!1,this.synchronize=!0,this.hasNonNullableRelations=!1,this.isJunction=!1,this.isAlwaysUsingConstructor=!0,this.isClosureJunction=!1,this.hasMultiplePrimaryKeys=!1,this.hasUUIDGeneratedColumns=!1,this.ownColumns=[],this.columns=[],this.ancestorColumns=[],this.descendantColumns=[],this.nonVirtualColumns=[],this.ownerColumns=[],this.inverseColumns=[],this.generatedColumns=[],this.primaryColumns=[],this.ownRelations=[],this.relations=[],this.eagerRelations=[],this.lazyRelations=[],this.oneToOneRelations=[],this.ownerOneToOneRelations=[],this.oneToManyRelations=[],this.manyToOneRelations=[],this.manyToManyRelations=[],this.ownerManyToManyRelations=[],this.relationsWithJoinColumns=[],this.relationIds=[],this.relationCounts=[],this.foreignKeys=[],this.embeddeds=[],this.allEmbeddeds=[],this.ownIndices=[],this.indices=[],this.uniques=[],this.ownUniques=[],this.checks=[],this.exclusions=[],this.ownListeners=[],this.listeners=[],this.afterLoadListeners=[],this.beforeInsertListeners=[],this.afterInsertListeners=[],this.beforeUpdateListeners=[],this.afterUpdateListeners=[],this.beforeRemoveListeners=[],this.beforeSoftRemoveListeners=[],this.beforeRecoverListeners=[],this.afterRemoveListeners=[],this.afterSoftRemoveListeners=[],this.afterRecoverListeners=[],this.connection=e.connection,this.inheritanceTree=e.inheritanceTree||[],this.inheritancePattern=e.inheritancePattern,this.treeType=e.tableTree?e.tableTree.type:void 0,this.treeOptions=e.tableTree?e.tableTree.options:void 0,this.parentClosureEntityMetadata=e.parentClosureEntityMetadata,this.tableMetadataArgs=e.args,this.target=this.tableMetadataArgs.target,this.tableType=this.tableMetadataArgs.type,this.expression=this.tableMetadataArgs.expression,this.withoutRowid=this.tableMetadataArgs.withoutRowid,this.dependsOn=this.tableMetadataArgs.dependsOn}create(e,t){let n=!!(t&&t.pojo===!0),s;return typeof this.target=="function"&&!n?!t?.fromDeserializer||this.isAlwaysUsingConstructor?s=new this.target:s=Object.create(this.target.prototype):s={},this.connection.options.typename&&(s[this.connection.options.typename]=this.targetName),this.lazyRelations.forEach(i=>this.connection.relationLoader.enableLazyLoad(i,s,e)),s}hasId(e){return e?this.primaryColumns.every(t=>{let n=t.getEntityValue(e);return n!=null&&n!==""}):!1}hasAllPrimaryKeys(e){return this.primaryColumns.every(t=>{let n=t.getEntityValue(e);return n!=null})}ensureEntityIdMap(e){if(ne.isObject(e))return e;if(this.hasMultiplePrimaryKeys)throw new Kr(this,e);return this.primaryColumns[0].createValueMap(e)}getEntityIdMap(e){if(e)return a.getValueMap(e,this.primaryColumns,{skipNulls:!0})}getEntityIdMixedMap(e){if(!e)return e;let t=this.getEntityIdMap(e);return this.hasMultiplePrimaryKeys?t:t&&this.primaryColumns[0].getEntityValue(t)}compareEntities(e,t){let n=this.getEntityIdMap(e);if(!n)return!1;let s=this.getEntityIdMap(t);return s?ce.compareIds(n,s):!1}findColumnWithPropertyName(e){return this.columns.find(t=>t.propertyName===e)}findColumnWithDatabaseName(e){return this.columns.find(t=>t.databaseName===e)}hasColumnWithPropertyPath(e){return this.columns.some(n=>n.propertyPath===e)||this.hasRelationWithPropertyPath(e)}findColumnWithPropertyPath(e){let t=this.columns.find(s=>s.propertyPath===e);if(t)return t;let n=this.relations.find(s=>s.propertyPath===e);if(n&&n.joinColumns.length===1)return n.joinColumns[0]}findColumnWithPropertyPathStrict(e){return this.columns.find(t=>t.propertyPath===e)}findColumnsWithPropertyPath(e){let t=this.columns.find(s=>s.propertyPath===e);if(t)return[t];let n=this.findRelationWithPropertyPath(e);return n&&n.joinColumns?n.joinColumns:[]}hasRelationWithPropertyPath(e){return this.relations.some(t=>t.propertyPath===e)}findRelationWithPropertyPath(e){return this.relations.find(t=>t.propertyPath===e)}hasEmbeddedWithPropertyPath(e){return this.allEmbeddeds.some(t=>t.propertyPath===e)}findEmbeddedWithPropertyPath(e){return this.allEmbeddeds.find(t=>t.propertyPath===e)}mapPropertyPathsToColumns(e){return e.map(t=>{let n=this.findColumnWithPropertyPath(t);if(n==null)throw new pt(t,this);return n})}extractRelationValuesFromEntity(e,t){let n=[];return t.forEach(s=>{let i=s.getEntityValue(e);Array.isArray(i)?i.forEach(r=>n.push([s,r,this.getInverseEntityMetadata(r,s)])):i&&n.push([s,i,this.getInverseEntityMetadata(i,s)])}),n}getInverseEntityMetadata(e,t){let n=t.inverseEntityMetadata.childEntityMetadatas.find(s=>s.target===e.constructor);return n||t.inverseEntityMetadata}static createPropertyPath(e,t,n=""){let s=[];return Object.keys(t).forEach(i=>{let r=n?n+"."+i:i;if(e.hasEmbeddedWithPropertyPath(r)){let o=this.createPropertyPath(e,t[i],r);s.push(...o)}else{let o=n?n+"."+i:i;s.push(o)}}),s}static difference(e,t){return e.filter(n=>!t.find(s=>ce.compareIds(n,s)))}static getValueMap(e,t,n){return t.reduce((s,i)=>{let r=i.getEntityValueMap(e,n);if(!(s===void 0||r===null||r===void 0))return ce.mergeDeep(s,r)},{})}build(){let e=this.connection.namingStrategy,t=this.connection.options.entityPrefix,n=this.connection.options.entitySkipConstructor;this.engine=this.tableMetadataArgs.engine,this.database=this.tableMetadataArgs.type==="entity-child"&&this.parentEntityMetadata?this.parentEntityMetadata.database:this.tableMetadataArgs.database,this.tableMetadataArgs.schema?this.schema=this.tableMetadataArgs.schema:this.tableMetadataArgs.type==="entity-child"&&this.parentEntityMetadata?this.schema=this.parentEntityMetadata.schema:this.connection.options?.hasOwnProperty("schema")&&(this.schema=this.connection.options.schema),this.givenTableName=this.tableMetadataArgs.type==="entity-child"&&this.parentEntityMetadata?this.parentEntityMetadata.givenTableName:this.tableMetadataArgs.name,this.synchronize=this.tableMetadataArgs.synchronize!==!1,this.targetName=typeof this.tableMetadataArgs.target=="function"?this.tableMetadataArgs.target.name:this.tableMetadataArgs.target,this.tableMetadataArgs.type==="closure-junction"?this.tableNameWithoutPrefix=e.closureJunctionTableName(this.givenTableName):this.tableMetadataArgs.type==="entity-child"&&this.parentEntityMetadata?this.tableNameWithoutPrefix=e.tableName(this.parentEntityMetadata.targetName,this.parentEntityMetadata.givenTableName):(this.tableNameWithoutPrefix=e.tableName(this.targetName,this.givenTableName),this.tableMetadataArgs.type==="junction"&&this.connection.driver.maxAliasLength&&this.connection.driver.maxAliasLength>0&&this.tableNameWithoutPrefix.length>this.connection.driver.maxAliasLength&&(this.tableNameWithoutPrefix=Gc(this.tableNameWithoutPrefix,{separator:"_",segmentLength:3}))),this.tableName=t?e.prefixTableName(t,this.tableNameWithoutPrefix):this.tableNameWithoutPrefix,this.target=this.target?this.target:this.tableName,this.name=this.targetName?this.targetName:this.tableName,this.expression=this.tableMetadataArgs.expression,this.withoutRowid=this.tableMetadataArgs.withoutRowid===!0,this.tablePath=this.connection.driver.buildTableName(this.tableName,this.schema,this.database),this.orderBy=typeof this.tableMetadataArgs.orderBy=="function"?this.tableMetadataArgs.orderBy(this.propertiesMap):this.tableMetadataArgs.orderBy,n!==void 0&&(this.isAlwaysUsingConstructor=!n),this.isJunction=this.tableMetadataArgs.type==="closure-junction"||this.tableMetadataArgs.type==="junction",this.isClosureJunction=this.tableMetadataArgs.type==="closure-junction"}registerColumn(e){this.ownColumns.indexOf(e)===-1&&(this.ownColumns.push(e),this.columns=this.embeddeds.reduce((t,n)=>t.concat(n.columnsFromTree),this.ownColumns),this.primaryColumns=this.columns.filter(t=>t.isPrimary),this.hasMultiplePrimaryKeys=this.primaryColumns.length>1,this.hasUUIDGeneratedColumns=this.columns.filter(t=>t.isGenerated||t.generationStrategy==="uuid").length>0,this.propertiesMap=this.createPropertiesMap(),this.childEntityMetadatas&&this.childEntityMetadatas.forEach(t=>t.registerColumn(e)))}createPropertiesMap(){let e={};return this.columns.forEach(t=>ce.mergeDeep(e,t.createValueMap(t.propertyPath))),this.relations.forEach(t=>ce.mergeDeep(e,t.createValueMap(t.propertyPath))),e}getInsertionReturningColumns(){return this.columns.filter(e=>e.default!==void 0||e.isGenerated||e.isCreateDate||e.isUpdateDate||e.isDeleteDate||e.isVersion)}},Oa=class{constructor(e){this.subjects=e}build(){this.subjects.forEach(e=>{e.metadata.oneToManyRelations.forEach(t=>{t.persistenceEnabled!==!1&&this.buildForSubjectRelation(e,t)})})}buildForSubjectRelation(e,t){let n=[];if(e.databaseEntity){let r=t.getEntityValue(e.databaseEntity);r&&(n=r.map(o=>t.inverseEntityMetadata.getEntityIdMap(o)))}let s=t.getEntityValue(e.entity);if(s===null&&(s=[]),s===void 0)return;let i=[];s.forEach(r=>{let o=t.inverseEntityMetadata.getEntityIdMap(r),c=this.subjects.find(u=>u.entity===r);if(c&&(o=c.identifier),!o){if(!c)return;c.changeMaps.push({relation:t.inverseRelation,value:e});return}n.find(u=>ce.compareIds(o,u))||(c||(c=new at({metadata:t.inverseEntityMetadata,parentSubject:e,canBeUpdated:!0,identifier:o}),this.subjects.push(c)),c.changeMaps.push({relation:t.inverseRelation,value:e})),i.push(o)}),t.inverseRelation?.orphanedRowAction!=="disable"&&Zt.difference(n,i).forEach(r=>{let o=new at({metadata:t.inverseEntityMetadata,parentSubject:e,identifier:r});!t.inverseRelation||t.inverseRelation.orphanedRowAction==="nullify"?(o.canBeUpdated=!0,o.changeMaps=[{relation:t.inverseRelation,value:null}]):t.inverseRelation.orphanedRowAction==="delete"?o.mustBeRemoved=!0:t.inverseRelation.orphanedRowAction==="soft-delete"&&(o.canBeSoftRemoved=!0),this.subjects.push(o)})}},Pa=class{constructor(e){this.subjects=e}build(){this.subjects.forEach(e=>{e.metadata.oneToOneRelations.forEach(t=>{t.isOwning||t.persistenceEnabled===!1||this.buildForSubjectRelation(e,t)})})}buildForSubjectRelation(e,t){let n;e.databaseEntity&&(n=t.getEntityValue(e.databaseEntity));let s=t.getEntityValue(e.entity);if(s===void 0)return;if(s===null){if(n){let c=new at({metadata:t.inverseEntityMetadata,parentSubject:e,canBeUpdated:!0,identifier:n,changeMaps:[{relation:t.inverseRelation,value:null}]});this.subjects.push(c)}return}let i=t.inverseEntityMetadata.getEntityIdMap(s),r=this.subjects.find(c=>!!c.entity&&c.entity===s);if(r&&(i=r.identifier),!i){if(!r)return;r.changeMaps.push({relation:t.inverseRelation,value:e})}n&&ce.compareIds(i,n)||(r||(r=new at({metadata:t.inverseEntityMetadata,canBeUpdated:!0,identifier:i}),this.subjects.push(r)),r.changeMaps.push({relation:t.inverseRelation,value:e}))}},Ti=class{constructor(e){this.subjects=e}build(){this.subjects.forEach(e=>{e.entity&&e.metadata.manyToManyRelations.forEach(t=>{t.persistenceEnabled!==!1&&this.buildForSubjectRelation(e,t)})})}buildForAllRemoval(e){e.databaseEntity&&e.metadata.manyToManyRelations.forEach(t=>{if(t.persistenceEnabled===!1)return;t.getEntityValue(e.databaseEntity).forEach(s=>{let i=new at({metadata:t.junctionEntityMetadata,parentSubject:e,mustBeRemoved:!0,identifier:this.buildJunctionIdentifier(e,t,s)});this.subjects.push(i)})})}buildForSubjectRelation(e,t){let n=[];e.databaseEntity&&(n=t.getEntityValue(e.databaseEntity));let s=t.getEntityValue(e.entity);if(s===null&&(s=[]),!Array.isArray(s))return;s.forEach(o=>{let c=t.inverseEntityMetadata.getEntityIdMap(o),l=this.subjects.find(p=>p.entity===o);if(l&&(c=l.identifier),!c&&!l||n.find(p=>ce.compareIds(p,c)))return;let h=t.isOwning?e:l||o,d=t.isOwning?l||o:e,f=new at({metadata:t.junctionEntityMetadata,parentSubject:e,canBeInserted:!0});this.subjects.push(f),t.junctionEntityMetadata.ownerColumns.forEach(p=>{f.changeMaps.push({column:p,value:h})}),t.junctionEntityMetadata.inverseColumns.forEach(p=>{f.changeMaps.push({column:p,value:d})})});let i=[];s.forEach(o=>{let c=t.inverseEntityMetadata.getEntityIdMap(o),l=this.subjects.find(u=>u.entity===o);l&&(c=l.identifier),c!=null&&i.push(c)}),n.filter(o=>!i.find(c=>ce.compareIds(c,o))).forEach(o=>{let c=new at({metadata:t.junctionEntityMetadata,parentSubject:e,mustBeRemoved:!0,identifier:this.buildJunctionIdentifier(e,t,o)});this.subjects.push(c)})}buildJunctionIdentifier(e,t,n){let s=t.isOwning?e.entity:n,i=t.isOwning?n:e.entity,r={};return t.junctionEntityMetadata.ownerColumns.forEach(o=>{ce.mergeDeep(r,o.createValueMap(o.referencedColumn.getEntityValue(s)))}),t.junctionEntityMetadata.inverseColumns.forEach(o=>{ce.mergeDeep(r,o.createValueMap(o.referencedColumn.getEntityValue(i)))}),r}},_a=class{constructor(e,t){this.queryRunner=e,this.subjects=t}async load(e){let t=this.groupByEntityTargets().map(async n=>{let s=[],i=[];if(n.subjects.forEach(l=>{l.databaseEntity||!l.identifier||(s.push(l.identifier),i.push(l))}),!s.length)return;let r=[];e==="save"||e==="soft-remove"||e==="recover"?n.subjects.forEach(l=>{l.metadata.relations.forEach(u=>{u.getEntityValue(l.entityWithFulfilledIds)!==void 0&&r.indexOf(u.propertyPath)===-1&&r.push(u.propertyPath)})}):r.push(...n.subjects[0].metadata.manyToManyRelations.map(l=>l.propertyPath));let o={loadEagerRelations:!1,loadRelationIds:{relations:r,disableMixedMap:!0},withDeleted:!0},c=[];this.queryRunner.connection.driver.options.type==="mongodb"||(c=await this.queryRunner.manager.getRepository(n.target).createQueryBuilder().setFindOptions(o).whereInIds(s).getMany()),c.forEach(l=>{this.findByPersistEntityLike(n.target,l).forEach(h=>{h.databaseEntity=l,h.identifier||(h.identifier=h.metadata.hasAllPrimaryKeys(l)?h.metadata.getEntityIdMap(l):void 0)})});for(let l of i)l.databaseEntityLoaded=!0});await Promise.all(t)}findByPersistEntityLike(e,t){return this.subjects.filter(n=>n.entity?n.entity===t?!0:n.metadata.target===e&&n.metadata.compareEntities(n.entityWithFulfilledIds,t):!1)}groupByEntityTargets(){return this.subjects.reduce((e,t)=>{let n=e.find(s=>s.target===t.metadata.target);return n||(n={target:t.metadata.target,subjects:[]},e.push(n)),n.subjects.push(t),e},[])}},Ia=class{constructor(e){this.allSubjects=e}build(e,t){e.metadata.extractRelationValuesFromEntity(e.entity,e.metadata.relations).forEach(([n,s,i])=>{if(s==null||!n.isCascadeInsert&&!n.isCascadeUpdate&&!n.isCascadeSoftRemove&&!n.isCascadeRecover||!ne.isObject(s))return;let r=this.findByPersistEntityLike(i.target,s);if(r){r.canBeInserted===!1&&(r.canBeInserted=n.isCascadeInsert===!0&&t==="save"),r.canBeUpdated===!1&&(r.canBeUpdated=n.isCascadeUpdate===!0&&t==="save"),r.canBeSoftRemoved===!1&&(r.canBeSoftRemoved=n.isCascadeSoftRemove===!0&&t==="soft-remove"),r.canBeRecovered===!1&&(r.canBeRecovered=n.isCascadeRecover===!0&&t==="recover");return}let o=new at({metadata:i,parentSubject:e,entity:s,canBeInserted:n.isCascadeInsert===!0&&t==="save",canBeUpdated:n.isCascadeUpdate===!0&&t==="save",canBeSoftRemoved:n.isCascadeSoftRemove===!0&&t==="soft-remove",canBeRecovered:n.isCascadeRecover===!0&&t==="recover"});this.allSubjects.push(o),this.build(o,t)})}findByPersistEntityLike(e,t){return this.allSubjects.find(n=>n.entity?n.entity===t?!0:n.metadata.target===e&&n.metadata.compareEntities(n.entityWithFulfilledIds,t):!1)}},En=class{constructor(e,t,n,s,i,r){this.connection=e,this.queryRunner=t,this.mode=n,this.target=s,this.entity=i,this.options=r}async execute(){if(!this.entity||typeof this.entity!="object")return Promise.reject(new ta(this.mode,this.entity));await Promise.resolve();let e=this.queryRunner||this.connection.createQueryRunner(),t=e.data;this.options&&this.options.data&&(e.data=this.options.data);try{let n=Array.isArray(this.entity)?this.entity:[this.entity],s=this.options&&this.options.chunk&&this.options.chunk>0?ce.chunk(n,this.options.chunk):[n],r=(await Promise.all(s.map(async c=>{let l=[];c.forEach(h=>{let d=this.target?this.target:h.constructor;if(d===Object)throw new Yr(this.mode);let f=this.connection.getMetadata(d);if(f.inheritancePattern==="STI"&&f.childEntityMetadatas.length>0){let p=f.childEntityMetadatas.find(m=>h.constructor===m.target);p&&(f=p)}l.push(new at({metadata:f,entity:h,canBeInserted:this.mode==="save",canBeUpdated:this.mode==="save",mustBeRemoved:this.mode==="remove",canBeSoftRemoved:this.mode==="soft-remove",canBeRecovered:this.mode==="recover"}))});let u=new Ia(l);return l.forEach(h=>{u.build(h,this.mode)}),await new _a(e,l).load(this.mode),this.mode==="save"||this.mode==="soft-remove"||this.mode==="recover"?(new Oa(l).build(),new Pa(l).build(),new Ti(l).build()):l.forEach(h=>{h.mustBeRemoved&&new Ti(l).buildForAllRemoval(h)}),new Aa(e,l,this.options)}))).filter(c=>c.hasExecutableOperations);if(r.length===0)return;let o=!1;try{e.isTransactionActive||(!this.options||this.options.transaction!==!1)&&(o=!0,await e.startTransaction());for(let c of r)await c.execute();o===!0&&await e.commitTransaction()}catch(c){if(o)try{await e.rollbackTransaction()}catch{}throw c}}finally{e.data=t,this.queryRunner||await e.release()}}},Ci=class{constructor(e,t){this["@instanceof"]=Symbol.for("EntityManager"),this.repositories=[],this.treeRepositories=[],this.plainObjectToEntityTransformer=new Na,this.connection=e,t&&(this.queryRunner=t,ne.assign(this.queryRunner,{manager:this}))}async transaction(e,t){let n=typeof e=="string"?e:void 0,s=typeof e=="function"?e:t;if(!s)throw new v("Transaction method requires callback in second parameter if isolation level is supplied.");if(this.queryRunner&&this.queryRunner.isReleased)throw new pi;let i=this.queryRunner||this.connection.createQueryRunner();try{await i.startTransaction(n);let r=await s(i.manager);return await i.commitTransaction(),r}catch(r){try{await i.rollbackTransaction()}catch{}throw r}finally{this.queryRunner||await i.release()}}async query(e,t){return this.connection.query(e,t,this.queryRunner)}createQueryBuilder(e,t,n){return t?this.connection.createQueryBuilder(e,t,n||this.queryRunner):this.connection.createQueryBuilder(e||n||this.queryRunner)}hasId(e,t){let n=arguments.length===2?e:e.constructor,s=arguments.length===2?t:e;return this.connection.getMetadata(n).hasId(s)}getId(e,t){let n=arguments.length===2?e:e.constructor,s=arguments.length===2?t:e;return this.connection.getMetadata(n).getEntityIdMixedMap(s)}create(e,t){let n=this.connection.getMetadata(e);if(!t)return n.create(this.queryRunner);if(Array.isArray(t))return t.map(i=>this.create(e,i));let s=n.create(this.queryRunner);return this.plainObjectToEntityTransformer.transform(s,t,n,!0),s}merge(e,t,...n){let s=this.connection.getMetadata(e);return n.forEach(i=>this.plainObjectToEntityTransformer.transform(t,i,s)),t}async preload(e,t){let n=this.connection.getMetadata(e),i=await new xa(this.connection.manager).transform(t,n);if(i)return this.merge(e,i,t)}save(e,t,n){let s=arguments.length>1&&(typeof e=="function"||$.isEntitySchema(e)||typeof e=="string")?e:void 0,i=s?t:e,r=s?n:t;return $.isEntitySchema(s)&&(s=s.options.name),Array.isArray(i)&&i.length===0?Promise.resolve(i):new En(this.connection,this.queryRunner,"save",s,i,r).execute().then(()=>i)}remove(e,t,n){let s=arguments.length>1&&(typeof e=="function"||$.isEntitySchema(e)||typeof e=="string")?e:void 0,i=s?t:e,r=s?n:t;return Array.isArray(i)&&i.length===0?Promise.resolve(i):new En(this.connection,this.queryRunner,"remove",s,i,r).execute().then(()=>i)}softRemove(e,t,n){let s=arguments.length>1&&(typeof e=="function"||$.isEntitySchema(e)||typeof e=="string")?e:void 0,i=s?t:e,r=s?n:t;return $.isEntitySchema(s)&&(s=s.options.name),Array.isArray(i)&&i.length===0?Promise.resolve(i):new En(this.connection,this.queryRunner,"soft-remove",s,i,r).execute().then(()=>i)}recover(e,t,n){let s=arguments.length>1&&(typeof e=="function"||$.isEntitySchema(e)||typeof e=="string")?e:void 0,i=s?t:e,r=s?n:t;return $.isEntitySchema(s)&&(s=s.options.name),Array.isArray(i)&&i.length===0?Promise.resolve(i):new En(this.connection,this.queryRunner,"recover",s,i,r).execute().then(()=>i)}async insert(e,t){return this.createQueryBuilder().insert().into(e).values(t).execute()}async upsert(e,t,n){let s=this.connection.getMetadata(e),i;Array.isArray(n)?i={conflictPaths:n}:i=n;let r;Array.isArray(t)?r=t:r=[t];let o=s.mapPropertyPathsToColumns(i.conflictPaths),c=s.columns.filter(l=>!o.includes(l)&&r.some(u=>typeof l.getEntityValue(u)<"u"));return this.createQueryBuilder().insert().into(e).values(r).orUpdate([...o,...c].map(l=>l.databaseName),o.map(l=>l.databaseName),{skipUpdateIfNoValuesChanged:i.skipUpdateIfNoValuesChanged}).execute()}update(e,t,n){return t==null||t===""||Array.isArray(t)&&t.length===0?Promise.reject(new v("Empty criteria(s) are not allowed for the update method.")):typeof t=="string"||typeof t=="number"||t instanceof Date||Array.isArray(t)?this.createQueryBuilder().update(e).set(n).whereInIds(t).execute():this.createQueryBuilder().update(e).set(n).where(t).execute()}delete(e,t){return t==null||t===""||Array.isArray(t)&&t.length===0?Promise.reject(new v("Empty criteria(s) are not allowed for the delete method.")):typeof t=="string"||typeof t=="number"||t instanceof Date||Array.isArray(t)?this.createQueryBuilder().delete().from(e).whereInIds(t).execute():this.createQueryBuilder().delete().from(e).where(t).execute()}softDelete(e,t){return t==null||t===""||Array.isArray(t)&&t.length===0?Promise.reject(new v("Empty criteria(s) are not allowed for the delete method.")):typeof t=="string"||typeof t=="number"||t instanceof Date||Array.isArray(t)?this.createQueryBuilder().softDelete().from(e).whereInIds(t).execute():this.createQueryBuilder().softDelete().from(e).where(t).execute()}restore(e,t){return t==null||t===""||Array.isArray(t)&&t.length===0?Promise.reject(new v("Empty criteria(s) are not allowed for the delete method.")):typeof t=="string"||typeof t=="number"||t instanceof Date||Array.isArray(t)?this.createQueryBuilder().restore().from(e).whereInIds(t).execute():this.createQueryBuilder().restore().from(e).where(t).execute()}count(e,t){let n=this.connection.getMetadata(e);return this.createQueryBuilder(e,Le.extractFindManyOptionsAlias(t)||n.name).setFindOptions(t||{}).getCount()}countBy(e,t){let n=this.connection.getMetadata(e);return this.createQueryBuilder(e,n.name).setFindOptions({where:t}).getCount()}async find(e,t){let n=this.connection.getMetadata(e);return this.createQueryBuilder(e,Le.extractFindManyOptionsAlias(t)||n.name).setFindOptions(t||{}).getMany()}async findBy(e,t){let n=this.connection.getMetadata(e);return this.createQueryBuilder(e,n.name).setFindOptions({where:t}).getMany()}findAndCount(e,t){let n=this.connection.getMetadata(e);return this.createQueryBuilder(e,Le.extractFindManyOptionsAlias(t)||n.name).setFindOptions(t||{}).getManyAndCount()}findAndCountBy(e,t){let n=this.connection.getMetadata(e);return this.createQueryBuilder(e,n.name).setFindOptions({where:t}).getManyAndCount()}async findByIds(e,t){if(!t.length)return Promise.resolve([]);let n=this.connection.getMetadata(e);return this.createQueryBuilder(e,n.name).andWhereInIds(t).getMany()}async findOne(e,t){let s=this.connection.getMetadata(e).name;if(t&&t.join&&(s=t.join.alias),!t.where)throw new Error("You must provide selection conditions in order to find a single row.");return this.createQueryBuilder(e,s).setFindOptions(je(oe({},t),{take:1})).getOne()}async findOneBy(e,t){let n=this.connection.getMetadata(e);return this.createQueryBuilder(e,n.name).setFindOptions({where:t,take:1}).getOne()}async findOneById(e,t){let n=this.connection.getMetadata(e);return this.createQueryBuilder(e,n.name).setFindOptions({take:1}).whereInIds(n.ensureEntityIdMap(t)).getOne()}async findOneOrFail(e,t){return this.findOne(e,t).then(n=>n===null?Promise.reject(new us(e,t)):Promise.resolve(n))}async findOneByOrFail(e,t){return this.findOneBy(e,t).then(n=>n===null?Promise.reject(new us(e,t)):Promise.resolve(n))}async clear(e){let t=this.connection.getMetadata(e),n=this.queryRunner||this.connection.createQueryRunner();try{return await n.clearTable(t.tablePath)}finally{this.queryRunner||await n.release()}}async increment(e,t,n,s){let i=this.connection.getMetadata(e),r=i.findColumnWithPropertyPath(n);if(!r)throw new v(`Column ${n} was not found in ${i.targetName} entity.`);if(isNaN(Number(s)))throw new v(`Value "${s}" is not a number.`);let o=n.split(".").reduceRight((c,l)=>({[l]:c}),()=>this.connection.driver.escape(r.databaseName)+" + "+s);return this.createQueryBuilder(e,"entity").update(e).set(o).where(t).execute()}async decrement(e,t,n,s){let i=this.connection.getMetadata(e),r=i.findColumnWithPropertyPath(n);if(!r)throw new v(`Column ${n} was not found in ${i.targetName} entity.`);if(isNaN(Number(s)))throw new v(`Value "${s}" is not a number.`);let o=n.split(".").reduceRight((c,l)=>({[l]:c}),()=>this.connection.driver.escape(r.databaseName)+" - "+s);return this.createQueryBuilder(e,"entity").update(e).set(o).where(t).execute()}getRepository(e){let t=this.repositories.find(n=>n.target===e);if(t)return t;if(this.connection.driver.options.type!=="mongodb"){let n=new gi(e,this,this.queryRunner);return this.repositories.push(n),n}}getTreeRepository(e){if(this.connection.driver.treeSupport===!1)throw new Zr(this.connection.driver);let t=this.treeRepositories.find(s=>s.target===e);if(t)return t;let n=new Ca(e,this,this.queryRunner);return this.treeRepositories.push(n),n}withRepository(e){let t=e.constructor,o=e,{target:n,manager:s,queryRunner:i}=o,r=Tr(o,["target","manager","queryRunner"]);return Object.assign(new t(e.target,this),oe({},r))}getCustomRepository(e){let t=ze().entityRepositories.find(i=>i.target===(typeof e=="function"?e:e.constructor));if(!t)throw new ui(e);let n=t.entity?this.connection.getMetadata(t.entity):void 0,s=new t.target(this,n);if(s instanceof Sa)s.manager||(s.manager=this);else{if(!n)throw new na(e);s.manager=this,s.metadata=n}return s}async release(){if(!this.queryRunner)throw new fa;return this.queryRunner.release()}},Da=class extends Ci{constructor(e,t){super(e,t),this["@instanceof"]=Symbol.for("SqljsEntityManager"),this.driver=e.driver}async loadDatabase(e){await this.driver.load(e)}async saveDatabase(e){await this.driver.save(e)}exportDatabase(){return this.driver.export()}},$a=class{create(e,t){return e.driver.options.type==="sqljs"?new Da(e,t):new Ci(e,t)}},Ni=class a{constructor(e){this["@instanceof"]=Symbol.for("View"),e&&(this.database=e.database,this.schema=e.schema,this.name=e.name,this.expression=e.expression,this.materialized=!!e.materialized)}clone(){return new a({database:this.database,schema:this.schema,name:this.name,expression:this.expression,materialized:this.materialized})}static create(e,t){let n={database:e.database,schema:e.schema,name:t.buildTableName(e.tableName,e.schema,e.database),expression:e.expression,materialized:e.tableMetadataArgs.materialized};return new a(n)}},vi=class{static viewMetadataCmp(e,t){return!e||!t?0:e.dependsOn&&(e.dependsOn.has(t.target)||e.dependsOn.has(t.name))?1:t.dependsOn&&(t.dependsOn.has(e.target)||t.dependsOn.has(e.name))?-1:0}},qa=class{constructor(e){this.connection=e,this["@instanceof"]=Symbol.for("RdbmsSchemaBuilder")}async build(){this.queryRunner=this.connection.createQueryRunner(),this.currentDatabase=this.connection.driver.database,this.currentSchema=this.connection.driver.schema;let e=this.connection.driver.options.type!=="cockroachdb"&&this.connection.driver.options.type!=="spanner"&&this.connection.options.migrationsTransactionMode!=="none";await this.queryRunner.beforeMigration(),e&&await this.queryRunner.startTransaction();try{await this.createMetadataTableIfNecessary(this.queryRunner);let t=this.entityToSyncMetadatas.map(n=>this.getTablePath(n));await this.queryRunner.getTables(t),await this.queryRunner.getViews([]),await this.executeSchemaSyncOperationsInProperOrder(),this.connection.queryResultCache&&await this.connection.queryResultCache.synchronize(this.queryRunner),e&&await this.queryRunner.commitTransaction()}catch(t){try{e&&await this.queryRunner.rollbackTransaction()}catch{}throw t}finally{await this.queryRunner.afterMigration(),await this.queryRunner.release()}}async createMetadataTableIfNecessary(e){(this.viewEntityToSyncMetadatas.length>0||this.hasGeneratedColumns())&&await this.createTypeormMetadataTable(e)}async log(){this.queryRunner=this.connection.createQueryRunner();try{let e=this.entityToSyncMetadatas.map(t=>this.getTablePath(t));return await this.queryRunner.getTables(e),await this.queryRunner.getViews([]),this.queryRunner.enableSqlMemory(),await this.executeSchemaSyncOperationsInProperOrder(),this.connection.queryResultCache&&await this.connection.queryResultCache.synchronize(this.queryRunner),this.queryRunner.getMemorySql()}finally{this.queryRunner.disableSqlMemory(),await this.queryRunner.release()}}get entityToSyncMetadatas(){return this.connection.entityMetadatas.filter(e=>e.synchronize&&e.tableType!=="entity-child"&&e.tableType!=="view")}get viewEntityToSyncMetadatas(){return this.connection.entityMetadatas.filter(e=>e.tableType==="view"&&e.synchronize).sort(vi.viewMetadataCmp)}hasGeneratedColumns(){return this.connection.entityMetadatas.some(e=>e.columns.some(t=>t.generatedType))}async executeSchemaSyncOperationsInProperOrder(){await this.dropOldViews(),await this.dropOldForeignKeys(),await this.dropOldIndices(),await this.dropOldChecks(),await this.dropOldExclusions(),await this.dropCompositeUniqueConstraints(),await this.renameColumns(),await this.createNewTables(),await this.dropRemovedColumns(),await this.addNewColumns(),await this.updatePrimaryKeys(),await this.updateExistColumns(),await this.createNewIndices(),await this.createNewChecks(),await this.createNewExclusions(),await this.createCompositeUniqueConstraints(),await this.createForeignKeys(),await this.createViews()}getTablePath(e){let t=this.connection.driver.parseTableName(e);return this.connection.driver.buildTableName(t.tableName,t.schema||this.currentSchema,t.database||this.currentDatabase)}async dropOldForeignKeys(){for(let e of this.entityToSyncMetadatas){let t=this.queryRunner.loadedTables.find(s=>this.getTablePath(s)===this.getTablePath(e));if(!t)continue;let n=t.foreignKeys.filter(s=>{let i=e.foreignKeys.find(r=>s.name===r.name&&this.getTablePath(s)===this.getTablePath(r.referencedEntityMetadata));return!i||i.onDelete&&i.onDelete!==s.onDelete||i.onUpdate&&i.onUpdate!==s.onUpdate});n.length!==0&&(this.connection.logger.logSchemaBuild(`dropping old foreign keys of ${t.name}: ${n.map(s=>s.name).join(", ")}`),await this.queryRunner.dropForeignKeys(t,n))}}async renameTables(){}async renameColumns(){for(let e of this.entityToSyncMetadatas){let t=this.queryRunner.loadedTables.find(r=>this.getTablePath(r)===this.getTablePath(e));if(!t||e.columns.length!==t.columns.length)continue;let n=e.columns.filter(r=>!r.isVirtualProperty).filter(r=>!t.columns.find(o=>o.name===r.databaseName&&o.type===this.connection.driver.normalizeType(r)&&o.isNullable===r.isNullable&&o.isUnique===this.connection.driver.normalizeIsUnique(r)));if(n.length===0||n.length>1)continue;let s=t.columns.filter(r=>!e.columns.find(o=>!o.isVirtualProperty&&o.databaseName===r.name&&this.connection.driver.normalizeType(o)===r.type&&o.isNullable===r.isNullable&&this.connection.driver.normalizeIsUnique(o)===r.isUnique));if(s.length===0||s.length>1)continue;let i=s[0].clone();i.name=n[0].databaseName,this.connection.logger.logSchemaBuild(`renaming column "${s[0].name}" in to "${i.name}"`),await this.queryRunner.renameColumn(t,s[0],i)}}async dropOldIndices(){for(let e of this.entityToSyncMetadatas){let t=this.queryRunner.loadedTables.find(s=>this.getTablePath(s)===this.getTablePath(e));if(!t)continue;let n=t.indices.filter(s=>{let i=e.indices.find(r=>r.name===s.name);return i?i.synchronize===!1?!1:i.isUnique!==s.isUnique||i.isSpatial!==s.isSpatial||this.connection.driver.isFullTextColumnTypeSupported()&&i.isFulltext!==s.isFulltext||i.columns.length!==s.columnNames.length?!0:!i.columns.every(r=>s.columnNames.indexOf(r.databaseName)!==-1):!0}).map(async s=>{this.connection.logger.logSchemaBuild(`dropping an index: "${s.name}" from table ${t.name}`),await this.queryRunner.dropIndex(t,s)});await Promise.all(n)}}async dropOldChecks(){if(!(L.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"))for(let e of this.entityToSyncMetadatas){let t=this.queryRunner.loadedTables.find(s=>this.getTablePath(s)===this.getTablePath(e));if(!t)continue;let n=t.checks.filter(s=>!e.checks.find(i=>i.name===s.name));n.length!==0&&(this.connection.logger.logSchemaBuild(`dropping old check constraint: ${n.map(s=>`"${s.name}"`).join(", ")} from table "${t.name}"`),await this.queryRunner.dropCheckConstraints(t,n))}}async dropCompositeUniqueConstraints(){for(let e of this.entityToSyncMetadatas){let t=this.queryRunner.loadedTables.find(s=>this.getTablePath(s)===this.getTablePath(e));if(!t)continue;let n=t.uniques.filter(s=>s.columnNames.length>1&&!e.uniques.find(i=>i.name===s.name));n.length!==0&&(this.connection.logger.logSchemaBuild(`dropping old unique constraint: ${n.map(s=>`"${s.name}"`).join(", ")} from table "${t.name}"`),await this.queryRunner.dropUniqueConstraints(t,n))}}async dropOldExclusions(){if(this.connection.driver.options.type==="postgres")for(let e of this.entityToSyncMetadatas){let t=this.queryRunner.loadedTables.find(s=>this.getTablePath(s)===this.getTablePath(e));if(!t)continue;let n=t.exclusions.filter(s=>!e.exclusions.find(i=>i.name===s.name));n.length!==0&&(this.connection.logger.logSchemaBuild(`dropping old exclusion constraint: ${n.map(s=>`"${s.name}"`).join(", ")} from table "${t.name}"`),await this.queryRunner.dropExclusionConstraints(t,n))}}async createNewTables(){for(let e of this.entityToSyncMetadatas){if(this.queryRunner.loadedTables.find(s=>this.getTablePath(s)===this.getTablePath(e)))continue;this.connection.logger.logSchemaBuild(`creating a new table: ${this.getTablePath(e)}`);let n=St.create(e,this.connection.driver);await this.queryRunner.createTable(n,!1,!1),this.queryRunner.loadedTables.push(n)}}async createViews(){for(let e of this.viewEntityToSyncMetadatas){if(this.queryRunner.loadedViews.find(s=>{let i=typeof s.expression=="string"?s.expression.trim():s.expression(this.connection).getQuery(),r=typeof e.expression=="string"?e.expression.trim():e.expression(this.connection).getQuery();return this.getTablePath(s)===this.getTablePath(e)&&i===r}))continue;this.connection.logger.logSchemaBuild(`creating a new view: ${this.getTablePath(e)}`);let n=Ni.create(e,this.connection.driver);await this.queryRunner.createView(n,!0),this.queryRunner.loadedViews.push(n)}}async dropOldViews(){let e=[],t=this.viewEntityToSyncMetadatas,n=new Map;for(let r of this.queryRunner.loadedViews){let o=t.find(c=>this.getTablePath(r)===this.getTablePath(c));o&&n.set(r,o)}for(let r of this.queryRunner.loadedViews){let o=n.get(r);if(!o)continue;let c=typeof r.expression=="string"?r.expression.trim():r.expression(this.connection).getQuery(),l=typeof o.expression=="string"?o.expression.trim():o.expression(this.connection).getQuery();c!==l&&(this.connection.logger.logSchemaBuild(`dropping an old view: ${r.name}`),e.push(r))}let s=r=>{let o=n.get(r),c=[r];if(!o)return c;for(let[l,u]of n.entries())l!==r&&u.dependsOn&&(u.dependsOn.has(o.target)||u.dependsOn.has(o.name))&&(c=c.concat(s(l)));return c},i=new Set(e.map(r=>s(r)).reduce((r,o)=>r.concat(o),[]).sort((r,o)=>vi.viewMetadataCmp(n.get(r),n.get(o))).reverse());for(let r of i)await this.queryRunner.dropView(r);this.queryRunner.loadedViews=this.queryRunner.loadedViews.filter(r=>!i.has(r))}async dropRemovedColumns(){for(let e of this.entityToSyncMetadatas){let t=this.queryRunner.loadedTables.find(s=>this.getTablePath(s)===this.getTablePath(e));if(!t)continue;let n=t.columns.filter(s=>!e.columns.find(i=>i.isVirtualProperty||i.databaseName===s.name));n.length!==0&&(this.connection.logger.logSchemaBuild(`columns dropped in ${t.name}: `+n.map(s=>s.name).join(", ")),await this.queryRunner.dropColumns(t,n))}}async addNewColumns(){for(let e of this.entityToSyncMetadatas){let t=this.queryRunner.loadedTables.find(r=>this.getTablePath(r)===this.getTablePath(e));if(!t)continue;let n=e.columns.filter(r=>!r.isVirtualProperty&&!t.columns.find(o=>o.name===r.databaseName));if(n.length===0)continue;let i=this.metadataColumnsToTableColumnOptions(n).map(r=>new Ht(r));i.length!==0&&(this.connection.logger.logSchemaBuild("new columns added: "+n.map(r=>r.databaseName).join(", ")),await this.queryRunner.addColumns(t,i))}}async updatePrimaryKeys(){for(let e of this.entityToSyncMetadatas){let t=this.queryRunner.loadedTables.find(i=>this.getTablePath(i)===this.getTablePath(e));if(!t)continue;let n=e.columns.filter(i=>i.isPrimary);if(t.columns.filter(i=>i.isPrimary).length!==n.length&&n.length>1){let i=n.map(r=>new Ht(Nn.createTableColumnOptions(r,this.connection.driver)));await this.queryRunner.updatePrimaryKeys(t,i)}}}async updateExistColumns(){for(let e of this.entityToSyncMetadatas){let t=this.queryRunner.loadedTables.find(i=>this.getTablePath(i)===this.getTablePath(e));if(!t)continue;let n=this.connection.driver.findChangedColumns(t.columns,e.columns);if(n.length===0)continue;for(let i of n)await this.dropColumnReferencedForeignKeys(this.getTablePath(e),i.databaseName);for(let i of n)await this.dropColumnCompositeIndices(this.getTablePath(e),i.databaseName);if(!(L.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"||this.connection.driver.options.type==="spanner"))for(let i of n)await this.dropColumnCompositeUniques(this.getTablePath(e),i.databaseName);let s=n.map(i=>{let r=t.columns.find(l=>l.name===i.databaseName),o=Nn.createTableColumnOptions(i,this.connection.driver),c=new Ht(o);return{oldColumn:r,newColumn:c}});s.length!==0&&(this.connection.logger.logSchemaBuild(`columns changed in "${t.name}". updating: `+n.map(i=>i.databaseName).join(", ")),await this.queryRunner.changeColumns(t,s))}}async createNewIndices(){for(let e of this.entityToSyncMetadatas){let t=this.queryRunner.loadedTables.find(s=>this.getTablePath(s)===this.getTablePath(e));if(!t)continue;let n=e.indices.filter(s=>!t.indices.find(i=>i.name===s.name)&&s.synchronize===!0).map(s=>Lt.create(s));n.length!==0&&(this.connection.logger.logSchemaBuild(`adding new indices ${n.map(s=>`"${s.name}"`).join(", ")} in table "${t.name}"`),await this.queryRunner.createIndices(t,n))}}async createNewChecks(){if(!(L.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"))for(let e of this.entityToSyncMetadatas){let t=this.queryRunner.loadedTables.find(s=>this.getTablePath(s)===this.getTablePath(e));if(!t)continue;let n=e.checks.filter(s=>!t.checks.find(i=>i.name===s.name)).map(s=>An.create(s));n.length!==0&&(this.connection.logger.logSchemaBuild(`adding new check constraints: ${n.map(s=>`"${s.name}"`).join(", ")} in table "${t.name}"`),await this.queryRunner.createCheckConstraints(t,n))}}async createCompositeUniqueConstraints(){for(let e of this.entityToSyncMetadatas){let t=this.queryRunner.loadedTables.find(s=>this.getTablePath(s)===this.getTablePath(e));if(!t)continue;let n=e.uniques.filter(s=>s.columns.length>1&&!t.uniques.find(i=>i.name===s.name)).map(s=>Kt.create(s));n.length!==0&&(this.connection.logger.logSchemaBuild(`adding new unique constraints: ${n.map(s=>`"${s.name}"`).join(", ")} in table "${t.name}"`),await this.queryRunner.createUniqueConstraints(t,n))}}async createNewExclusions(){if(this.connection.driver.options.type==="postgres")for(let e of this.entityToSyncMetadatas){let t=this.queryRunner.loadedTables.find(s=>this.getTablePath(s)===this.getTablePath(e));if(!t)continue;let n=e.exclusions.filter(s=>!t.exclusions.find(i=>i.name===s.name)).map(s=>ds.create(s));n.length!==0&&(this.connection.logger.logSchemaBuild(`adding new exclusion constraints: ${n.map(s=>`"${s.name}"`).join(", ")} in table "${t.name}"`),await this.queryRunner.createExclusionConstraints(t,n))}}async createForeignKeys(){for(let e of this.entityToSyncMetadatas){let t=this.queryRunner.loadedTables.find(i=>this.getTablePath(i)===this.getTablePath(e));if(!t)continue;let n=e.foreignKeys.filter(i=>!t.foreignKeys.find(r=>r.name===i.name&&this.getTablePath(r)===this.getTablePath(i.referencedEntityMetadata)));if(n.length===0)continue;let s=n.map(i=>hs.create(i,this.connection.driver));this.connection.logger.logSchemaBuild(`creating a foreign keys: ${n.map(i=>i.name).join(", ")} on table "${t.name}"`),await this.queryRunner.createForeignKeys(t,s)}}async dropColumnReferencedForeignKeys(e,t){let n=this.queryRunner.loadedTables.find(r=>this.getTablePath(r)===e);if(!n)return;let s=[],i=n.foreignKeys.find(r=>r.columnNames.indexOf(t)!==-1);if(i){let r=n.clone();r.foreignKeys=[i],s.push(r),n.removeForeignKey(i)}for(let r of this.queryRunner.loadedTables){let o=r.foreignKeys.filter(c=>this.getTablePath(c)===e&&c.referencedColumnNames.indexOf(t)!==-1);if(o.length>0){let c=r.clone();c.foreignKeys=o,s.push(c),o.forEach(l=>r.removeForeignKey(l))}}if(s.length>0)for(let r of s)this.connection.logger.logSchemaBuild(`dropping related foreign keys of ${r.name}: ${r.foreignKeys.map(o=>o.name).join(", ")}`),await this.queryRunner.dropForeignKeys(r,r.foreignKeys)}async dropColumnCompositeIndices(e,t){let n=this.queryRunner.loadedTables.find(i=>this.getTablePath(i)===e);if(!n)return;let s=n.indices.filter(i=>i.columnNames.length>1&&i.columnNames.indexOf(t)!==-1);s.length!==0&&(this.connection.logger.logSchemaBuild(`dropping related indices of "${e}"."${t}": ${s.map(i=>i.name).join(", ")}`),await this.queryRunner.dropIndices(n,s))}async dropColumnCompositeUniques(e,t){let n=this.queryRunner.loadedTables.find(i=>this.getTablePath(i)===e);if(!n)return;let s=n.uniques.filter(i=>i.columnNames.length>1&&i.columnNames.indexOf(t)!==-1);s.length!==0&&(this.connection.logger.logSchemaBuild(`dropping related unique constraints of "${e}"."${t}": ${s.map(i=>i.name).join(", ")}`),await this.queryRunner.dropUniqueConstraints(n,s))}metadataColumnsToTableColumnOptions(e){return e.map(t=>Nn.createTableColumnOptions(t,this.connection.driver))}async createTypeormMetadataTable(e){let t=this.currentSchema,n=this.currentDatabase,s=this.connection.driver.buildTableName(this.connection.metadataTableName,t,n),i=this.connection.driver.options.type==="spanner";await e.createTable(new St({database:n,schema:t,name:s,columns:[{name:"type",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.metadataType}),isNullable:!1,isPrimary:i},{name:"database",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.metadataDatabase}),isNullable:!0,isPrimary:i},{name:"schema",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.metadataSchema}),isNullable:!0,isPrimary:i},{name:"table",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.metadataTable}),isNullable:!0,isPrimary:i},{name:"name",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.metadataName}),isNullable:!0,isPrimary:i},{name:"value",type:this.connection.driver.normalizeType({type:this.connection.driver.mappedDataTypes.metadataValue}),isNullable:!0,isPrimary:i}]}),!0)}},On=class{constructor(e){this.isReplicated=!1,this.treeSupport=!0,this.transactionSupport="nested",this.supportedDataTypes=["int","integer","tinyint","smallint","mediumint","bigint","unsigned big int","int2","int8","integer","character","varchar","varying character","nchar","native character","nvarchar","text","clob","text","blob","real","double","double precision","float","real","numeric","decimal","boolean","date","time","datetime"],this.supportedUpsertType="on-conflict-do-update",this.withLengthColumnTypes=["character","varchar","varying character","nchar","native character","nvarchar","text","blob","clob"],this.spatialTypes=[],this.withPrecisionColumnTypes=["real","double","double precision","float","real","numeric","decimal","date","time","datetime"],this.withScaleColumnTypes=["real","double","double precision","float","real","numeric","decimal"],this.mappedDataTypes={createDate:"datetime",createDateDefault:"datetime('now')",updateDate:"datetime",updateDateDefault:"datetime('now')",deleteDate:"datetime",deleteDateNullable:!0,version:"integer",treeLevel:"integer",migrationId:"integer",migrationName:"varchar",migrationTimestamp:"bigint",cacheId:"int",cacheIdentifier:"varchar",cacheTime:"bigint",cacheDuration:"int",cacheQuery:"text",cacheResult:"text",metadataType:"varchar",metadataDatabase:"varchar",metadataSchema:"varchar",metadataTable:"varchar",metadataName:"varchar",metadataValue:"text"},this.cteCapabilities={enabled:!0,requiresRecursiveHint:!0},this.attachedDatabases={},this.connection=e,this.options=e.options,this.database=L.buildDriverOptions(this.options).database}async connect(){this.databaseConnection=await this.createDatabaseConnection()}afterConnect(){return Promise.resolve()}async disconnect(){return new Promise((e,t)=>{this.queryRunner=void 0,this.databaseConnection.close(n=>n?t(n):e())})}hasAttachedDatabases(){return!!Object.keys(this.attachedDatabases).length}getAttachedDatabaseHandleByRelativePath(e){return this.attachedDatabases?.[e]?.attachHandle}getAttachedDatabasePathRelativeByHandle(e){return Object.values(this.attachedDatabases).find(({attachHandle:t})=>e===t)?.attachFilepathRelative}createSchemaBuilder(){return new qa(this.connection)}preparePersistentValue(e,t){return t.transformer&&(e=Bt.transformTo(t.transformer,e)),e==null?e:t.type===Boolean||t.type==="boolean"?e===!0?1:0:t.type==="date"?Ne.mixedDateToDateString(e):t.type==="time"?Ne.mixedDateToTimeString(e):t.type==="datetime"||t.type===Date?Ne.mixedDateToUtcDatetimeString(e):t.type==="simple-array"?Ne.simpleArrayToString(e):t.type==="simple-json"?Ne.simpleJsonToString(e):t.type==="simple-enum"?Ne.simpleEnumToString(e):e}prepareHydratedValue(e,t){return e==null?t.transformer?Bt.transformFrom(t.transformer,e):e:(t.type===Boolean||t.type==="boolean"?e=!!e:t.type==="datetime"||t.type===Date?(e&&typeof e=="string"&&(/^\d\d\d\d-\d\d-\d\d \d\d:\d\d/.test(e)&&(e=e.replace(" ","T")),/^\d\d\d\d-\d\d-\d\dT\d\d:\d\d(:\d\d(\.\d\d\d)?)?$/.test(e)&&(e+="Z")),e=Ne.normalizeHydratedDate(e)):t.type==="date"?e=Ne.mixedDateToDateString(e):t.type==="time"?e=Ne.mixedTimeToString(e):t.type==="simple-array"?e=Ne.stringToSimpleArray(e):t.type==="simple-json"?e=Ne.stringToSimpleJson(e):t.type==="simple-enum"?e=Ne.stringToSimpleEnum(e,t):t.type===Number&&(e=isNaN(+e)?e:parseInt(e)),t.transformer&&(e=Bt.transformFrom(t.transformer,e)),e)}escapeQueryWithParameters(e,t,n){let s=Object.keys(n).map(i=>typeof n[i]=="boolean"?n[i]===!0?1:0:n[i]instanceof Date?Ne.mixedDateToUtcDatetimeString(n[i]):n[i]);return!t||!Object.keys(t).length?[e,s]:(e=e.replace(/:(\.\.\.)?([A-Za-z0-9_.]+)/g,(i,r,o)=>{if(!t.hasOwnProperty(o))return i;let c=t[o];return r?c.map(l=>(s.push(l),this.createParameter(o,s.length-1))).join(", "):typeof c=="function"?c():typeof c=="number"?String(c):c instanceof Date?(s.push(Ne.mixedDateToUtcDatetimeString(c)),this.createParameter(o,s.length-1)):(s.push(c),this.createParameter(o,s.length-1))}),[e,s])}escape(e){return'"'+e+'"'}buildTableName(e,t,n){return e}parseTableName(e){let t=this.database,n=void 0;if($.isTable(e)||$.isView(e)){let i=this.parseTableName(e.schema?`"${e.schema}"."${e.name}"`:e.name);return{database:e.database||i.database||t,schema:e.schema||i.schema||n,tableName:i.tableName}}if($.isTableForeignKey(e)){let i=this.parseTableName(e.referencedTableName);return{database:e.referencedDatabase||i.database||t,schema:e.referencedSchema||i.schema||n,tableName:i.tableName}}if($.isEntityMetadata(e))return{database:e.database||t,schema:e.schema||n,tableName:e.tableName};let s=e.split(".");return s.length===3?{database:s[0]||t,schema:s[1]||n,tableName:s[2]}:s.length===2?{database:this.getAttachedDatabasePathRelativeByHandle(s[0])??t,schema:s[0],tableName:s[1]}:{database:t,schema:n,tableName:e}}normalizeType(e){return e.type===Number||e.type==="int"?"integer":e.type===String?"varchar":e.type===Date?"datetime":e.type===Boolean?"boolean":e.type==="uuid"?"varchar":e.type==="simple-array"||e.type==="simple-json"?"text":e.type==="simple-enum"?"varchar":e.type||""}normalizeDefault(e){let t=e.default;if(typeof t=="number")return""+t;if(typeof t=="boolean")return t?"1":"0";if(typeof t=="function")return t();if(typeof t=="string")return`'${t}'`;if(t!=null)return`${t}`}normalizeIsUnique(e){return e.entityMetadata.uniques.some(t=>t.columns.length===1&&t.columns[0]===e)}getColumnLength(e){return e.length?e.length.toString():""}createFullType(e){let t=e.type;return e.enum?"varchar":(e.length?t+="("+e.length+")":e.precision!==null&&e.precision!==void 0&&e.scale!==null&&e.scale!==void 0?t+="("+e.precision+","+e.scale+")":e.precision!==null&&e.precision!==void 0&&(t+="("+e.precision+")"),e.isArray&&(t+=" array"),t)}obtainMasterConnection(){return Promise.resolve()}obtainSlaveConnection(){return Promise.resolve()}createGeneratedMap(e,t,n,s){let i=e.generatedColumns.reduce((r,o)=>{let c;return o.generationStrategy==="increment"&&t&&(c=t-s+n+1),c?ce.mergeDeep(r,o.createValueMap(c)):r},{});return Object.keys(i).length>0?i:void 0}findChangedColumns(e,t){return t.filter(n=>{let s=e.find(r=>r.name===n.databaseName);return s?s.name!==n.databaseName||s.type!==this.normalizeType(n)||s.length!==n.length||s.precision!==n.precision||s.scale!==n.scale||this.normalizeDefault(n)!==s.default||s.isPrimary!==n.isPrimary||s.isNullable!==n.isNullable||s.generatedType!==n.generatedType||s.asExpression!==n.asExpression||s.isUnique!==this.normalizeIsUnique(n)||n.generationStrategy!=="uuid"&&s.isGenerated!==n.isGenerated:!1})}isReturningSqlSupported(){return!1}isUUIDGenerationSupported(){return!1}isFullTextColumnTypeSupported(){return!1}createParameter(e,t){return"?"}createDatabaseConnection(){throw new v("Do not use AbstractSqlite directly, it has to be used with one of the sqlite drivers")}loadDependencies(){}},Me=class{constructor(e,t){this.query=e,this.parameters=t,this["@instanceof"]=Symbol.for("Query")}},Tn=class{constructor(){this.upQueries=[],this.downQueries=[]}},Ba=class{constructor(){this.isReleased=!1,this.isTransactionActive=!1,this.data={},this.loadedTables=[],this.loadedViews=[],this.sqlMemoryMode=!1,this.sqlInMemory=new Tn,this.transactionDepth=0,this.cachedTablePaths={}}async beforeMigration(){}async afterMigration(){}async getTable(e){return this.loadedTables=await this.loadTables([e]),this.loadedTables.length>0?this.loadedTables[0]:void 0}async getTables(e){return e?(this.loadedTables=await this.loadTables(e),this.loadedTables):await this.loadTables(e)}async getView(e){return this.loadedViews=await this.loadViews([e]),this.loadedViews.length>0?this.loadedViews[0]:void 0}async getViews(e){return this.loadedViews=await this.loadViews(e),this.loadedViews}enableSqlMemory(){this.sqlInMemory=new Tn,this.sqlMemoryMode=!0}disableSqlMemory(){this.sqlInMemory=new Tn,this.sqlMemoryMode=!1}clearSqlMemory(){this.sqlInMemory=new Tn}getMemorySql(){return this.sqlInMemory}async executeMemoryUpSql(){for(let{query:e,parameters:t}of this.sqlInMemory.upQueries)await this.query(e,t)}async executeMemoryDownSql(){for(let{query:e,parameters:t}of this.sqlInMemory.downQueries.reverse())await this.query(e,t)}getReplicationMode(){return this.mode}async getCachedView(e){let t=this.loadedViews.find(s=>s.name===e);if(t)return t;let n=await this.loadViews([e]);if(n.length>0)return this.loadedViews.push(n[0]),n[0];throw new v(`View "${e}" does not exist.`)}async getCachedTable(e){if(e in this.cachedTablePaths){let n=this.cachedTablePaths[e],s=this.loadedTables.find(i=>this.getTablePath(i)===n);if(s)return s}let t=await this.loadTables([e]);if(t.length>0){let n=this.getTablePath(t[0]),s=this.loadedTables.find(i=>this.getTablePath(i)===n);return s||(this.cachedTablePaths[e]=this.getTablePath(t[0]),this.loadedTables.push(t[0]),t[0])}else throw new v(`Table "${e}" does not exist.`)}replaceCachedTable(e,t){let n=this.getTablePath(e),s=this.loadedTables.find(i=>this.getTablePath(i)===n);for(let[i,r]of Object.entries(this.cachedTablePaths))r===n&&(this.cachedTablePaths[i]=this.getTablePath(t));s&&(s.database=t.database,s.schema=t.schema,s.name=t.name,s.columns=t.columns,s.indices=t.indices,s.foreignKeys=t.foreignKeys,s.uniques=t.uniques,s.checks=t.checks,s.justCreated=t.justCreated,s.engine=t.engine)}getTablePath(e){let t=this.connection.driver.parseTableName(e);return this.connection.driver.buildTableName(t.tableName,t.schema,t.database)}getTypeormMetadataTableName(){let e;return e=this.connection.driver.options,this.connection.driver.buildTableName(this.connection.metadataTableName,e.schema,e.database)}selectTypeormMetadataSql({database:e,schema:t,table:n,type:s,name:i}){let r=this.connection.createQueryBuilder(),o=r.select().from(this.getTypeormMetadataTableName(),"t").where(`${r.escape("type")} = :type`,{type:s}).andWhere(`${r.escape("name")} = :name`,{name:i});e&&o.andWhere(`${r.escape("database")} = :database`,{database:e}),t&&o.andWhere(`${r.escape("schema")} = :schema`,{schema:t}),n&&o.andWhere(`${r.escape("table")} = :table`,{table:n});let[c,l]=o.getQueryAndParameters();return new Me(c,l)}insertTypeormMetadataSql({database:e,schema:t,table:n,type:s,name:i,value:r}){let[o,c]=this.connection.createQueryBuilder().insert().into(this.getTypeormMetadataTableName()).values({database:e,schema:t,table:n,type:s,name:i,value:r}).getQueryAndParameters();return new Me(o,c)}deleteTypeormMetadataSql({database:e,schema:t,table:n,type:s,name:i}){let r=this.connection.createQueryBuilder(),o=r.delete().from(this.getTypeormMetadataTableName()).where(`${r.escape("type")} = :type`,{type:s}).andWhere(`${r.escape("name")} = :name`,{name:i});e&&o.andWhere(`${r.escape("database")} = :database`,{database:e}),t&&o.andWhere(`${r.escape("schema")} = :schema`,{schema:t}),n&&o.andWhere(`${r.escape("table")} = :table`,{table:n});let[c,l]=o.getQueryAndParameters();return new Me(c,l)}isColumnChanged(e,t,n,s){return e.charset!==t.charset||e.collation!==t.collation||e.precision!==t.precision||e.scale!==t.scale||e.width!==t.width||e.zerofill!==t.zerofill||e.unsigned!==t.unsigned||e.asExpression!==t.asExpression||n&&e.default!==t.default||e.onUpdate!==t.onUpdate||e.isNullable!==t.isNullable||s&&e.comment!==t.comment||!ce.isArraysEqual(e.enum||[],t.enum||[])}isDefaultColumnLength(e,t,n){if(this.connection.hasMetadata(e.name)){let i=this.connection.getMetadata(e.name).findColumnWithDatabaseName(t.name);if(i&&this.connection.driver.getColumnLength(i))return!1}return this.connection.driver.dataTypeDefaults&&this.connection.driver.dataTypeDefaults[t.type]&&this.connection.driver.dataTypeDefaults[t.type].length?this.connection.driver.dataTypeDefaults[t.type].length.toString()===n.toString():!1}isDefaultColumnPrecision(e,t,n){if(this.connection.hasMetadata(e.name)){let i=this.connection.getMetadata(e.name).findColumnWithDatabaseName(t.name);if(i&&i.precision!==null&&i.precision!==void 0)return!1}return this.connection.driver.dataTypeDefaults&&this.connection.driver.dataTypeDefaults[t.type]&&this.connection.driver.dataTypeDefaults[t.type].precision!==null&&this.connection.driver.dataTypeDefaults[t.type].precision!==void 0?this.connection.driver.dataTypeDefaults[t.type].precision===n:!1}isDefaultColumnScale(e,t,n){if(this.connection.hasMetadata(e.name)){let i=this.connection.getMetadata(e.name).findColumnWithDatabaseName(t.name);if(i&&i.scale!==null&&i.scale!==void 0)return!1}return this.connection.driver.dataTypeDefaults&&this.connection.driver.dataTypeDefaults[t.type]&&this.connection.driver.dataTypeDefaults[t.type].scale!==null&&this.connection.driver.dataTypeDefaults[t.type].scale!==void 0?this.connection.driver.dataTypeDefaults[t.type].scale===n:!1}async executeQueries(e,t){if($.isQuery(e)&&(e=[e]),$.isQuery(t)&&(t=[t]),this.sqlInMemory.upQueries.push(...e),this.sqlInMemory.downQueries.push(...t),this.sqlMemoryMode===!0)return Promise.resolve();for(let{query:n,parameters:s}of e)await this.query(n,s)}generateIndexName(e,t){return this.connection.namingStrategy.indexName(e,t.columnNames,t.where)}},Ie=(function(a){return a.VIEW="VIEW",a.MATERIALIZED_VIEW="MATERIALIZED_VIEW",a.GENERATED_COLUMN="GENERATED_COLUMN",a})(Ie||{}),Pn=class extends Ba{constructor(){super(),this.transactionPromise=null}connect(){return Promise.resolve(this.driver.databaseConnection)}release(){return this.loadedTables=[],this.clearSqlMemory(),Promise.resolve()}async startTransaction(e){if(this.driver.transactionSupport==="none")throw new v(`Transactions aren't supported by ${this.connection.driver.options.type}.`);if(this.isTransactionActive&&this.driver.transactionSupport==="simple")throw new Xr;if(e&&e!=="READ UNCOMMITTED"&&e!=="SERIALIZABLE")throw new v("SQLite only supports SERIALIZABLE and READ UNCOMMITTED isolation");this.isTransactionActive=!0;try{await this.broadcaster.broadcast("BeforeTransactionStart")}catch(t){throw this.isTransactionActive=!1,t}this.transactionDepth===0?(e&&(e==="READ UNCOMMITTED"?await this.query("PRAGMA read_uncommitted = true"):await this.query("PRAGMA read_uncommitted = false")),await this.query("BEGIN TRANSACTION")):await this.query(`SAVEPOINT typeorm_${this.transactionDepth}`),this.transactionDepth+=1,await this.broadcaster.broadcast("AfterTransactionStart")}async commitTransaction(){if(!this.isTransactionActive)throw new hi;await this.broadcaster.broadcast("BeforeTransactionCommit"),this.transactionDepth>1?await this.query(`RELEASE SAVEPOINT typeorm_${this.transactionDepth-1}`):(await this.query("COMMIT"),this.isTransactionActive=!1),this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionCommit")}async rollbackTransaction(){if(!this.isTransactionActive)throw new hi;await this.broadcaster.broadcast("BeforeTransactionRollback"),this.transactionDepth>1?await this.query(`ROLLBACK TO SAVEPOINT typeorm_${this.transactionDepth-1}`):(await this.query("ROLLBACK"),this.isTransactionActive=!1),this.transactionDepth-=1,await this.broadcaster.broadcast("AfterTransactionRollback")}stream(e,t,n,s){throw new v("Stream is not supported by sqlite driver.")}async getDatabases(){return Promise.resolve([])}async getSchemas(e){return Promise.resolve([])}async hasDatabase(e){return Promise.resolve(!1)}async getCurrentDatabase(){return Promise.resolve(void 0)}async hasSchema(e){throw new v("This driver does not support table schemas")}async getCurrentSchema(){return Promise.resolve(void 0)}async hasTable(e){let n=`SELECT * FROM "sqlite_master" WHERE "type" = 'table' AND "name" = '${$.isTable(e)?e.name:e}'`;return!!(await this.query(n)).length}async hasColumn(e,t){let n=$.isTable(e)?e.name:e,s=`PRAGMA table_xinfo(${this.escapePath(n)})`;return!!(await this.query(s)).find(r=>r.name===t)}async createDatabase(e,t){return Promise.resolve()}async dropDatabase(e,t){return Promise.resolve()}async createSchema(e,t){return Promise.resolve()}async dropSchema(e,t){return Promise.resolve()}async createTable(e,t=!1,n=!0,s=!0){let i=[],r=[];if(t&&await this.hasTable(e))return Promise.resolve();i.push(this.createTableSql(e,n)),r.push(this.dropTableSql(e)),s&&e.indices.forEach(c=>{c.name||(c.name=this.connection.namingStrategy.indexName(e,c.columnNames,c.where)),i.push(this.createIndexSql(e,c)),r.push(this.dropIndexSql(c))});let o=e.columns.filter(c=>c.generatedType&&c.asExpression);for(let c of o){let l=this.insertTypeormMetadataSql({table:e.name,type:Ie.GENERATED_COLUMN,name:c.name,value:c.asExpression}),u=this.deleteTypeormMetadataSql({table:e.name,type:Ie.GENERATED_COLUMN,name:c.name});i.push(l),r.push(u)}await this.executeQueries(i,r)}async dropTable(e,t,n=!0,s=!0){if(t&&!await this.hasTable(e))return Promise.resolve();let i=n,r=$.isTable(e)?e:await this.getCachedTable(e),o=[],c=[];s&&r.indices.forEach(u=>{o.push(this.dropIndexSql(u)),c.push(this.createIndexSql(r,u))}),o.push(this.dropTableSql(r,t)),c.push(this.createTableSql(r,i));let l=r.columns.filter(u=>u.generatedType&&u.asExpression);for(let u of l){let h=this.deleteTypeormMetadataSql({table:r.name,type:Ie.GENERATED_COLUMN,name:u.name}),d=this.insertTypeormMetadataSql({table:r.name,type:Ie.GENERATED_COLUMN,name:u.name,value:u.asExpression});o.push(h),c.push(d)}await this.executeQueries(o,c)}async createView(e,t=!1){let n=[],s=[];n.push(this.createViewSql(e)),t&&n.push(this.insertViewDefinitionSql(e)),s.push(this.dropViewSql(e)),t&&s.push(this.deleteViewDefinitionSql(e)),await this.executeQueries(n,s)}async dropView(e){let t=$.isView(e)?e.name:e,n=await this.getCachedView(t),s=[],i=[];s.push(this.deleteViewDefinitionSql(n)),s.push(this.dropViewSql(n)),i.push(this.insertViewDefinitionSql(n)),i.push(this.createViewSql(n)),await this.executeQueries(s,i)}async renameTable(e,t){let n=$.isTable(e)?e:await this.getCachedTable(e),s=n.clone();s.name=t;let i=new Me(`ALTER TABLE ${this.escapePath(n.name)} RENAME TO ${this.escapePath(t)}`),r=new Me(`ALTER TABLE ${this.escapePath(t)} RENAME TO ${this.escapePath(n.name)}`);await this.executeQueries(i,r),s.uniques.forEach(o=>{let c=this.connection.namingStrategy.uniqueConstraintName(n,o.columnNames);o.name===c&&(o.name=this.connection.namingStrategy.uniqueConstraintName(s,o.columnNames))}),s.foreignKeys.forEach(o=>{let c=this.connection.namingStrategy.foreignKeyName(n,o.columnNames,this.getTablePath(o),o.referencedColumnNames);o.name===c&&(o.name=this.connection.namingStrategy.foreignKeyName(s,o.columnNames,this.getTablePath(o),o.referencedColumnNames))}),s.indices.forEach(o=>{let c=this.connection.namingStrategy.indexName(n,o.columnNames,o.where);o.name===c&&(o.name=this.connection.namingStrategy.indexName(s,o.columnNames,o.where))}),n.name=s.name,await this.recreateTable(s,n)}async addColumn(e,t){let n=$.isTable(e)?e:await this.getCachedTable(e);return this.addColumns(n,[t])}async addColumns(e,t){let n=$.isTable(e)?e:await this.getCachedTable(e),s=n.clone();t.forEach(i=>s.addColumn(i)),await this.recreateTable(s,n)}async renameColumn(e,t,n){let s=$.isTable(e)?e:await this.getCachedTable(e),i=$.isTableColumn(t)?t:s.columns.find(o=>o.name===t);if(!i)throw new v(`Column "${t}" was not found in the "${s.name}" table.`);let r;return $.isTableColumn(n)?r=n:(r=i.clone(),r.name=n),this.changeColumn(s,i,r)}async changeColumn(e,t,n){let s=$.isTable(e)?e:await this.getCachedTable(e),i=$.isTableColumn(t)?t:s.columns.find(r=>r.name===t);if(!i)throw new v(`Column "${t}" was not found in the "${s.name}" table.`);await this.changeColumns(s,[{oldColumn:i,newColumn:n}])}async changeColumns(e,t){let n=$.isTable(e)?e:await this.getCachedTable(e),s=n.clone();t.forEach(i=>{i.newColumn.name!==i.oldColumn.name&&(s.findColumnUniques(i.oldColumn).forEach(o=>{let c=this.connection.namingStrategy.uniqueConstraintName(n,o.columnNames);o.columnNames.splice(o.columnNames.indexOf(i.oldColumn.name),1),o.columnNames.push(i.newColumn.name),o.name===c&&(o.name=this.connection.namingStrategy.uniqueConstraintName(s,o.columnNames))}),s.findColumnForeignKeys(i.oldColumn).forEach(o=>{let c=this.connection.namingStrategy.foreignKeyName(n,o.columnNames,this.getTablePath(o),o.referencedColumnNames);o.columnNames.splice(o.columnNames.indexOf(i.oldColumn.name),1),o.columnNames.push(i.newColumn.name),o.name===c&&(o.name=this.connection.namingStrategy.foreignKeyName(s,o.columnNames,this.getTablePath(o),o.referencedColumnNames))}),s.findColumnIndices(i.oldColumn).forEach(o=>{let c=this.connection.namingStrategy.indexName(n,o.columnNames,o.where);o.columnNames.splice(o.columnNames.indexOf(i.oldColumn.name),1),o.columnNames.push(i.newColumn.name),o.name===c&&(o.name=this.connection.namingStrategy.indexName(s,o.columnNames,o.where))}));let r=s.columns.find(o=>o.name===i.oldColumn.name);r&&(s.columns[s.columns.indexOf(r)]=i.newColumn)}),await this.recreateTable(s,n)}async dropColumn(e,t){let n=$.isTable(e)?e:await this.getCachedTable(e),s=$.isTableColumn(t)?t:n.findColumnByName(t);if(!s)throw new v(`Column "${t}" was not found in table "${n.name}"`);await this.dropColumns(n,[s])}async dropColumns(e,t){let n=$.isTable(e)?e:await this.getCachedTable(e),s=n.clone();t.forEach(i=>{let r=$.isTableColumn(i)?i:n.findColumnByName(i);if(!r)throw new Error(`Column "${i}" was not found in table "${n.name}"`);s.removeColumn(r),s.findColumnUniques(r).forEach(o=>s.removeUniqueConstraint(o)),s.findColumnIndices(r).forEach(o=>s.removeIndex(o)),s.findColumnForeignKeys(r).forEach(o=>s.removeForeignKey(o))}),await this.recreateTable(s,n)}async createPrimaryKey(e,t){let n=$.isTable(e)?e:await this.getCachedTable(e),s=n.clone();s.columns.forEach(i=>{t.find(r=>r===i.name)&&(i.isPrimary=!0)}),await this.recreateTable(s,n),n.columns.forEach(i=>{t.find(r=>r===i.name)&&(i.isPrimary=!0)})}async updatePrimaryKeys(e,t){await Promise.resolve()}async dropPrimaryKey(e){let t=$.isTable(e)?e:await this.getCachedTable(e),n=t.clone();n.primaryColumns.forEach(s=>{s.isPrimary=!1}),await this.recreateTable(n,t),t.primaryColumns.forEach(s=>{s.isPrimary=!1})}async createUniqueConstraint(e,t){await this.createUniqueConstraints(e,[t])}async createUniqueConstraints(e,t){let n=$.isTable(e)?e:await this.getCachedTable(e),s=n.clone();t.forEach(i=>s.addUniqueConstraint(i)),await this.recreateTable(s,n)}async dropUniqueConstraint(e,t){let n=$.isTable(e)?e:await this.getCachedTable(e),s=$.isTableUnique(t)?t:n.uniques.find(i=>i.name===t);if(!s)throw new v(`Supplied unique constraint was not found in table ${n.name}`);await this.dropUniqueConstraints(n,[s])}async dropUniqueConstraints(e,t){let n=$.isTable(e)?e:await this.getCachedTable(e),s=n.clone();t.forEach(i=>s.removeUniqueConstraint(i)),await this.recreateTable(s,n)}async createCheckConstraint(e,t){await this.createCheckConstraints(e,[t])}async createCheckConstraints(e,t){let n=$.isTable(e)?e:await this.getCachedTable(e),s=n.clone();t.forEach(i=>s.addCheckConstraint(i)),await this.recreateTable(s,n)}async dropCheckConstraint(e,t){let n=$.isTable(e)?e:await this.getCachedTable(e),s=$.isTableCheck(t)?t:n.checks.find(i=>i.name===t);if(!s)throw new v(`Supplied check constraint was not found in table ${n.name}`);await this.dropCheckConstraints(n,[s])}async dropCheckConstraints(e,t){let n=$.isTable(e)?e:await this.getCachedTable(e),s=n.clone();t.forEach(i=>s.removeCheckConstraint(i)),await this.recreateTable(s,n)}async createExclusionConstraint(e,t){throw new v("Sqlite does not support exclusion constraints.")}async createExclusionConstraints(e,t){throw new v("Sqlite does not support exclusion constraints.")}async dropExclusionConstraint(e,t){throw new v("Sqlite does not support exclusion constraints.")}async dropExclusionConstraints(e,t){throw new v("Sqlite does not support exclusion constraints.")}async createForeignKey(e,t){await this.createForeignKeys(e,[t])}async createForeignKeys(e,t){let n=$.isTable(e)?e:await this.getCachedTable(e),s=n.clone();t.forEach(i=>s.addForeignKey(i)),await this.recreateTable(s,n)}async dropForeignKey(e,t){let n=$.isTable(e)?e:await this.getCachedTable(e),s=$.isTableForeignKey(t)?t:n.foreignKeys.find(i=>i.name===t);if(!s)throw new v(`Supplied foreign key was not found in table ${n.name}`);await this.dropForeignKeys(e,[s])}async dropForeignKeys(e,t){let n=$.isTable(e)?e:await this.getCachedTable(e),s=n.clone();t.forEach(i=>s.removeForeignKey(i)),await this.recreateTable(s,n)}async createIndex(e,t){let n=$.isTable(e)?e:await this.getCachedTable(e);t.name||(t.name=this.generateIndexName(n,t));let s=this.createIndexSql(n,t),i=this.dropIndexSql(t);await this.executeQueries(s,i),n.addIndex(t)}async createIndices(e,t){let n=t.map(s=>this.createIndex(e,s));await Promise.all(n)}async dropIndex(e,t){let n=$.isTable(e)?e:await this.getCachedTable(e),s=$.isTableIndex(t)?t:n.indices.find(o=>o.name===t);if(!s)throw new v(`Supplied index ${t} was not found in table ${n.name}`);s.name||(s.name=this.generateIndexName(n,s));let i=this.dropIndexSql(s),r=this.createIndexSql(n,s);await this.executeQueries(i,r),n.removeIndex(s)}async dropIndices(e,t){let n=t.map(s=>this.dropIndex(e,s));await Promise.all(n)}async clearTable(e){await this.query(`DELETE FROM ${this.escapePath(e)}`)}async clearDatabase(e){let t;e&&this.driver.getAttachedDatabaseHandleByRelativePath(e)&&(t=this.driver.getAttachedDatabaseHandleByRelativePath(e)),await this.query("PRAGMA foreign_keys = OFF");let n=this.isTransactionActive;n||await this.startTransaction();try{let s=t?`SELECT 'DROP VIEW "${t}"."' || name || '";' as query FROM "${t}"."sqlite_master" WHERE "type" = 'view'`:`SELECT 'DROP VIEW "' || name || '";' as query FROM "sqlite_master" WHERE "type" = 'view'`,i=await this.query(s);await Promise.all(i.map(c=>this.query(c.query)));let r=t?`SELECT 'DROP TABLE "${t}"."' || name || '";' as query FROM "${t}"."sqlite_master" WHERE "type" = 'table' AND "name" != 'sqlite_sequence'`:`SELECT 'DROP TABLE "' || name || '";' as query FROM "sqlite_master" WHERE "type" = 'table' AND "name" != 'sqlite_sequence'`,o=await this.query(r);await Promise.all(o.map(c=>this.query(c.query))),n||await this.commitTransaction()}catch(s){try{n||await this.rollbackTransaction()}catch{}throw s}finally{await this.query("PRAGMA foreign_keys = ON")}}async loadViews(e){if(!await this.hasTable(this.getTypeormMetadataTableName()))return[];e||(e=[]);let n=e.map(r=>"'"+r+"'").join(", "),s=`SELECT "t".* FROM "${this.getTypeormMetadataTableName()}" "t" INNER JOIN "sqlite_master" s ON "s"."name" = "t"."name" AND "s"."type" = 'view' WHERE "t"."type" = '${Ie.VIEW}'`;return n.length>0&&(s+=` AND "t"."name" IN (${n})`),(await this.query(s)).map(r=>{let o=new Ni;return o.name=r.name,o.expression=r.value,o})}async loadTableRecords(e,t){let n,[s,i]=this.splitTablePath(e);return s&&this.driver.getAttachedDatabasePathRelativeByHandle(s)&&(n=this.driver.getAttachedDatabasePathRelativeByHandle(s)),await this.query(`SELECT ${n?`'${n}'`:null} as database, ${s?`'${s}'`:null} as schema, * FROM ${s?`"${s}".`:""}${this.escapePath("sqlite_master")} WHERE "type" = '${t}' AND "${t==="table"?"name":"tbl_name"}" IN ('${i}')`)}async loadPragmaRecords(e,t){let[,n]=this.splitTablePath(e);return await this.query(`PRAGMA ${t}("${n}")`)}async loadTables(e){if(e&&e.length===0)return[];let t=[],n;if(e)t=(await Promise.all(e.map(s=>this.loadTableRecords(s,"table")))).reduce((s,i)=>[...s,...i],[]).filter(Boolean),n=(await Promise.all((e??[]).map(s=>this.loadTableRecords(s,"index")))).reduce((s,i)=>[...s,...i],[]).filter(Boolean);else{t.push(...await this.query(`SELECT * FROM "sqlite_master" WHERE "type" = 'table'`));let i=t.map(({name:r})=>`'${r}'`).join(", ");n=await this.query(`SELECT * FROM "sqlite_master" WHERE "type" = 'index' AND "tbl_name" IN (${i})`)}return t.length===0?[]:Promise.all(t.map(async s=>{let i=s.database&&this.driver.getAttachedDatabaseHandleByRelativePath(s.database)?`${this.driver.getAttachedDatabaseHandleByRelativePath(s.database)}.${s.name}`:s.name,r=s.sql,o=r.includes("WITHOUT ROWID"),c=new St({name:i,withoutRowid:o}),[l,u,h]=await Promise.all([this.loadPragmaRecords(i,"table_xinfo"),this.loadPragmaRecords(i,"index_list"),this.loadPragmaRecords(i,"foreign_key_list")]),d,f=s.sql,p=f.toUpperCase().indexOf("AUTOINCREMENT");if(p!==-1){d=f.substr(0,p);let T=d.lastIndexOf(","),O=d.lastIndexOf("(");T!==-1?(d=d.substr(T),d=d.substr(0,d.lastIndexOf('"')),d=d.substr(d.indexOf('"')+1)):O!==-1&&(d=d.substr(O),d=d.substr(0,d.lastIndexOf('"')),d=d.substr(d.indexOf('"')+1))}c.columns=await Promise.all(l.map(async T=>{let O=new Ht;if(O.name=T.name,O.type=T.type.toLowerCase(),O.default=T.dflt_value!==null&&T.dflt_value!==void 0?T.dflt_value:void 0,O.isNullable=T.notnull===0,O.isPrimary=T.pk>0,O.comment="",O.isGenerated=d===T.name,O.isGenerated&&(O.generationStrategy="increment"),T.hidden===2||T.hidden===3){O.generatedType=T.hidden===2?"VIRTUAL":"STORED";let V=await this.selectTypeormMetadataSql({table:c.name,type:Ie.GENERATED_COLUMN,name:O.name}),me=await this.query(V.query,V.parameters);me[0]&&me[0].value?O.asExpression=me[0].value:O.asExpression=""}if(O.type==="varchar"){let V=r.match(new RegExp('"('+O.name+`)" varchar CHECK\\s*\\(\\s*"\\1"\\s+IN\\s*\\(('[^']+'(?:\\s*,\\s*'[^']+')+)\\s*\\)\\s*\\)`));V&&(O.enum=V[2].substr(1,V[2].length-2).split("','"))}let k=O.type.indexOf("(");if(k!==-1){let V=O.type,me=V.substr(0,k);if(this.driver.withLengthColumnTypes.find(fe=>fe===me)){let fe=parseInt(V.substring(k+1,V.length-1));fe&&(O.length=fe.toString(),O.type=me)}if(this.driver.withPrecisionColumnTypes.find(fe=>fe===me)){let fe=new RegExp(`^${me}\\((\\d+),?\\s?(\\d+)?\\)`),we=V.match(fe);we&&we[1]&&(O.precision=+we[1]),this.driver.withScaleColumnTypes.find(Ae=>Ae===me)&&we&&we[2]&&(O.scale=+we[2]),O.type=me}}return O}));let m,x=[],S=/CONSTRAINT "([^"]*)" FOREIGN KEY ?\((.*?)\) REFERENCES "([^"]*)"/g;for(;(m=S.exec(r))!==null;)x.push({name:m[1],columns:m[2].substr(1,m[2].length-2).split('", "'),referencedTableName:m[3]});let G=ce.uniq(h,T=>T.id);c.foreignKeys=G.map(T=>{let O=h.filter(fe=>fe.id===T.id&&fe.table===T.table),k=O.map(fe=>fe.from),V=O.map(fe=>fe.to),me=x.find(fe=>fe.referencedTableName===T.table&&fe.columns.every(we=>k.indexOf(we)!==-1));return new hs({name:me.name,columnNames:k,referencedTableName:T.table,referencedColumnNames:V,onDelete:T.on_delete,onUpdate:T.on_update})});let D,q=[],J=/CONSTRAINT "([^"]*)" UNIQUE ?\((.*?)\)/g;for(;(D=J.exec(r))!==null;)q.push({name:D[1],columns:D[2].substr(1,D[2].length-2).split('", "')});let re=u.filter(T=>T.origin==="u").map(T=>T.name).filter((T,O,k)=>k.indexOf(T)===O).map(async T=>{let O=u.find(fe=>fe.name===T),V=(await this.query(`PRAGMA index_info("${O.name}")`)).sort((fe,we)=>parseInt(fe.seqno)-parseInt(we.seqno)).map(fe=>fe.name);if(V.length===1){let fe=c.columns.find(we=>!!V.find(Ae=>Ae===we.name));fe&&(fe.isUnique=!0)}let me=q.find(fe=>fe.columns.every(we=>V.indexOf(we)!==-1));return new Kt({name:me?me.name:this.connection.namingStrategy.uniqueConstraintName(c,V),columnNames:V})});c.uniques=await Promise.all(re);let le,ue=/CONSTRAINT "([^"]*)" CHECK ?(\(.*?\))([,]|[)]$)/g;for(;(le=ue.exec(r))!==null;)c.checks.push(new An({name:le[1],expression:le[2]}));let de=u.filter(T=>T.origin==="c").map(T=>T.name).filter((T,O,k)=>k.indexOf(T)===O).map(async T=>{let O=n.find($e=>$e.name===T),k=/WHERE (.*)/.exec(O.sql),V=u.find($e=>$e.name===T),fe=(await this.query(`PRAGMA index_info("${V.name}")`)).sort(($e,yt)=>parseInt($e.seqno)-parseInt(yt.seqno)).map($e=>$e.name),we=`${s.database?`${s.database}.`:""}${V.name}`,Ae=V.unique==="1"||V.unique===1;return new Lt({table:c,name:we,columnNames:fe,isUnique:Ae,where:k?k[1]:void 0})}),E=await Promise.all(de);return c.indices=E.filter(T=>!!T),c}))}createTableSql(e,t,n){let s=e.columns.filter(f=>f.isPrimary),i=s.find(f=>f.isGenerated&&f.generationStrategy==="increment"),r=s.length>1;if(r&&i)throw new v("Sqlite does not support AUTOINCREMENT on composite primary key");let o=e.columns.map(f=>this.buildCreateColumnSql(f,r)).join(", "),[c]=this.splitTablePath(e.name),l=`CREATE TABLE ${this.escapePath(e.name)} (${o}`,[u,h]=this.splitTablePath(e.name),d=n?`${u?`${u}.`:""}${h.replace(/^temporary_/,"")}`:e.name;if(e.columns.filter(f=>f.isUnique).forEach(f=>{e.uniques.some(m=>m.columnNames.length===1&&m.columnNames[0]===f.name)||e.uniques.push(new Kt({name:this.connection.namingStrategy.uniqueConstraintName(e,[f.name]),columnNames:[f.name]}))}),e.uniques.length>0){let f=e.uniques.map(p=>{let m=p.name?p.name:this.connection.namingStrategy.uniqueConstraintName(d,p.columnNames),x=p.columnNames.map(S=>`"${S}"`).join(", ");return`CONSTRAINT "${m}" UNIQUE (${x})`}).join(", ");l+=`, ${f}`}if(e.checks.length>0){let f=e.checks.map(p=>`CONSTRAINT "${p.name?p.name:this.connection.namingStrategy.checkConstraintName(d,p.expression)}" CHECK (${p.expression})`).join(", ");l+=`, ${f}`}if(e.foreignKeys.length>0&&t){let f=e.foreignKeys.filter(p=>{let[m]=this.splitTablePath(p.referencedTableName);return m===c}).map(p=>{let[,m]=this.splitTablePath(p.referencedTableName),x=p.columnNames.map(D=>`"${D}"`).join(", ");p.name||(p.name=this.connection.namingStrategy.foreignKeyName(d,p.columnNames,this.getTablePath(p),p.referencedColumnNames));let S=p.referencedColumnNames.map(D=>`"${D}"`).join(", "),G=`CONSTRAINT "${p.name}" FOREIGN KEY (${x}) REFERENCES "${m}" (${S})`;return p.onDelete&&(G+=` ON DELETE ${p.onDelete}`),p.onUpdate&&(G+=` ON UPDATE ${p.onUpdate}`),p.deferrable&&(G+=` DEFERRABLE ${p.deferrable}`),G}).join(", ");l+=`, ${f}`}if(s.length>1){let f=s.map(p=>`"${p.name}"`).join(", ");l+=`, PRIMARY KEY (${f})`}return l+=")",e.withoutRowid&&(l+=" WITHOUT ROWID"),new Me(l)}dropTableSql(e,t){let n=$.isTable(e)?e.name:e,s=t?`DROP TABLE IF EXISTS ${this.escapePath(n)}`:`DROP TABLE ${this.escapePath(n)}`;return new Me(s)}createViewSql(e){return typeof e.expression=="string"?new Me(`CREATE VIEW "${e.name}" AS ${e.expression}`):new Me(`CREATE VIEW "${e.name}" AS ${e.expression(this.connection).getQuery()}`)}insertViewDefinitionSql(e){let t=typeof e.expression=="string"?e.expression.trim():e.expression(this.connection).getQuery();return this.insertTypeormMetadataSql({type:Ie.VIEW,name:e.name,value:t})}dropViewSql(e){let t=$.isView(e)?e.name:e;return new Me(`DROP VIEW "${t}"`)}deleteViewDefinitionSql(e){let t=$.isView(e)?e.name:e;return this.deleteTypeormMetadataSql({type:Ie.VIEW,name:t})}createIndexSql(e,t){let n=t.columnNames.map(r=>`"${r}"`).join(", "),[s,i]=this.splitTablePath(e.name);return new Me(`CREATE ${t.isUnique?"UNIQUE ":""}INDEX ${s?`"${s}".`:""}${this.escapePath(t.name)} ON "${i}" (${n}) ${t.where?"WHERE "+t.where:""}`)}dropIndexSql(e){let t=$.isTableIndex(e)?e.name:e;return new Me(`DROP INDEX ${this.escapePath(t)}`)}buildCreateColumnSql(e,t){let n='"'+e.name+'"';return $.isColumnMetadata(e)?n+=" "+this.driver.normalizeType(e):n+=" "+this.connection.driver.createFullType(e),e.enum&&(n+=' CHECK( "'+e.name+'" IN ('+e.enum.map(s=>"'"+s+"'").join(",")+") )"),e.isPrimary&&!t&&(n+=" PRIMARY KEY"),e.isGenerated===!0&&e.generationStrategy==="increment"&&(n+=" AUTOINCREMENT"),e.collation&&(n+=" COLLATE "+e.collation),e.isNullable!==!0&&(n+=" NOT NULL"),e.asExpression?n+=` AS (${e.asExpression}) ${e.generatedType?e.generatedType:"VIRTUAL"}`:e.default!==void 0&&e.default!==null&&(n+=" DEFAULT ("+e.default+")"),n}async recreateTable(e,t,n=!0){let s=[],i=[];t.indices.forEach(l=>{s.push(this.dropIndexSql(l)),i.push(this.createIndexSql(t,l))});let[r,o]=this.splitTablePath(e.name),[,c]=this.splitTablePath(t.name);if(e.name=o=`${r?`${r}.`:""}temporary_${o}`,s.push(this.createTableSql(e,!0,!0)),i.push(this.dropTableSql(e)),n){let l=e.columns.filter(h=>!h.generatedType).map(h=>`"${h.name}"`),u=t.columns.filter(h=>!h.generatedType).map(h=>`"${h.name}"`);u.length<l.length?l=e.columns.filter(h=>{let d=t.columns.find(f=>f.name===h.name);return d&&d.generatedType?!1:!h.generatedType&&d}).map(h=>`"${h.name}"`):u.length>l.length&&(u=t.columns.filter(h=>!h.generatedType&&e.columns.find(d=>d.name===h.name)).map(h=>`"${h.name}"`)),s.push(new Me(`INSERT INTO ${this.escapePath(e.name)}(${l.join(", ")}) SELECT ${u.join(", ")} FROM ${this.escapePath(t.name)}`)),i.push(new Me(`INSERT INTO ${this.escapePath(t.name)}(${u.join(", ")}) SELECT ${l.join(", ")} FROM ${this.escapePath(e.name)}`))}s.push(this.dropTableSql(t)),i.push(this.createTableSql(t,!0)),s.push(new Me(`ALTER TABLE ${this.escapePath(e.name)} RENAME TO ${this.escapePath(c)}`)),i.push(new Me(`ALTER TABLE ${this.escapePath(t.name)} RENAME TO ${this.escapePath(o)}`)),e.name=t.name,e.indices.forEach(l=>{l.name||(l.name=this.connection.namingStrategy.indexName(e,l.columnNames,l.where)),s.push(this.createIndexSql(e,l)),i.push(this.dropIndexSql(l))}),t.columns.filter(l=>{let u=e.columns.find(h=>h.name===l.name);return l.generatedType&&l.asExpression&&(!u||!u.generatedType&&!u.asExpression)}).forEach(l=>{let u=this.deleteTypeormMetadataSql({table:t.name,type:Ie.GENERATED_COLUMN,name:l.name}),h=this.insertTypeormMetadataSql({table:t.name,type:Ie.GENERATED_COLUMN,name:l.name,value:l.asExpression});s.push(u),i.push(h)}),e.columns.filter(l=>l.generatedType&&l.asExpression&&!t.columns.some(u=>u.name===l.name)).forEach(l=>{let u=this.insertTypeormMetadataSql({table:e.name,type:Ie.GENERATED_COLUMN,name:l.name,value:l.asExpression}),h=this.deleteTypeormMetadataSql({table:e.name,type:Ie.GENERATED_COLUMN,name:l.name});s.push(u),i.push(h)}),e.columns.filter(l=>l.generatedType&&l.asExpression).forEach(l=>{let u=t.columns.find(m=>m.name===l.name&&m.generatedType&&l.generatedType&&m.asExpression!==l.asExpression);if(!u)return;let h=this.deleteTypeormMetadataSql({table:t.name,type:Ie.GENERATED_COLUMN,name:u.name}),d=this.insertTypeormMetadataSql({table:e.name,type:Ie.GENERATED_COLUMN,name:l.name,value:l.asExpression});s.push(h),s.push(d);let f=this.insertTypeormMetadataSql({table:e.name,type:Ie.GENERATED_COLUMN,name:u.name,value:u.asExpression}),p=this.deleteTypeormMetadataSql({table:t.name,type:Ie.GENERATED_COLUMN,name:l.name});i.push(f),i.push(p)}),await this.executeQueries(s,i),this.replaceCachedTable(t,e)}splitTablePath(e){return e.indexOf(".")!==-1?e.split("."):[void 0,e]}escapePath(e,t){return($.isTable(e)||$.isView(e)?e.name:e).replace(/^\.+|\.+$/g,"").split(".").map(s=>t?s:`"${s}"`).join(".")}},_n=class{constructor(e){this.queryRunner=e}async broadcast(e,...t){let n=new Yt,s=this[`broadcast${e}Event`];typeof s=="function"&&s.call(this,n,...t),await n.wait()}broadcastBeforeInsertEvent(e,t,n){n&&t.beforeInsertListeners.length&&t.beforeInsertListeners.forEach(s=>{if(s.isAllowed(n)){let i=s.execute(n);i instanceof Promise&&e.promises.push(i),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(s=>{if(this.isAllowedSubscriber(s,t.target)&&s.beforeInsert){let i=s.beforeInsert({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t});i instanceof Promise&&e.promises.push(i),e.count++}})}broadcastBeforeUpdateEvent(e,t,n,s,i,r){n&&t.beforeUpdateListeners.length&&t.beforeUpdateListeners.forEach(o=>{if(o.isAllowed(n)){let c=o.execute(n);c instanceof Promise&&e.promises.push(c),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(o=>{if(this.isAllowedSubscriber(o,t.target)&&o.beforeUpdate){let c=o.beforeUpdate({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t,databaseEntity:s,updatedColumns:i||[],updatedRelations:r||[]});c instanceof Promise&&e.promises.push(c),e.count++}})}broadcastBeforeRemoveEvent(e,t,n,s){n&&t.beforeRemoveListeners.length&&t.beforeRemoveListeners.forEach(i=>{if(i.isAllowed(n)){let r=i.execute(n);r instanceof Promise&&e.promises.push(r),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(i=>{if(this.isAllowedSubscriber(i,t.target)&&i.beforeRemove){let r=i.beforeRemove({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t,databaseEntity:s,entityId:t.getEntityIdMixedMap(s)});r instanceof Promise&&e.promises.push(r),e.count++}})}broadcastBeforeSoftRemoveEvent(e,t,n,s){n&&t.beforeSoftRemoveListeners.length&&t.beforeSoftRemoveListeners.forEach(i=>{if(i.isAllowed(n)){let r=i.execute(n);r instanceof Promise&&e.promises.push(r),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(i=>{if(this.isAllowedSubscriber(i,t.target)&&i.beforeSoftRemove){let r=i.beforeSoftRemove({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t,databaseEntity:s,entityId:t.getEntityIdMixedMap(s)});r instanceof Promise&&e.promises.push(r),e.count++}})}broadcastBeforeRecoverEvent(e,t,n,s){n&&t.beforeRecoverListeners.length&&t.beforeRecoverListeners.forEach(i=>{if(i.isAllowed(n)){let r=i.execute(n);r instanceof Promise&&e.promises.push(r),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(i=>{if(this.isAllowedSubscriber(i,t.target)&&i.beforeRecover){let r=i.beforeRecover({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t,databaseEntity:s,entityId:t.getEntityIdMixedMap(s)});r instanceof Promise&&e.promises.push(r),e.count++}})}broadcastAfterInsertEvent(e,t,n){n&&t.afterInsertListeners.length&&t.afterInsertListeners.forEach(s=>{if(s.isAllowed(n)){let i=s.execute(n);i instanceof Promise&&e.promises.push(i),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(s=>{if(this.isAllowedSubscriber(s,t.target)&&s.afterInsert){let i=s.afterInsert({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t});i instanceof Promise&&e.promises.push(i),e.count++}})}broadcastBeforeTransactionStartEvent(e){this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(t=>{if(t.beforeTransactionStart){let n=t.beforeTransactionStart({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager});n instanceof Promise&&e.promises.push(n),e.count++}})}broadcastAfterTransactionStartEvent(e){this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(t=>{if(t.afterTransactionStart){let n=t.afterTransactionStart({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager});n instanceof Promise&&e.promises.push(n),e.count++}})}broadcastBeforeTransactionCommitEvent(e){this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(t=>{if(t.beforeTransactionCommit){let n=t.beforeTransactionCommit({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager});n instanceof Promise&&e.promises.push(n),e.count++}})}broadcastAfterTransactionCommitEvent(e){this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(t=>{if(t.afterTransactionCommit){let n=t.afterTransactionCommit({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager});n instanceof Promise&&e.promises.push(n),e.count++}})}broadcastBeforeTransactionRollbackEvent(e){this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(t=>{if(t.beforeTransactionRollback){let n=t.beforeTransactionRollback({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager});n instanceof Promise&&e.promises.push(n),e.count++}})}broadcastAfterTransactionRollbackEvent(e){this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(t=>{if(t.afterTransactionRollback){let n=t.afterTransactionRollback({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager});n instanceof Promise&&e.promises.push(n),e.count++}})}broadcastAfterUpdateEvent(e,t,n,s,i,r){n&&t.afterUpdateListeners.length&&t.afterUpdateListeners.forEach(o=>{if(o.isAllowed(n)){let c=o.execute(n);c instanceof Promise&&e.promises.push(c),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(o=>{if(this.isAllowedSubscriber(o,t.target)&&o.afterUpdate){let c=o.afterUpdate({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t,databaseEntity:s,updatedColumns:i||[],updatedRelations:r||[]});c instanceof Promise&&e.promises.push(c),e.count++}})}broadcastAfterRemoveEvent(e,t,n,s){n&&t.afterRemoveListeners.length&&t.afterRemoveListeners.forEach(i=>{if(i.isAllowed(n)){let r=i.execute(n);r instanceof Promise&&e.promises.push(r),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(i=>{if(this.isAllowedSubscriber(i,t.target)&&i.afterRemove){let r=i.afterRemove({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t,databaseEntity:s,entityId:t.getEntityIdMixedMap(s)});r instanceof Promise&&e.promises.push(r),e.count++}})}broadcastAfterSoftRemoveEvent(e,t,n,s){n&&t.afterSoftRemoveListeners.length&&t.afterSoftRemoveListeners.forEach(i=>{if(i.isAllowed(n)){let r=i.execute(n);r instanceof Promise&&e.promises.push(r),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(i=>{if(this.isAllowedSubscriber(i,t.target)&&i.afterSoftRemove){let r=i.afterSoftRemove({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t,databaseEntity:s,entityId:t.getEntityIdMixedMap(s)});r instanceof Promise&&e.promises.push(r),e.count++}})}broadcastAfterRecoverEvent(e,t,n,s){n&&t.afterRecoverListeners.length&&t.afterRecoverListeners.forEach(i=>{if(i.isAllowed(n)){let r=i.execute(n);r instanceof Promise&&e.promises.push(r),e.count++}}),this.queryRunner.connection.subscribers.length&&this.queryRunner.connection.subscribers.forEach(i=>{if(this.isAllowedSubscriber(i,t.target)&&i.afterRecover){let r=i.afterRecover({connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager,entity:n,metadata:t,databaseEntity:s,entityId:t.getEntityIdMixedMap(s)});r instanceof Promise&&e.promises.push(r),e.count++}})}broadcastLoadEventsForAll(e,t,n){return this.broadcastLoadEvent(e,t,n)}broadcastLoadEvent(e,t,n){let s=this.queryRunner.connection.subscribers.filter(i=>this.isAllowedSubscriber(i,t.target)&&i.afterLoad);if(t.relations.length||t.afterLoadListeners.length||s.length){let i=n.filter(r=>!(r instanceof Promise));t.relations.length&&t.relations.forEach(r=>{i.forEach(o=>{if(r.isLazy&&!o.hasOwnProperty(r.propertyName))return;let c=r.getEntityValue(o);ne.isObject(c)&&this.broadcastLoadEvent(e,r.inverseEntityMetadata,Array.isArray(c)?c:[c])})}),t.afterLoadListeners.length&&t.afterLoadListeners.forEach(r=>{i.forEach(o=>{if(r.isAllowed(o)){let c=r.execute(o);c instanceof Promise&&e.promises.push(c),e.count++}})}),s.forEach(r=>{i.forEach(o=>{let c=r.afterLoad(o,{entity:o,metadata:t,connection:this.queryRunner.connection,queryRunner:this.queryRunner,manager:this.queryRunner.manager});c instanceof Promise&&e.promises.push(c),e.count++})})}}isAllowedSubscriber(e,t){return!e.listenTo||!e.listenTo()||e.listenTo()===Object||e.listenTo()===t||e.listenTo().isPrototypeOf(t)}},In=class{constructor(){this.records=[]}},Fa=class extends Pn{constructor(e){super(),this.driver=e,this.connection=e.connection,this.broadcaster=new _n(this)}async beforeMigration(){await this.query("PRAGMA foreign_keys = OFF")}async afterMigration(){await this.query("PRAGMA foreign_keys = ON")}async query(e,t,n=!1){if(this.isReleased)throw new Mn;let s=await this.connect();this.driver.connection.logger.logQuery(e,t,this);let i=+new Date;try{let r=await new Promise(async(h,d)=>{s.executeSql(e,t,f=>h(f),f=>d(f))}),o=this.driver.options.maxQueryExecutionTime,l=+new Date-i;o&&l>o&&this.driver.connection.logger.logQuerySlow(l,e,t,this);let u=new In;if(e.substr(0,11)==="INSERT INTO")u.raw=r.insertId;else{let h=[];for(let d=0;d<r.rows.length;d++)h.push(r.rows.item(d));u.records=h,u.raw=h}return n?u:u.raw}catch(r){throw this.driver.connection.logger.logQueryError(r,e,t,this),new Sn(e,t,r)}}async startTransaction(){throw new v("Transactions are not supported by the Cordova driver")}async commitTransaction(){throw new v("Transactions are not supported by the Cordova driver")}async rollbackTransaction(){throw new v("Transactions are not supported by the Cordova driver")}async clearDatabase(){await this.query("PRAGMA foreign_keys = OFF");try{let t=await this.query(`SELECT 'DROP VIEW "' || name || '";' as query FROM "sqlite_master" WHERE "type" = 'view'`),s=await this.query(`SELECT 'DROP TABLE "' || name || '";' as query FROM "sqlite_master" WHERE "type" = 'table' AND "name" != 'sqlite_sequence'`);await Promise.all(t.map(i=>this.query(i.query))),await Promise.all(s.map(i=>this.query(i.query)))}finally{await this.query("PRAGMA foreign_keys = ON")}}parametrize(e,t=0){return Object.keys(e).map((n,s)=>`"${n}"=?`)}},La=class extends On{constructor(e){if(super(e),this.database=this.options.database,!this.options.database)throw new Ft("database");if(!this.options.location)throw new Ft("location");this.loadDependencies()}async disconnect(){return this.queryRunner=void 0,new Promise((e,t)=>{this.databaseConnection.close(e,t)})}createQueryRunner(e){return this.queryRunner||(this.queryRunner=new Fa(this)),this.queryRunner}async createDatabaseConnection(){let e=Object.assign({},{name:this.options.database,location:this.options.location},this.options.extra||{}),t=await new Promise(n=>{this.sqlite.openDatabase(e,s=>n(s))});return await new Promise((n,s)=>{t.executeSql("PRAGMA foreign_keys = ON",[],()=>n(),i=>s(i))}),t}loadDependencies(){try{let e=this.options.driver||globalThis.sqlitePlugin;this.sqlite=e}catch{throw new xn("Cordova-SQLite","cordova-sqlite-storage")}}},ka=class extends Pn{constructor(e){super(),this.driver=e,this.connection=e.connection,this.broadcaster=new _n(this)}async beforeMigration(){await this.query("PRAGMA foreign_keys = OFF")}async afterMigration(){await this.query("PRAGMA foreign_keys = ON")}query(e,t,n=!1){if(this.isReleased)throw new Mn;return new Promise(async(s,i)=>{let r=await this.connect();this.driver.connection.logger.logQuery(e,t,this);let o=+new Date;r.executeSql(e,t,c=>{let l=this.driver.options.maxQueryExecutionTime,h=+new Date-o;l&&h>l&&this.driver.connection.logger.logQuerySlow(h,e,t,this);let d=new In;if(e.substr(0,11)==="INSERT INTO"&&(d.raw=c.insertId),c?.hasOwnProperty("rowsAffected")&&(d.affected=c.rowsAffected),c?.hasOwnProperty("rows")){let f=[];for(let p=0;p<c.rows.length;p++)f.push(c.rows.item(p));d.raw=f,d.records=f}s(n?d:d.raw)},c=>{this.driver.connection.logger.logQueryError(c,e,t,this),i(new Sn(e,t,c))})})}parametrize(e,t=0){return Object.keys(e).map((n,s)=>`"${n}"=?`)}},ja=class extends On{constructor(e){if(super(e),this.database=this.options.database,!this.options.database)throw new Ft("database");if(!this.options.location)throw new Ft("location");this.loadDependencies()}async disconnect(){return new Promise((e,t)=>{this.queryRunner=void 0,this.databaseConnection.close(e,t)})}createQueryRunner(e){return this.queryRunner||(this.queryRunner=new ka(this)),this.queryRunner}createDatabaseConnection(){return new Promise((e,t)=>{let n=Object.assign({},{name:this.options.database,location:this.options.location},this.options.extra||{});this.sqlite.openDatabase(n,s=>{let i=s;i.executeSql("PRAGMA foreign_keys = ON",[],r=>{e(i)},r=>{t(r)})},s=>{t(s)})})}loadDependencies(){try{let e=this.options.driver||jc();this.sqlite=e}catch{throw new xn("React-Native","react-native-sqlite-storage")}}},Ua=class extends Pn{constructor(e){super(),this.driver=e,this.connection=e.connection,this.broadcaster=new _n(this)}async beforeMigration(){await this.query("PRAGMA foreign_keys = OFF")}async afterMigration(){await this.query("PRAGMA foreign_keys = ON")}async query(e,t,n=!1){if(this.isReleased)throw new Mn;let s=this.driver.connection;return new Promise(async(i,r)=>{let o=await this.connect(),c=e.substr(0,11)==="INSERT INTO";s.logger.logQuery(e,t,this);let l=(h,d)=>{let f=this.driver.options.maxQueryExecutionTime,m=+new Date-u;f&&m>f&&s.logger.logQuerySlow(m,e,t,this),h&&(s.logger.logQueryError(h,e,t,this),r(new Sn(e,t,h)));let x=new In;x.raw=d,!c&&Array.isArray(d)&&(x.records=d),i(n?x:x.raw)},u=+new Date;c?o.execSQL(e,t,l):o.all(e,t,l)})}parametrize(e,t=0){return Object.keys(e).map((n,s)=>`"${n}"=?`)}},Va=class extends On{constructor(e){if(super(e),this.connection=e,this.options=e.options,this.database=this.options.database,this.driver=this.options.driver,!this.options.database)throw new Ft("database");this.loadDependencies()}async disconnect(){return new Promise((e,t)=>{this.queryRunner=void 0,this.databaseConnection.close().then(e).catch(t)})}createQueryRunner(e){return this.queryRunner||(this.queryRunner=new Ua(this)),this.queryRunner}normalizeType(e){return e.type===Buffer?"blob":super.normalizeType(e)}createDatabaseConnection(){return new Promise((e,t)=>{let n=Object.assign({},{readOnly:this.options.readOnly,key:this.options.key,multithreading:this.options.multithreading,migrate:this.options.migrate,iosFlags:this.options.iosFlags,androidFlags:this.options.androidFlags},this.options.extra||{});new this.sqlite(this.options.database,n,(s,i)=>{if(s)return t(s);i.resultType(this.sqlite.RESULTSASOBJECT),i.execSQL("PRAGMA foreign_keys = ON",[],(r,o)=>{if(r)return t(r);e(i)})})})}loadDependencies(){if(this.sqlite=this.driver,!this.driver)throw new xn("Nativescript","nativescript-sqlite")}},Wa=class extends Pn{constructor(e){super(),this.isDirty=!1,this.driver=e,this.connection=e.connection,this.broadcaster=new _n(this)}async beforeMigration(){await this.query("PRAGMA foreign_keys = OFF")}async afterMigration(){await this.query("PRAGMA foreign_keys = ON")}async flush(){this.isDirty&&(await this.driver.autoSave(),this.isDirty=!1)}async release(){return await this.flush(),super.release()}async commitTransaction(){await super.commitTransaction(),this.isTransactionActive||await this.flush()}async query(e,t=[],n=!1){if(this.isReleased)throw new Mn;let s=e.trim().split(" ",1)[0],i=this.driver.databaseConnection;this.driver.connection.logger.logQuery(e,t,this);let r=+new Date,o;try{o=i.prepare(e),t&&(t=t.map(f=>typeof f<"u"?f:null),o.bind(t));let c=this.driver.options.maxQueryExecutionTime,u=+new Date-r;c&&u>c&&this.driver.connection.logger.logQuerySlow(u,e,t,this);let h=[];for(;o.step();)h.push(o.getAsObject());let d=new In;return d.affected=i.getRowsModified(),d.records=h,d.raw=h,o.free(),s!=="SELECT"&&(this.isDirty=!0),n?d:d.raw}catch(c){throw o&&o.free(),this.driver.connection.logger.logQueryError(c,e,t,this),new Sn(e,t,c)}}},Jp=globalThis.ENV,ih=500,Qa=class extends On{constructor(e){super(e),this.databaseArrayFast={},this.debounceSave=H.debounce(async n=>{await this.localForgeInstance.setItem(n,this.databaseArrayFast[n])},ih);let t=globalThis.localforage;if(this.localForgeInstance=t?.createInstance({driver:t.INDEXEDDB,storeName:"taon-typeorm_"+H.kebabCase(globalThis.CURRENT_PROJECT_GENERIC_NAME)}),this.options.autoSave&&!this.options.location&&!this.options.autoSaveCallback)throw new Ft("location or autoSaveCallback");this.loadDependencies()}async connect(){this.databaseConnection=await this.createDatabaseConnection()}async disconnect(){this.queryRunner=void 0,this.databaseConnection.close()}createQueryRunner(e){return this.queryRunner||(this.queryRunner=new Wa(this)),this.queryRunner}async load(e,t=!0){if(typeof e=="string")if(Te.type==="node")if(Te.fileExist(e)){let n=Te.readFileSync(e);return this.createDatabaseConnectionWithImport(n)}else{if(t)throw new v(`File ${e} does not exist`);return this.createDatabaseConnectionWithImport()}else{let n=null;if(this.options.useLocalForage)if(this.localForgeInstance){if(H.isUndefined(this.databaseArrayFast[e])){let s=await this.localForgeInstance.getItem(e);this.databaseArrayFast[e]=s}n=this.databaseArrayFast[e]}else throw new v("localforage is not defined - please import localforage.js into your site");else n=Te.getGlobalVariable().localStorage.getItem(e);if(n!=null)return this.createDatabaseConnectionWithImport(this.localForgeInstance?n:JSON.parse(n));if(t)throw new v(`File ${e} does not exist`);return this.createDatabaseConnectionWithImport()}else return this.createDatabaseConnectionWithImport(e)}async save(e){if(!e&&!this.options.location)throw new v("No location is set, specify a location parameter or add the location option to your configuration");let t="";if(e?t=e:this.options.location&&(t=this.options.location),Te.type!=="node"){let n=this.databaseConnection.export(),s=[].slice.call(n);if(this.options.useLocalForage)if(this.localForgeInstance)this.databaseArrayFast[t]=s,this.debounceSave(t);else throw new v("localforage is not defined - please import localforage.js into your site");else Te.getGlobalVariable().localStorage.setItem(t,JSON.stringify(s))}}async autoSave(){this.options.autoSave&&!this.queryRunner?.isTransactionActive&&(this.options.autoSaveCallback?await this.options.autoSaveCallback(this.export()):await this.save())}export(){return this.databaseConnection.export()}createGeneratedMap(e,t){let n=e.generatedColumns.reduce((s,i)=>{if(i.isPrimary&&i.generationStrategy==="increment"){let r="SELECT last_insert_rowid()";try{let o=this.databaseConnection.exec(r);return this.connection.logger.logQuery(r),ce.mergeDeep(s,i.createValueMap(o[0].values[0][0]))}catch(o){this.connection.logger.logQueryError(o,r,[])}}return s},{});return Object.keys(n).length>0?n:void 0}createDatabaseConnection(){return this.options.location?this.load(this.options.location,!1):this.createDatabaseConnectionWithImport(this.options.database)}async createDatabaseConnectionWithImport(e){let n=typeof this.sqlite.Database=="function"?this.sqlite:await this.sqlite(this.options.sqlJsConfig);return e&&e.length>0?this.databaseConnection=new n.Database(e):this.databaseConnection=new n.Database,this.databaseConnection.exec("PRAGMA foreign_keys = ON"),this.databaseConnection}loadDependencies(){if(Te.type==="browser"){let e=this.options.driver||globalThis.SQL;this.sqlite=e}else try{let e=this.options.driver||Te.load("sql.js");this.sqlite=e}catch{throw new xn("sql.js","sql.js")}}},Ga=class{create(e){let{type:t}=e.options;switch(t){case"cordova":return new La(e);case"nativescript":return new Va(e);case"react-native":return new ja(e);case"sqljs":return new Qa(e);default:throw new aa(t,["cordova","nativescript","react-native","sqljs"])}}};async function Jr(a,e,t=[".js",".mjs",".cjs",".ts",".mts",".cts"]){return[]}var rh=new class{constructor(){this.instances=[]}get(a){let e=this.instances.find(t=>t.type===a);return e||(e={type:a,object:new a},this.instances.push(e)),e.object}},Wc,ci;function Qc(a){if(Wc)try{let e=Wc.get(a);if(e||!ci||!ci.fallback)return e}catch(e){if(!ci||!ci.fallbackOnErrors)throw e}return rh.get(a)}var We=class{constructor(e){this["@instanceof"]=Symbol.for("ColumnMetadata"),this.length="",this.isPrimary=!1,this.isGenerated=!1,this.isNullable=!1,this.isSelect=!0,this.isInsert=!0,this.isUpdate=!0,this.zerofill=!1,this.unsigned=!1,this.isArray=!1,this.isVirtual=!1,this.isVirtualProperty=!1,this.isDiscriminator=!1,this.isTreeLevel=!1,this.isCreateDate=!1,this.isUpdateDate=!1,this.isDeleteDate=!1,this.isVersion=!1,this.isObjectId=!1,this.isNestedSetLeft=!1,this.isNestedSetRight=!1,this.isMaterializedPath=!1,this.entityMetadata=e.entityMetadata,this.embeddedMetadata=e.embeddedMetadata,this.referencedColumn=e.referencedColumn,e.args.target&&(this.target=e.args.target),e.args.propertyName&&(this.propertyName=e.args.propertyName),e.args.options.name&&(this.givenDatabaseName=e.args.options.name),e.args.options.type&&(this.type=e.args.options.type),e.args.options.length&&(this.length=e.args.options.length?e.args.options.length.toString():""),e.args.options.width&&(this.width=e.args.options.width),e.args.options.charset&&(this.charset=e.args.options.charset),e.args.options.collation&&(this.collation=e.args.options.collation),e.args.options.primary&&(this.isPrimary=e.args.options.primary),e.args.options.default===null&&(this.isNullable=!0),e.args.options.nullable!==void 0&&(this.isNullable=e.args.options.nullable),e.args.options.select!==void 0&&(this.isSelect=e.args.options.select),e.args.options.insert!==void 0&&(this.isInsert=e.args.options.insert),e.args.options.update!==void 0&&(this.isUpdate=e.args.options.update),e.args.options.readonly!==void 0&&(this.isUpdate=!e.args.options.readonly),e.args.options.comment&&(this.comment=e.args.options.comment),e.args.options.default!==void 0&&(this.default=e.args.options.default),e.args.options.onUpdate&&(this.onUpdate=e.args.options.onUpdate),e.args.options.generatedIdentity&&(this.generatedIdentity=e.args.options.generatedIdentity),e.args.options.scale!==null&&e.args.options.scale!==void 0&&(this.scale=e.args.options.scale),e.args.options.zerofill&&(this.zerofill=e.args.options.zerofill,this.unsigned=!0),e.args.options.unsigned&&(this.unsigned=e.args.options.unsigned),e.args.options.precision!==null&&(this.precision=e.args.options.precision),e.args.options.enum&&(ne.isObject(e.args.options.enum)&&!Array.isArray(e.args.options.enum)?this.enum=Object.keys(e.args.options.enum).filter(t=>isNaN(+t)&&typeof e.args.options.enum[t]!="function").map(t=>e.args.options.enum[t]):this.enum=e.args.options.enum),e.args.options.enumName&&(this.enumName=e.args.options.enumName),e.args.options.primaryKeyConstraintName&&(this.primaryKeyConstraintName=e.args.options.primaryKeyConstraintName),e.args.options.foreignKeyConstraintName&&(this.foreignKeyConstraintName=e.args.options.foreignKeyConstraintName),e.args.options.asExpression&&(this.asExpression=e.args.options.asExpression,this.generatedType=e.args.options.generatedType?e.args.options.generatedType:"VIRTUAL"),e.args.options.hstoreType&&(this.hstoreType=e.args.options.hstoreType),e.args.options.array&&(this.isArray=e.args.options.array),e.args.mode&&(this.isVirtualProperty=e.args.mode==="virtual-property",this.isVirtual=e.args.mode==="virtual",this.isTreeLevel=e.args.mode==="treeLevel",this.isCreateDate=e.args.mode==="createDate",this.isUpdateDate=e.args.mode==="updateDate",this.isDeleteDate=e.args.mode==="deleteDate",this.isVersion=e.args.mode==="version",this.isObjectId=e.args.mode==="objectId"),this.isVirtualProperty&&(this.isInsert=!1,this.isUpdate=!1),e.args.options.transformer&&(this.transformer=e.args.options.transformer),e.args.options.spatialFeatureType&&(this.spatialFeatureType=e.args.options.spatialFeatureType),e.args.options.srid!==void 0&&(this.srid=e.args.options.srid),e.args.options.query&&(this.query=e.args.options.query),this.isTreeLevel&&(this.type=e.connection.driver.mappedDataTypes.treeLevel),this.isCreateDate&&(this.type||(this.type=e.connection.driver.mappedDataTypes.createDate),this.default||(this.default=()=>e.connection.driver.mappedDataTypes.createDateDefault),this.precision===void 0&&e.args.options.precision===void 0&&e.connection.driver.mappedDataTypes.createDatePrecision&&(this.precision=e.connection.driver.mappedDataTypes.createDatePrecision)),this.isUpdateDate&&(this.type||(this.type=e.connection.driver.mappedDataTypes.updateDate),this.default||(this.default=()=>e.connection.driver.mappedDataTypes.updateDateDefault),this.onUpdate||(this.onUpdate=e.connection.driver.mappedDataTypes.updateDateDefault),this.precision===void 0&&e.args.options.precision===void 0&&e.connection.driver.mappedDataTypes.updateDatePrecision&&(this.precision=e.connection.driver.mappedDataTypes.updateDatePrecision)),this.isDeleteDate&&(this.type||(this.type=e.connection.driver.mappedDataTypes.deleteDate),this.isNullable||(this.isNullable=e.connection.driver.mappedDataTypes.deleteDateNullable),this.precision===void 0&&e.args.options.precision===void 0&&e.connection.driver.mappedDataTypes.deleteDatePrecision&&(this.precision=e.connection.driver.mappedDataTypes.deleteDatePrecision)),this.isVersion&&(this.type=e.connection.driver.mappedDataTypes.version),e.closureType&&(this.closureType=e.closureType),e.nestedSetLeft&&(this.isNestedSetLeft=e.nestedSetLeft),e.nestedSetRight&&(this.isNestedSetRight=e.nestedSetRight),e.materializedPath&&(this.isMaterializedPath=e.materializedPath)}createValueMap(e,t=!1){if(this.embeddedMetadata){let n=[...this.embeddedMetadata.parentPropertyNames],s=(i,r)=>{let o=i.shift();return o?(r[o]={},s(i,r[o]),r):((this.generationStrategy==="increment"||this.generationStrategy==="rowid")&&this.type==="bigint"&&e!==null&&(e=String(e)),r[t?this.databaseName:this.propertyName]=e,r)};return s(n,{})}else return(this.generationStrategy==="increment"||this.generationStrategy==="rowid")&&this.type==="bigint"&&e!==null&&(e=String(e)),{[t?this.databaseName:this.propertyName]:e}}getEntityValueMap(e,t){if(this.embeddedMetadata){let s=[...this.embeddedMetadata.parentPropertyNames],i=this.embeddedMetadata.isArray,r=(c,l)=>{if(l===void 0)return{};let u=c.shift();if(u){let h=r(c,l[u]);return Object.keys(h).length>0?{[u]:h}:{}}return i&&Array.isArray(l)?l.map(h=>({[this.propertyName]:h[this.propertyName]})):l[this.propertyName]!==void 0?{[this.propertyName]:l[this.propertyName]}:{}},o=r(s,e);return Object.keys(o).length>0?o:void 0}else if(this.relationMetadata&&!Object.getOwnPropertyDescriptor(e,this.relationMetadata.propertyName)?.get&&e[this.relationMetadata.propertyName]&&ne.isObject(e[this.relationMetadata.propertyName])){let s=this.relationMetadata.joinColumns.reduce((i,r)=>{let o=r.referencedColumn.getEntityValueMap(e[this.relationMetadata.propertyName]);return o===void 0?i:ce.mergeDeep(i,o)},{});return Object.keys(s).length>0?{[this.propertyName]:s}:void 0}else return e[this.propertyName]!==void 0?{[this.propertyName]:e[this.propertyName]}:void 0}getEntityValue(e,t=!1){if(e==null)return;let n;if(this.embeddedMetadata){let s=[...this.embeddedMetadata.parentPropertyNames],i=this.embeddedMetadata.isArray,r=(c,l)=>{let u=c.shift();return u&&l?r(c,l[u]):l},o=r(s,e);if(o)if(this.relationMetadata&&this.referencedColumn){let c=this.relationMetadata.getEntityValue(o);c&&ne.isObject(c)&&!$.isFindOperator(c)?n=this.referencedColumn.getEntityValue(c):o[this.propertyName]&&ne.isObject(o[this.propertyName])&&!$.isFindOperator(o[this.propertyName])&&!(o[this.propertyName]instanceof Date)?n=this.referencedColumn.getEntityValue(o[this.propertyName]):n=o[this.propertyName]}else this.referencedColumn?n=this.referencedColumn.getEntityValue(o[this.propertyName]):i&&Array.isArray(o)?n=o.map(c=>c[this.propertyName]):n=o[this.propertyName]}else if(this.relationMetadata&&this.referencedColumn){let s=this.relationMetadata.getEntityValue(e);s&&ne.isObject(s)&&!$.isFindOperator(s)&&typeof s!="function"?n=this.referencedColumn.getEntityValue(s):e[this.propertyName]&&ne.isObject(e[this.propertyName])&&!$.isFindOperator(e[this.propertyName])&&typeof e[this.propertyName]!="function"&&!(e[this.propertyName]instanceof Date)?n=this.referencedColumn.getEntityValue(e[this.propertyName]):n=e[this.propertyName]}else this.referencedColumn?n=this.referencedColumn.getEntityValue(e[this.propertyName]):n=e[this.propertyName];return t&&this.transformer&&(n=Bt.transformTo(this.transformer,n)),n}setEntityValue(e,t){if(this.embeddedMetadata){let n=(s,i)=>{let r=s.shift();return r?(i[r.propertyName]||(i[r.propertyName]=r.create()),n(s,i[r.propertyName]),i):(i[this.propertyName]=t,i)};return n([...this.embeddedMetadata.embeddedMetadataTree],e)}else!this.entityMetadata.isJunction&&this.isVirtual&&this.referencedColumn&&this.referencedColumn.propertyName!==this.propertyName?(this.propertyName in e||(e[this.propertyName]={}),e[this.propertyName][this.referencedColumn.propertyName]=t):e[this.propertyName]=t}compareEntityValue(e,t){let n=this.getEntityValue(e);return ne.isObject(n)?n.equals(t):n===t}build(e){return this.propertyPath=this.buildPropertyPath(),this.propertyAliasName=this.propertyPath.replace(".","_"),this.databaseName=this.buildDatabaseName(e),this.databasePath=this.buildDatabasePath(),this.databaseNameWithoutPrefixes=e.namingStrategy.columnName(this.propertyName,this.givenDatabaseName,[]),this}buildPropertyPath(){let e="";return this.embeddedMetadata&&this.embeddedMetadata.parentPropertyNames.length&&(e=this.embeddedMetadata.parentPropertyNames.join(".")+"."),e+=this.propertyName,!this.entityMetadata.isJunction&&this.isVirtual&&this.referencedColumn&&this.referencedColumn.propertyName!==this.propertyName&&(e+="."+this.referencedColumn.propertyName),e}buildDatabasePath(){let e="";return this.embeddedMetadata&&this.embeddedMetadata.parentPropertyNames.length&&(e=this.embeddedMetadata.parentPropertyNames.join(".")+"."),e+=this.databaseName,!this.entityMetadata.isJunction&&this.isVirtual&&this.referencedColumn&&this.referencedColumn.databaseName!==this.databaseName&&(e+="."+this.referencedColumn.databaseName),e}buildDatabaseName(e){let t=this.embeddedMetadata?this.embeddedMetadata.parentPrefixes:[];return e.driver.options.type==="mongodb"&&(t=[]),e.namingStrategy.columnName(this.propertyName,this.givenDatabaseName,t)}},Je=class{constructor(e){this.isUnique=!1,this.isSpatial=!1,this.isFulltext=!1,this.isNullFiltered=!1,this.synchronize=!0,this.columns=[],this.columnNamesWithOrderingMap={},this.entityMetadata=e.entityMetadata,this.embeddedMetadata=e.embeddedMetadata,e.columns&&(this.columns=e.columns),e.args&&(this.target=e.args.target,e.args.synchronize!==null&&e.args.synchronize!==void 0&&(this.synchronize=e.args.synchronize),this.isUnique=!!e.args.unique,this.isSpatial=!!e.args.spatial,this.isFulltext=!!e.args.fulltext,this.isNullFiltered=!!e.args.nullFiltered,this.parser=e.args.parser,this.where=e.args.where,this.isSparse=e.args.sparse,this.isBackground=e.args.background,this.expireAfterSeconds=e.args.expireAfterSeconds,this.givenName=e.args.name,this.givenColumnNames=e.args.columns)}build(e){if(this.synchronize===!1)return this.name=this.givenName,this;let t={};if(this.givenColumnNames){let n=[];if(Array.isArray(this.givenColumnNames))n=this.givenColumnNames.map(s=>this.embeddedMetadata?this.embeddedMetadata.propertyPath+"."+s:s.trim()),n.forEach(s=>t[s]=1);else{let s=this.givenColumnNames(this.entityMetadata.propertiesMap);Array.isArray(s)?(n=s.map(i=>String(i)),n.forEach(i=>t[i]=1)):(n=Object.keys(s).map(i=>String(i)),Object.keys(s).forEach(i=>t[i]=s[i]))}this.columns=n.map(s=>{let i=this.entityMetadata.columns.find(l=>l.propertyPath===s);if(i)return[i];let r=this.entityMetadata.relations.find(l=>l.isWithJoinColumn&&l.propertyName===s);if(r)return r.joinColumns;let o=this.givenName?'"'+this.givenName+'" ':"",c=this.entityMetadata.targetName;throw new v(`Index ${o}contains column that is missing in the entity (${c}): `+s)}).reduce((s,i)=>s.concat(i))}return this.columnNamesWithOrderingMap=Object.keys(t).reduce((n,s)=>{let i=this.entityMetadata.columns.find(r=>r.propertyPath===s);return i&&(n[i.databasePath]=t[s]),n},{}),this.name=this.givenName?this.givenName:e.indexName(this.entityMetadata.tableName,this.columns.map(n=>n.databaseName),this.where),this}},Ri=class{constructor(e){this.isTreeParent=!1,this.isTreeChildren=!1,this.isPrimary=!1,this.isLazy=!1,this.isEager=!1,this.persistenceEnabled=!0,this.isCascadeInsert=!1,this.isCascadeUpdate=!1,this.isCascadeRemove=!1,this.isCascadeSoftRemove=!1,this.isCascadeRecover=!1,this.isNullable=!0,this.createForeignKeyConstraints=!0,this.isOwning=!1,this.isOneToOne=!1,this.isOneToOneOwner=!1,this.isWithJoinColumn=!1,this.isOneToOneNotOwner=!1,this.isOneToMany=!1,this.isManyToOne=!1,this.isManyToMany=!1,this.isManyToManyOwner=!1,this.isManyToManyNotOwner=!1,this.foreignKeys=[],this.joinColumns=[],this.inverseJoinColumns=[],this.entityMetadata=e.entityMetadata,this.embeddedMetadata=e.embeddedMetadata;let t=e.args;this.target=t.target,this.propertyName=t.propertyName,this.relationType=t.relationType,t.inverseSideProperty&&(this.givenInverseSidePropertyFactory=t.inverseSideProperty),this.isLazy=t.isLazy||!1,this.isCascadeInsert=t.options.cascade===!0||Array.isArray(t.options.cascade)&&t.options.cascade.indexOf("insert")!==-1,this.isCascadeUpdate=t.options.cascade===!0||Array.isArray(t.options.cascade)&&t.options.cascade.indexOf("update")!==-1,this.isCascadeRemove=t.options.cascade===!0||Array.isArray(t.options.cascade)&&t.options.cascade.indexOf("remove")!==-1,this.isCascadeSoftRemove=t.options.cascade===!0||Array.isArray(t.options.cascade)&&t.options.cascade.indexOf("soft-remove")!==-1,this.isCascadeRecover=t.options.cascade===!0||Array.isArray(t.options.cascade)&&t.options.cascade.indexOf("recover")!==-1,this.isNullable=!(t.options.nullable===!1||this.isPrimary),this.onDelete=t.options.onDelete,this.onUpdate=t.options.onUpdate,this.deferrable=t.options.deferrable,this.createForeignKeyConstraints=t.options.createForeignKeyConstraints!==!1,this.isEager=t.options.eager||!1,this.persistenceEnabled=t.options.persistence!==!1,this.orphanedRowAction=t.options.orphanedRowAction||"nullify",this.isTreeParent=t.isTreeParent||!1,this.isTreeChildren=t.isTreeChildren||!1,typeof t.type=="function"?this.type=typeof t.type=="function"?t.type():t.type:$.isEntitySchema(t.type)?this.type=t.type.options.name:ne.isObject(t.type)&&typeof t.type.name=="string"?this.type=t.type.name:this.type=t.type,this.isOneToOne=this.relationType==="one-to-one",this.isOneToMany=this.relationType==="one-to-many",this.isManyToOne=this.relationType==="many-to-one",this.isManyToMany=this.relationType==="many-to-many",this.isOneToOneNotOwner=!!this.isOneToOne,this.isManyToManyNotOwner=!!this.isManyToMany}getRelationIdMap(e){let n=(this.isOwning?this.joinColumns:this.inverseRelation.joinColumns).map(s=>s.referencedColumn);return Zt.getValueMap(e,n)}ensureRelationIdMap(e){if(ne.isObject(e))return e;let n=(this.isOwning?this.joinColumns:this.inverseRelation.joinColumns).map(s=>s.referencedColumn);if(n.length>1)throw new v("Cannot create relation id map for a single value because relation contains multiple referenced columns.");return n[0].createValueMap(e)}getEntityValue(e,t=!1){if(e!=null)if(this.embeddedMetadata){let n=[...this.embeddedMetadata.parentPropertyNames],s=(r,o)=>{let c=r.shift();return c?o[c]?s(r,o[c]):void 0:o},i=s(n,e);return this.isLazy?i["__"+this.propertyName+"__"]!==void 0?i["__"+this.propertyName+"__"]:t===!0?i[this.propertyName]:void 0:i?i[this.isLazy?"__"+this.propertyName+"__":this.propertyName]:void 0}else return this.isLazy?e["__"+this.propertyName+"__"]!==void 0?e["__"+this.propertyName+"__"]:t===!0?e[this.propertyName]:void 0:e[this.propertyName]}setEntityValue(e,t){let n=this.isLazy?"__"+this.propertyName+"__":this.propertyName;if(this.embeddedMetadata){let s=(i,r)=>{let o=i.shift();return o?(r[o.propertyName]||(r[o.propertyName]=o.create()),s(i,r[o.propertyName]),r):(r[n]=t,r)};return s([...this.embeddedMetadata.embeddedMetadataTree],e)}else e[n]=t}createValueMap(e){if(this.embeddedMetadata){let t=[...this.embeddedMetadata.parentPropertyNames],n=(s,i)=>{let r=s.shift();return r?(i[r]={},n(s,i[r]),i):(i[this.propertyName]=e,i)};return n(t,{})}else return{[this.propertyName]:e}}build(){this.propertyPath=this.buildPropertyPath()}registerForeignKeys(...e){this.foreignKeys.push(...e)}registerJoinColumns(e=[],t=[]){this.joinColumns=e,this.inverseJoinColumns=t,this.isOwning=this.isManyToOne||(this.isManyToMany||this.isOneToOne)&&this.joinColumns.length>0,this.isOneToOneOwner=this.isOneToOne&&this.isOwning,this.isOneToOneNotOwner=this.isOneToOne&&!this.isOwning,this.isManyToManyOwner=this.isManyToMany&&this.isOwning,this.isManyToManyNotOwner=this.isManyToMany&&!this.isOwning,this.isWithJoinColumn=this.isManyToOne||this.isOneToOneOwner}registerJunctionEntityMetadata(e){this.junctionEntityMetadata=e,this.joinTableName=e.tableName,this.inverseRelation&&(this.inverseRelation.junctionEntityMetadata=e,this.joinTableName=e.tableName)}buildInverseSidePropertyPath(){if(this.givenInverseSidePropertyFactory){let e=this.inverseEntityMetadata.propertiesMap;if(typeof this.givenInverseSidePropertyFactory=="function")return this.givenInverseSidePropertyFactory(e);if(typeof this.givenInverseSidePropertyFactory=="string")return this.givenInverseSidePropertyFactory}else{if(this.isTreeParent&&this.entityMetadata.treeChildrenRelation)return this.entityMetadata.treeChildrenRelation.propertyName;if(this.isTreeChildren&&this.entityMetadata.treeParentRelation)return this.entityMetadata.treeParentRelation.propertyName}return""}buildPropertyPath(){return!this.embeddedMetadata||!this.embeddedMetadata.parentPropertyNames.length?this.propertyName:this.embeddedMetadata.parentPropertyNames.join(".")+"."+this.propertyName}},Ja=class{constructor(e){this.columns=[],this.relations=[],this.listeners=[],this.indices=[],this.uniques=[],this.relationIds=[],this.relationCounts=[],this.embeddeds=[],this.isAlwaysUsingConstructor=!0,this.isArray=!1,this.parentPropertyNames=[],this.parentPrefixes=[],this.embeddedMetadataTree=[],this.columnsFromTree=[],this.relationsFromTree=[],this.listenersFromTree=[],this.indicesFromTree=[],this.uniquesFromTree=[],this.relationIdsFromTree=[],this.relationCountsFromTree=[],this.entityMetadata=e.entityMetadata,this.type=e.args.type(),this.propertyName=e.args.propertyName,this.customPrefix=e.args.prefix,this.isArray=e.args.isArray}create(e){return typeof this.type!="function"?{}:!e?.fromDeserializer||this.isAlwaysUsingConstructor?new this.type:Object.create(this.type.prototype)}build(e){return this.embeddeds.forEach(t=>t.build(e)),this.prefix=this.buildPrefix(e),this.parentPropertyNames=this.buildParentPropertyNames(),this.parentPrefixes=this.buildParentPrefixes(),this.propertyPath=this.parentPropertyNames.join("."),this.embeddedMetadataTree=this.buildEmbeddedMetadataTree(),this.columnsFromTree=this.buildColumnsFromTree(),this.relationsFromTree=this.buildRelationsFromTree(),this.listenersFromTree=this.buildListenersFromTree(),this.indicesFromTree=this.buildIndicesFromTree(),this.uniquesFromTree=this.buildUniquesFromTree(),this.relationIdsFromTree=this.buildRelationIdsFromTree(),this.relationCountsFromTree=this.buildRelationCountsFromTree(),e.options.entitySkipConstructor&&(this.isAlwaysUsingConstructor=!e.options.entitySkipConstructor),this}buildPartialPrefix(){if(this.customPrefix===void 0||this.customPrefix===!0)return[this.propertyName];if(this.customPrefix===""||this.customPrefix===!1)return[];if(typeof this.customPrefix=="string")return[this.customPrefix];throw new v(`Invalid prefix option given for ${this.entityMetadata.targetName}#${this.propertyName}`)}buildPrefix(e){if(e.driver.options.type==="mongodb")return this.propertyName;let t=[];return this.parentEmbeddedMetadata&&t.push(this.parentEmbeddedMetadata.buildPrefix(e)),t.push(...this.buildPartialPrefix()),t.join("_")}buildParentPropertyNames(){return this.parentEmbeddedMetadata?this.parentEmbeddedMetadata.buildParentPropertyNames().concat(this.propertyName):[this.propertyName]}buildParentPrefixes(){return this.parentEmbeddedMetadata?this.parentEmbeddedMetadata.buildParentPrefixes().concat(this.buildPartialPrefix()):this.buildPartialPrefix()}buildEmbeddedMetadataTree(){return this.parentEmbeddedMetadata?this.parentEmbeddedMetadata.buildEmbeddedMetadataTree().concat(this):[this]}buildColumnsFromTree(){return this.embeddeds.reduce((e,t)=>e.concat(t.buildColumnsFromTree()),this.columns)}buildRelationsFromTree(){return this.embeddeds.reduce((e,t)=>e.concat(t.buildRelationsFromTree()),this.relations)}buildListenersFromTree(){return this.embeddeds.reduce((e,t)=>e.concat(t.buildListenersFromTree()),this.listeners)}buildIndicesFromTree(){return this.embeddeds.reduce((e,t)=>e.concat(t.buildIndicesFromTree()),this.indices)}buildUniquesFromTree(){return this.embeddeds.reduce((e,t)=>e.concat(t.buildUniquesFromTree()),this.uniques)}buildRelationIdsFromTree(){return this.embeddeds.reduce((e,t)=>e.concat(t.buildRelationIdsFromTree()),this.relationIds)}buildRelationCountsFromTree(){return this.embeddeds.reduce((e,t)=>e.concat(t.buildRelationCountsFromTree()),this.relationCounts)}},xi=class{constructor(e){this.entityMetadata=e.entityMetadata,this.target=e.args.target,this.propertyName=e.args.propertyName,this.relationNameOrFactory=e.args.relation,this.alias=e.args.alias,this.queryBuilderFactory=e.args.queryBuilderFactory}setValue(e){let t=this.relation.getEntityValue(e);if(Array.isArray(t))e[this.propertyName]=t.map(n=>this.relation.inverseEntityMetadata.getEntityIdMixedMap(n)).filter(n=>n!=null);else{let n=this.relation.inverseEntityMetadata.getEntityIdMixedMap(t);n!==void 0&&(e[this.propertyName]=n)}}build(){let e=typeof this.relationNameOrFactory=="function"?this.relationNameOrFactory(this.entityMetadata.propertiesMap):this.relationNameOrFactory,t=this.entityMetadata.findRelationWithPropertyPath(e);if(!t)throw new v(`Cannot find relation ${e}. Wrong relation specified for @RelationId decorator.`);this.relation=t}},Si=class{constructor(e){this.entityMetadata=e.entityMetadata,this.target=e.args.target,this.propertyName=e.args.propertyName,this.relationNameOrFactory=e.args.relation,this.alias=e.args.alias,this.queryBuilderFactory=e.args.queryBuilderFactory}build(){let e=typeof this.relationNameOrFactory=="function"?this.relationNameOrFactory(this.entityMetadata.propertiesMap):this.relationNameOrFactory,t=this.entityMetadata.findRelationWithPropertyPath(e);if(!t)throw new v(`Cannot find relation ${e}. Wrong relation specified for @RelationCount decorator.`);this.relation=t}},rt=(()=>{class a{static{this.AFTER_LOAD="after-load"}static{this.BEFORE_INSERT="before-insert"}static{this.AFTER_INSERT="after-insert"}static{this.BEFORE_UPDATE="before-update"}static{this.AFTER_UPDATE="after-update"}static{this.BEFORE_REMOVE="before-remove"}static{this.AFTER_REMOVE="after-remove"}static{this.BEFORE_SOFT_REMOVE="before-soft-remove"}static{this.AFTER_SOFT_REMOVE="after-soft-remove"}static{this.BEFORE_RECOVER="before-recover"}static{this.AFTER_RECOVER="after-recover"}}return a})(),Xt=class{constructor(e){this.columns=[],this.referencedColumns=[],this.columnNames=[],this.referencedColumnNames=[],this.entityMetadata=e.entityMetadata,this.referencedEntityMetadata=e.referencedEntityMetadata,this.columns=e.columns,this.referencedColumns=e.referencedColumns,this.onDelete=e.onDelete||"NO ACTION",this.onUpdate=e.onUpdate||"NO ACTION",this.deferrable=e.deferrable,this.givenName=e.name,e.namingStrategy&&this.build(e.namingStrategy)}build(e){this.columnNames=this.columns.map(t=>t.databaseName),this.referencedColumnNames=this.referencedColumns.map(t=>t.databaseName),this.referencedTablePath=this.referencedEntityMetadata.tablePath,this.name=this.givenName?this.givenName:e.foreignKeyName(this.entityMetadata.tableName,this.columnNames,this.referencedEntityMetadata.tableName,this.referencedColumnNames)}},za=class{constructor(e){this.connection=e}build(e,t){let n=this.collectReferencedColumns(e,t),s=this.collectInverseReferencedColumns(e,t),i=t.name||this.connection.namingStrategy.joinTableName(e.entityMetadata.tableNameWithoutPrefix,e.inverseEntityMetadata.tableNameWithoutPrefix,e.propertyPath,e.inverseRelation?e.inverseRelation.propertyName:""),r=new Zt({connection:this.connection,args:{target:"",name:i,type:"junction",database:t.database||e.entityMetadata.database,schema:t.schema||e.entityMetadata.schema}});r.build();let o=n.map(l=>{let u=t.joinColumns?t.joinColumns.find(d=>(!d.referencedColumnName||d.referencedColumnName===l.propertyName)&&!!d.name):void 0,h=u&&u.name?u.name:this.connection.namingStrategy.joinTableColumnName(e.entityMetadata.tableNameWithoutPrefix,l.propertyName,l.databaseName);return new We({connection:this.connection,entityMetadata:r,referencedColumn:l,args:{target:"",mode:"virtual",propertyName:h,options:{name:h,length:!l.length&&(L.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&(l.generationStrategy==="uuid"||l.type==="uuid")?"36":l.length,width:l.width,type:l.type,precision:l.precision,scale:l.scale,charset:l.charset,collation:l.collation,zerofill:l.zerofill,unsigned:l.zerofill?!0:l.unsigned,enum:l.enum,enumName:l.enumName,foreignKeyConstraintName:u?.foreignKeyConstraintName,nullable:!1,primary:!0}}})}),c=s.map(l=>{let u=t.inverseJoinColumns?t.inverseJoinColumns.find(d=>(!d.referencedColumnName||d.referencedColumnName===l.propertyName)&&!!d.name):void 0,h=u&&u.name?u.name:this.connection.namingStrategy.joinTableInverseColumnName(e.inverseEntityMetadata.tableNameWithoutPrefix,l.propertyName,l.databaseName);return new We({connection:this.connection,entityMetadata:r,referencedColumn:l,args:{target:"",mode:"virtual",propertyName:h,options:{length:!l.length&&(L.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&(l.generationStrategy==="uuid"||l.type==="uuid")?"36":l.length,width:l.width,type:l.type,precision:l.precision,scale:l.scale,charset:l.charset,collation:l.collation,zerofill:l.zerofill,unsigned:l.zerofill?!0:l.unsigned,enum:l.enum,enumName:l.enumName,foreignKeyConstraintName:u?.foreignKeyConstraintName,name:h,nullable:!1,primary:!0}}})});return this.changeDuplicatedColumnNames(o,c),r.ownerColumns=o,r.inverseColumns=c,r.ownColumns=[...o,...c],r.ownColumns.forEach(l=>l.relationMetadata=e),r.foreignKeys=e.createForeignKeyConstraints?[new Xt({entityMetadata:r,referencedEntityMetadata:e.entityMetadata,columns:o,referencedColumns:n,name:o[0]?.foreignKeyConstraintName,onDelete:this.connection.driver.options.type==="spanner"?"NO ACTION":e.onDelete||"CASCADE",onUpdate:this.connection.driver.options.type==="oracle"||this.connection.driver.options.type==="spanner"?"NO ACTION":e.onUpdate||"CASCADE"}),new Xt({entityMetadata:r,referencedEntityMetadata:e.inverseEntityMetadata,columns:c,referencedColumns:s,name:c[0]?.foreignKeyConstraintName,onDelete:this.connection.driver.options.type==="spanner"?"NO ACTION":e.inverseRelation?e.inverseRelation.onDelete:"CASCADE",onUpdate:this.connection.driver.options.type==="oracle"||this.connection.driver.options.type==="spanner"?"NO ACTION":e.inverseRelation?e.inverseRelation.onUpdate:"CASCADE"})]:[],r.ownIndices=[new Je({entityMetadata:r,columns:o,args:{target:r.target,synchronize:!0}}),new Je({entityMetadata:r,columns:c,args:{target:r.target,synchronize:!0}})],r}collectReferencedColumns(e,t){let n=t.joinColumns?t.joinColumns.find(s=>!!s.referencedColumnName):!1;return!t.joinColumns||t.joinColumns&&!n?e.entityMetadata.columns.filter(s=>s.isPrimary):t.joinColumns.map(s=>{let i=e.entityMetadata.columns.find(r=>r.propertyName===s.referencedColumnName);if(!i)throw new v(`Referenced column ${s.referencedColumnName} was not found in entity ${e.entityMetadata.name}`);return i})}collectInverseReferencedColumns(e,t){let n=!!t.inverseJoinColumns,s=n?t.inverseJoinColumns.find(i=>!!i.referencedColumnName):!1;return!n||n&&!s?e.inverseEntityMetadata.primaryColumns:t.inverseJoinColumns.map(i=>{let r=e.inverseEntityMetadata.ownColumns.find(o=>o.propertyName===i.referencedColumnName);if(!r)throw new v(`Referenced column ${i.referencedColumnName} was not found in entity ${e.inverseEntityMetadata.name}`);return r})}changeDuplicatedColumnNames(e,t){e.forEach(n=>{t.forEach(s=>{if(n.givenDatabaseName===s.givenDatabaseName){let i=this.connection.namingStrategy.joinTableColumnDuplicationPrefix(n.propertyName,1);n.propertyName=i,n.givenDatabaseName=i;let r=this.connection.namingStrategy.joinTableColumnDuplicationPrefix(s.propertyName,2);s.propertyName=r,s.givenDatabaseName=r}})})}},Ha=class{constructor(e){this.connection=e}build(e){let t=new Zt({parentClosureEntityMetadata:e,connection:this.connection,args:{target:"",name:e.treeOptions&&e.treeOptions.closureTableName?e.treeOptions.closureTableName:e.tableNameWithoutPrefix,type:"closure-junction"}});return t.build(),e.primaryColumns.forEach(n=>{t.ownColumns.push(new We({connection:this.connection,entityMetadata:t,closureType:"ancestor",referencedColumn:n,args:{target:"",mode:"virtual",propertyName:e.treeOptions&&e.treeOptions.ancestorColumnName?e.treeOptions.ancestorColumnName(n):n.propertyName+"_ancestor",options:{primary:!0,length:n.length,type:n.type}}})),t.ownColumns.push(new We({connection:this.connection,entityMetadata:t,closureType:"descendant",referencedColumn:n,args:{target:"",mode:"virtual",propertyName:e.treeOptions&&e.treeOptions.descendantColumnName?e.treeOptions.descendantColumnName(n):n.propertyName+"_descendant",options:{primary:!0,length:n.length,type:n.type}}}))}),t.ownIndices=[new Je({entityMetadata:t,columns:[t.ownColumns[0]],args:{target:t.target,synchronize:!0}}),new Je({entityMetadata:t,columns:[t.ownColumns[1]],args:{target:t.target,synchronize:!0}})],e.treeLevelColumn&&t.ownColumns.push(new We({connection:this.connection,entityMetadata:t,args:{target:"",mode:"virtual",propertyName:"level",options:{type:this.connection.driver.mappedDataTypes.treeLevel}}})),t.foreignKeys=[new Xt({entityMetadata:t,referencedEntityMetadata:e,columns:[t.ownColumns[0]],referencedColumns:e.primaryColumns,onDelete:this.connection.driver.options.type==="mssql"?"NO ACTION":"CASCADE"}),new Xt({entityMetadata:t,referencedEntityMetadata:e,columns:[t.ownColumns[1]],referencedColumns:e.primaryColumns,onDelete:this.connection.driver.options.type==="mssql"?"NO ACTION":"CASCADE"})],t}},vn=class{constructor(e){this.columns=[],this.columnNamesWithOrderingMap={},this.entityMetadata=e.entityMetadata,this.embeddedMetadata=e.embeddedMetadata,e.columns&&(this.columns=e.columns),e.args&&(this.target=e.args.target,this.givenName=e.args.name,this.givenColumnNames=e.args.columns,this.deferrable=e.args.deferrable)}build(e){let t={};if(this.givenColumnNames){let n=[];if(Array.isArray(this.givenColumnNames))n=this.givenColumnNames.map(s=>this.embeddedMetadata?this.embeddedMetadata.propertyPath+"."+s:s.trim()),n.forEach(s=>t[s]=1);else{let s=this.givenColumnNames(this.entityMetadata.propertiesMap);Array.isArray(s)?(n=s.map(i=>String(i)),n.forEach(i=>t[i]=1)):(n=Object.keys(s).map(i=>String(i)),Object.keys(s).forEach(i=>t[i]=s[i]))}this.columns=n.map(s=>{let i=this.entityMetadata.columns.find(l=>l.propertyPath===s);if(i)return[i];let r=this.entityMetadata.relations.find(l=>l.isWithJoinColumn&&l.propertyName===s);if(r)return r.joinColumns;let o=this.givenName?'"'+this.givenName+'" ':"",c=this.entityMetadata.targetName;throw new v(`Unique constraint ${o}contains column that is missing in the entity (${c}): `+s)}).reduce((s,i)=>s.concat(i))}return this.columnNamesWithOrderingMap=Object.keys(t).reduce((n,s)=>{let i=this.entityMetadata.columns.find(r=>r.propertyPath===s);return i&&(n[i.databasePath]=t[s]),n},{}),this.name=this.givenName?this.givenName:e.uniqueConstraintName(this.entityMetadata.tableName,this.columns.map(n=>n.databaseName)),this}},Ka=class{constructor(e){this.connection=e}build(e,t){let n=this.collectReferencedColumns(e,t),s=this.collectColumns(e,t,n);if(!n.length||!t.createForeignKeyConstraints)return{foreignKey:void 0,columns:s,uniqueConstraint:void 0};let i=new Xt({name:e[0]?.foreignKeyConstraintName,entityMetadata:t.entityMetadata,referencedEntityMetadata:t.inverseEntityMetadata,namingStrategy:this.connection.namingStrategy,columns:s,referencedColumns:n,onDelete:t.onDelete,onUpdate:t.onUpdate,deferrable:t.deferrable});if(this.connection.driver.options.type==="oracle"&&s.every(r=>r.isPrimary))return{foreignKey:i,columns:s,uniqueConstraint:void 0};if(n.length>0&&t.isOneToOne){let r=new vn({entityMetadata:t.entityMetadata,columns:i.columns,args:{name:this.connection.namingStrategy.relationConstraintName(t.entityMetadata.tableName,i.columns.map(o=>o.databaseName)),target:t.entityMetadata.target}});return r.build(this.connection.namingStrategy),{foreignKey:i,columns:s,uniqueConstraint:r}}return{foreignKey:i,columns:s,uniqueConstraint:void 0}}collectReferencedColumns(e,t){let n=e.find(r=>!!r.referencedColumnName),s=e.length===0&&t.isManyToOne,i=e.length>0&&!n;return s||i?t.inverseEntityMetadata.primaryColumns:e.map(r=>{let o=t.inverseEntityMetadata.ownColumns.find(c=>c.propertyName===r.referencedColumnName);if(!o)throw new v(`Referenced column ${r.referencedColumnName} was not found in entity ${t.inverseEntityMetadata.name}`);return o})}collectColumns(e,t,n){return n.map(s=>{let i=e.find(l=>(!l.referencedColumnName||l.referencedColumnName===s.propertyName)&&!!l.name),r=i?i.name:this.connection.namingStrategy.joinColumnName(t.propertyName,s.propertyName),c=(t.embeddedMetadata?t.embeddedMetadata.columns:t.entityMetadata.ownColumns).find(l=>l.databaseNameWithoutPrefixes===r);return c||(c=new We({connection:this.connection,entityMetadata:t.entityMetadata,embeddedMetadata:t.embeddedMetadata,args:{target:"",mode:"virtual",propertyName:t.propertyName,options:{name:r,type:s.type,length:!s.length&&(L.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&(s.generationStrategy==="uuid"||s.type==="uuid")?"36":s.length,width:s.width,charset:s.charset,collation:s.collation,precision:s.precision,scale:s.scale,zerofill:s.zerofill,unsigned:s.unsigned,comment:s.comment,enum:s.enum,enumName:s.enumName,primary:t.isPrimary,nullable:t.isNullable}}}),t.entityMetadata.registerColumn(c)),c.referencedColumn=s,c.type=s.type,c.relationMetadata=t,c.build(this.connection),c})}},Mi=class{constructor(e){this.entityMetadata=e.entityMetadata,this.embeddedMetadata=e.embeddedMetadata,this.target=e.args.target,this.propertyName=e.args.propertyName,this.type=e.args.type}isAllowed(e){return this.entityMetadata.target===e.constructor||typeof this.entityMetadata.target=="function"&&e.constructor.prototype instanceof this.entityMetadata.target}execute(e){if(!this.embeddedMetadata)return e[this.propertyName]();this.callEntityEmbeddedMethod(e,this.embeddedMetadata.propertyPath.split("."))}callEntityEmbeddedMethod(e,t){let n=t.shift();!n||!e[n]||(t.length===0?Array.isArray(e[n])?e[n].map(s=>s[this.propertyName]()):e[n][this.propertyName]():e[n]&&this.callEntityEmbeddedMethod(e[n],t))}},Ya=class{constructor(e){this.entityMetadata=e.entityMetadata,e.args&&(this.target=e.args.target,this.expression=e.args.expression,this.givenName=e.args.name)}build(e){return this.name=this.givenName?this.givenName:e.checkConstraintName(this.entityMetadata.tableName,this.expression),this}},Za=class{constructor(e){this.entityMetadata=e.entityMetadata,e.args&&(this.target=e.args.target,this.expression=e.args.expression,this.givenName=e.args.name)}build(e){return this.name=this.givenName?this.givenName:e.exclusionConstraintName(this.entityMetadata.tableName,this.expression),this}},Ai=class{constructor(e,t){this.connection=e,this.metadataArgsStorage=t,this.junctionEntityMetadataBuilder=new za(e),this.closureJunctionEntityMetadataBuilder=new Ha(e),this.relationJoinColumnBuilder=new Ka(e)}build(e){let s=(e?this.metadataArgsStorage.filterTables(e):this.metadataArgsStorage.tables).filter(i=>i.type==="regular"||i.type==="closure"||i.type==="entity-child"||i.type==="view").map(i=>this.createEntityMetadata(i));return s.forEach(i=>this.computeParentEntityMetadata(s,i)),s.forEach(i=>{i.childEntityMetadatas=s.filter(r=>typeof i.target=="function"&&typeof r.target=="function"&&Cn.isInherited(r.target,i.target))}),s.filter(i=>i.tableType!=="entity-child").forEach(i=>i.build()),s.filter(i=>i.tableType==="entity-child").forEach(i=>i.build()),s.filter(i=>i.tableType!=="entity-child").forEach(i=>this.computeEntityMetadataStep1(s,i)),s.filter(i=>i.tableType==="entity-child").forEach(i=>this.computeEntityMetadataStep1(s,i)),s.forEach(i=>this.computeEntityMetadataStep2(i)),s.forEach(i=>this.computeInverseProperties(i,s)),s.filter(i=>i.tableType!=="entity-child").forEach(i=>{i.relations.filter(r=>r.isOneToOne||r.isManyToOne).forEach(r=>{let o=this.metadataArgsStorage.filterJoinColumns(r.target,r.propertyName),{foreignKey:c,columns:l,uniqueConstraint:u}=this.relationJoinColumnBuilder.build(o,r);if(c&&(r.registerForeignKeys(c),i.foreignKeys.push(c)),l&&r.registerJoinColumns(l),u)if(L.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"||this.connection.driver.options.type==="mssql"||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner"){let h=new Je({entityMetadata:u.entityMetadata,columns:u.columns,args:{target:u.target,name:u.name,unique:!0,synchronize:!0}});this.connection.driver.options.type==="mssql"&&(h.where=h.columns.map(d=>`${this.connection.driver.escape(d.databaseName)} IS NOT NULL`).join(" AND ")),this.connection.driver.options.type==="spanner"&&(h.isNullFiltered=!0),r.embeddedMetadata?r.embeddedMetadata.indices.push(h):r.entityMetadata.ownIndices.push(h),this.computeEntityMetadataStep2(i)}else r.embeddedMetadata?r.embeddedMetadata.uniques.push(u):r.entityMetadata.ownUniques.push(u),this.computeEntityMetadataStep2(i);if(c&&this.connection.driver.options.type==="cockroachdb"){let h=new Je({entityMetadata:r.entityMetadata,columns:c.columns,args:{target:r.entityMetadata.target,synchronize:!0}});r.embeddedMetadata?r.embeddedMetadata.indices.push(h):r.entityMetadata.ownIndices.push(h),this.computeEntityMetadataStep2(i)}}),i.relations.filter(r=>r.isManyToMany).forEach(r=>{let o=this.metadataArgsStorage.findJoinTable(r.target,r.propertyName);if(!o)return;let c=this.junctionEntityMetadataBuilder.build(r,o);r.registerForeignKeys(...c.foreignKeys),r.registerJoinColumns(c.ownIndices[0].columns,c.ownIndices[1].columns),r.registerJunctionEntityMetadata(c),this.computeEntityMetadataStep2(c),this.computeInverseProperties(c,s),s.push(c)})}),s.forEach(i=>{i.relationsWithJoinColumns=i.relations.filter(r=>r.isWithJoinColumn),i.hasNonNullableRelations=i.relationsWithJoinColumns.some(r=>!r.isNullable||r.isPrimary)}),s.filter(i=>i.treeType==="closure-table").forEach(i=>{let r=this.closureJunctionEntityMetadataBuilder.build(i);i.closureJunctionTable=r,this.computeEntityMetadataStep2(r),this.computeInverseProperties(r,s),s.push(r)}),s.filter(i=>i.inheritancePattern==="STI"&&i.discriminatorColumn).forEach(i=>this.createKeysForTableInheritance(i)),s.forEach(i=>{i.indices.forEach(r=>r.build(this.connection.namingStrategy))}),s.forEach(i=>{i.uniques.forEach(r=>r.build(this.connection.namingStrategy))}),s.forEach(i=>{i.checks.forEach(r=>r.build(this.connection.namingStrategy))}),s.forEach(i=>{i.exclusions.forEach(r=>r.build(this.connection.namingStrategy))}),s.filter(i=>typeof i.target=="function").forEach(i=>{i.relations.filter(r=>r.isLazy).forEach(r=>{this.connection.relationLoader.enableLazyLoad(r,i.target.prototype)})}),s.forEach(i=>{i.columns.forEach(r=>{let o=this.metadataArgsStorage.findGenerated(r.target,r.propertyName);o&&(r.isGenerated=!0,r.generationStrategy=o.strategy,o.strategy==="uuid"?r.type="uuid":o.strategy==="rowid"?r.type="int":r.type=r.type||Number,r.build(this.connection),this.computeEntityMetadataStep2(i))})}),s}createEntityMetadata(e){let t=typeof e.target=="function"?Cn.getInheritanceTree(e.target):[e.target],n=this.metadataArgsStorage.findInheritanceType(e.target),s=this.metadataArgsStorage.findTree(e.target),i;return(n&&n.pattern==="STI"||e.type==="entity-child")&&(i=this.metadataArgsStorage.filterSingleTableChildren(e.target).map(r=>r.target).filter(r=>typeof r=="function"),t.push(...i)),new Zt({connection:this.connection,args:e,inheritanceTree:t,tableTree:s,inheritancePattern:n?n.pattern:void 0})}computeParentEntityMetadata(e,t){t.tableType==="entity-child"&&(t.parentEntityMetadata=e.find(n=>n.inheritanceTree.indexOf(t.target)!==-1&&n.inheritancePattern==="STI"))}computeEntityMetadataStep1(e,t){let n=this.metadataArgsStorage.findInheritanceType(t.target),s=this.metadataArgsStorage.findDiscriminatorValue(t.target);if(typeof s<"u"?t.discriminatorValue=s.value:t.discriminatorValue=t.target.name,t.embeddeds=this.createEmbeddedsRecursively(t,this.metadataArgsStorage.filterEmbeddeds(t.inheritanceTree)).map(r=>(t.inheritancePattern==="STI"&&(r.columns=r.columns.map(o=>(o.isNullable=!0,o))),r)),t.ownColumns=this.metadataArgsStorage.filterColumns(t.inheritanceTree).map(r=>{if(t.tableType==="entity-child")return t.parentEntityMetadata.ownColumns.find(l=>l.propertyName===r.propertyName);let o=new We({connection:this.connection,entityMetadata:t,args:r});return e.find(l=>l.tableType==="entity-child"&&l.target===r.target)&&(o.isNullable=!0),o}),n&&n.column){let r=n.column&&n.column.name?n.column.name:"type",o=t.ownColumns.find(c=>c.propertyName===r);o?o.isDiscriminator=!0:(o=new We({connection:this.connection,entityMetadata:t,args:{target:t.target,mode:"virtual",propertyName:r,options:n.column||{name:r,type:"varchar",nullable:!1}}}),o.isVirtual=!0,o.isDiscriminator=!0,t.ownColumns.push(o))}if(t.tableType==="entity-child"){let r=t.parentEntityMetadata.ownColumns.find(o=>o.isDiscriminator);r&&!t.ownColumns.find(o=>o===r)&&t.ownColumns.push(r)}let{namingStrategy:i}=this.connection;if(t.treeType==="materialized-path")t.ownColumns.push(new We({connection:this.connection,entityMetadata:t,materializedPath:!0,args:{target:t.target,mode:"virtual",propertyName:"mpath",options:{name:i.materializedPathColumnName,type:String,nullable:!0,default:""}}}));else if(t.treeType==="nested-set"){let{left:r,right:o}=i.nestedSetColumnNames;t.ownColumns.push(new We({connection:this.connection,entityMetadata:t,nestedSetLeft:!0,args:{target:t.target,mode:"virtual",propertyName:r,options:{name:r,type:Number,nullable:!1,default:1}}})),t.ownColumns.push(new We({connection:this.connection,entityMetadata:t,nestedSetRight:!0,args:{target:t.target,mode:"virtual",propertyName:o,options:{name:o,type:Number,nullable:!1,default:2}}}))}if(t.ownRelations=this.metadataArgsStorage.filterRelations(t.inheritanceTree).map(r=>{if(t.tableType==="entity-child"){let o=t.parentEntityMetadata.ownRelations.find(l=>l.propertyName===r.propertyName),c=typeof r.type=="function"?r.type():r.type;if(o.type!==c){let l=Object.create(o);return l.type=c,l}return o}return new Ri({entityMetadata:t,args:r})}),t.relationIds=this.metadataArgsStorage.filterRelationIds(t.inheritanceTree).map(r=>t.tableType==="entity-child"?t.parentEntityMetadata.relationIds.find(o=>o.propertyName===r.propertyName):new xi({entityMetadata:t,args:r})),t.relationCounts=this.metadataArgsStorage.filterRelationCounts(t.inheritanceTree).map(r=>t.tableType==="entity-child"?t.parentEntityMetadata.relationCounts.find(o=>o.propertyName===r.propertyName):new Si({entityMetadata:t,args:r})),t.ownListeners=this.metadataArgsStorage.filterListeners(t.inheritanceTree).map(r=>new Mi({entityMetadata:t,args:r})),t.checks=this.metadataArgsStorage.filterChecks(t.inheritanceTree).map(r=>new Ya({entityMetadata:t,args:r})),this.connection.driver.options.type==="postgres"&&(t.exclusions=this.metadataArgsStorage.filterExclusions(t.inheritanceTree).map(r=>new Za({entityMetadata:t,args:r}))),this.connection.driver.options.type==="cockroachdb"){t.ownIndices=this.metadataArgsStorage.filterIndices(t.inheritanceTree).filter(o=>!o.unique).map(o=>new Je({entityMetadata:t,args:o}));let r=this.metadataArgsStorage.filterIndices(t.inheritanceTree).filter(o=>o.unique).map(o=>new vn({entityMetadata:t,args:{target:o.target,name:o.name,columns:o.columns}}));t.ownUniques.push(...r)}else t.ownIndices=this.metadataArgsStorage.filterIndices(t.inheritanceTree).map(r=>new Je({entityMetadata:t,args:r}));if(L.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner"){let r=this.metadataArgsStorage.filterUniques(t.inheritanceTree).map(o=>new Je({entityMetadata:t,args:{target:o.target,name:o.name,columns:o.columns,unique:!0,synchronize:!0}}));t.ownIndices.push(...r)}else{let r=this.metadataArgsStorage.filterUniques(t.inheritanceTree).map(o=>new vn({entityMetadata:t,args:o}));t.ownUniques.push(...r)}}createEmbeddedsRecursively(e,t){return t.map(n=>{let s=new Ja({entityMetadata:e,args:n}),i=typeof s.type=="function"?Cn.getInheritanceTree(s.type):[s.type];return s.columns=this.metadataArgsStorage.filterColumns(i).map(r=>new We({connection:this.connection,entityMetadata:e,embeddedMetadata:s,args:r})),s.relations=this.metadataArgsStorage.filterRelations(i).map(r=>new Ri({entityMetadata:e,embeddedMetadata:s,args:r})),s.listeners=this.metadataArgsStorage.filterListeners(i).map(r=>new Mi({entityMetadata:e,embeddedMetadata:s,args:r})),s.indices=this.metadataArgsStorage.filterIndices(i).map(r=>new Je({entityMetadata:e,embeddedMetadata:s,args:r})),s.uniques=this.metadataArgsStorage.filterUniques(i).map(r=>new vn({entityMetadata:e,embeddedMetadata:s,args:r})),s.relationIds=this.metadataArgsStorage.filterRelationIds(i).map(r=>new xi({entityMetadata:e,args:r})),s.relationCounts=this.metadataArgsStorage.filterRelationCounts(i).map(r=>new Si({entityMetadata:e,args:r})),s.embeddeds=this.createEmbeddedsRecursively(e,this.metadataArgsStorage.filterEmbeddeds(i)),s.embeddeds.forEach(r=>r.parentEmbeddedMetadata=s),e.allEmbeddeds.push(s),s})}computeEntityMetadataStep2(e){e.embeddeds.forEach(t=>t.build(this.connection)),e.embeddeds.forEach(t=>{t.columnsFromTree.forEach(n=>n.build(this.connection)),t.relationsFromTree.forEach(n=>n.build())}),e.ownColumns.forEach(t=>t.build(this.connection)),e.ownRelations.forEach(t=>t.build()),e.relations=e.embeddeds.reduce((t,n)=>t.concat(n.relationsFromTree),e.ownRelations),e.eagerRelations=e.relations.filter(t=>t.isEager),e.lazyRelations=e.relations.filter(t=>t.isLazy),e.oneToOneRelations=e.relations.filter(t=>t.isOneToOne),e.oneToManyRelations=e.relations.filter(t=>t.isOneToMany),e.manyToOneRelations=e.relations.filter(t=>t.isManyToOne),e.manyToManyRelations=e.relations.filter(t=>t.isManyToMany),e.ownerOneToOneRelations=e.relations.filter(t=>t.isOneToOneOwner),e.ownerManyToManyRelations=e.relations.filter(t=>t.isManyToManyOwner),e.treeParentRelation=e.relations.find(t=>t.isTreeParent),e.treeChildrenRelation=e.relations.find(t=>t.isTreeChildren),e.columns=e.embeddeds.reduce((t,n)=>t.concat(n.columnsFromTree),e.ownColumns),e.listeners=e.embeddeds.reduce((t,n)=>t.concat(n.listenersFromTree),e.ownListeners),e.afterLoadListeners=e.listeners.filter(t=>t.type===rt.AFTER_LOAD),e.afterInsertListeners=e.listeners.filter(t=>t.type===rt.AFTER_INSERT),e.afterUpdateListeners=e.listeners.filter(t=>t.type===rt.AFTER_UPDATE),e.afterRemoveListeners=e.listeners.filter(t=>t.type===rt.AFTER_REMOVE),e.afterSoftRemoveListeners=e.listeners.filter(t=>t.type===rt.AFTER_SOFT_REMOVE),e.afterRecoverListeners=e.listeners.filter(t=>t.type===rt.AFTER_RECOVER),e.beforeInsertListeners=e.listeners.filter(t=>t.type===rt.BEFORE_INSERT),e.beforeUpdateListeners=e.listeners.filter(t=>t.type===rt.BEFORE_UPDATE),e.beforeRemoveListeners=e.listeners.filter(t=>t.type===rt.BEFORE_REMOVE),e.beforeSoftRemoveListeners=e.listeners.filter(t=>t.type===rt.BEFORE_SOFT_REMOVE),e.beforeRecoverListeners=e.listeners.filter(t=>t.type===rt.BEFORE_RECOVER),e.indices=e.embeddeds.reduce((t,n)=>t.concat(n.indicesFromTree),e.ownIndices),e.uniques=e.embeddeds.reduce((t,n)=>t.concat(n.uniquesFromTree),e.ownUniques),e.primaryColumns=e.columns.filter(t=>t.isPrimary),e.nonVirtualColumns=e.columns.filter(t=>!t.isVirtual),e.ancestorColumns=e.columns.filter(t=>t.closureType==="ancestor"),e.descendantColumns=e.columns.filter(t=>t.closureType==="descendant"),e.hasMultiplePrimaryKeys=e.primaryColumns.length>1,e.generatedColumns=e.columns.filter(t=>t.isGenerated||t.isObjectId),e.hasUUIDGeneratedColumns=e.columns.filter(t=>t.isGenerated||t.generationStrategy==="uuid").length>0,e.createDateColumn=e.columns.find(t=>t.isCreateDate),e.updateDateColumn=e.columns.find(t=>t.isUpdateDate),e.deleteDateColumn=e.columns.find(t=>t.isDeleteDate),e.versionColumn=e.columns.find(t=>t.isVersion),e.discriminatorColumn=e.columns.find(t=>t.isDiscriminator),e.treeLevelColumn=e.columns.find(t=>t.isTreeLevel),e.nestedSetLeftColumn=e.columns.find(t=>t.isNestedSetLeft),e.nestedSetRightColumn=e.columns.find(t=>t.isNestedSetRight),e.materializedPathColumn=e.columns.find(t=>t.isMaterializedPath),e.objectIdColumn=e.columns.find(t=>t.isObjectId),e.foreignKeys.forEach(t=>t.build(this.connection.namingStrategy)),e.propertiesMap=e.createPropertiesMap(),e.relationIds.forEach(t=>t.build()),e.relationCounts.forEach(t=>t.build()),e.embeddeds.forEach(t=>{t.relationIdsFromTree.forEach(n=>n.build()),t.relationCountsFromTree.forEach(n=>n.build())})}computeInverseProperties(e,t){e.relations.forEach(n=>{let s=t.find(i=>i.target===n.type||typeof n.type=="string"&&(i.targetName===n.type||i.givenTableName===n.type));if(!s)throw new v("Entity metadata for "+e.name+"#"+n.propertyPath+" was not found. Check if you specified a correct entity object and if it's connected in the connection options.");n.inverseEntityMetadata=s,n.inverseSidePropertyPath=n.buildInverseSidePropertyPath(),n.inverseRelation=s.relations.find(i=>i.propertyPath===n.inverseSidePropertyPath)})}createKeysForTableInheritance(e){e.indices.push(new Je({entityMetadata:e,columns:[e.discriminatorColumn],args:{target:e.target,unique:!1}}))}},Xa=class a extends v{static createEntitySchemaIsRequiredException(e){return new a(`EntitySchema is required for ${e} embedded field`)}static createTargetIsRequired(e){return new a(`Target field is required for ${e} embedded EntitySchema`)}constructor(e){super(e)}},eo=class{transform(e){let t=new li;return e.forEach(n=>{let s=n.options,i={target:s.target||s.name,name:s.tableName,database:s.database,schema:s.schema,type:s.type||"regular",orderBy:s.orderBy,synchronize:s.synchronize,withoutRowid:!!s.withoutRowid,expression:s.expression};t.tables.push(i),this.transformColumnsRecursive(s,t)}),t}transformColumnsRecursive(e,t){Object.keys(e.columns).forEach(n=>{let i=e.columns[n],r="regular";i.createDate&&(r="createDate"),i.updateDate&&(r="updateDate"),i.deleteDate&&(r="deleteDate"),i.version&&(r="version"),i.treeChildrenCount&&(r="treeChildrenCount"),i.treeLevel&&(r="treeLevel"),i.objectId&&(r="objectId");let o={target:e.target||e.name,mode:r,propertyName:n,options:{type:i.type,name:i.objectId?"_id":i.name,primaryKeyConstraintName:i.primaryKeyConstraintName,length:i.length,width:i.width,nullable:i.nullable,readonly:i.readonly,update:i.update,select:i.select,insert:i.insert,primary:i.primary,unique:i.unique,comment:i.comment,default:i.default,onUpdate:i.onUpdate,precision:i.precision,scale:i.scale,zerofill:i.zerofill,unsigned:i.unsigned,charset:i.charset,collation:i.collation,enum:i.enum,enumName:i.enumName,asExpression:i.asExpression,generatedType:i.generatedType,hstoreType:i.hstoreType,array:i.array,transformer:i.transformer,spatialFeatureType:i.spatialFeatureType,srid:i.srid}};if(t.columns.push(o),i.generated){let c={target:e.target||e.name,propertyName:n,strategy:typeof i.generated=="string"?i.generated:"increment"};t.generations.push(c)}i.unique&&t.uniques.push({target:e.target||e.name,columns:[n]})}),e.relations&&Object.keys(e.relations).forEach(n=>{let s=e.relations[n],i={target:e.target||e.name,propertyName:n,relationType:s.type,isLazy:s.lazy||!1,type:s.target,inverseSideProperty:s.inverseSide,isTreeParent:s.treeParent,isTreeChildren:s.treeChildren,options:{eager:s.eager||!1,cascade:s.cascade,nullable:s.nullable,onDelete:s.onDelete,onUpdate:s.onUpdate,deferrable:s.deferrable,createForeignKeyConstraints:s.createForeignKeyConstraints,persistence:s.persistence,orphanedRowAction:s.orphanedRowAction}};if(t.relations.push(i),s.joinColumn)if(typeof s.joinColumn=="boolean"){let r={target:e.target||e.name,propertyName:n};t.joinColumns.push(r)}else{let r=Array.isArray(s.joinColumn)?s.joinColumn:[s.joinColumn];for(let o of r){let c={target:e.target||e.name,propertyName:n,name:o.name,referencedColumnName:o.referencedColumnName,foreignKeyConstraintName:o.foreignKeyConstraintName};t.joinColumns.push(c)}}if(s.joinTable)if(typeof s.joinTable=="boolean"){let r={target:e.target||e.name,propertyName:n};t.joinTables.push(r)}else{let r={target:e.target||e.name,propertyName:n,name:s.joinTable.name,database:s.joinTable.database,schema:s.joinTable.schema,joinColumns:s.joinTable.joinColumn?[s.joinTable.joinColumn]:s.joinTable.joinColumns,inverseJoinColumns:s.joinTable.inverseJoinColumn?[s.joinTable.inverseJoinColumn]:s.joinTable.inverseJoinColumns};t.joinTables.push(r)}}),e.relationIds&&Object.keys(e.relationIds).forEach(n=>{let s=e.relationIds[n],i={propertyName:n,relation:s.relationName,target:e.target||e.name,alias:s.alias,queryBuilderFactory:s.queryBuilderFactory};t.relationIds.push(i)}),e.indices&&e.indices.forEach(n=>{let s={target:e.target||e.name,name:n.name,unique:n.unique===!0,spatial:n.spatial===!0,fulltext:n.fulltext===!0,nullFiltered:n.nullFiltered===!0,parser:n.parser,synchronize:n.synchronize!==!1,where:n.where,sparse:n.sparse,columns:n.columns};t.indices.push(s)}),e.uniques&&e.uniques.forEach(n=>{let s={target:e.target||e.name,name:n.name,columns:n.columns,deferrable:n.deferrable};t.uniques.push(s)}),e.checks&&e.checks.forEach(n=>{let s={target:e.target||e.name,name:n.name,expression:n.expression};t.checks.push(s)}),e.exclusions&&e.exclusions.forEach(n=>{let s={target:e.target||e.name,name:n.name,expression:n.expression};t.exclusions.push(s)}),e.embeddeds&&Object.keys(e.embeddeds).forEach(n=>{let s=e.embeddeds[n];if(!s.schema)throw Xa.createEntitySchemaIsRequiredException(n);let i=s.schema.options;t.embeddeds.push({target:e.target||e.name,propertyName:n,isArray:s.array===!0,prefix:s.prefix!==void 0?s.prefix:void 0,type:()=>i?.target||i.name}),this.transformColumnsRecursive(i,t)})}},to=class{constructor(e){this.connection=e}async buildMigrations(e){let[t,n]=ce.splitClassesAndStrings(e);return[...t,...await Jr(this.connection.logger,n)].map(i=>Qc(i))}async buildSubscribers(e){let[t,n]=ce.splitClassesAndStrings(e||[]),s=[...t,...await Jr(this.connection.logger,n)];return ze().filterSubscribers(s).map(i=>Qc(i.target))}async buildEntityMetadatas(e){let[t,n]=ce.splitClassesAndStrings(e||[]),s=t.filter(u=>!$.isEntitySchema(u)),i=t.filter(u=>$.isEntitySchema(u)),r=[...s,...await Jr(this.connection.logger,n)];r.forEach(u=>{$.isEntitySchema(u)&&i.push(u)});let o=new Ai(this.connection,ze()).build(r),c=new eo().transform(i),l=new Ai(this.connection,c).build();return[...o,...l]}},no=class{constructor(e,t,n,s,i){this.expressionMap=e,this.driver=t,this.rawRelationIdResults=n,this.rawRelationCountResults=s,this.queryRunner=i}transform(e,t){let n=this.group(e,t),s=[];return n.forEach(i=>{let r=this.transformRawResultsGroup(i,t);r!==void 0&&!Object.values(r).every(o=>o===null)&&s.push(r)}),s}group(e,t){let n=new Map,s=[];return t.metadata.tableType==="view"?s.push(...t.metadata.columns.map(i=>L.buildAlias(this.driver,t.name,i.databaseName))):s.push(...t.metadata.primaryColumns.map(i=>L.buildAlias(this.driver,t.name,i.databaseName))),e.forEach(i=>{let r=s.map(c=>{let l=i[c];return ne.isObject(l)?JSON.stringify(l):l}).join("_"),o=n.get(r);o?o.push(i):n.set(r,[i])}),n}transformRawResultsGroup(e,t){let n=t.metadata;if(n.discriminatorColumn){let u=e.map(d=>d[L.buildAlias(this.driver,t.name,t.metadata.discriminatorColumn.databaseName)]),h=n.childEntityMetadatas.find(d=>typeof u.find(f=>f===d.discriminatorValue)<"u");h&&(n=h)}let s=n.create(this.queryRunner,{fromDeserializer:!0,pojo:this.expressionMap.options.indexOf("create-pojo")!==-1}),i=this.transformColumns(e,t,s,n),r=this.transformJoins(e,s,t,n),o=this.transformRelationIds(e,t,s,n),c=this.transformRelationCounts(e,t,s);if(i||n.primaryColumns.filter(u=>u.isVirtual===!1).length===0&&(r||o||c))return s}transformColumns(e,t,n,s){let i=!1;return s.columns.forEach(r=>{if(s.childEntityMetadatas.length>0&&s.childEntityMetadatas.findIndex(c=>c.target===r.target)!==-1)return;let o=e[0][L.buildAlias(this.driver,t.name,r.databaseName)];o===void 0||r.isVirtual||this.expressionMap.selects.find(c=>c.selection===t.name||c.selection===t.name+"."+r.propertyPath)&&(r.setEntityValue(n,this.driver.prepareHydratedValue(o,r)),o!==null&&(i=!0))}),i}transformJoins(e,t,n,s){let i=!1;return this.expressionMap.joinAttributes.forEach(r=>{if(!r.metadata||!r.isSelected||r.relation&&!s.relations.find(c=>c===r.relation))return;if(r.mapToProperty){if(r.mapToPropertyParentAlias!==n.name)return}else if(!r.relation||r.parentAlias!==n.name||r.relationPropertyPath!==r.relation.propertyPath)return;let o=this.transform(e,r.alias);o=r.isMany?o:o[0],o=!r.isMany&&o===void 0?null:o,o!==void 0&&(r.mapToPropertyPropertyName?t[r.mapToPropertyPropertyName]=o:r.relation.setEntityValue(t,o),i=!0)}),i}transformRelationIds(e,t,n,s){let i=!1;return this.rawRelationIdResults.forEach((r,o)=>{if(r.relationIdAttribute.parentAlias!==t.name)return;let c=r.relationIdAttribute.relation,l=this.createValueMapFromJoinColumns(c,r.relationIdAttribute.parentAlias,e);if(l==null)return;this.prepareDataForTransformRelationIds();let u=this.hashEntityIds(c,l),h=this.relationIdMaps[o][u]||[],d=r.relationIdAttribute.mapToPropertyPropertyPath.split("."),f=(p,m,x)=>{let S=p.shift();if(S&&p.length===0)return m[S]=x,m;if(S&&p.length>0)f(p,m[S],x);else return m};c.isOneToOne||c.isManyToOne?h[0]!==void 0&&(f(d,n,h[0]),i=!0):(f(d,n,h),i=i||h.length>0)}),i}transformRelationCounts(e,t,n){let s=!1;return this.rawRelationCountResults.filter(i=>i.relationCountAttribute.parentAlias===t.name).forEach(i=>{let r=i.relationCountAttribute.relation,o;r.isOneToMany?o=r.inverseRelation.joinColumns[0].referencedColumn.databaseName:o=r.isOwning?r.joinColumns[0].referencedColumn.databaseName:r.inverseRelation.joinColumns[0].referencedColumn.databaseName;let c=e[0][L.buildAlias(this.driver,t.name,o)];c!=null&&(n[i.relationCountAttribute.mapToPropertyPropertyName]=0,i.results.filter(l=>l.parentId===c).forEach(l=>{n[i.relationCountAttribute.mapToPropertyPropertyName]=parseInt(l.cnt),s=!0}))}),s}createValueMapFromJoinColumns(e,t,n){let s;return e.isManyToOne||e.isOneToOneOwner?s=e.entityMetadata.primaryColumns.map(i=>i):e.isOneToMany||e.isOneToOneNotOwner?s=e.inverseRelation.joinColumns.map(i=>i):e.isOwning?s=e.joinColumns.map(i=>i):s=e.inverseRelation.inverseJoinColumns.map(i=>i),s.reduce((i,r)=>(n.forEach(o=>{e.isManyToOne||e.isOneToOneOwner?i[r.databaseName]=this.driver.prepareHydratedValue(o[L.buildAlias(this.driver,t,r.databaseName)],r):i[r.databaseName]=this.driver.prepareHydratedValue(o[L.buildAlias(this.driver,t,r.referencedColumn.databaseName)],r)}),i),{})}extractEntityPrimaryIds(e,t){let n;return e.isManyToOne||e.isOneToOneOwner?n=e.entityMetadata.primaryColumns.map(s=>s):e.isOneToMany||e.isOneToOneNotOwner?n=e.inverseRelation.joinColumns.map(s=>s):e.isOwning?n=e.joinColumns.map(s=>s):n=e.inverseRelation.inverseJoinColumns.map(s=>s),n.reduce((s,i)=>(s[i.databaseName]=t[i.databaseName],s),{})}prepareDataForTransformRelationIds(){this.relationIdMaps||(this.relationIdMaps=this.rawRelationIdResults.map(e=>{let t=e.relationIdAttribute.relation,n;return t.isManyToOne||t.isOneToOneOwner?n=t.joinColumns:t.isOneToMany||t.isOneToOneNotOwner?n=t.inverseEntityMetadata.primaryColumns:t.isOwning?n=t.inverseJoinColumns:n=t.inverseRelation.joinColumns,e.results.reduce((s,i)=>{let r=n.reduce((o,c)=>{let l=i[c.databaseName];return t.isOneToMany||t.isOneToOneNotOwner?(c.isVirtual&&c.referencedColumn&&c.referencedColumn.propertyName!==c.propertyName&&(l=c.referencedColumn.createValueMap(l)),ce.mergeDeep(o,c.createValueMap(l))):(!c.isPrimary&&c.referencedColumn.referencedColumn&&(l=c.referencedColumn.referencedColumn.createValueMap(l)),ce.mergeDeep(o,c.referencedColumn.createValueMap(l)))},{});if(n.length===1&&!e.relationIdAttribute.disableMixedMap&&(t.isOneToMany||t.isOneToOneNotOwner?r=n[0].getEntityValue(r):r=n[0].referencedColumn.getEntityValue(r)),r!==void 0){let o=this.hashEntityIds(t,i);s[o]?s[o].push(r):s[o]=[r]}return s},{})}))}hashEntityIds(e,t){let n=this.extractEntityPrimaryIds(e,t);return JSON.stringify(n)}},et=class{static isAliasProperty(e){if(typeof e!="string"||e.indexOf(".")===-1)return!1;let[t,n]=e.split(".");return!(!t||!n||e.indexOf("(")!==-1||e.indexOf(")")!==-1)}},Oi=class{constructor(e,t,n){this.connection=e,this.queryExpressionMap=t,this.isSelectedEvaluated=!1,this.relationEvaluated=!1,ne.assign(this,n||{})}get isMany(){return this.isMappingMany!==void 0?this.isMappingMany:this.relation?this.relation.isManyToMany||this.relation.isOneToMany:!1}get isSelected(){if(!this.isSelectedEvaluated){let e=()=>{for(let t of this.queryExpressionMap.selects)if(t.selection===this.alias.name||this.metadata&&this.metadata.columns.find(n=>t.selection===this.alias.name+"."+n.propertyPath))return!0;return!1};this.isSelectedCache=e(),this.isSelectedEvaluated=!0}return this.isSelectedCache}get tablePath(){return this.metadata?this.metadata.tablePath:this.entityOrProperty}get parentAlias(){if(et.isAliasProperty(this.entityOrProperty))return this.entityOrProperty.substr(0,this.entityOrProperty.indexOf("."))}get relationPropertyPath(){if(et.isAliasProperty(this.entityOrProperty))return this.entityOrProperty.substr(this.entityOrProperty.indexOf(".")+1)}get relation(){if(!this.relationEvaluated){let e=()=>{if(!et.isAliasProperty(this.entityOrProperty))return;let t=this.queryExpressionMap.findAliasByName(this.parentAlias),n=t.metadata.findRelationWithPropertyPath(this.relationPropertyPath);if(n||t.metadata.parentEntityMetadata&&(n=t.metadata.parentEntityMetadata.findRelationWithPropertyPath(this.relationPropertyPath),n))return n;throw new v(`Relation with property path ${this.relationPropertyPath} in entity was not found.`)};this.relationCache=e.bind(this)(),this.relationEvaluated=!0}return this.relationCache}get metadata(){if(this.relation)return this.relation.inverseEntityMetadata;if(this.connection.hasMetadata(this.entityOrProperty))return this.connection.getMetadata(this.entityOrProperty)}get junctionAlias(){if(!this.relation)throw new v("Cannot get junction table for join without relation.");return this.relation.isOwning?L.buildAlias(this.connection.driver,this.parentAlias,this.alias.name):L.buildAlias(this.connection.driver,this.alias.name,this.parentAlias)}get mapToPropertyParentAlias(){if(this.mapToProperty)return this.mapToProperty.split(".")[0]}get mapToPropertyPropertyName(){if(this.mapToProperty)return this.mapToProperty.split(".")[1]}},fs=class{constructor(e,t){this.queryExpressionMap=e,this.disableMixedMap=!1,ne.assign(this,t||{})}get joinInverseSideMetadata(){return this.relation.inverseEntityMetadata}get parentAlias(){if(!et.isAliasProperty(this.relationName))throw new v("Given value must be a string representation of alias property");return this.relationName.substr(0,this.relationName.indexOf("."))}get relationPropertyPath(){if(!et.isAliasProperty(this.relationName))throw new v("Given value must be a string representation of alias property");return this.relationName.substr(this.relationName.indexOf(".")+1)}get relation(){if(!et.isAliasProperty(this.relationName))throw new v("Given value must be a string representation of alias property");let t=this.queryExpressionMap.findAliasByName(this.parentAlias).metadata.findRelationWithPropertyPath(this.relationPropertyPath);if(!t)throw new v(`Relation with property path ${this.relationPropertyPath} in entity was not found.`);return t}get junctionAlias(){let[e,t]=this.relationName.split(".");return e+"_"+t+"_rid"}get junctionMetadata(){return this.relation.junctionEntityMetadata}get mapToPropertyParentAlias(){return this.mapToProperty.substr(0,this.mapToProperty.indexOf("."))}get mapToPropertyPropertyPath(){return this.mapToProperty.substr(this.mapToProperty.indexOf(".")+1)}},ps=class{constructor(e,t){this.expressionMap=e,ne.assign(this,t||{})}get joinInverseSideMetadata(){return this.relation.inverseEntityMetadata}get parentAlias(){if(!et.isAliasProperty(this.relationName))throw new v("Given value must be a string representation of alias property");return this.relationName.split(".")[0]}get relationProperty(){if(!et.isAliasProperty(this.relationName))throw new v("Given value is a string representation of alias property");return this.relationName.split(".")[1]}get junctionAlias(){let[e,t]=this.relationName.split(".");return e+"_"+t+"_rc"}get relation(){if(!et.isAliasProperty(this.relationName))throw new v("Given value is a string representation of alias property");let[e,t]=this.relationName.split("."),s=this.expressionMap.findAliasByName(e).metadata.findRelationWithPropertyPath(t);if(!s)throw new v(`Relation with property path ${t} in entity was not found.`);return s}get metadata(){if(!et.isAliasProperty(this.relationName))throw new v("Given value is a string representation of alias property");let e=this.relationName.split(".")[0];return this.expressionMap.findAliasByName(e).metadata}get mapToPropertyPropertyName(){return this.mapToProperty.split(".")[1]}},ah=class{constructor(e,t,n){this.connection=e,this.queryRunner=t,this.relationIdAttributes=n}async load(e){let t=this.relationIdAttributes.map(async n=>{if(n.relation.isManyToOne||n.relation.isOneToOneOwner){if(n.queryBuilderFactory)throw new v("Additional condition can not be used with ManyToOne or OneToOne owner relations.");let s={},i=e.map(r=>{let o={},c=[];n.relation.joinColumns.forEach(u=>{o[u.databaseName]=this.connection.driver.prepareHydratedValue(r[L.buildAlias(this.connection.driver,n.parentAlias,u.databaseName)],u.referencedColumn);let h=`${u.databaseName}:${o[u.databaseName]}`;c.indexOf(h)===-1&&c.push(h)}),n.relation.entityMetadata.primaryColumns.forEach(u=>{o[u.databaseName]=this.connection.driver.prepareHydratedValue(r[L.buildAlias(this.connection.driver,n.parentAlias,u.databaseName)],u);let h=`${u.databaseName}:${o[u.databaseName]}`;c.indexOf(h)===-1&&c.push(h)}),c.sort();let l=c.join("::");return s[l]?null:(s[l]=!0,o)}).filter(r=>r);return{relationIdAttribute:n,results:i}}else if(n.relation.isOneToMany||n.relation.isOneToOneNotOwner){let s=n.relation,i=s.isOwning?s.joinColumns:s.inverseRelation.joinColumns,r=s.inverseEntityMetadata.target,o=s.inverseEntityMetadata.tableName,c=n.alias||o,l={},u={},h=e.map((m,x)=>{let S=[],G={},D=i.map(J=>{let re=J.databaseName+x,le=m[L.buildAlias(this.connection.driver,n.parentAlias,J.referencedColumn.databaseName)],ue=`${c}:${J.propertyPath}:${le}`;return S.indexOf(ue)!==-1?"":(S.push(ue),G[re]=le,c+"."+J.propertyPath+" = :"+re)}).filter(J=>J).join(" AND ");S.sort();let q=S.join("::");return l[q]?"":(l[q]=!0,Object.assign(u,G),D)}).filter(m=>m).map(m=>"("+m+")").join(" OR ");if(!h)return{relationIdAttribute:n,results:[]};let d=this.connection.createQueryBuilder(this.queryRunner);ce.uniq([...i,...s.inverseRelation.entityMetadata.primaryColumns],m=>m.propertyPath).forEach(m=>{d.addSelect(c+"."+m.propertyPath,m.databaseName)}),d.from(r,c).where("("+h+")").setParameters(u),n.queryBuilderFactory&&n.queryBuilderFactory(d);let p=await d.getRawMany();return p.forEach(m=>{i.forEach(x=>{m[x.databaseName]=this.connection.driver.prepareHydratedValue(m[x.databaseName],x.referencedColumn)}),s.inverseRelation.entityMetadata.primaryColumns.forEach(x=>{m[x.databaseName]=this.connection.driver.prepareHydratedValue(m[x.databaseName],x)})}),{relationIdAttribute:n,results:p}}else{let s=n.relation,i=s.isOwning?s.joinColumns:s.inverseRelation.inverseJoinColumns,r=s.isOwning?s.inverseJoinColumns:s.inverseRelation.joinColumns,o=n.junctionAlias,c=n.joinInverseSideMetadata.tableName,l=n.alias||c,u=s.isOwning?s.junctionEntityMetadata.tableName:s.inverseRelation.junctionEntityMetadata.tableName,h=e.map(D=>i.reduce((q,J)=>(q[J.propertyPath]=D[L.buildAlias(this.connection.driver,n.parentAlias,J.referencedColumn.databaseName)],q),{}));if(h.length===0)return{relationIdAttribute:n,results:[]};let d={},f={},p=h.map((D,q)=>{let J=[],re={},le=Object.keys(D).map(de=>{let E=de+q,T=D[de],O=`${o}:${de}:${T}`;return J.indexOf(O)!==-1?"":(J.push(O),re[E]=T,o+"."+de+" = :"+E)}).filter(de=>de).join(" AND ");J.sort();let ue=J.join("::");return f[ue]?"":(f[ue]=!0,Object.assign(d,re),le)}).filter(D=>D),m=r.map(D=>o+"."+D.propertyPath+" = "+l+"."+D.referencedColumn.propertyPath).join(" AND "),x=p.map(D=>"("+D+" AND "+m+")").join(" OR "),S=this.connection.createQueryBuilder(this.queryRunner);r.forEach(D=>{S.addSelect(o+"."+D.propertyPath,D.databaseName).addOrderBy(o+"."+D.propertyPath)}),i.forEach(D=>{S.addSelect(o+"."+D.propertyPath,D.databaseName).addOrderBy(o+"."+D.propertyPath)}),S.from(c,l).innerJoin(u,o,x).setParameters(d),n.queryBuilderFactory&&n.queryBuilderFactory(S);let G=await S.getRawMany();return G.forEach(D=>{[...i,...r].forEach(q=>{D[q.databaseName]=this.connection.driver.prepareHydratedValue(D[q.databaseName],q.referencedColumn)})}),{relationIdAttribute:n,results:G}}});return Promise.all(t)}},so=class{constructor(e){this.expressionMap=e}transform(){this.expressionMap.mainAlias&&this.expressionMap.mainAlias.metadata.relationIds.forEach(e=>{let t=this.metadataToAttribute(this.expressionMap.mainAlias.name,e);this.expressionMap.relationIdAttributes.push(t)}),this.expressionMap.joinAttributes.forEach(e=>{!e.metadata||e.metadata.isJunction||e.metadata.relationIds.forEach(t=>{let n=this.metadataToAttribute(e.alias.name,t);this.expressionMap.relationIdAttributes.push(n)})})}metadataToAttribute(e,t){return new fs(this.expressionMap,{relationName:e+"."+t.relation.propertyName,mapToProperty:e+"."+t.propertyName,alias:t.alias,queryBuilderFactory:t.queryBuilderFactory})}},io=class{constructor(e,t,n){this.connection=e,this.queryRunner=t,this.relationCountAttributes=n}async load(e){let t=(s,i,r)=>r.indexOf(s)===i,n=this.relationCountAttributes.map(async s=>{if(s.relation.isOneToMany){let i=s.relation,r=i.inverseRelation,o=r.joinColumns[0].referencedColumn.propertyName,c=i.inverseEntityMetadata.target,l=i.inverseEntityMetadata.tableName,u=s.alias||l,h=r.propertyName,d=e.map(p=>p[s.parentAlias+"_"+o]).filter(p=>!!p);if(d=d.filter(t),d.length===0)return{relationCountAttribute:s,results:[]};let f=this.connection.createQueryBuilder(this.queryRunner);return f.select(u+"."+h,"parentId").addSelect("COUNT(*)","cnt").from(c,u).where(u+"."+h+" IN (:...ids)").addGroupBy(u+"."+h).setParameter("ids",d),s.queryBuilderFactory&&s.queryBuilderFactory(f),{relationCountAttribute:s,results:await f.getRawMany()}}else{let i,r,o,c;s.relation.isOwning?(i=s.relation.joinColumns[0].referencedColumn.databaseName,r=s.relation.inverseJoinColumns[0].referencedColumn.databaseName,o=s.relation.junctionEntityMetadata.columns[0],c=s.relation.junctionEntityMetadata.columns[1]):(i=s.relation.inverseRelation.inverseJoinColumns[0].referencedColumn.databaseName,r=s.relation.inverseRelation.joinColumns[0].referencedColumn.databaseName,o=s.relation.junctionEntityMetadata.columns[1],c=s.relation.junctionEntityMetadata.columns[0]);let l=e.map(x=>x[s.parentAlias+"_"+i]).filter(x=>!!x);if(l=l.filter(t),l.length===0)return{relationCountAttribute:s,results:[]};let u=s.junctionAlias,h=s.joinInverseSideMetadata.tableName,d=s.alias||h,f=s.relation.junctionEntityMetadata.tableName,p=u+"."+o.propertyName+" IN ("+l.map(x=>isNaN(x)?"'"+x+"'":x)+") AND "+u+"."+c.propertyName+" = "+d+"."+r,m=this.connection.createQueryBuilder(this.queryRunner);return m.select(u+"."+o.propertyName,"parentId").addSelect("COUNT("+m.escape(d)+"."+m.escape(r)+")","cnt").from(h,d).innerJoin(f,u,p).addGroupBy(u+"."+o.propertyName),s.queryBuilderFactory&&s.queryBuilderFactory(m),{relationCountAttribute:s,results:await m.getRawMany()}}});return Promise.all(n)}},ro=class{constructor(e){this.expressionMap=e}transform(){this.expressionMap.mainAlias&&this.expressionMap.mainAlias.metadata.relationCounts.forEach(e=>{let t=this.metadataToAttribute(this.expressionMap.mainAlias.name,e);this.expressionMap.relationCountAttributes.push(t)}),this.expressionMap.joinAttributes.forEach(e=>{!e.metadata||e.metadata.isJunction||e.metadata.relationCounts.forEach(t=>{let n=this.metadataToAttribute(e.alias.name,t);this.expressionMap.relationCountAttributes.push(n)})})}metadataToAttribute(e,t){return new ps(this.expressionMap,{relationName:e+"."+t.relation.propertyName,mapToProperty:e+"."+t.propertyName,alias:t.alias,queryBuilderFactory:t.queryBuilderFactory})}},Pi=class{constructor(e){ne.assign(this,e||{})}get target(){return this.metadata.target}get hasMetadata(){return!!this._metadata}set metadata(e){this._metadata=e}get metadata(){if(!this._metadata)throw new v(`Cannot get entity metadata for the given alias "${this.name}"`);return this._metadata}},ao=class a{constructor(e){this.connection=e,this.relationLoadStrategy="join",this.queryEntity=!1,this.aliases=[],this.queryType="select",this.selects=[],this.maxExecutionTime=0,this.selectDistinct=!1,this.selectDistinctOn=[],this.extraReturningColumns=[],this.onConflict="",this.onIgnore=!1,this.joinAttributes=[],this.relationIdAttributes=[],this.relationCountAttributes=[],this.wheres=[],this.havings=[],this.orderBys={},this.groupBys=[],this.withDeleted=!1,this.parameters={},this.disableEscaping=!0,this.enableRelationIdValues=!1,this.extraAppendedAndWhereCondition="",this.subQuery=!1,this.aliasNamePrefixingEnabled=!0,this.cache=!1,this.options=[],this.insertColumns=[],this.whereEntities=[],this.updateEntity=!0,this.callListeners=!0,this.useTransaction=!1,this.nativeParameters={},this.locallyGenerated={},this.commonTableExpressions=[],e.options.relationLoadStrategy&&(this.relationLoadStrategy=e.options.relationLoadStrategy)}get allOrderBys(){if(!Object.keys(this.orderBys).length&&this.mainAlias.hasMetadata&&this.options.indexOf("disable-global-order")===-1){let e=this.mainAlias.metadata.orderBy||{};return Object.keys(e).reduce((t,n)=>(t[this.mainAlias.name+"."+n]=e[n],t),{})}return this.orderBys}setMainAlias(e){return this.mainAlias=e,e}createAlias(e){let t=e.name;!t&&e.tablePath&&(t=e.tablePath),!t&&typeof e.target=="function"&&(t=e.target.name),!t&&typeof e.target=="string"&&(t=e.target);let n=new Pi;return n.type=e.type,t&&(n.name=t),e.metadata&&(n.metadata=e.metadata),e.target&&!n.hasMetadata&&(n.metadata=this.connection.getMetadata(e.target)),e.tablePath&&(n.tablePath=e.tablePath),e.subQuery&&(n.subQuery=e.subQuery),this.aliases.push(n),n}findAliasByName(e){let t=this.aliases.find(n=>n.name===e);if(!t)throw new v(`"${e}" alias was not found. Maybe you forgot to join it?`);return t}findColumnByAliasExpression(e){let[t,n]=e.split(".");return this.findAliasByName(t).metadata.findColumnWithPropertyName(n)}get relationMetadata(){if(!this.mainAlias)throw new v("Entity to work with is not specified!");let e=this.mainAlias.metadata.findRelationWithPropertyPath(this.relationPropertyPath);if(!e)throw new v(`Relation ${this.relationPropertyPath} was not found in entity ${this.mainAlias.name}`);return e}clone(){let e=new a(this.connection);return e.queryType=this.queryType,e.selects=this.selects.map(t=>t),e.maxExecutionTime=this.maxExecutionTime,e.selectDistinct=this.selectDistinct,e.selectDistinctOn=this.selectDistinctOn,this.aliases.forEach(t=>e.aliases.push(new Pi(t))),e.relationLoadStrategy=this.relationLoadStrategy,e.mainAlias=this.mainAlias,e.valuesSet=this.valuesSet,e.returning=this.returning,e.onConflict=this.onConflict,e.onIgnore=this.onIgnore,e.onUpdate=this.onUpdate,e.joinAttributes=this.joinAttributes.map(t=>new Oi(this.connection,this,t)),e.relationIdAttributes=this.relationIdAttributes.map(t=>new fs(this,t)),e.relationCountAttributes=this.relationCountAttributes.map(t=>new ps(this,t)),e.wheres=this.wheres.map(t=>oe({},t)),e.havings=this.havings.map(t=>oe({},t)),e.orderBys=Object.assign({},this.orderBys),e.groupBys=this.groupBys.map(t=>t),e.limit=this.limit,e.offset=this.offset,e.skip=this.skip,e.take=this.take,e.lockMode=this.lockMode,e.onLocked=this.onLocked,e.lockVersion=this.lockVersion,e.lockTables=this.lockTables,e.withDeleted=this.withDeleted,e.parameters=Object.assign({},this.parameters),e.disableEscaping=this.disableEscaping,e.enableRelationIdValues=this.enableRelationIdValues,e.extraAppendedAndWhereCondition=this.extraAppendedAndWhereCondition,e.subQuery=this.subQuery,e.aliasNamePrefixingEnabled=this.aliasNamePrefixingEnabled,e.cache=this.cache,e.cacheId=this.cacheId,e.cacheDuration=this.cacheDuration,e.relationPropertyPath=this.relationPropertyPath,e.of=this.of,e.insertColumns=this.insertColumns,e.whereEntities=this.whereEntities,e.updateEntity=this.updateEntity,e.callListeners=this.callListeners,e.useTransaction=this.useTransaction,e.nativeParameters=Object.assign({},this.nativeParameters),e.comment=this.comment,e.commonTableExpressions=this.commonTableExpressions.map(t=>({alias:t.alias,queryBuilder:typeof t.queryBuilder=="string"?t.queryBuilder:t.queryBuilder.clone(),options:t.options})),e}},_i=class{constructor(e){this["@instanceof"]=Symbol.for("Brackets"),this.whereFactory=e}},Ii=class{constructor(e,t,n=!0,s=!1,i,r){this["@instanceof"]=Symbol.for("FindOperator"),this._type=e,this._value=t,this._useParameter=n,this._multipleParameters=s,this._getSql=i,this._objectLiteralParameters=r}get useParameter(){return $.isFindOperator(this._value)?this._value.useParameter:this._useParameter}get multipleParameters(){return $.isFindOperator(this._value)?this._value.multipleParameters:this._multipleParameters}get type(){return this._type}get value(){return $.isFindOperator(this._value)?this._value.value:this._value}get objectLiteralParameters(){return $.isFindOperator(this._value)?this._value.objectLiteralParameters:this._objectLiteralParameters}get child(){if($.isFindOperator(this._value))return this._value}get getSql(){return $.isFindOperator(this._value)?this._value.getSql:this._getSql}};function oh(a){return new Ii("in",a,!0,!0)}var ch=/[.*+\-?^${}()|[\]\\]/g,lh=a=>a.replace(ch,"\\$&"),kt=class{constructor(e,t){this["@instanceof"]=Symbol.for("QueryBuilder"),this.parameterIndex=0,$.isQueryBuilder(e)?(this.connection=e.connection,this.queryRunner=e.queryRunner,this.expressionMap=e.expressionMap.clone()):(this.connection=e,this.queryRunner=t,this.expressionMap=new ao(this.connection))}get alias(){if(!this.expressionMap.mainAlias)throw new v("Main alias is not set");return this.expressionMap.mainAlias.name}select(e,t){this.expressionMap.queryType="select",Array.isArray(e)?this.expressionMap.selects=e.map(s=>({selection:s})):e&&(this.expressionMap.selects=[{selection:e,aliasName:t}]);let n=xe.getBy("SelectQueryBuilder");return $.isSelectQueryBuilder(this)?this:new n(this)}insert(){this.expressionMap.queryType="insert";let e=xe.getBy("InsertQueryBuilder");return $.isInsertQueryBuilder(this)?this:new e(this)}update(e,t){let n=t||e;if(e=$.isEntitySchema(e)?e.options.name:e,typeof e=="function"||typeof e=="string"){let i=this.createFromAlias(e);this.expressionMap.setMainAlias(i)}this.expressionMap.queryType="update",this.expressionMap.valuesSet=n;let s=xe.getBy("UpdateQueryBuilder");return $.isUpdateQueryBuilder(this)?this:new s(this)}delete(){this.expressionMap.queryType="delete";let e=xe.getBy("DeleteQueryBuilder");return $.isDeleteQueryBuilder(this)?this:new e(this)}softDelete(){this.expressionMap.queryType="soft-delete";let e=xe.getBy("SoftDeleteQueryBuilder");return $.isSoftDeleteQueryBuilder(this)?this:new e(this)}restore(){this.expressionMap.queryType="restore";let e=xe.getBy("SoftDeleteQueryBuilder");return $.isSoftDeleteQueryBuilder(this)?this:new e(this)}relation(e,t){let n=arguments.length===2?e:void 0,s=arguments.length===2?t:e;if(this.expressionMap.queryType="relation",this.expressionMap.relationPropertyPath=s,n){let r=this.createFromAlias(n);this.expressionMap.setMainAlias(r)}let i=xe.getBy("RelationQueryBuilder");return $.isRelationQueryBuilder(this)?this:new i(this)}hasRelation(e,t){let n=this.connection.getMetadata(e);return(Array.isArray(t)?t:[t]).every(i=>!!n.findRelationWithPropertyPath(i))}hasParameter(e){return this.parentQueryBuilder?.hasParameter(e)||e in this.expressionMap.parameters}setParameter(e,t){if(typeof t=="function")throw new v(`Function parameter isn't supported in the parameters. Please check "${e}" parameter.`);if(!e.match(/^([A-Za-z0-9_.]+)$/))throw new v("QueryBuilder parameter keys may only contain numbers, letters, underscores, or periods.");return this.parentQueryBuilder&&this.parentQueryBuilder.setParameter(e,t),this.expressionMap.parameters[e]=t,this}setParameters(e){for(let[t,n]of Object.entries(e))this.setParameter(t,n);return this}createParameter(e){let t;do t=`orm_param_${this.parameterIndex++}`;while(this.hasParameter(t));return this.setParameter(t,e),`:${t}`}setNativeParameters(e){return this.parentQueryBuilder&&this.parentQueryBuilder.setNativeParameters(e),Object.keys(e).forEach(t=>{this.expressionMap.nativeParameters[t]=e[t]}),this}getParameters(){let e=Object.assign({},this.expressionMap.parameters);if(this.expressionMap.mainAlias&&this.expressionMap.mainAlias.hasMetadata){let t=this.expressionMap.mainAlias.metadata;if(t.discriminatorColumn&&t.parentEntityMetadata){let n=t.childEntityMetadatas.filter(s=>s.discriminatorColumn).map(s=>s.discriminatorValue);n.push(t.discriminatorValue),e.discriminatorColumnValues=n}}return e}printSql(){let[e,t]=this.getQueryAndParameters();return this.connection.logger.logQuery(e,t),this}getSql(){return this.getQueryAndParameters()[0]}getQueryAndParameters(){let e=this.getQuery(),t=this.getParameters();return this.connection.driver.escapeQueryWithParameters(e,t,this.expressionMap.nativeParameters)}async execute(){let[e,t]=this.getQueryAndParameters(),n=this.obtainQueryRunner();try{return await n.query(e,t)}finally{n!==this.queryRunner&&await n.release()}}createQueryBuilder(){return new this.constructor(this.connection,this.queryRunner)}clone(){return new this.constructor(this)}comment(e){return this.expressionMap.comment=e,this}disableEscaping(){return this.expressionMap.disableEscaping=!1,this}escape(e){return this.expressionMap.disableEscaping?this.connection.driver.escape(e):e}setQueryRunner(e){return this.queryRunner=e,this}callListeners(e){return this.expressionMap.callListeners=e,this}useTransaction(e){return this.expressionMap.useTransaction=e,this}addCommonTableExpression(e,t,n){return this.expressionMap.commonTableExpressions.push({queryBuilder:e,alias:t,options:n||{}}),this}getTableName(e){return e.split(".").map(t=>t===""?t:this.escape(t)).join(".")}getMainTableName(){if(!this.expressionMap.mainAlias)throw new v('Entity where values should be inserted is not specified. Call "qb.into(entity)" method to specify it.');return this.expressionMap.mainAlias.hasMetadata?this.expressionMap.mainAlias.metadata.tablePath:this.expressionMap.mainAlias.tablePath}createFromAlias(e,t){if(this.connection.hasMetadata(e)){let n=this.connection.getMetadata(e);return this.expressionMap.createAlias({type:"from",name:t,metadata:this.connection.getMetadata(e),tablePath:n.tablePath})}else{if(typeof e=="string"){let i=e.substr(0,1)==="("&&e.substr(-1)===")";return this.expressionMap.createAlias({type:"from",name:t,tablePath:i?void 0:e,subQuery:i?e:void 0})}let n=e(this.subQuery());this.setParameters(n.getParameters());let s=n.getQuery();return this.expressionMap.createAlias({type:"from",name:t,subQuery:s})}}replacePropertyNames(e){for(let t of this.expressionMap.aliases){if(!t.hasMetadata)continue;let n=this.expressionMap.aliasNamePrefixingEnabled?`${t.name}.`:"",s=this.expressionMap.aliasNamePrefixingEnabled?`${this.escape(t.name)}.`:"",i={};for(let r of t.metadata.relations)r.joinColumns.length>0&&(i[r.propertyPath]=r.joinColumns[0].databaseName);for(let r of t.metadata.relations)for(let o of[...r.joinColumns,...r.inverseJoinColumns]){let c=`${r.propertyPath}.${o.referencedColumn.propertyPath}`;i[c]=o.databaseName}for(let r of t.metadata.columns)i[r.databaseName]=r.databaseName;for(let r of t.metadata.columns)i[r.propertyName]=r.databaseName;for(let r of t.metadata.columns)i[r.propertyPath]=r.databaseName;e=e.replace(new RegExp(`([ =(]|^.{0})${lh(n)}([^ =(),]+)(?=[ =),]|.{0}$)`,"gm"),(r,o,c)=>i[c]?`${o}${s}${this.escape(i[c])}`:r)}return e}createComment(){return this.expressionMap.comment?`/* ${this.expressionMap.comment.replace("*/","")} */ `:""}createWhereExpression(){let e=[],t=this.createWhereClausesExpression(this.expressionMap.wheres);if(t.length>0&&t!=="1=1"&&e.push(this.replacePropertyNames(t)),this.expressionMap.mainAlias.hasMetadata){let n=this.expressionMap.mainAlias.metadata;if(this.expressionMap.queryType==="select"&&!this.expressionMap.withDeleted&&n.deleteDateColumn){let s=this.expressionMap.aliasNamePrefixingEnabled?this.expressionMap.mainAlias.name+"."+n.deleteDateColumn.propertyName:n.deleteDateColumn.propertyName,i=`${this.replacePropertyNames(s)} IS NULL`;e.push(i)}if(n.discriminatorColumn&&n.parentEntityMetadata){let s=this.expressionMap.aliasNamePrefixingEnabled?this.expressionMap.mainAlias.name+"."+n.discriminatorColumn.databaseName:n.discriminatorColumn.databaseName,i=`${this.replacePropertyNames(s)} IN (:...discriminatorColumnValues)`;e.push(i)}}if(this.expressionMap.extraAppendedAndWhereCondition){let n=this.replacePropertyNames(this.expressionMap.extraAppendedAndWhereCondition);e.push(n)}return e.length?e.length===1?` WHERE ${e[0]}`:` WHERE ( ${e.join(" ) AND ( ")} )`:""}createReturningExpression(e){let t=this.getReturningColumns(),n=this.connection.driver;return typeof this.expressionMap.returning!="string"&&this.expressionMap.extraReturningColumns.length>0&&n.isReturningSqlSupported(e)&&t.push(...this.expressionMap.extraReturningColumns.filter(s=>t.indexOf(s)===-1)),t.length?t.map(i=>{let r=this.escape(i.databaseName);return n.options.type==="mssql"?this.expressionMap.queryType==="insert"||this.expressionMap.queryType==="update"||this.expressionMap.queryType==="soft-delete"||this.expressionMap.queryType==="restore"?"INSERTED."+r:this.escape(this.getMainTableName())+"."+r:r}).join(", "):typeof this.expressionMap.returning=="string"?this.expressionMap.returning:""}getReturningColumns(){let e=[];return Array.isArray(this.expressionMap.returning)&&this.expressionMap.returning.forEach(t=>{this.expressionMap.mainAlias.hasMetadata&&e.push(...this.expressionMap.mainAlias.metadata.findColumnsWithPropertyPath(t))}),e}createWhereClausesExpression(e){return e.map((t,n)=>{let s=this.createWhereConditionExpression(t.condition);switch(t.type){case"and":return(n>0?"AND ":"")+s;case"or":return(n>0?"OR ":"")+s}return s}).join(" ").trim()}createWhereConditionExpression(e,t=!1){if(typeof e=="string")return e;if(Array.isArray(e))return e.length===0?"1=1":e.length===1&&!t?this.createWhereClausesExpression(e):"("+this.createWhereClausesExpression(e)+")";let{driver:n}=this.connection;switch(e.operator){case"lessThan":return`${e.parameters[0]} < ${e.parameters[1]}`;case"lessThanOrEqual":return`${e.parameters[0]} <= ${e.parameters[1]}`;case"arrayContains":return`${e.parameters[0]} @> ${e.parameters[1]}`;case"arrayContainedBy":return`${e.parameters[0]} <@ ${e.parameters[1]}`;case"arrayOverlap":return`${e.parameters[0]} && ${e.parameters[1]}`;case"moreThan":return`${e.parameters[0]} > ${e.parameters[1]}`;case"moreThanOrEqual":return`${e.parameters[0]} >= ${e.parameters[1]}`;case"notEqual":return`${e.parameters[0]} != ${e.parameters[1]}`;case"equal":return`${e.parameters[0]} = ${e.parameters[1]}`;case"ilike":return n.options.type==="postgres"||n.options.type==="cockroachdb"?`${e.parameters[0]} ILIKE ${e.parameters[1]}`:`UPPER(${e.parameters[0]}) LIKE UPPER(${e.parameters[1]})`;case"like":return`${e.parameters[0]} LIKE ${e.parameters[1]}`;case"between":return`${e.parameters[0]} BETWEEN ${e.parameters[1]} AND ${e.parameters[2]}`;case"in":return e.parameters.length<=1?"0=1":`${e.parameters[0]} IN (${e.parameters.slice(1).join(", ")})`;case"any":return`${e.parameters[0]} = ANY(${e.parameters[1]})`;case"isNull":return`${e.parameters[0]} IS NULL`;case"not":return`NOT(${this.createWhereConditionExpression(e.condition)})`;case"brackets":return`${this.createWhereConditionExpression(e.condition,!0)}`}throw new TypeError(`Unsupported FindOperator ${Ii.constructor.name}`)}createCteExpression(){if(!this.hasCommonTableExpressions())return"";let e=this.connection.driver.cteCapabilities.requiresRecursiveHint;return"WITH "+this.expressionMap.commonTableExpressions.map(n=>{let s=typeof n.queryBuilder=="string"?n.queryBuilder:n.queryBuilder.getQuery();if(typeof n.queryBuilder!="string"){if(n.queryBuilder.hasCommonTableExpressions())throw new v(`Nested CTEs aren't supported (CTE: ${n.alias})`);if(!this.connection.driver.cteCapabilities.writable&&!$.isSelectQueryBuilder(n.queryBuilder))throw new v(`Only select queries are supported in CTEs in ${this.connection.options.type} (CTE: ${n.alias})`);this.setParameters(n.queryBuilder.getParameters())}let i=this.escape(n.alias);if(n.options.columnNames){let c=n.options.columnNames.map(l=>this.escape(l));if($.isSelectQueryBuilder(n.queryBuilder)&&n.queryBuilder.expressionMap.selects.length&&n.options.columnNames.length!==n.queryBuilder.expressionMap.selects.length)throw new v(`cte.options.columnNames length (${n.options.columnNames.length}) doesn't match subquery select list length ${n.queryBuilder.expressionMap.selects.length} (CTE: ${n.alias})`);i+=`(${c.join(", ")})`}let r=n.options.recursive&&e?"RECURSIVE":"",o=n.options.materialized&&this.connection.driver.cteCapabilities.materializedHint?"MATERIALIZED":"";return[r,i,o,"AS",`(${s})`].filter(Boolean).join(" ")}).join(", ")+" "}getWhereInIdsCondition(e){let t=this.expressionMap.mainAlias.metadata,n=(Array.isArray(e)?e:[e]).map(s=>t.ensureEntityIdMap(s));if(!t.hasMultiplePrimaryKeys){let s=t.primaryColumns[0];if(!s.transformer&&!s.relationMetadata&&!s.embeddedMetadata)return{[s.propertyName]:oh(n.map(i=>s.getEntityValue(i,!1)))}}return new _i(s=>{for(let i of n)s.orWhere(new _i(r=>r.where(i)))})}findColumnsForPropertyPath(e){let t=this.expressionMap.mainAlias,n=[],s=e.split(".");for(;s.length>1;){let o=s[0];if(!t?.hasMetadata)break;if(t.metadata.hasEmbeddedWithPropertyPath(o)){s.unshift(`${s.shift()}.${s.shift()}`);continue}if(t.metadata.hasRelationWithPropertyPath(o)){let c=this.expressionMap.joinAttributes.find(l=>l.relationPropertyPath===o);if(!c?.alias){let l=n.length>0?`${n.join(".")}.${o}`:o;throw new Error(`Cannot find alias for relation at ${l}`)}t=c.alias,n.push(...o.split(".")),s.shift();continue}break}if(!t)throw new Error(`Cannot find alias for property ${e}`);let i=s.join("."),r=t.metadata.findColumnsWithPropertyPath(i);if(!r.length)throw new pt(e,t.metadata);return[t,n,r]}createPropertyPath(e,t,n=""){let s=[];for(let i of Object.keys(t)){let r=n?`${n}.${i}`:i;if(t[i]===null||typeof t[i]!="object"||$.isFindOperator(t[i])){s.push(r);continue}if(e.hasEmbeddedWithPropertyPath(r)){let o=this.createPropertyPath(e,t[i],r);s.push(...o);continue}if(e.hasRelationWithPropertyPath(r)){let o=e.findRelationWithPropertyPath(r);if(o.relationType==="one-to-one"||o.relationType==="many-to-one"){let h=o.joinColumns.map(f=>f.referencedColumn).filter(f=>!!f);if(h.length>0&&h.every(f=>f.getEntityValue(t[i],!1))){s.push(r);continue}}if(o.relationType==="one-to-many"||o.relationType==="many-to-many")throw new Error(`Cannot query across ${o.relationType} for property ${r}`);let c=o.inverseEntityMetadata.primaryColumns;if(c.length>0&&c.every(h=>h.getEntityValue(t[i],!1))){let h=c.map(d=>`${r}.${d.propertyPath}`);s.push(...h);continue}let u=this.createPropertyPath(o.inverseEntityMetadata,t[i]).map(h=>`${r}.${h}`);s.push(...u);continue}s.push(r)}return s}*getPredicates(e){if(this.expressionMap.mainAlias.hasMetadata){let t=this.createPropertyPath(this.expressionMap.mainAlias.metadata,e);for(let n of t){let[s,i,r]=this.findColumnsForPropertyPath(n);for(let o of r){let c=e;for(let h of i){if(!c||!(h in c)){c={};break}c=c[h]}let l=this.expressionMap.aliasNamePrefixingEnabled?`${s.name}.${o.propertyPath}`:o.propertyPath,u=o.getEntityValue(c,!0);yield[l,u]}}}else for(let t of Object.keys(e)){let n=e[t];yield[this.expressionMap.aliasNamePrefixingEnabled?`${this.alias}.${t}`:t,n]}}getWherePredicateCondition(e,t){if($.isFindOperator(t)){let n=[];if(t.useParameter)if(t.objectLiteralParameters)this.setParameters(t.objectLiteralParameters);else if(t.multipleParameters)for(let s of t.value)n.push(this.createParameter(s));else n.push(this.createParameter(t.value));return t.type==="raw"?t.getSql?t.getSql(e):{operator:"equal",parameters:[e,t.value]}:t.type==="not"?t.child?{operator:t.type,condition:this.getWherePredicateCondition(e,t.child)}:{operator:"notEqual",parameters:[e,...n]}:{operator:t.type,parameters:[e,...n]}}else return{operator:"equal",parameters:[e,this.createParameter(t)]}}getWhereCondition(e){if(typeof e=="string")return e;if($.isBrackets(e)){let s=this.createQueryBuilder();return s.parentQueryBuilder=this,s.expressionMap.mainAlias=this.expressionMap.mainAlias,s.expressionMap.aliasNamePrefixingEnabled=this.expressionMap.aliasNamePrefixingEnabled,s.expressionMap.parameters=this.expressionMap.parameters,s.expressionMap.nativeParameters=this.expressionMap.nativeParameters,s.expressionMap.wheres=[],e.whereFactory(s),{operator:$.isNotBrackets(e)?"not":"brackets",condition:s.expressionMap.wheres}}if(typeof e=="function")return e(this);let t=Array.isArray(e)?e:[e],n=[];for(let s of t){let i=[];for(let[r,o]of this.getPredicates(s))i.push({type:"and",condition:this.getWherePredicateCondition(r,o)});n.push({type:"or",condition:i})}return n.length===1?n[0].condition:n}obtainQueryRunner(){return this.queryRunner||this.connection.createQueryRunner()}hasCommonTableExpressions(){return this.expressionMap.commonTableExpressions.length>0}},oo,cs=oo=class extends kt{constructor(){super(...arguments),this["@instanceof"]=Symbol.for("SelectQueryBuilder"),this.findOptions={},this.selects=[],this.joins=[],this.conditions="",this.orderBys=[],this.relationMetadatas=[]}getQuery(){let e=this.createComment();return e+=this.createCteExpression(),e+=this.createSelectExpression(),e+=this.createJoinExpression(),e+=this.createWhereExpression(),e+=this.createGroupByExpression(),e+=this.createHavingExpression(),e+=this.createOrderByExpression(),e+=this.createLimitOffsetExpression(),e+=this.createLockExpression(),e=e.trim(),this.expressionMap.subQuery&&(e="("+e+")"),e}setFindOptions(e){return this.findOptions=e,this.applyFindOptions(),this}subQuery(){let e=this.createQueryBuilder();return e.expressionMap.subQuery=!0,e.parentQueryBuilder=this,e}select(e,t){if(this.expressionMap.queryType="select",Array.isArray(e))this.expressionMap.selects=e.map(n=>({selection:n}));else if(typeof e=="function"){let n=e(this.subQuery());this.setParameters(n.getParameters()),this.expressionMap.selects.push({selection:n.getQuery(),aliasName:t})}else e&&(this.expressionMap.selects=[{selection:e,aliasName:t}]);return this}addSelect(e,t){if(!e)return this;if(Array.isArray(e))this.expressionMap.selects=this.expressionMap.selects.concat(e.map(n=>({selection:n})));else if(typeof e=="function"){let n=e(this.subQuery());this.setParameters(n.getParameters()),this.expressionMap.selects.push({selection:n.getQuery(),aliasName:t})}else e&&this.expressionMap.selects.push({selection:e,aliasName:t});return this}maxExecutionTime(e){return this.expressionMap.maxExecutionTime=e,this}distinct(e=!0){return this.expressionMap.selectDistinct=e,this}distinctOn(e){return this.expressionMap.selectDistinctOn=e,this}from(e,t){let n=this.createFromAlias(e,t);return this.expressionMap.setMainAlias(n),this}addFrom(e,t){let n=this.createFromAlias(e,t);return this.expressionMap.mainAlias||this.expressionMap.setMainAlias(n),this}innerJoin(e,t,n,s){return this.join("INNER",e,t,n,s),this}leftJoin(e,t,n,s){return this.join("LEFT",e,t,n,s),this}innerJoinAndSelect(e,t,n,s){return this.addSelect(t),this.innerJoin(e,t,n,s),this}leftJoinAndSelect(e,t,n,s){return this.addSelect(t),this.leftJoin(e,t,n,s),this}innerJoinAndMapMany(e,t,n,s,i){return this.addSelect(n),this.join("INNER",t,n,s,i,e,!0),this}innerJoinAndMapOne(e,t,n,s,i){return this.addSelect(n),this.join("INNER",t,n,s,i,e,!1),this}leftJoinAndMapMany(e,t,n,s,i){return this.addSelect(n),this.join("LEFT",t,n,s,i,e,!0),this}leftJoinAndMapOne(e,t,n,s,i){return this.addSelect(n),this.join("LEFT",t,n,s,i,e,!1),this}loadRelationIdAndMap(e,t,n,s){let i=new fs(this.expressionMap);return i.mapToProperty=e,i.relationName=t,typeof n=="string"&&(i.alias=n),typeof n=="object"&&n.disableMixedMap&&(i.disableMixedMap=!0),i.queryBuilderFactory=s,this.expressionMap.relationIdAttributes.push(i),i.relation.junctionEntityMetadata&&this.expressionMap.createAlias({type:"other",name:i.junctionAlias,metadata:i.relation.junctionEntityMetadata}),this}loadRelationCountAndMap(e,t,n,s){let i=new ps(this.expressionMap);return i.mapToProperty=e,i.relationName=t,i.alias=n,i.queryBuilderFactory=s,this.expressionMap.relationCountAttributes.push(i),this.expressionMap.createAlias({type:"other",name:i.junctionAlias}),i.relation.junctionEntityMetadata&&this.expressionMap.createAlias({type:"other",name:i.junctionAlias,metadata:i.relation.junctionEntityMetadata}),this}loadAllRelationIds(e){return this.expressionMap.mainAlias.metadata.relations.forEach(t=>{e!==void 0&&e.relations!==void 0&&e.relations.indexOf(t.propertyPath)===-1||this.loadRelationIdAndMap(this.expressionMap.mainAlias.name+"."+t.propertyPath,this.expressionMap.mainAlias.name+"."+t.propertyPath,e)}),this}where(e,t){this.expressionMap.wheres=[];let n=this.getWhereCondition(e);return n&&(this.expressionMap.wheres=[{type:"simple",condition:n}]),t&&this.setParameters(t),this}andWhere(e,t){return this.expressionMap.wheres.push({type:"and",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}orWhere(e,t){return this.expressionMap.wheres.push({type:"or",condition:this.getWhereCondition(e)}),t&&this.setParameters(t),this}whereInIds(e){return this.where(this.getWhereInIdsCondition(e))}andWhereInIds(e){return this.andWhere(this.getWhereInIdsCondition(e))}orWhereInIds(e){return this.orWhere(this.getWhereInIdsCondition(e))}having(e,t){return this.expressionMap.havings.push({type:"simple",condition:e}),t&&this.setParameters(t),this}andHaving(e,t){return this.expressionMap.havings.push({type:"and",condition:e}),t&&this.setParameters(t),this}orHaving(e,t){return this.expressionMap.havings.push({type:"or",condition:e}),t&&this.setParameters(t),this}groupBy(e){return e?this.expressionMap.groupBys=[e]:this.expressionMap.groupBys=[],this}addGroupBy(e){return this.expressionMap.groupBys.push(e),this}orderBy(e,t="ASC",n){if(t!==void 0&&t!=="ASC"&&t!=="DESC")throw new v('SelectQueryBuilder.addOrderBy "order" can accept only "ASC" and "DESC" values.');if(n!==void 0&&n!=="NULLS FIRST"&&n!=="NULLS LAST")throw new v('SelectQueryBuilder.addOrderBy "nulls" can accept only "NULLS FIRST" and "NULLS LAST" values.');return e?typeof e=="object"?this.expressionMap.orderBys=e:n?this.expressionMap.orderBys={[e]:{order:t,nulls:n}}:this.expressionMap.orderBys={[e]:t}:this.expressionMap.orderBys={},this}addOrderBy(e,t="ASC",n){if(t!==void 0&&t!=="ASC"&&t!=="DESC")throw new v('SelectQueryBuilder.addOrderBy "order" can accept only "ASC" and "DESC" values.');if(n!==void 0&&n!=="NULLS FIRST"&&n!=="NULLS LAST")throw new v('SelectQueryBuilder.addOrderBy "nulls" can accept only "NULLS FIRST" and "NULLS LAST" values.');return n?this.expressionMap.orderBys[e]={order:t,nulls:n}:this.expressionMap.orderBys[e]=t,this}limit(e){if(this.expressionMap.limit=this.normalizeNumber(e),this.expressionMap.limit!==void 0&&isNaN(this.expressionMap.limit))throw new v('Provided "limit" value is not a number. Please provide a numeric value.');return this}offset(e){if(this.expressionMap.offset=this.normalizeNumber(e),this.expressionMap.offset!==void 0&&isNaN(this.expressionMap.offset))throw new v('Provided "offset" value is not a number. Please provide a numeric value.');return this}take(e){if(this.expressionMap.take=this.normalizeNumber(e),this.expressionMap.take!==void 0&&isNaN(this.expressionMap.take))throw new v('Provided "take" value is not a number. Please provide a numeric value.');return this}skip(e){if(this.expressionMap.skip=this.normalizeNumber(e),this.expressionMap.skip!==void 0&&isNaN(this.expressionMap.skip))throw new v('Provided "skip" value is not a number. Please provide a numeric value.');return this}useIndex(e){return this.expressionMap.useIndex=e,this}setLock(e,t,n){return this.expressionMap.lockMode=e,this.expressionMap.lockVersion=t,this.expressionMap.lockTables=n,this}setOnLocked(e){return this.expressionMap.onLocked=e,this}withDeleted(){return this.expressionMap.withDeleted=!0,this}async getRawOne(){return(await this.getRawMany())[0]}async getRawMany(){if(this.expressionMap.lockMode==="optimistic")throw new bn;this.expressionMap.queryEntity=!1;let e=this.obtainQueryRunner(),t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0);let n=await this.loadRawResults(e);return t&&await e.commitTransaction(),n}catch(n){if(t)try{await e.rollbackTransaction()}catch{}throw n}finally{e!==this.queryRunner&&await e.release()}}async getRawAndEntities(){let e=this.obtainQueryRunner(),t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.queryEntity=!0;let n=await this.executeEntitiesAndRawResults(e);return t&&await e.commitTransaction(),n}catch(n){if(t)try{await e.rollbackTransaction()}catch{}throw n}finally{e!==this.queryRunner&&await e.release()}}async getOne(){let t=(await this.getRawAndEntities()).entities[0];if(t&&this.expressionMap.lockMode==="optimistic"&&this.expressionMap.lockVersion){let n=this.expressionMap.mainAlias.metadata;if(this.expressionMap.lockVersion instanceof Date){let s=n.updateDateColumn.getEntityValue(t);if(s.getTime()!==this.expressionMap.lockVersion.getTime())throw new di(n.name,this.expressionMap.lockVersion,s)}else{let s=n.versionColumn.getEntityValue(t);if(s!==this.expressionMap.lockVersion)throw new di(n.name,this.expressionMap.lockVersion,s)}}return t===void 0?null:t}async getOneOrFail(){let e=await this.getOne();if(!e)throw new us(this.expressionMap.mainAlias.target,this);return e}async getMany(){if(this.expressionMap.lockMode==="optimistic")throw new bn;return(await this.getRawAndEntities()).entities}async getCount(){if(this.expressionMap.lockMode==="optimistic")throw new bn;let e=this.obtainQueryRunner(),t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.queryEntity=!1;let n=await this.executeCountQuery(e);return t&&await e.commitTransaction(),n}catch(n){if(t)try{await e.rollbackTransaction()}catch{}throw n}finally{e!==this.queryRunner&&await e.release()}}async getManyAndCount(){if(this.expressionMap.lockMode==="optimistic")throw new bn;let e=this.obtainQueryRunner(),t=!1;try{this.expressionMap.useTransaction===!0&&e.isTransactionActive===!1&&(await e.startTransaction(),t=!0),this.expressionMap.queryEntity=!0;let n=await this.executeEntitiesAndRawResults(e);this.expressionMap.queryEntity=!1;let s=this.expressionMap.cacheId;this.expressionMap.cacheId=s&&`${s}-count`;let i=await this.executeCountQuery(e),r=[n.entities,i];return t&&await e.commitTransaction(),r}catch(n){if(t)try{await e.rollbackTransaction()}catch{}throw n}finally{e!==this.queryRunner&&await e.release()}}cache(e,t){return typeof e=="boolean"?this.expressionMap.cache=e:typeof e=="number"?(this.expressionMap.cache=!0,this.expressionMap.cacheDuration=e):(typeof e=="string"||typeof e=="number")&&(this.expressionMap.cache=!0,this.expressionMap.cacheId=e),t&&(this.expressionMap.cacheDuration=t),this}setOption(e){return this.expressionMap.options.push(e),this}join(e,t,n,s,i,r,o){this.setParameters(i||{});let c=new Oi(this.connection,this.expressionMap);if(c.direction=e,c.mapToProperty=r,c.isMappingMany=o,c.entityOrProperty=t,c.condition=s||void 0,this.expressionMap.joinAttributes.push(c),c.metadata){if(c.metadata.deleteDateColumn&&!this.expressionMap.withDeleted){let l=`${n}.${c.metadata.deleteDateColumn.propertyName} IS NULL`;c.condition=c.condition?` ${c.condition} AND ${l}`:`${l}`}c.alias=this.expressionMap.createAlias({type:"join",name:n,metadata:c.metadata}),c.relation&&c.relation.junctionEntityMetadata&&this.expressionMap.createAlias({type:"join",name:c.junctionAlias,metadata:c.relation.junctionEntityMetadata})}else{let l="";if(typeof t=="function"){let h=t(this.subQuery());this.setParameters(h.getParameters()),l=h.getQuery()}else l=t;let u=typeof t=="function"||t.substr(0,1)==="("&&t.substr(-1)===")";c.alias=this.expressionMap.createAlias({type:"join",name:n,tablePath:u===!1?t:void 0,subQuery:u===!0?l:void 0})}}createSelectExpression(){if(!this.expressionMap.mainAlias)throw new v("Cannot build query because main alias is not set (call qb#from method)");let e=[],t=[];if(this.expressionMap.mainAlias.hasMetadata){let o=this.expressionMap.mainAlias.metadata;e.push(...this.buildEscapedEntityColumnSelects(this.expressionMap.mainAlias.name,o)),t.push(...this.findEntityColumnSelects(this.expressionMap.mainAlias.name,o))}this.expressionMap.joinAttributes.forEach(o=>{if(o.metadata)e.push(...this.buildEscapedEntityColumnSelects(o.alias.name,o.metadata)),t.push(...this.findEntityColumnSelects(o.alias.name,o.metadata));else if(this.expressionMap.selects.some(l=>l.selection===o.alias.name)){e.push({selection:this.escape(o.alias.name)+".*"});let l=this.expressionMap.selects.find(u=>u.selection===o.alias.name);t.push(l)}}),this.expressionMap.selects.filter(o=>t.indexOf(o)===-1).forEach(o=>e.push({selection:this.replacePropertyNames(o.selection),aliasName:o.aliasName})),e.length===0&&e.push({selection:"*"});let n="";this.expressionMap.useIndex&&L.isMySQLFamily(this.connection.driver)&&(n=` USE INDEX (${this.expressionMap.useIndex})`);let s=this.expressionMap.aliases.filter(o=>o.type==="from"&&(o.tablePath||o.subQuery)).map(o=>o.subQuery?o.subQuery+" "+this.escape(o.name):this.getTableName(o.tablePath)+" "+this.escape(o.name)),i=this.createSelectDistinctExpression(),r=e.map(o=>o.selection+(o.aliasName?" AS "+this.escape(o.aliasName):"")).join(", ");return i+r+" FROM "+s.join(", ")+this.createTableLockExpression()+n}createSelectDistinctExpression(){let{selectDistinct:e,selectDistinctOn:t,maxExecutionTime:n}=this.expressionMap,{driver:s}=this.connection,i="SELECT ";return n>0&&L.isMySQLFamily(s)&&(i+=`/*+ MAX_EXECUTION_TIME(${this.expressionMap.maxExecutionTime}) */ `),L.isPostgresFamily(s)&&t.length>0?i=`SELECT DISTINCT ON (${t.map(o=>this.replacePropertyNames(o)).join(", ")}) `:e&&(i="SELECT DISTINCT "),i}createJoinExpression(){return this.expressionMap.joinAttributes.map(t=>{let n=t.relation,s=t.tablePath,i=t.alias.name,r=t.condition?" AND ("+t.condition+")":"",o=t.parentAlias;if(!o||!n){let c=t.alias.subQuery?t.alias.subQuery:this.getTableName(s);return" "+t.direction+" JOIN "+c+" "+this.escape(i)+this.createTableLockExpression()+(t.condition?" ON "+this.replacePropertyNames(t.condition):"")}if(n.isManyToOne||n.isOneToOneOwner){let c=n.joinColumns.map(l=>i+"."+l.referencedColumn.propertyPath+"="+o+"."+n.propertyPath+"."+l.referencedColumn.propertyPath).join(" AND ");return" "+t.direction+" JOIN "+this.getTableName(s)+" "+this.escape(i)+this.createTableLockExpression()+" ON "+this.replacePropertyNames(c+r)}else if(n.isOneToMany||n.isOneToOneNotOwner){let c=n.inverseRelation.joinColumns.map(l=>(n.inverseEntityMetadata.tableType==="entity-child"&&n.inverseEntityMetadata.discriminatorColumn&&(r+=" AND "+i+"."+n.inverseEntityMetadata.discriminatorColumn.databaseName+"='"+n.inverseEntityMetadata.discriminatorValue+"'"),i+"."+n.inverseRelation.propertyPath+"."+l.referencedColumn.propertyPath+"="+o+"."+l.referencedColumn.propertyPath)).join(" AND ");return" "+t.direction+" JOIN "+this.getTableName(s)+" "+this.escape(i)+this.createTableLockExpression()+" ON "+this.replacePropertyNames(c+r)}else{let c=n.junctionEntityMetadata.tablePath,l=t.junctionAlias,u="",h="";return n.isOwning?(u=n.joinColumns.map(d=>l+"."+d.propertyPath+"="+o+"."+d.referencedColumn.propertyPath).join(" AND "),h=n.inverseJoinColumns.map(d=>i+"."+d.referencedColumn.propertyPath+"="+l+"."+d.propertyPath).join(" AND ")):(u=n.inverseRelation.inverseJoinColumns.map(d=>l+"."+d.propertyPath+"="+o+"."+d.referencedColumn.propertyPath).join(" AND "),h=n.inverseRelation.joinColumns.map(d=>i+"."+d.referencedColumn.propertyPath+"="+l+"."+d.propertyPath).join(" AND "))," "+t.direction+" JOIN "+this.getTableName(c)+" "+this.escape(l)+this.createTableLockExpression()+" ON "+this.replacePropertyNames(u)+" "+t.direction+" JOIN "+this.getTableName(s)+" "+this.escape(i)+this.createTableLockExpression()+" ON "+this.replacePropertyNames(h+r)}}).join(" ")}createGroupByExpression(){return!this.expressionMap.groupBys||!this.expressionMap.groupBys.length?"":" GROUP BY "+this.replacePropertyNames(this.expressionMap.groupBys.join(", "))}createOrderByExpression(){let e=this.expressionMap.allOrderBys;return Object.keys(e).length>0?" ORDER BY "+Object.keys(e).map(t=>typeof e[t]=="string"?this.replacePropertyNames(t)+" "+e[t]:this.replacePropertyNames(t)+" "+e[t].order+" "+e[t].nulls).join(", "):""}createLimitOffsetExpression(){let e=this.expressionMap.offset,t=this.expressionMap.limit;if(!e&&!t&&this.expressionMap.joinAttributes.length===0&&(e=this.expressionMap.skip,t=this.expressionMap.take),this.connection.driver.options.type==="mssql"){let n="";if((t||e)&&Object.keys(this.expressionMap.allOrderBys).length<=0&&(n=" ORDER BY (SELECT NULL)"),t&&e)return n+" OFFSET "+e+" ROWS FETCH NEXT "+t+" ROWS ONLY";if(t)return n+" OFFSET 0 ROWS FETCH NEXT "+t+" ROWS ONLY";if(e)return n+" OFFSET "+e+" ROWS"}else if(L.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner"){if(t&&e)return" LIMIT "+t+" OFFSET "+e;if(t)return" LIMIT "+t;if(e)throw new ya}else if(L.isSQLiteFamily(this.connection.driver)){if(t&&e)return" LIMIT "+t+" OFFSET "+e;if(t)return" LIMIT "+t;if(e)return" LIMIT -1 OFFSET "+e}else if(this.connection.driver.options.type==="oracle"){if(t&&e)return" OFFSET "+e+" ROWS FETCH NEXT "+t+" ROWS ONLY";if(t)return" FETCH NEXT "+t+" ROWS ONLY";if(e)return" OFFSET "+e+" ROWS"}else{if(t&&e)return" LIMIT "+t+" OFFSET "+e;if(t)return" LIMIT "+t;if(e)return" OFFSET "+e}return""}createTableLockExpression(){if(this.connection.driver.options.type==="mssql")switch(this.expressionMap.lockMode){case"pessimistic_read":return" WITH (HOLDLOCK, ROWLOCK)";case"pessimistic_write":return" WITH (UPDLOCK, ROWLOCK)";case"dirty_read":return" WITH (NOLOCK)"}return""}createLockExpression(){let e=this.connection.driver,t="";if(this.expressionMap.lockTables){if(!(L.isPostgresFamily(e)||e.options.type==="cockroachdb"))throw new v("Lock tables not supported in selected driver");if(this.expressionMap.lockTables.length<1)throw new v("lockTables cannot be an empty array");t=" OF "+this.expressionMap.lockTables.join(", ")}let n="";switch(this.expressionMap.onLocked==="nowait"?n=" NOWAIT":this.expressionMap.onLocked==="skip_locked"&&(n=" SKIP LOCKED"),this.expressionMap.lockMode){case"pessimistic_read":if(e.options.type==="mysql"||e.options.type==="aurora-mysql")return L.isReleaseVersionOrGreater(e,"8.0.0")?" FOR SHARE"+t+n:" LOCK IN SHARE MODE";if(e.options.type==="mariadb")return" LOCK IN SHARE MODE";if(L.isPostgresFamily(e))return" FOR SHARE"+t+n;if(e.options.type==="oracle")return" FOR UPDATE";if(e.options.type==="mssql")return"";throw new qt;case"pessimistic_write":if(L.isMySQLFamily(e)||e.options.type==="aurora-mysql"||e.options.type==="oracle")return" FOR UPDATE"+n;if(L.isPostgresFamily(e)||e.options.type==="cockroachdb")return" FOR UPDATE"+t+n;if(e.options.type==="mssql")return"";throw new qt;case"pessimistic_partial_write":if(L.isPostgresFamily(e))return" FOR UPDATE"+t+" SKIP LOCKED";if(L.isMySQLFamily(e))return" FOR UPDATE SKIP LOCKED";throw new qt;case"pessimistic_write_or_fail":if(L.isPostgresFamily(e)||e.options.type==="cockroachdb")return" FOR UPDATE"+t+" NOWAIT";if(L.isMySQLFamily(e))return" FOR UPDATE NOWAIT";throw new qt;case"for_no_key_update":if(L.isPostgresFamily(e)||e.options.type==="cockroachdb")return" FOR NO KEY UPDATE"+t+n;throw new qt;case"for_key_share":if(L.isPostgresFamily(e))return" FOR KEY SHARE"+t+n;throw new qt;default:return""}}createHavingExpression(){if(!this.expressionMap.havings||!this.expressionMap.havings.length)return"";let e=this.expressionMap.havings.map((t,n)=>{switch(t.type){case"and":return(n>0?"AND ":"")+this.replacePropertyNames(t.condition);case"or":return(n>0?"OR ":"")+this.replacePropertyNames(t.condition);default:return this.replacePropertyNames(t.condition)}}).join(" ");return e.length?" HAVING "+e:""}buildEscapedEntityColumnSelects(e,t){let n=this.expressionMap.selects.some(l=>l.selection===e),s=[];if(n&&s.push(...t.columns.filter(l=>l.isSelect===!0)),s.push(...t.columns.filter(l=>this.expressionMap.selects.some(u=>u.selection===e+"."+l.propertyPath))),s.length===0)return[];let i=this.expressionMap.queryEntity?t.primaryColumns.filter(l=>s.indexOf(l)===-1):[],r=[...s,...i],o=[],c=this.escape(e);return r.forEach(l=>{let u=c+"."+this.escape(l.databaseName);l.isVirtualProperty&&l.query&&(u=`(${l.query(c)})`),this.connection.driver.spatialTypes.indexOf(l.type);let h=this.expressionMap.selects.filter(d=>d.selection===e+"."+l.propertyPath);h.length?h.forEach(d=>{o.push({selection:u,aliasName:d.aliasName?d.aliasName:L.buildAlias(this.connection.driver,e,l.databaseName),virtual:d.virtual})}):o.push({selection:u,aliasName:L.buildAlias(this.connection.driver,e,l.databaseName),virtual:n})}),o}findEntityColumnSelects(e,t){let n=this.expressionMap.selects.find(s=>s.selection===e);return n?[n]:this.expressionMap.selects.filter(s=>t.columns.some(i=>s.selection===e+"."+i.propertyPath))}computeCountExpression(){let e=this.expressionMap.mainAlias.name,n=this.expressionMap.mainAlias.metadata.primaryColumns,s=this.escape(e);if(this.expressionMap.joinAttributes.length===0&&this.expressionMap.relationIdAttributes.length===0&&this.expressionMap.relationCountAttributes.length===0)return"COUNT(1)";if(this.connection.driver.options.type==="cockroachdb"||L.isPostgresFamily(this.connection.driver))return"COUNT(DISTINCT("+n.map(i=>`${s}.${this.escape(i.databaseName)}`).join(", ")+"))";if(L.isMySQLFamily(this.connection.driver))return"COUNT(DISTINCT "+n.map(i=>`${s}.${this.escape(i.databaseName)}`).join(", ")+")";if(this.connection.driver.options.type==="mssql"){let i=n.map(r=>`${s}.${this.escape(r.databaseName)}`).join(", '|;|', ");return n.length===1?`COUNT(DISTINCT(${i}))`:`COUNT(DISTINCT(CONCAT(${i})))`}return this.connection.driver.options.type==="spanner"?n.length===1?`COUNT(DISTINCT(${s}.${this.escape(n[0].databaseName)}))`:`COUNT(DISTINCT(CONCAT(${n.map(r=>`CAST(${s}.${this.escape(r.databaseName)} AS STRING)`).join(", '|;|', ")})))`:"COUNT(DISTINCT("+n.map(i=>`${s}.${this.escape(i.databaseName)}`).join(" || '|;|' || ")+"))"}async executeCountQuery(e){let t=this.computeCountExpression(),n=await this.clone().orderBy().groupBy().offset(void 0).limit(void 0).skip(void 0).take(void 0).select(t,"cnt").setOption("disable-global-order").loadRawResults(e);return!n||!n[0]||!n[0].cnt?0:parseInt(n[0].cnt)}applyFindOptions(){if(this.expressionMap.mainAlias.metadata){if(this.findOptions.relationLoadStrategy&&(this.expressionMap.relationLoadStrategy=this.findOptions.relationLoadStrategy),this.findOptions.comment&&this.comment(this.findOptions.comment),this.findOptions.withDeleted&&this.withDeleted(),this.findOptions.select){let e=Array.isArray(this.findOptions.select)?ce.propertyPathsToTruthyObject(this.findOptions.select):this.findOptions.select;this.buildSelect(e,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name)}if(this.selects.length&&this.select(this.selects),this.selects=[],this.findOptions.relations){let e=Array.isArray(this.findOptions.relations)?ce.propertyPathsToTruthyObject(this.findOptions.relations):this.findOptions.relations;this.buildRelations(e,typeof this.findOptions.select=="object"?this.findOptions.select:void 0,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name),this.findOptions.loadEagerRelations!==!1&&this.expressionMap.relationLoadStrategy==="join"&&this.buildEagerRelations(e,typeof this.findOptions.select=="object"?this.findOptions.select:void 0,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name)}if(this.selects.length&&this.addSelect(this.selects),this.findOptions.where&&(this.conditions=this.buildWhere(this.findOptions.where,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name),this.conditions.length&&this.andWhere(this.conditions.substr(0,1)!=="("?"("+this.conditions+")":this.conditions)),this.findOptions.order&&this.buildOrder(this.findOptions.order,this.expressionMap.mainAlias.metadata,this.expressionMap.mainAlias.name),this.joins.length&&this.joins.forEach(e=>{e.select&&!e.selection?e.type==="inner"?this.innerJoinAndSelect(`${e.parentAlias}.${e.relationMetadata.propertyPath}`,e.alias):this.leftJoinAndSelect(`${e.parentAlias}.${e.relationMetadata.propertyPath}`,e.alias):e.type==="inner"?this.innerJoin(`${e.parentAlias}.${e.relationMetadata.propertyPath}`,e.alias):this.leftJoin(`${e.parentAlias}.${e.relationMetadata.propertyPath}`,e.alias)}),this.findOptions.skip!==void 0&&this.skip(this.findOptions.skip),this.findOptions.take!==void 0&&this.take(this.findOptions.take),typeof this.findOptions.cache=="number"?this.cache(this.findOptions.cache):typeof this.findOptions.cache=="boolean"?this.cache(this.findOptions.cache):typeof this.findOptions.cache=="object"&&this.cache(this.findOptions.cache.id,this.findOptions.cache.milliseconds),this.findOptions.join&&(this.findOptions.join.leftJoin&&Object.keys(this.findOptions.join.leftJoin).forEach(e=>{this.leftJoin(this.findOptions.join.leftJoin[e],e)}),this.findOptions.join.innerJoin&&Object.keys(this.findOptions.join.innerJoin).forEach(e=>{this.innerJoin(this.findOptions.join.innerJoin[e],e)}),this.findOptions.join.leftJoinAndSelect&&Object.keys(this.findOptions.join.leftJoinAndSelect).forEach(e=>{this.leftJoinAndSelect(this.findOptions.join.leftJoinAndSelect[e],e)}),this.findOptions.join.innerJoinAndSelect&&Object.keys(this.findOptions.join.innerJoinAndSelect).forEach(e=>{this.innerJoinAndSelect(this.findOptions.join.innerJoinAndSelect[e],e)})),this.findOptions.lock){if(this.findOptions.lock.mode==="optimistic")this.setLock(this.findOptions.lock.mode,this.findOptions.lock.version);else if(this.findOptions.lock.mode==="pessimistic_read"||this.findOptions.lock.mode==="pessimistic_write"||this.findOptions.lock.mode==="dirty_read"||this.findOptions.lock.mode==="pessimistic_partial_write"||this.findOptions.lock.mode==="pessimistic_write_or_fail"||this.findOptions.lock.mode==="for_no_key_update"||this.findOptions.lock.mode==="for_key_share"){let e=this.findOptions.lock.tables?this.findOptions.lock.tables.map(t=>{let n=this.expressionMap.aliases.find(s=>s.metadata.tableNameWithoutPrefix===t);if(!n)throw new v(`"${t}" is not part of this query`);return this.escape(n.name)}):void 0;this.setLock(this.findOptions.lock.mode,void 0,e),this.findOptions.lock.onLocked&&this.setOnLocked(this.findOptions.lock.onLocked)}}this.findOptions.loadRelationIds===!0?this.loadAllRelationIds():typeof this.findOptions.loadRelationIds=="object"&&this.loadAllRelationIds(this.findOptions.loadRelationIds),this.findOptions.loadEagerRelations!==!1&&Le.joinEagerRelations(this,this.expressionMap.mainAlias.name,this.expressionMap.mainAlias.metadata),this.findOptions.transaction===!0&&(this.expressionMap.useTransaction=!0)}}async executeEntitiesAndRawResults(e){if(!this.expressionMap.mainAlias)throw new v('Alias is not set. Use "from" method to set an alias.');if((this.expressionMap.lockMode==="pessimistic_read"||this.expressionMap.lockMode==="pessimistic_write"||this.expressionMap.lockMode==="pessimistic_partial_write"||this.expressionMap.lockMode==="pessimistic_write_or_fail"||this.expressionMap.lockMode==="for_no_key_update"||this.expressionMap.lockMode==="for_key_share")&&!e.isTransactionActive)throw new ua;if(this.expressionMap.lockMode==="optimistic"){let c=this.expressionMap.mainAlias.metadata;if(!c.versionColumn&&!c.updateDateColumn)throw new oa(c.name)}let t=new ah(this.connection,e,this.expressionMap.relationIdAttributes),n=new io(this.connection,e,this.expressionMap.relationCountAttributes);new so(this.expressionMap).transform(),new ro(this.expressionMap).transform();let r=[],o=[];if((this.expressionMap.skip||this.expressionMap.take)&&this.expressionMap.joinAttributes.length>0){let[c,l]=this.createOrderByCombinedWithSelectExpression("distinctAlias"),u=this.expressionMap.mainAlias.metadata,h=this.expressionMap.mainAlias.name,d=u.primaryColumns.map(f=>{let p=this.escape("distinctAlias"),m=this.escape(L.buildAlias(this.connection.driver,h,f.databaseName));l[m]||(l[m]="ASC");let x=L.buildAlias(this.connection.driver,"ids_"+h,f.databaseName);return`${p}.${m} AS ${this.escape(x)}`});if(r=await new oo(this.connection,e).select(`DISTINCT ${d.join(", ")}`).addSelect(c).from(`(${this.clone().orderBy().getQuery()})`,"distinctAlias").offset(this.expressionMap.skip).limit(this.expressionMap.take).orderBy(l).cache(this.expressionMap.cache?this.expressionMap.cache:this.expressionMap.cacheId,this.expressionMap.cacheDuration).setParameters(this.getParameters()).setNativeParameters(this.expressionMap.nativeParameters).getRawMany(),r.length>0){let f="",p={};if(u.hasMultiplePrimaryKeys)f=r.map((m,x)=>u.primaryColumns.map(S=>{let G=`orm_distinct_ids_${x}_${S.databaseName}`;return p[G]=m[`ids_${h}_${S.databaseName}`],`${h}.${S.propertyPath}=:${G}`}).join(" AND ")).join(" OR ");else{let m=L.buildAlias(this.connection.driver,"ids_"+h,u.primaryColumns[0].databaseName),x=r.map(G=>G[m]);x.every(G=>typeof G=="number")?f=`${h}.${u.primaryColumns[0].propertyPath} IN (${x.join(", ")})`:(p.orm_distinct_ids=x,f=h+"."+u.primaryColumns[0].propertyPath+" IN (:...orm_distinct_ids)")}r=await this.clone().mergeExpressionMap({extraAppendedAndWhereCondition:f}).setParameters(p).loadRawResults(e)}}else r=await this.loadRawResults(e);if(r.length>0){let c=await t.load(r),l=await n.load(r);o=new no(this.expressionMap,this.connection.driver,c,l,this.queryRunner).transform(r,this.expressionMap.mainAlias),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await e.broadcaster.broadcast("Load",this.expressionMap.mainAlias.metadata,o)}return this.expressionMap.relationLoadStrategy==="query"&&await Promise.all(this.relationMetadatas.map(async c=>{let l=c.inverseEntityMetadata.target,u=c.inverseEntityMetadata.targetName,h=Array.isArray(this.findOptions.select)?ce.propertyPathsToTruthyObject(this.findOptions.select):this.findOptions.select,d=Array.isArray(this.findOptions.relations)?ce.propertyPathsToTruthyObject(this.findOptions.relations):this.findOptions.relations,f=this.createQueryBuilder().select(u).from(l,u).setFindOptions({select:h?ce.deepValue(h,c.propertyPath):void 0,order:this.findOptions.order?ce.deepValue(this.findOptions.order,c.propertyPath):void 0,relations:d?ce.deepValue(d,c.propertyPath):void 0,withDeleted:this.findOptions.withDeleted,relationLoadStrategy:this.findOptions.relationLoadStrategy});if(o.length>0){let p=await this.connection.relationIdLoader.loadManyToManyRelationIdsAndGroup(c,o,void 0,f);o.forEach(m=>{let x=p.find(S=>S.entity===m);if(x){let S=x.related===void 0?null:x.related;c.setEntityValue(m,S)}})}})),{raw:r,entities:o}}createOrderByCombinedWithSelectExpression(e){let t=this.expressionMap.allOrderBys,n=Object.keys(t).map(i=>{if(i.indexOf(".")!==-1){let r=i.split("."),o=r[0],c=r.slice(1).join("."),u=this.expressionMap.findAliasByName(o).metadata.findColumnWithPropertyPath(c);return this.escape(e)+"."+this.escape(L.buildAlias(this.connection.driver,o,u.databaseName))}else return this.expressionMap.selects.find(r=>r.selection===i||r.aliasName===i)?this.escape(e)+"."+i:""}).join(", "),s={};return Object.keys(t).forEach(i=>{if(i.indexOf(".")!==-1){let r=i.split("."),o=r[0],c=r.slice(1).join("."),u=this.expressionMap.findAliasByName(o).metadata.findColumnWithPropertyPath(c);s[this.escape(e)+"."+this.escape(L.buildAlias(this.connection.driver,o,u.databaseName))]=t[i]}else this.expressionMap.selects.find(r=>r.selection===i||r.aliasName===i)?s[this.escape(e)+"."+i]=t[i]:s[i]=t[i]}),[n,s]}async loadRawResults(e){let[t,n]=this.getQueryAndParameters(),s=t+" -- PARAMETERS: "+JSON.stringify(n),i=typeof this.connection.options.cache=="object"?this.connection.options.cache:{},r,o=!1;if(this.connection.queryResultCache&&(this.expressionMap.cache||i.alwaysEnabled))try{if(r=await this.connection.queryResultCache.getFromCache({identifier:this.expressionMap.cacheId,query:s,duration:this.expressionMap.cacheDuration||i.duration||1e3},e),r&&!this.connection.queryResultCache.isExpired(r))return JSON.parse(r.result)}catch(l){if(!i.ignoreErrors)throw l;o=!0}let c=await e.query(t,n,!0);if(!o&&this.connection.queryResultCache&&(this.expressionMap.cache||i.alwaysEnabled))try{await this.connection.queryResultCache.storeInCache({identifier:this.expressionMap.cacheId,query:s,time:new Date().getTime(),duration:this.expressionMap.cacheDuration||i.duration||1e3,result:JSON.stringify(c.records)},r,e)}catch(l){if(!i.ignoreErrors)throw l}return c.records}mergeExpressionMap(e){return ne.assign(this.expressionMap,e),this}normalizeNumber(e){return typeof e=="number"||e===void 0||e===null?e:Number(e)}obtainQueryRunner(){return this.queryRunner||this.connection.createQueryRunner("slave")}buildSelect(e,t,n,s){for(let i in e){if(e[i]===void 0||e[i]===!1)continue;let r=s?s+"."+i:i,o=t.findColumnWithPropertyPathStrict(r),c=t.findEmbeddedWithPropertyPath(r),l=t.findRelationWithPropertyPath(r);if(!c&&!o&&!l)throw new pt(r,t);o?this.selects.push(n+"."+r):c&&this.buildSelect(e[i],t,n,r)}}buildRelations(e,t,n,s,i){e&&Object.keys(e).forEach(r=>{let o=e[r],c=i?i+"."+r:r,l=n.findEmbeddedWithPropertyPath(c),u=n.findRelationWithPropertyPath(c);if(!l&&!u)throw new pt(c,n);if(l)this.buildRelations(o,typeof t=="object"?ce.deepValue(t,l.propertyPath):void 0,n,s,c);else if(u){let h=s+"_"+c.replace(".","_");h=L.buildAlias(this.connection.driver,{joiner:"__"},s,h),(o===!0||typeof o=="object")&&(this.expressionMap.relationLoadStrategy==="query"?this.relationMetadatas.push(u):(this.joins.push({type:"left",select:!0,selection:t&&typeof t[r]=="object"?t[r]:void 0,alias:h,parentAlias:s,relationMetadata:u}),t&&typeof t[r]=="object"&&this.buildSelect(t[r],u.inverseEntityMetadata,h))),typeof o=="object"&&this.expressionMap.relationLoadStrategy==="join"&&this.buildRelations(o,typeof t=="object"?ce.deepValue(t,u.propertyPath):void 0,u.inverseEntityMetadata,h,void 0)}})}buildEagerRelations(e,t,n,s,i){e&&Object.keys(e).forEach(r=>{let o=e[r],c=i?i+"."+r:r,l=n.findEmbeddedWithPropertyPath(c),u=n.findRelationWithPropertyPath(c);if(!l&&!u)throw new pt(c,n);if(l)this.buildEagerRelations(o,typeof t=="object"?ce.deepValue(t,l.propertyPath):void 0,n,s,c);else if(u){let h=s+"_"+c.replace(".","_");h=L.buildAlias(this.connection.driver,{joiner:"__"},s,h),(o===!0||typeof o=="object")&&u.inverseEntityMetadata.eagerRelations.forEach(d=>{let f=h+"_"+d.propertyPath.replace(".","_");f=L.buildAlias(this.connection.driver,{joiner:"__"},h,f),this.joins.find(m=>m.alias===f)||this.joins.push({type:"left",select:!0,alias:f,parentAlias:h,selection:void 0,relationMetadata:d}),t&&typeof t[r]=="object"&&this.buildSelect(t[r],u.inverseEntityMetadata,h)}),typeof o=="object"&&this.buildEagerRelations(o,typeof t=="object"?ce.deepValue(t,u.propertyPath):void 0,u.inverseEntityMetadata,h,void 0)}})}buildOrder(e,t,n,s){for(let i in e){if(e[i]===void 0)continue;let r=s?s+"."+i:i,o=t.findColumnWithPropertyPathStrict(r),c=t.findEmbeddedWithPropertyPath(r),l=t.findRelationWithPropertyPath(r);if(!c&&!o&&!l)throw new pt(r,t);if(o){let u=typeof e[i]=="object"?e[i].direction:e[i];u=u==="DESC"||u==="desc"||u===-1?"DESC":"ASC";let h=typeof e[i]=="object"?e[i].nulls:void 0;h=h?.toLowerCase()==="first"?"NULLS FIRST":h?.toLowerCase()==="last"?"NULLS LAST":void 0;let d=`${n}.${r}`;if(o.isVirtualProperty&&o.query){let f=this.expressionMap.selects.find(p=>p.selection===d);f?(d=L.buildAlias(this.connection.driver,n,o.databaseName),f.aliasName=d):d=`(${o.query(n)})`}this.addOrderBy(d,u,h)}else if(c)this.buildOrder(e[i],t,n,r);else if(l){let u=n+"_"+r.replace(".","_");u=L.buildAlias(this.connection.driver,{joiner:"__"},n,u),this.joins.find(d=>d.alias===u)||this.joins.push({type:"left",select:!1,alias:u,parentAlias:n,selection:void 0,relationMetadata:l}),this.buildOrder(e[i],l.inverseEntityMetadata,u)}}}buildWhere(e,t,n,s){let i="";if(Array.isArray(e))i="("+e.map(r=>this.buildWhere(r,t,n,s)).filter(r=>!!r).map(r=>"("+r+")").join(" OR ")+")";else{let r=[];for(let o in e){if(e[o]===void 0||e[o]===null)continue;let c=s?s+"."+o:o,l=t.findColumnWithPropertyPathStrict(c),u=t.findEmbeddedWithPropertyPath(c),h=t.findRelationWithPropertyPath(c);if(!u&&!l&&!h)throw new pt(c,t);if(l){let d=`${n}.${c}`;l.isVirtualProperty&&l.query&&(d=`(${l.query(n)})`);let f=e[o];$.isEqualOperator(e[o])&&(f=e[o].value),l.transformer&&(f=Bt.transformTo(l.transformer,f)),r.push(this.createWhereConditionExpression(this.getWherePredicateCondition(d,f)))}else if(u){let d=this.buildWhere(e[o],t,n,c);d&&r.push(d)}else if(h){if(typeof e[o]=="object"&&Object.keys(e[o]).every(f=>e[o][f]===void 0))continue;if($.isFindOperator(e[o]))if(e[o].type==="moreThan"||e[o].type==="lessThan"){let d=e[o].type==="moreThan"?">":"<",f=this.subQuery();if(h.isManyToManyOwner)f.select("COUNT(*)").from(h.joinTableName,h.joinTableName).where(h.joinColumns.map(p=>`${h.joinTableName}.${p.propertyName} = ${n}.${p.referencedColumn.propertyName}`).join(" AND "));else if(h.isManyToManyNotOwner)f.select("COUNT(*)").from(h.inverseRelation.joinTableName,h.inverseRelation.joinTableName).where(h.inverseRelation.inverseJoinColumns.map(p=>`${h.inverseRelation.joinTableName}.${p.propertyName} = ${n}.${p.referencedColumn.propertyName}`).join(" AND "));else if(h.isOneToMany)f.select("COUNT(*)").from(h.inverseEntityMetadata.target,h.inverseEntityMetadata.tableName).where(h.inverseRelation.joinColumns.map(p=>`${h.inverseEntityMetadata.tableName}.${p.propertyName} = ${n}.${p.referencedColumn.propertyName}`).join(" AND "));else throw new Error("This relation isn't supported by given find operator");this.andWhere(f.getSql()+" "+d+" "+parseInt(e[o].value))}else if(h.isManyToOne||h.isOneToOne&&h.isOneToOneOwner){let d=`${n}.${c}`;r.push(this.createWhereConditionExpression(this.getWherePredicateCondition(d,e[o])))}else throw new Error("This relation isn't supported by given find operator");else{let d=n+"_"+h.propertyPath.replace(".","_");d=L.buildAlias(this.connection.driver,{joiner:"__"},n,d);let f=this.joins.find(m=>m.alias===d);f?f.type==="left"&&(f.type="inner"):this.joins.push({type:"inner",select:!1,selection:void 0,alias:d,parentAlias:n,relationMetadata:h});let p=this.buildWhere(e[o],h.inverseEntityMetadata,d);p&&r.push(p)}}}i=r.join(" AND ")}return i}};cs=oo=Qe([xe.NAME("SelectQueryBuilder")],cs);var Di=class{constructor(){this.generatedMaps=[]}static from(e){let t=new this;return t.raw=e.records,t.affected=e.affected,t}},ms=class{constructor(e,t){this.queryRunner=e,this.expressionMap=t}async update(e,t){let n=this.expressionMap.mainAlias.metadata;await Promise.all(t.map(async(s,i)=>{if(this.queryRunner.connection.driver.isReturningSqlSupported("update")){this.queryRunner.connection.driver.options.type==="oracle"&&Array.isArray(e.raw)&&this.expressionMap.extraReturningColumns.length>0&&(e.raw=e.raw.reduce((c,l,u)=>(c[this.expressionMap.extraReturningColumns[u].databaseName]=l[0],c),{}));let r=Array.isArray(e.raw)?e.raw[i]:e.raw,o=this.queryRunner.connection.driver.createGeneratedMap(n,r);o&&(this.queryRunner.manager.merge(n.target,s,o),e.generatedMaps.push(o))}else{let r=this.expressionMap.extraReturningColumns;if(r.length>0){let o=this.expressionMap.mainAlias.metadata.getEntityIdMap(s);if(!o)throw new v("Cannot update entity because entity id is not set in the entity.");let c=await this.queryRunner.manager.createQueryBuilder().select(n.primaryColumns.map(l=>n.targetName+"."+l.propertyPath)).addSelect(r.map(l=>n.targetName+"."+l.propertyPath)).from(n.target,n.targetName).where(o).withDeleted().setOption("create-pojo").getOne();c&&(this.queryRunner.manager.merge(n.target,s,c),e.generatedMaps.push(c))}}}))}async insert(e,t){let n=this.expressionMap.mainAlias.metadata,s=n.getInsertionReturningColumns(),i=this.queryRunner.connection.driver.isReturningSqlSupported("insert");s=s.filter(o=>o.isGenerated?i===!0:!0);let r=t.map((o,c)=>{this.queryRunner.connection.driver.options.type==="oracle"&&Array.isArray(e.raw)&&this.expressionMap.extraReturningColumns.length>0&&(e.raw=e.raw.reduce((h,d,f)=>(h[this.expressionMap.extraReturningColumns[f].databaseName]=d[0],h),{}));let l=Array.isArray(e.raw)?e.raw[c]:e.raw,u=this.queryRunner.connection.driver.createGeneratedMap(n,l,c,t.length)||{};return c in this.expressionMap.locallyGenerated&&this.queryRunner.manager.merge(n.target,u,this.expressionMap.locallyGenerated[c]),this.queryRunner.manager.merge(n.target,o,u),u});if(s.length>0&&!this.queryRunner.connection.driver.isReturningSqlSupported("insert")){let o=t.map(l=>{let u=n.getEntityIdMap(l);if(!u)throw new v("Cannot update entity because entity id is not set in the entity.");return u}),c=await this.queryRunner.manager.createQueryBuilder().select(n.primaryColumns.map(l=>n.targetName+"."+l.propertyPath)).addSelect(s.map(l=>n.targetName+"."+l.propertyPath)).from(n.target,n.targetName).where(o).setOption("create-pojo").getMany();t.forEach((l,u)=>{this.queryRunner.manager.merge(n.target,r[u],c[u]),this.queryRunner.manager.merge(n.target,l,c[u])})}t.forEach((o,c)=>{let l=n.getEntityIdMap(o);e.identifiers.push(l),e.generatedMaps.push(r[c])})}getUpdationReturningColumns(){return this.expressionMap.mainAlias.metadata.columns.filter(e=>e.isUpdateDate||e.isVersion)}getSoftDeletionReturningColumns(){return this.expressionMap.mainAlias.metadata.columns.filter(e=>e.isUpdateDate||e.isVersion||e.isDeleteDate)}},uh=(()=>{let a=class extends kt{constructor(t,n){super(t,n),this["@instanceof"]=Symbol.for("UpdateQueryBuilder"),this.expressionMap.aliasNamePrefixingEnabled=!1}getQuery(){let t=this.createComment();return t+=this.createCteExpression(),t+=this.createUpdateExpression(),t+=this.createOrderByExpression(),t+=this.createLimitExpression(),t.trim()}async execute(){let t=this.obtainQueryRunner(),n=!1;try{this.expressionMap.useTransaction===!0&&t.isTransactionActive===!1&&(await t.startTransaction(),n=!0),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await t.broadcaster.broadcast("BeforeUpdate",this.expressionMap.mainAlias.metadata,this.expressionMap.valuesSet);let s=null,i=null,r=new ms(t,this.expressionMap),o=[];if(Array.isArray(this.expressionMap.returning)&&this.expressionMap.mainAlias.hasMetadata)for(let f of this.expressionMap.returning)o.push(...this.expressionMap.mainAlias.metadata.findColumnsWithPropertyPath(f));this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.whereEntities.length>0&&(this.expressionMap.extraReturningColumns=r.getUpdationReturningColumns(),o.push(...this.expressionMap.extraReturningColumns.filter(f=>!o.includes(f))));let[c,l]=this.getQueryAndParameters(),u=[s,c,i],h=await t.query(u.filter(f=>f!=null).join(`;

`),l,!0),d=Di.from(h);return this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.whereEntities.length>0&&await r.update(d,this.expressionMap.whereEntities),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await t.broadcaster.broadcast("AfterUpdate",this.expressionMap.mainAlias.metadata,this.expressionMap.valuesSet),n&&await t.commitTransaction(),d}catch(s){if(n)try{await t.rollbackTransaction()}catch{}throw s}finally{t!==this.queryRunner&&await t.release()}}set(t){return this.expressionMap.valuesSet=t,this}where(t,n){this.expressionMap.wheres=[];let s=this.getWhereCondition(t);return s&&(this.expressionMap.wheres=[{type:"simple",condition:s}]),n&&this.setParameters(n),this}andWhere(t,n){return this.expressionMap.wheres.push({type:"and",condition:this.getWhereCondition(t)}),n&&this.setParameters(n),this}orWhere(t,n){return this.expressionMap.wheres.push({type:"or",condition:this.getWhereCondition(t)}),n&&this.setParameters(n),this}whereInIds(t){return this.where(this.getWhereInIdsCondition(t))}andWhereInIds(t){return this.andWhere(this.getWhereInIdsCondition(t))}orWhereInIds(t){return this.orWhere(this.getWhereInIdsCondition(t))}output(t){return this.returning(t)}returning(t){if(!this.connection.driver.isReturningSqlSupported("update"))throw new Rn;return this.expressionMap.returning=t,this}orderBy(t,n="ASC",s){return t?typeof t=="object"?this.expressionMap.orderBys=t:s?this.expressionMap.orderBys={[t]:{order:n,nulls:s}}:this.expressionMap.orderBys={[t]:n}:this.expressionMap.orderBys={},this}addOrderBy(t,n="ASC",s){return s?this.expressionMap.orderBys[t]={order:n,nulls:s}:this.expressionMap.orderBys[t]=n,this}limit(t){return this.expressionMap.limit=t,this}whereEntity(t){if(!this.expressionMap.mainAlias.hasMetadata)throw new v(".whereEntity method can only be used on queries which update real entity table.");this.expressionMap.wheres=[];let n=Array.isArray(t)?t:[t];return n.forEach(s=>{let i=this.expressionMap.mainAlias.metadata.getEntityIdMap(s);if(!i)throw new v("Provided entity does not have ids set, cannot perform operation.");this.orWhereInIds(i)}),this.expressionMap.whereEntities=n,this}updateEntity(t){return this.expressionMap.updateEntity=t,this}createUpdateExpression(){let t=this.getValueSet(),n=this.expressionMap.mainAlias.hasMetadata?this.expressionMap.mainAlias.metadata:void 0,s={};for(let l in t)t.hasOwnProperty(l)&&t[l]!==void 0&&(s[l]=t[l]);let i=[],r=[];if(n?(this.createPropertyPath(n,s).forEach(l=>{let u=n.findColumnsWithPropertyPath(l);if(u.length<=0)throw new pt(l,n);u.forEach(h=>{if(!h.isUpdate||r.includes(h))return;r.push(h);let d=h.getEntityValue(s);if(h.referencedColumn&&typeof d=="object"&&!(d instanceof Date)&&d!==null?d=h.referencedColumn.getEntityValue(d):typeof d!="function"&&(d=this.connection.driver.preparePersistentValue(d,h)),typeof d=="function")i.push(this.escape(h.databaseName)+" = "+d());else if((this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner")&&d===null)i.push(this.escape(h.databaseName)+" = NULL");else{let f=this.createParameter(d),p=null;this.connection.driver.options.type==="mssql"&&this.connection.driver.spatialTypes.indexOf(h.type)!==-1?p=h.type+"::STGeomFromText("+f+", "+(h.srid||"0")+")":p=f,i.push(this.escape(h.databaseName)+" = "+p)}})}),(i.length>0||Object.keys(s).length===0)&&(n.versionColumn&&r.indexOf(n.versionColumn)===-1&&i.push(this.escape(n.versionColumn.databaseName)+" = "+this.escape(n.versionColumn.databaseName)+" + 1"),n.updateDateColumn&&r.indexOf(n.updateDateColumn)===-1&&i.push(this.escape(n.updateDateColumn.databaseName)+" = CURRENT_TIMESTAMP"))):Object.keys(s).map(l=>{let u=s[l];if(typeof u=="function")i.push(this.escape(l)+" = "+u());else if((this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner")&&u===null)i.push(this.escape(l)+" = NULL");else{let h=this.createParameter(u);i.push(this.escape(l)+" = "+h)}}),i.length<=0)throw new ls;let o=this.createWhereExpression(),c=this.createReturningExpression("update");return c===""?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${i.join(", ")}${o}`:this.connection.driver.options.type==="mssql"?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${i.join(", ")} OUTPUT ${c}${o}`:`UPDATE ${this.getTableName(this.getMainTableName())} SET ${i.join(", ")}${o} RETURNING ${c}`}createOrderByExpression(){let t=this.expressionMap.orderBys;return Object.keys(t).length>0?" ORDER BY "+Object.keys(t).map(n=>typeof t[n]=="string"?this.replacePropertyNames(n)+" "+t[n]:this.replacePropertyNames(n)+" "+t[n].order+" "+t[n].nulls).join(", "):""}createLimitExpression(){let t=this.expressionMap.limit;if(t){if(L.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")return" LIMIT "+t;throw new fi}return""}getValueSet(){if(typeof this.expressionMap.valuesSet=="object")return this.expressionMap.valuesSet;throw new ls}};return a=Qe([xe.NAME("UpdateQueryBuilder"),cn("design:paramtypes",[Object,Object])],a),a})(),co=class{static from(e){let t=new this;return t.raw=e.records,t.affected=e.affected,t}},hh=(()=>{let a=class extends kt{constructor(t,n){super(t,n),this["@instanceof"]=Symbol.for("DeleteQueryBuilder"),this.expressionMap.aliasNamePrefixingEnabled=!1}getQuery(){let t=this.createComment();return t+=this.createCteExpression(),t+=this.createDeleteExpression(),t.trim()}async execute(){let[t,n]=this.getQueryAndParameters(),s=this.obtainQueryRunner(),i=!1;try{this.expressionMap.useTransaction===!0&&s.isTransactionActive===!1&&(await s.startTransaction(),i=!0),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await s.broadcaster.broadcast("BeforeRemove",this.expressionMap.mainAlias.metadata);let r=await s.query(t,n,!0),o=co.from(r);return this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&await s.broadcaster.broadcast("AfterRemove",this.expressionMap.mainAlias.metadata),i&&await s.commitTransaction(),o}catch(r){if(i)try{await s.rollbackTransaction()}catch{}throw r}finally{s!==this.queryRunner&&await s.release()}}from(t,n){t=$.isEntitySchema(t)?t.options.name:t;let s=this.createFromAlias(t,n);return this.expressionMap.setMainAlias(s),this}where(t,n){this.expressionMap.wheres=[];let s=this.getWhereCondition(t);return s&&(this.expressionMap.wheres=[{type:"simple",condition:s}]),n&&this.setParameters(n),this}andWhere(t,n){return this.expressionMap.wheres.push({type:"and",condition:this.getWhereCondition(t)}),n&&this.setParameters(n),this}orWhere(t,n){return this.expressionMap.wheres.push({type:"or",condition:this.getWhereCondition(t)}),n&&this.setParameters(n),this}whereInIds(t){return this.where(this.getWhereInIdsCondition(t))}andWhereInIds(t){return this.andWhere(this.getWhereInIdsCondition(t))}orWhereInIds(t){return this.orWhere(this.getWhereInIdsCondition(t))}output(t){return this.returning(t)}returning(t){if(!this.connection.driver.isReturningSqlSupported("delete"))throw new Rn;return this.expressionMap.returning=t,this}createDeleteExpression(){let t=this.getTableName(this.getMainTableName()),n=this.createWhereExpression(),s=this.createReturningExpression("delete");return s===""?`DELETE FROM ${t}${n}`:this.connection.driver.options.type==="mssql"?`DELETE FROM ${t} OUTPUT ${s}${n}`:`DELETE FROM ${t}${n} RETURNING ${s}`}};return a=Qe([xe.NAME("DeleteQueryBuilder"),cn("design:paramtypes",[Object,Object])],a),a})(),dh=(()=>{let a=class extends kt{constructor(t,n){super(t,n),this["@instanceof"]=Symbol.for("SoftDeleteQueryBuilder"),this.expressionMap.aliasNamePrefixingEnabled=!1}getQuery(){let t=this.createUpdateExpression();return t+=this.createCteExpression(),t+=this.createOrderByExpression(),t+=this.createLimitExpression(),t.trim()}async execute(){let t=this.obtainQueryRunner(),n=!1;try{this.expressionMap.useTransaction===!0&&t.isTransactionActive===!1&&(await t.startTransaction(),n=!0),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&(this.expressionMap.queryType==="soft-delete"?await t.broadcaster.broadcast("BeforeSoftRemove",this.expressionMap.mainAlias.metadata):this.expressionMap.queryType==="restore"&&await t.broadcaster.broadcast("BeforeRecover",this.expressionMap.mainAlias.metadata));let s=new ms(t,this.expressionMap);this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.whereEntities.length>0&&(this.expressionMap.extraReturningColumns=s.getSoftDeletionReturningColumns());let[i,r]=this.getQueryAndParameters(),o=await t.query(i,r,!0),c=Di.from(o);return this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.whereEntities.length>0&&await s.update(c,this.expressionMap.whereEntities),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata&&(this.expressionMap.queryType==="soft-delete"?await t.broadcaster.broadcast("AfterSoftRemove",this.expressionMap.mainAlias.metadata):this.expressionMap.queryType==="restore"&&await t.broadcaster.broadcast("AfterRecover",this.expressionMap.mainAlias.metadata)),n&&await t.commitTransaction(),c}catch(s){if(n)try{await t.rollbackTransaction()}catch{}throw s}finally{t!==this.queryRunner&&await t.release()}}from(t,n){t=$.isEntitySchema(t)?t.options.name:t;let s=this.createFromAlias(t,n);return this.expressionMap.setMainAlias(s),this}where(t,n){this.expressionMap.wheres=[];let s=this.getWhereCondition(t);return s&&(this.expressionMap.wheres=[{type:"simple",condition:s}]),n&&this.setParameters(n),this}andWhere(t,n){return this.expressionMap.wheres.push({type:"and",condition:this.getWhereCondition(t)}),n&&this.setParameters(n),this}orWhere(t,n){return this.expressionMap.wheres.push({type:"or",condition:this.getWhereCondition(t)}),n&&this.setParameters(n),this}whereInIds(t){return this.where(this.getWhereInIdsCondition(t))}andWhereInIds(t){return this.andWhere(this.getWhereInIdsCondition(t))}orWhereInIds(t){return this.orWhere(this.getWhereInIdsCondition(t))}output(t){return this.returning(t)}returning(t){if(!this.connection.driver.isReturningSqlSupported("update"))throw new Rn;return this.expressionMap.returning=t,this}orderBy(t,n="ASC",s){return t?typeof t=="object"?this.expressionMap.orderBys=t:s?this.expressionMap.orderBys={[t]:{order:n,nulls:s}}:this.expressionMap.orderBys={[t]:n}:this.expressionMap.orderBys={},this}addOrderBy(t,n="ASC",s){return s?this.expressionMap.orderBys[t]={order:n,nulls:s}:this.expressionMap.orderBys[t]=n,this}limit(t){return this.expressionMap.limit=t,this}whereEntity(t){if(!this.expressionMap.mainAlias.hasMetadata)throw new v(".whereEntity method can only be used on queries which update real entity table.");this.expressionMap.wheres=[];let n=Array.isArray(t)?t:[t];return n.forEach(s=>{let i=this.expressionMap.mainAlias.metadata.getEntityIdMap(s);if(!i)throw new v("Provided entity does not have ids set, cannot perform operation.");this.orWhereInIds(i)}),this.expressionMap.whereEntities=n,this}updateEntity(t){return this.expressionMap.updateEntity=t,this}createUpdateExpression(){let t=this.expressionMap.mainAlias.hasMetadata?this.expressionMap.mainAlias.metadata:void 0;if(!t)throw new v(`Cannot get entity metadata for the given alias "${this.expressionMap.mainAlias}"`);if(!t.deleteDateColumn)throw new sa(t);let n=[];switch(this.expressionMap.queryType){case"soft-delete":n.push(this.escape(t.deleteDateColumn.databaseName)+" = CURRENT_TIMESTAMP");break;case"restore":n.push(this.escape(t.deleteDateColumn.databaseName)+" = NULL");break;default:throw new v('The queryType must be "soft-delete" or "restore"')}if(t.versionColumn&&n.push(this.escape(t.versionColumn.databaseName)+" = "+this.escape(t.versionColumn.databaseName)+" + 1"),t.updateDateColumn&&n.push(this.escape(t.updateDateColumn.databaseName)+" = CURRENT_TIMESTAMP"),n.length<=0)throw new ls;let s=this.createWhereExpression(),i=this.createReturningExpression("update");return i===""?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${n.join(", ")}${s}`:this.connection.driver.options.type==="mssql"?`UPDATE ${this.getTableName(this.getMainTableName())} SET ${n.join(", ")} OUTPUT ${i}${s}`:`UPDATE ${this.getTableName(this.getMainTableName())} SET ${n.join(", ")}${s} RETURNING ${i}`}createOrderByExpression(){let t=this.expressionMap.orderBys;return Object.keys(t).length>0?" ORDER BY "+Object.keys(t).map(n=>typeof t[n]=="string"?this.replacePropertyNames(n)+" "+t[n]:this.replacePropertyNames(n)+" "+t[n].order+" "+t[n].nulls).join(", "):""}createLimitExpression(){let t=this.expressionMap.limit;if(t){if(L.isMySQLFamily(this.connection.driver))return" LIMIT "+t;throw new fi}return""}};return a=Qe([xe.NAME("SoftDeleteQueryBuilder"),cn("design:paramtypes",[Object,Object])],a),a})(),$i=class{constructor(){this.identifiers=[],this.generatedMaps=[]}static from(e){let t=new this;return t.raw=e.raw,t}},fh=(()=>{let a=class extends kt{constructor(){super(...arguments),this["@instanceof"]=Symbol.for("InsertQueryBuilder")}getQuery(){let t=this.createComment();return t+=this.createCteExpression(),t+=this.createInsertExpression(),t.trim()}async execute(){let t=this.getValueSets();if(t.length===0)return new $i;let n=this.obtainQueryRunner(),s=!1;try{if(this.expressionMap.useTransaction===!0&&n.isTransactionActive===!1&&(await n.startTransaction(),s=!0),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata){let m=new Yt;t.forEach(x=>{n.broadcaster.broadcastBeforeInsertEvent(m,this.expressionMap.mainAlias.metadata,x)}),await m.wait()}let i=null,r=null,o=new ms(n,this.expressionMap),c=[];if(Array.isArray(this.expressionMap.returning)&&this.expressionMap.mainAlias.hasMetadata)for(let m of this.expressionMap.returning)c.push(...this.expressionMap.mainAlias.metadata.findColumnsWithPropertyPath(m));this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&(t.length>1&&this.connection.driver.options.type==="oracle"||(this.expressionMap.extraReturningColumns=this.expressionMap.mainAlias.metadata.getInsertionReturningColumns()),c.push(...this.expressionMap.extraReturningColumns.filter(m=>!c.includes(m)))),c.length>0&&this.connection.driver.options.type==="mssql"&&(i={}.buildTableVariableDeclaration("@OutputTable",c),r="SELECT * FROM @OutputTable");let[l,u]=this.getQueryAndParameters(),d=[i,l,r].filter(m=>m!=null).join(`;

`),f=await n.query(d,u,!0),p=$i.from(f);if(this.expressionMap.updateEntity===!0&&this.expressionMap.mainAlias.hasMetadata&&await o.insert(p,t),this.expressionMap.callListeners===!0&&this.expressionMap.mainAlias.hasMetadata){let m=new Yt;t.forEach(x=>{n.broadcaster.broadcastAfterInsertEvent(m,this.expressionMap.mainAlias.metadata,x)}),await m.wait()}return s&&await n.commitTransaction(),p}catch(i){if(s)try{await n.rollbackTransaction()}catch{}throw i}finally{n!==this.queryRunner&&await n.release()}}into(t,n){t=$.isEntitySchema(t)?t.options.name:t;let s=this.createFromAlias(t);return this.expressionMap.setMainAlias(s),this.expressionMap.insertColumns=n||[],this}values(t){return this.expressionMap.valuesSet=t,this}output(t){return this.returning(t)}returning(t){if(!this.connection.driver.isReturningSqlSupported("insert"))throw new Rn;return this.expressionMap.returning=t,this}updateEntity(t){return this.expressionMap.updateEntity=t,this}onConflict(t){return this.expressionMap.onConflict=t,this}orIgnore(t=!0){return this.expressionMap.onIgnore=!!t,this}orUpdate(t,n,s){return Array.isArray(t)?(this.expressionMap.onUpdate={overwrite:t,conflict:n,skipUpdateIfNoValuesChanged:s?.skipUpdateIfNoValuesChanged},this):(this.expressionMap.onUpdate={conflict:t?.conflict_target,columns:t?.columns,overwrite:t?.overwrite,skipUpdateIfNoValuesChanged:s?.skipUpdateIfNoValuesChanged},this)}createInsertExpression(){let t=this.getTableName(this.getMainTableName()),n=this.createValuesExpression(),s=this.connection.driver.options.type==="oracle"&&this.getValueSets().length>1?null:this.createReturningExpression("insert"),i=this.createColumnNamesExpression(),r="INSERT ";if((L.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&(r+=`${this.expressionMap.onIgnore?" IGNORE ":""}`),r+=`INTO ${t}`,this.alias!==this.getMainTableName()&&L.isPostgresFamily(this.connection.driver)&&(r+=` AS "${this.alias}"`),i?r+=`(${i})`:!n&&(L.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql")&&(r+="()"),s&&this.connection.driver.options.type==="mssql"&&(r+=` OUTPUT ${s}`),n?this.connection.driver.options.type==="oracle"&&this.getValueSets().length>1?r+=` ${n}`:r+=` VALUES ${n}`:L.isMySQLFamily(this.connection.driver)||this.connection.driver.options.type==="aurora-mysql"?r+=" VALUES ()":r+=" DEFAULT VALUES",this.connection.driver.supportedUpsertType==="on-conflict-do-update"){if(this.expressionMap.onIgnore)r+=" ON CONFLICT DO NOTHING ";else if(this.expressionMap.onConflict)r+=` ON CONFLICT ${this.expressionMap.onConflict} `;else if(this.expressionMap.onUpdate){let{overwrite:o,columns:c,conflict:l,skipUpdateIfNoValuesChanged:u}=this.expressionMap.onUpdate,h="ON CONFLICT";Array.isArray(l)?h+=` ( ${l.map(d=>this.escape(d)).join(", ")} )`:l&&(h+=` ON CONSTRAINT ${this.escape(l)}`),Array.isArray(o)?(r+=` ${h} DO UPDATE SET `,r+=o?.map(d=>`${this.escape(d)} = EXCLUDED.${this.escape(d)}`).join(", "),r+=" "):c&&(r+=` ${h} DO UPDATE SET `,r+=c.map(d=>`${this.escape(d)} = :${d}`).join(", "),r+=" "),Array.isArray(o)&&u&&L.isPostgresFamily(this.connection.driver)&&(r+=" WHERE (",r+=o.map(d=>`${t}.${this.escape(d)} IS DISTINCT FROM EXCLUDED.${this.escape(d)}`).join(" OR "),r+=") ")}}else if(this.connection.driver.supportedUpsertType==="on-duplicate-key-update"){if(this.expressionMap.onUpdate){let{overwrite:o,columns:c}=this.expressionMap.onUpdate;Array.isArray(o)?(r+=" ON DUPLICATE KEY UPDATE ",r+=o.map(l=>`${this.escape(l)} = VALUES(${this.escape(l)})`).join(", "),r+=" "):Array.isArray(c)&&(r+=" ON DUPLICATE KEY UPDATE ",r+=c.map(l=>`${this.escape(l)} = :${l}`).join(", "),r+=" ")}}else if(this.expressionMap.onUpdate)throw new v("onUpdate is not supported by the current database driver");return s&&(L.isPostgresFamily(this.connection.driver)||this.connection.driver.options.type==="oracle"||this.connection.driver.options.type==="cockroachdb"||L.isMySQLFamily(this.connection.driver))&&(r+=` RETURNING ${s}`),this.connection.driver.options.type==="mssql"&&this.expressionMap.mainAlias.hasMetadata&&this.expressionMap.mainAlias.metadata.columns.filter(o=>this.expressionMap.insertColumns.length>0?this.expressionMap.insertColumns.indexOf(o.propertyPath)!==-1:o.isInsert).some(o=>this.isOverridingAutoIncrementBehavior(o))&&(r=`SET IDENTITY_INSERT ${t} ON; ${r}; SET IDENTITY_INSERT ${t} OFF`),r}getInsertedColumns(){return this.expressionMap.mainAlias.hasMetadata?this.expressionMap.mainAlias.metadata.columns.filter(t=>this.expressionMap.insertColumns.length?this.expressionMap.insertColumns.indexOf(t.propertyPath)!==-1:!(!t.isInsert||t.isGenerated&&t.generationStrategy==="increment"&&this.connection.driver.options.type!=="spanner"&&this.connection.driver.options.type!=="oracle"&&!L.isSQLiteFamily(this.connection.driver)&&!L.isMySQLFamily(this.connection.driver)&&this.connection.driver.options.type!=="aurora-mysql"&&!(this.connection.driver.options.type==="mssql"&&this.isOverridingAutoIncrementBehavior(t)))):[]}createColumnNamesExpression(){let t=this.getInsertedColumns();if(t.length>0)return t.map(n=>this.escape(n.databaseName)).join(", ");if(!this.expressionMap.mainAlias.hasMetadata&&!this.expressionMap.insertColumns.length){let n=this.getValueSets();if(n.length===1)return Object.keys(n[0]).map(s=>this.escape(s)).join(", ")}return this.expressionMap.insertColumns.map(n=>this.escape(n)).join(", ")}createValuesExpression(){let t=this.getValueSets(),n=this.getInsertedColumns();if(n.length>0){let s="";return t.forEach((i,r)=>{n.forEach((o,c)=>{c===0&&(this.connection.driver.options.type==="oracle"&&t.length>1||this.connection.driver.options.type==="sap"&&t.length>1?s+=" SELECT ":s+="(");let l=o.getEntityValue(i);if(typeof l!="function"&&(l=this.connection.driver.preparePersistentValue(l,o)),o.isVersion&&l===void 0)s+="1";else if(o.isDiscriminator)s+=this.createParameter(this.expressionMap.mainAlias.metadata.discriminatorValue);else if(o.isGenerated&&o.generationStrategy==="uuid"&&!this.connection.driver.isUUIDGenerationSupported()&&l===void 0)l=ii(),s+=this.createParameter(l),r in this.expressionMap.locallyGenerated||(this.expressionMap.locallyGenerated[r]={}),o.setEntityValue(this.expressionMap.locallyGenerated[r],l);else if(l===void 0)this.connection.driver.options.type==="oracle"&&t.length>1||L.isSQLiteFamily(this.connection.driver)||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner"?o.default!==void 0&&o.default!==null?s+=this.connection.driver.normalizeDefault(o):s+="NULL":s+="DEFAULT";else if(l===null&&this.connection.driver.options.type==="spanner")s+="NULL";else if(typeof l=="function")s+=l();else{let u=this.createParameter(l);L.isPostgresFamily(this.connection.driver)&&this.connection.driver.spatialTypes.indexOf(o.type)!==-1?o.srid!=null?s+=`ST_SetSRID(ST_GeomFromGeoJSON(${u}), ${o.srid})::${o.type}`:s+=`ST_GeomFromGeoJSON(${u})::${o.type}`:this.connection.driver.options.type==="mssql"&&this.connection.driver.spatialTypes.indexOf(o.type)!==-1?s+=o.type+"::STGeomFromText("+u+", "+(o.srid||"0")+")":s+=u}c===n.length-1?r===t.length-1?this.connection.driver.options.type==="oracle"&&t.length>1?s+=" FROM DUAL ":this.connection.driver.options.type==="sap"&&t.length>1?s+=" FROM dummy ":s+=")":this.connection.driver.options.type==="oracle"&&t.length>1?s+=" FROM DUAL UNION ALL ":this.connection.driver.options.type==="sap"&&t.length>1?s+=" FROM dummy UNION ALL ":s+="), ":s+=", "})}),s==="()"?"":s}else{let s="";return t.forEach((i,r)=>{Object.keys(i).forEach((c,l)=>{l===0&&(s+="(");let u=i[c];typeof u=="function"?s+=u():u===void 0?this.connection.driver.options.type==="oracle"&&t.length>1||L.isSQLiteFamily(this.connection.driver)||this.connection.driver.options.type==="sap"||this.connection.driver.options.type==="spanner"?s+="NULL":s+="DEFAULT":u===null&&this.connection.driver.options.type==="spanner"||(s+=this.createParameter(u)),l===Object.keys(i).length-1?r===t.length-1?s+=")":s+="), ":s+=", "})}),s==="()"?"":s}}getValueSets(){if(Array.isArray(this.expressionMap.valuesSet))return this.expressionMap.valuesSet;if(ne.isObject(this.expressionMap.valuesSet))return[this.expressionMap.valuesSet];throw new ca}isOverridingAutoIncrementBehavior(t){return t.isPrimary&&t.isGenerated&&t.generationStrategy==="increment"&&this.getValueSets().some(n=>t.getEntityValue(n)!==void 0&&t.getEntityValue(n)!==null)}};return a=Qe([xe.NAME("InsertQueryBuilder")],a),a})(),qi=class{constructor(e,t){this.queryBuilder=e,this.expressionMap=t}async update(e){let t=this.expressionMap.relationMetadata;if(t.isManyToOne||t.isOneToOneOwner){let n=t.joinColumns.reduce((s,i)=>{let r=ne.isObject(e)?i.referencedColumn.getEntityValue(e):e;return i.setEntityValue(s,r),s},{});if(!this.expressionMap.of||Array.isArray(this.expressionMap.of)&&!this.expressionMap.of.length)return;await this.queryBuilder.createQueryBuilder().update(t.entityMetadata.target).set(n).whereInIds(this.expressionMap.of).execute()}else if((t.isOneToOneNotOwner||t.isOneToMany)&&e===null){let n={};t.inverseRelation.joinColumns.forEach(c=>{n[c.propertyName]=null});let s=Array.isArray(this.expressionMap.of)?this.expressionMap.of:[this.expressionMap.of],i={},r=[];s.forEach((c,l)=>{t.inverseRelation.joinColumns.map((u,h)=>{let d="joinColumn_"+l+"_"+h;i[d]=ne.isObject(c)?u.referencedColumn.getEntityValue(c):c,r.push(`${u.propertyPath} = :${d}`)})});let o=r.map(c=>"("+c+")").join(" OR ");if(!o)return;await this.queryBuilder.createQueryBuilder().update(t.inverseEntityMetadata.target).set(n).where(o).setParameters(i).execute()}else if(t.isOneToOneNotOwner||t.isOneToMany){if(Array.isArray(this.expressionMap.of))throw new v("You cannot update relations of multiple entities with the same related object. Provide a single entity into .of method.");let n=this.expressionMap.of,s=t.inverseRelation.joinColumns.reduce((i,r)=>{let o=ne.isObject(n)?r.referencedColumn.getEntityValue(n):n;return r.setEntityValue(i,o),i},{});if(!e||Array.isArray(e)&&!e.length)return;await this.queryBuilder.createQueryBuilder().update(t.inverseEntityMetadata.target).set(s).whereInIds(e).execute()}else{let n=t.junctionEntityMetadata,s=Array.isArray(this.expressionMap.of)?this.expressionMap.of:[this.expressionMap.of],i=Array.isArray(e)?e:[e],r=t.isManyToManyOwner?s:i,o=t.isManyToManyOwner?i:s,c=[];if(r.forEach(l=>{o.forEach(u=>{let h={};n.ownerColumns.forEach(d=>{h[d.databaseName]=ne.isObject(l)?d.referencedColumn.getEntityValue(l):l}),n.inverseColumns.forEach(d=>{h[d.databaseName]=ne.isObject(u)?d.referencedColumn.getEntityValue(u):u}),c.push(h)})}),!c.length)return;this.queryBuilder.connection.driver.options.type==="oracle"||this.queryBuilder.connection.driver.options.type==="sap"?await Promise.all(c.map(l=>this.queryBuilder.createQueryBuilder().insert().into(n.tableName).values(l).execute())):await this.queryBuilder.createQueryBuilder().insert().into(n.tableName).values(c).execute()}}},lo=class{constructor(e,t){this.queryBuilder=e,this.expressionMap=t}async remove(e){let t=this.expressionMap.relationMetadata;if(t.isOneToMany){let n=Array.isArray(this.expressionMap.of)?this.expressionMap.of:[this.expressionMap.of],s=Array.isArray(e)?e:[e],i={};t.inverseRelation.joinColumns.forEach(l=>{i[l.propertyName]=null});let r={},o=[];n.forEach((l,u)=>{o.push(...s.map((h,d)=>[...t.inverseRelation.joinColumns.map((f,p)=>{let m="joinColumn_"+u+"_"+d+"_"+p;return r[m]=ne.isObject(l)?f.referencedColumn.getEntityValue(l):l,`${f.propertyPath} = :${m}`}),...t.inverseRelation.entityMetadata.primaryColumns.map((f,p)=>{let m="primaryColumn_"+d+"_"+d+"_"+p;return r[m]=ne.isObject(h)?f.getEntityValue(h):h,`${f.propertyPath} = :${m}`})].join(" AND ")))});let c=o.map(l=>"("+l+")").join(" OR ");if(!c)return;await this.queryBuilder.createQueryBuilder().update(t.inverseEntityMetadata.target).set(i).where(c).setParameters(r).execute()}else{let n=t.junctionEntityMetadata,s=Array.isArray(this.expressionMap.of)?this.expressionMap.of:[this.expressionMap.of],i=Array.isArray(e)?e:[e],r=t.isManyToManyOwner?s:i,o=t.isManyToManyOwner?i:s,c={},l=[];r.forEach((h,d)=>{l.push(...o.map((f,p)=>[...n.ownerColumns.map((m,x)=>{let S="firstValue_"+d+"_"+p+"_"+x;return c[S]=ne.isObject(h)?m.referencedColumn.getEntityValue(h):h,`${m.databaseName} = :${S}`}),...n.inverseColumns.map((m,x)=>{let S="secondValue_"+d+"_"+p+"_"+x;return c[S]=ne.isObject(f)?m.referencedColumn.getEntityValue(f):f,`${m.databaseName} = :${S}`})].join(" AND ")))});let u=l.map(h=>"("+h+")").join(" OR ");await this.queryBuilder.createQueryBuilder().delete().from(n.tableName).where(u).setParameters(c).execute()}}},ph=(()=>{let a=class extends kt{constructor(){super(...arguments),this["@instanceof"]=Symbol.for("RelationQueryBuilder")}getQuery(){return""}of(t){return this.expressionMap.of=t,this}async set(t){let n=this.expressionMap.relationMetadata;if(!this.expressionMap.of)throw new v("Entity whose relation needs to be set is not set. Use .of method to define whose relation you want to set.");if(n.isManyToMany||n.isOneToMany)throw new v(`Set operation is only supported for many-to-one and one-to-one relations. However given "${n.propertyPath}" has ${n.relationType} relation. Use .add() method instead.`);if(n.joinColumns&&n.joinColumns.length>1&&(!ne.isObject(t)||Object.keys(t).length<n.joinColumns.length))throw new v('Value to be set into the relation must be a map of relation ids, for example: .set({ firstName: "...", lastName: "..." })');return new qi(this,this.expressionMap).update(t)}async add(t){if(Array.isArray(t)&&t.length===0)return;let n=this.expressionMap.relationMetadata;if(!this.expressionMap.of)throw new v("Entity whose relation needs to be set is not set. Use .of method to define whose relation you want to set.");if(n.isManyToOne||n.isOneToOne)throw new v(`Add operation is only supported for many-to-many and one-to-many relations. However given "${n.propertyPath}" has ${n.relationType} relation. Use .set() method instead.`);if(n.joinColumns&&n.joinColumns.length>1&&(!ne.isObject(t)||Object.keys(t).length<n.joinColumns.length))throw new v('Value to be set into the relation must be a map of relation ids, for example: .set({ firstName: "...", lastName: "..." })');return new qi(this,this.expressionMap).update(t)}async remove(t){if(Array.isArray(t)&&t.length===0)return;let n=this.expressionMap.relationMetadata;if(!this.expressionMap.of)throw new v("Entity whose relation needs to be set is not set. Use .of method to define whose relation you want to set.");if(n.isManyToOne||n.isOneToOne)throw new v(`Add operation is only supported for many-to-many and one-to-many relations. However given "${n.propertyPath}" has ${n.relationType} relation. Use .set(null) method instead.`);return new lo(this,this.expressionMap).remove(t)}async addAndRemove(t,n){await this.remove(n),await this.add(t)}async loadOne(){return this.loadMany().then(t=>t[0])}async loadMany(){let t=this.expressionMap.of;if(!ne.isObject(t)){let n=this.expressionMap.mainAlias.metadata;if(n.hasMultiplePrimaryKeys)throw new v("Cannot load entity because only one primary key was specified, however entity contains multiple primary keys");t=n.primaryColumns[0].createValueMap(t)}return this.connection.relationLoader.load(this.expressionMap.relationMetadata,t,this.queryRunner)}};return a=Qe([xe.NAME("RelationQueryBuilder")],a),a})(),uo=class{constructor(e){this.options=e}logQuery(e,t,n){if(this.options==="all"||this.options===!0||Array.isArray(this.options)&&this.options.indexOf("query")!==-1){let s=e+(t&&t.length?" -- PARAMETERS: "+this.stringifyParams(t):"");console.log("query: "+s)}}logQueryError(e,t,n,s){if(this.options==="all"||this.options===!0||Array.isArray(this.options)&&this.options.indexOf("error")!==-1){let i=t+(n&&n.length?" -- PARAMETERS: "+this.stringifyParams(n):"");console.log("query failed: "+i),console.log("error:",e)}}logQuerySlow(e,t,n,s){let i=t+(n&&n.length?" -- PARAMETERS: "+this.stringifyParams(n):"");console.log("query is slow: "+i),console.log("execution time: "+e)}logSchemaBuild(e,t){(this.options==="all"||Array.isArray(this.options)&&this.options.indexOf("schema")!==-1)&&console.log(e)}logMigration(e,t){console.log(e)}log(e,t,n){switch(e){case"log":(this.options==="all"||Array.isArray(this.options)&&this.options.indexOf("log")!==-1)&&console.log(t);break;case"info":(this.options==="all"||Array.isArray(this.options)&&this.options.indexOf("info")!==-1)&&console.info(t);break;case"warn":(this.options==="all"||Array.isArray(this.options)&&this.options.indexOf("warn")!==-1)&&console.warn(t);break}}stringifyParams(e){try{return JSON.stringify(e)}catch{return e}}},Bi=class{constructor(e){this.options=e}logQuery(e,t,n){if(this.options==="all"||this.options===!0||Array.isArray(this.options)&&this.options.indexOf("query")!==-1){let s=e+(t&&t.length?" -- PARAMETERS: "+this.stringifyParams(t):"");Te.logInfo("query:",Te.highlightSql(s))}}logQueryError(e,t,n,s){if(this.options==="all"||this.options===!0||Array.isArray(this.options)&&this.options.indexOf("error")!==-1){let i=t+(n&&n.length?" -- PARAMETERS: "+this.stringifyParams(n):"");Te.logError("query failed:",Te.highlightSql(i)),Te.logError("error:",e)}}logQuerySlow(e,t,n,s){let i=t+(n&&n.length?" -- PARAMETERS: "+this.stringifyParams(n):"");Te.logWarn("query is slow:",Te.highlightSql(i)),Te.logWarn("execution time:",e)}logSchemaBuild(e,t){(this.options==="all"||Array.isArray(this.options)&&this.options.indexOf("schema")!==-1)&&Te.log(e)}logMigration(e,t){Te.log(e)}log(e,t,n){switch(e){case"log":(this.options==="all"||Array.isArray(this.options)&&this.options.indexOf("log")!==-1)&&Te.log(t);break;case"info":(this.options==="all"||Array.isArray(this.options)&&this.options.indexOf("info")!==-1)&&Te.logInfo("INFO:",t);break;case"warn":(this.options==="all"||Array.isArray(this.options)&&this.options.indexOf("warn")!==-1)&&console.warn(Te.warn(t));break}}stringifyParams(e){try{return JSON.stringify(e)}catch{return e}}},ho=class{constructor(){this.debugQueryLog=(0,xt.default)("typeorm:query:log"),this.debugQueryError=(0,xt.default)("typeorm:query:error"),this.debugQuerySlow=(0,xt.default)("typeorm:query:slow"),this.debugSchemaBuild=(0,xt.default)("typeorm:schema"),this.debugMigration=(0,xt.default)("typeorm:migration"),this.debugLog=(0,xt.default)("typeorm:log"),this.debugInfo=(0,xt.default)("typeorm:info"),this.debugWarn=(0,xt.default)("typeorm:warn")}logQuery(e,t,n){this.debugQueryLog.enabled&&(this.debugQueryLog(Te.highlightSql(e)+";"),t&&t.length&&this.debugQueryLog("parameters:",t))}logQueryError(e,t,n,s){this.debugQueryError.enabled&&(this.debugQueryError(Te.highlightSql(t)+";"),n&&n.length&&this.debugQueryError("parameters:",n),this.debugQueryError("error: ",e))}logQuerySlow(e,t,n,s){this.debugQuerySlow.enabled&&(this.debugQuerySlow(Te.highlightSql(t)+";"),n&&n.length&&this.debugQuerySlow("parameters:",n),this.debugQuerySlow("execution time:",e))}logSchemaBuild(e,t){this.debugSchemaBuild.enabled&&this.debugSchemaBuild(e)}logMigration(e,t){this.debugMigration.enabled&&this.debugMigration(e)}log(e,t,n){switch(e){case"log":this.debugLog.enabled&&this.debugLog(t);break;case"info":this.debugInfo.enabled&&this.debugInfo(t);break;case"warn":this.debugWarn.enabled&&this.debugWarn(t);break}}},Fi=class{create(e,t){if(ne.isObject(e))return e;if(e)switch(e){case"simple-console":return new uo(t);case"file":return;case"advanced-console":return new Bi(t);case"debug":return new ho}return new Bi(t)}},fo=class{constructor(e,t){this.connection=e,this.clientType=t,this.redis=this.loadRedis()}async connect(){let e=this.connection.options.cache;if(this.clientType==="redis")this.client=this.redis.createClient(je(oe({},e?.options),{legacyMode:!0})),typeof this.connection.options.cache=="object"&&this.connection.options.cache.ignoreErrors&&this.client.on("error",t=>{this.connection.logger.log("warn",t)}),"connect"in this.client&&await this.client.connect();else if(this.clientType==="ioredis")e&&e.port?e.options?this.client=new this.redis(e.port,e.options):this.client=new this.redis(e.port):e&&e.options?this.client=new this.redis(e.options):this.client=new this.redis;else if(this.clientType==="ioredis/cluster")if(e&&e.options&&Array.isArray(e.options))this.client=new this.redis.Cluster(e.options);else if(e&&e.options&&e.options.startupNodes)this.client=new this.redis.Cluster(e.options.startupNodes,e.options.options);else throw new v(`options.startupNodes required for ${this.clientType}.`)}async disconnect(){return new Promise((e,t)=>{this.client.quit((n,s)=>{if(n)return t(n);e(),this.client=void 0})})}async synchronize(e){}getFromCache(e,t){return new Promise((n,s)=>{e.identifier?this.client.get(e.identifier,(i,r)=>{if(i)return s(i);n(JSON.parse(r))}):e.query?this.client.get(e.query,(i,r)=>{if(i)return s(i);n(JSON.parse(r))}):n(void 0)})}isExpired(e){return e.time+e.duration<new Date().getTime()}async storeInCache(e,t,n){return new Promise((s,i)=>{e.identifier?this.client.set(e.identifier,JSON.stringify(e),"PX",e.duration,(r,o)=>{if(r)return i(r);s()}):e.query&&this.client.set(e.query,JSON.stringify(e),"PX",e.duration,(r,o)=>{if(r)return i(r);s()})})}async clear(e){return new Promise((t,n)=>{this.client.flushdb((s,i)=>{if(s)return n(s);t()})})}async remove(e,t){await Promise.all(e.map(n=>this.deleteKey(n)))}deleteKey(e){return new Promise((t,n)=>{this.client.del(e,(s,i)=>{if(s)return n(s);t()})})}loadRedis(){try{return this.clientType==="ioredis/cluster"?Te.load("ioredis"):Te.load(this.clientType)}catch{throw new v(`Cannot use cache because ${this.clientType} is not installed. Please run "npm i ${this.clientType} --save".`)}}},po=class{constructor(e){this.connection=e;let{schema:t}=this.connection.driver.options,n=this.connection.driver.database,i=(typeof this.connection.options.cache=="object"?this.connection.options.cache:{}).tableName||"query-result-cache";this.queryResultCacheDatabase=n,this.queryResultCacheSchema=t,this.queryResultCacheTable=this.connection.driver.buildTableName(i,t,n)}async connect(){}async disconnect(){}async synchronize(e){e=this.getQueryRunner(e);let t=this.connection.driver;await e.hasTable(this.queryResultCacheTable)||await e.createTable(new St({database:this.queryResultCacheDatabase,schema:this.queryResultCacheSchema,name:this.queryResultCacheTable,columns:[{name:"id",isPrimary:!0,isNullable:!1,type:t.normalizeType({type:t.mappedDataTypes.cacheId}),generationStrategy:t.options.type==="spanner"?"uuid":"increment",isGenerated:!0},{name:"identifier",type:t.normalizeType({type:t.mappedDataTypes.cacheIdentifier}),isNullable:!0},{name:"time",type:t.normalizeType({type:t.mappedDataTypes.cacheTime}),isPrimary:!1,isNullable:!1},{name:"duration",type:t.normalizeType({type:t.mappedDataTypes.cacheDuration}),isPrimary:!1,isNullable:!1},{name:"query",type:t.normalizeType({type:t.mappedDataTypes.cacheQuery}),isPrimary:!1,isNullable:!1},{name:"result",type:t.normalizeType({type:t.mappedDataTypes.cacheResult}),isNullable:!1}]}))}getFromCache(e,t){t=this.getQueryRunner(t);let n=this.connection.createQueryBuilder(t).select().from(this.queryResultCacheTable,"cache");return e.identifier?n.where(`${n.escape("cache")}.${n.escape("identifier")} = :identifier`).setParameters({identifier:e.identifier}).getRawOne():e.query?this.connection.driver.options.type==="oracle"?n.where(`dbms_lob.compare(${n.escape("cache")}.${n.escape("query")}, :query) = 0`,{query:e.query}).getRawOne():n.where(`${n.escape("cache")}.${n.escape("query")} = :query`).setParameters({query:e.query}).getRawOne():Promise.resolve(void 0)}isExpired(e){let t=typeof e.duration=="string"?parseInt(e.duration):e.duration;return(typeof e.time=="string"?parseInt(e.time):e.time)+t<new Date().getTime()}async storeInCache(e,t,n){let s=n===void 0||n?.getReplicationMode()==="slave";(n===void 0||s)&&(n=this.connection.createQueryRunner("master"));let i=e;if(this.connection.driver.options.type,t&&t.identifier){let r=n.manager.createQueryBuilder().update(this.queryResultCacheTable).set(i);r.where(`${r.escape("identifier")} = :condition`,{condition:i.identifier}),await r.execute()}else if(t&&t.query){let r=n.manager.createQueryBuilder().update(this.queryResultCacheTable).set(i);this.connection.driver.options.type==="oracle"?r.where('dbms_lob.compare("query", :condition) = 0',{condition:i.query}):r.where(`${r.escape("query")} = :condition`,{condition:i.query}),await r.execute()}else this.connection.driver.options.type==="spanner"&&!i.id&&(i.id=ii()),await n.manager.createQueryBuilder().insert().into(this.queryResultCacheTable).values(i).execute();s&&await n.release()}async clear(e){return this.getQueryRunner(e).clearTable(this.queryResultCacheTable)}async remove(e,t){let n=t||this.getQueryRunner();await Promise.all(e.map(s=>{let i=n.manager.createQueryBuilder();return i.delete().from(this.queryResultCacheTable).where(`${i.escape("identifier")} = :identifier`,{identifier:s}).execute()})),t||await n.release()}getQueryRunner(e){return e||this.connection.createQueryRunner()}},Li=class{constructor(e){this.connection=e}create(){if(!this.connection.options.cache)throw new v("To use cache you need to enable it in connection options by setting cache: true or providing some caching options. Example: { host: ..., username: ..., cache: true }");let e=this.connection.options.cache;return e.provider&&typeof e.provider=="function"?e.provider(this.connection):e.type==="redis"||e.type==="ioredis"||e.type==="ioredis/cluster"?new fo(this.connection,e.type):new po(this.connection)}},mo=class{constructor(e){this.connection=e}load(e,t,n,s){return n&&n.isReleased&&(n=void 0),e.isManyToOne||e.isOneToOneOwner?this.loadManyToOneOrOneToOneOwner(e,t,n,s):e.isOneToMany||e.isOneToOneNotOwner?this.loadOneToManyOrOneToOneNotOwner(e,t,n,s):e.isManyToManyOwner?this.loadManyToManyOwner(e,t,n,s):this.loadManyToManyNotOwner(e,t,n,s)}loadManyToOneOrOneToOneOwner(e,t,n,s){let i=Array.isArray(t)?t:[t],r=e.entityMetadata.name,o=s||this.connection.createQueryBuilder(n).select(e.propertyName).from(e.type,e.propertyName),c=o.expressionMap.mainAlias.name,l=e.entityMetadata.primaryColumns,h=(e.isOwning?e.joinColumns:e.inverseRelation.joinColumns).map(d=>`${e.entityMetadata.name}.${d.propertyName} = ${c}.${d.referencedColumn.propertyName}`).join(" AND ");if(o.innerJoin(e.entityMetadata.target,r,h),l.length===1)o.where(`${r}.${l[0].propertyPath} IN (:...${r+"_"+l[0].propertyName})`),o.setParameter(r+"_"+l[0].propertyName,i.map(d=>l[0].getEntityValue(d,!0)));else{let d=i.map((f,p)=>l.map((m,x)=>{let S=r+"_entity_"+p+"_"+x;return o.setParameter(S,m.getEntityValue(f,!0)),r+"."+m.propertyPath+" = :"+S}).join(" AND ")).map(f=>"("+f+")").join(" OR ");o.where(d)}return Le.joinEagerRelations(o,o.alias,o.expressionMap.mainAlias.metadata),o.getMany()}loadOneToManyOrOneToOneNotOwner(e,t,n,s){let i=Array.isArray(t)?t:[t],r=e.inverseRelation.joinColumns,o=s||this.connection.createQueryBuilder(n).select(e.propertyName).from(e.inverseRelation.entityMetadata.target,e.propertyName),c=o.expressionMap.mainAlias.name;if(r.length===1)o.where(`${c}.${r[0].propertyPath} IN (:...${c+"_"+r[0].propertyName})`),o.setParameter(c+"_"+r[0].propertyName,i.map(l=>r[0].referencedColumn.getEntityValue(l,!0)));else{let l=i.map((u,h)=>r.map((d,f)=>{let p=c+"_entity_"+h+"_"+f;return o.setParameter(p,d.referencedColumn.getEntityValue(u,!0)),c+"."+d.propertyPath+" = :"+p}).join(" AND ")).map(u=>"("+u+")").join(" OR ");o.where(l)}return Le.joinEagerRelations(o,o.alias,o.expressionMap.mainAlias.metadata),o.getMany()}loadManyToManyOwner(e,t,n,s){let i=Array.isArray(t)?t:[t],r=e.joinColumns.reduce((d,f)=>(d[f.propertyName]=i.map(p=>f.referencedColumn.getEntityValue(p,!0)),d),{}),o=s||this.connection.createQueryBuilder(n).select(e.propertyName).from(e.type,e.propertyName),c=o.expressionMap.mainAlias.name,l=e.junctionEntityMetadata.tableName,u=e.joinColumns.map(d=>`${l}.${d.propertyName} IN (:...${d.propertyName})`),h=e.inverseJoinColumns.map(d=>`${l}.${d.propertyName}=${c}.${d.referencedColumn.propertyName}`);return o.innerJoin(l,l,[...u,...h].join(" AND ")).setParameters(r),Le.joinEagerRelations(o,o.alias,o.expressionMap.mainAlias.metadata),o.getMany()}loadManyToManyNotOwner(e,t,n,s){let i=Array.isArray(t)?t:[t],r=s||this.connection.createQueryBuilder(n).select(e.propertyName).from(e.type,e.propertyName),o=r.expressionMap.mainAlias.name,c=e.junctionEntityMetadata.tableName,l=e.inverseRelation.joinColumns.map(d=>`${c}.${d.propertyName} = ${o}.${d.referencedColumn.propertyName}`),u=e.inverseRelation.inverseJoinColumns.map(d=>`${c}.${d.propertyName} IN (:...${d.propertyName})`),h=e.inverseRelation.inverseJoinColumns.reduce((d,f)=>(d[f.propertyName]=i.map(p=>f.referencedColumn.getEntityValue(p,!0)),d),{});return r.innerJoin(c,c,[...l,...u].join(" AND ")).setParameters(h),Le.joinEagerRelations(r,r.alias,r.expressionMap.mainAlias.metadata),r.getMany()}enableLazyLoad(e,t,n){let s=this,i="__"+e.propertyName+"__",r="__promise_"+e.propertyName+"__",o="__has_"+e.propertyName+"__",c=(u,h)=>(u[i]=h,u[o]=!0,delete u[r],h),l=(u,h)=>(delete u[o],delete u[i],u[r]=h,h.then(d=>u[r]===h?c(u,d):d),h);Object.defineProperty(t,e.propertyName,{get:function(){if(this[o]===!0||this[i]!==void 0)return Promise.resolve(this[i]);if(this[r])return this[r];let u=s.load(e,this,n).then(h=>e.isOneToOne||e.isManyToOne?h.length===0?null:h[0]:h);return l(this,u)},set:function(u){u instanceof Promise?l(this,u):c(this,u)},configurable:!0})}},yo=class{constructor(e){this.connection=e}load(e,t,n){let s=Array.isArray(t)?t:[t],i=Array.isArray(n)?n:n?[n]:void 0;return e.isManyToMany?this.loadForManyToMany(e,s,i):e.isManyToOne||e.isOneToOneOwner?this.loadForManyToOneAndOneToOneOwner(e,s,i):this.loadForOneToManyAndOneToOneNotOwner(e,s,i)}async loadManyToManyRelationIdsAndGroup(e,t,n,s){let i=e.isManyToMany||e.isOneToMany,r=Array.isArray(t)?t:[t];if(!n&&(n=await this.connection.relationLoader.load(e,t,void 0,s),!n.length))return r.map(h=>({entity:h,related:i?[]:void 0}));let o=await this.load(e,t,n),c=Array.isArray(n)?n:[n],l=[],u=[];return e.isManyToManyOwner?(l=e.junctionEntityMetadata.inverseColumns.map(h=>h.referencedColumn),u=e.junctionEntityMetadata.ownerColumns.map(h=>h.referencedColumn)):e.isManyToManyNotOwner?(l=e.junctionEntityMetadata.ownerColumns.map(h=>h.referencedColumn),u=e.junctionEntityMetadata.inverseColumns.map(h=>h.referencedColumn)):e.isManyToOne||e.isOneToOneOwner?(l=e.joinColumns.map(h=>h.referencedColumn),u=e.entityMetadata.primaryColumns):(e.isOneToMany||e.isOneToOneNotOwner)&&(l=e.inverseRelation.entityMetadata.primaryColumns,u=e.inverseRelation.joinColumns.map(h=>h.referencedColumn)),r.map(h=>{let d={entity:h,related:i?[]:void 0},f=o.filter(p=>u.every(m=>m.compareEntityValue(h,p[m.entityMetadata.name+"_"+m.propertyAliasName])));return f.length&&c.forEach(p=>{f.forEach(m=>{l.every(S=>S.compareEntityValue(p,m[L.buildAlias(this.connection.driver,S.entityMetadata.name+"_"+e.propertyPath.replace(".","_")+"_"+S.propertyPath.replace(".","_"))]))&&(i?d.related.push(p):d.related=p)})}),d})}loadForManyToMany(e,t,n){let s=e.junctionEntityMetadata,i=s.name,r=e.isOwning?s.ownerColumns:s.inverseColumns,o=e.isOwning?s.inverseColumns:s.ownerColumns,c=this.connection.createQueryBuilder();r.forEach(d=>{let f=L.buildAlias(this.connection.driver,d.referencedColumn.entityMetadata.name+"_"+d.referencedColumn.propertyPath.replace(".","_"));c.addSelect(i+"."+d.propertyPath,f)}),o.forEach(d=>{let f=L.buildAlias(this.connection.driver,d.referencedColumn.entityMetadata.name+"_"+e.propertyPath.replace(".","_")+"_"+d.referencedColumn.propertyPath.replace(".","_"));c.addSelect(i+"."+d.propertyPath,f)});let l="";if(r.length===1){let d=t.map(p=>r[0].referencedColumn.getEntityValue(p));d.every(p=>typeof p=="number")?l=`${i}.${r[0].propertyPath} IN (${d.join(", ")})`:(c.setParameter("values1",d),l=i+"."+r[0].propertyPath+" IN (:...values1)")}else l="("+t.map((d,f)=>r.map(p=>{let m="entity1_"+f+"_"+p.propertyName;return c.setParameter(m,p.referencedColumn.getEntityValue(d)),i+"."+p.propertyPath+" = :"+m}).join(" AND ")).map(d=>"("+d+")").join(" OR ")+")";let u="";if(n)if(o.length===1){let d=n.map(p=>o[0].referencedColumn.getEntityValue(p));d.every(p=>typeof p=="number")?u=`${i}.${o[0].propertyPath} IN (${d.join(", ")})`:(c.setParameter("values2",d),u=i+"."+o[0].propertyPath+" IN (:...values2)")}else u="("+n.map((d,f)=>o.map(p=>{let m="entity2_"+f+"_"+p.propertyName;return c.setParameter(m,p.referencedColumn.getEntityValue(d)),i+"."+p.propertyPath+" = :"+m}).join(" AND ")).map(d=>"("+d+")").join(" OR ")+")";let h=[l,u].filter(d=>d.length>0).join(" AND ");return c.from(s.target,i).where(h).getRawMany()}loadForManyToOneAndOneToOneOwner(e,t,n){let s=e.entityMetadata.targetName,i=e.joinColumns.every(c=>!!e.entityMetadata.nonVirtualColumns.find(l=>l===c));if(n&&i){let c=[];if(t.forEach(l=>{let u={};e.entityMetadata.primaryColumns.forEach(h=>{let d=h.entityMetadata.name+"_"+h.propertyPath.replace(".","_");u[d]=h.getEntityValue(l)}),n.forEach(h=>{e.joinColumns.forEach(d=>{let f=d.getEntityValue(l),p=d.referencedColumn.getEntityValue(h);if(!(f===void 0||p===void 0)&&f===p){let m=d.referencedColumn.entityMetadata.name+"_"+e.propertyPath.replace(".","_")+"_"+d.referencedColumn.propertyPath.replace(".","_");u[m]=p}})}),Object.keys(u).length===e.entityMetadata.primaryColumns.length+e.joinColumns.length&&c.push(u)}),c.length===t.length)return Promise.resolve(c)}let r=this.connection.createQueryBuilder();e.entityMetadata.primaryColumns.forEach(c=>{let l=L.buildAlias(this.connection.driver,c.entityMetadata.name+"_"+c.propertyPath.replace(".","_"));r.addSelect(s+"."+c.propertyPath,l)}),e.joinColumns.forEach(c=>{let l=L.buildAlias(this.connection.driver,c.referencedColumn.entityMetadata.name+"_"+e.propertyPath.replace(".","_")+"_"+c.referencedColumn.propertyPath.replace(".","_"));r.addSelect(s+"."+c.propertyPath,l)});let o="";if(e.entityMetadata.primaryColumns.length===1){let c=t.map(u=>e.entityMetadata.primaryColumns[0].getEntityValue(u));c.every(u=>typeof u=="number")?o=`${s}.${e.entityMetadata.primaryColumns[0].propertyPath} IN (${c.join(", ")})`:(r.setParameter("values",c),o=s+"."+e.entityMetadata.primaryColumns[0].propertyPath+" IN (:...values)")}else o=t.map((c,l)=>e.entityMetadata.primaryColumns.map((u,h)=>{let d="entity"+l+"_"+h;return r.setParameter(d,u.getEntityValue(c)),s+"."+u.propertyPath+" = :"+d}).join(" AND ")).map(c=>"("+c+")").join(" OR ");return r.from(e.entityMetadata.target,s).where(o).getRawMany()}loadForOneToManyAndOneToOneNotOwner(e,t,n){if(e=e.inverseRelation,e.entityMetadata.primaryColumns.length===e.joinColumns.length&&e.entityMetadata.primaryColumns.every(c=>e.joinColumns.indexOf(c)!==-1))return Promise.resolve(t.map(c=>{let l={};return e.joinColumns.forEach(function(u){let h=u.referencedColumn.getEntityValue(c),d=u.referencedColumn.entityMetadata.name+"_"+u.referencedColumn.propertyPath.replace(".","_"),f=u.entityMetadata.name+"_"+e.inverseRelation.propertyPath.replace(".","_")+"_"+u.propertyPath.replace(".","_");l[d]=h,l[f]=h}),l}));let s=e.entityMetadata.targetName,i=this.connection.createQueryBuilder();e.entityMetadata.primaryColumns.forEach(o=>{let c=L.buildAlias(this.connection.driver,o.entityMetadata.name+"_"+e.inverseRelation.propertyPath.replace(".","_")+"_"+o.propertyPath.replace(".","_"));i.addSelect(s+"."+o.propertyPath,c)}),e.joinColumns.forEach(o=>{let c=L.buildAlias(this.connection.driver,o.referencedColumn.entityMetadata.name+"_"+o.referencedColumn.propertyPath.replace(".","_"));i.addSelect(s+"."+o.propertyPath,c)});let r="";if(e.joinColumns.length===1){let o=t.map(l=>e.joinColumns[0].referencedColumn.getEntityValue(l));o.every(l=>typeof l=="number")?r=`${s}.${e.joinColumns[0].propertyPath} IN (${o.join(", ")})`:(i.setParameter("values",o),r=s+"."+e.joinColumns[0].propertyPath+" IN (:...values)")}else r=t.map((o,c)=>e.joinColumns.map((l,u)=>{let h="entity"+c+"_"+u;return i.setParameter(h,l.referencedColumn.getEntityValue(o)),s+"."+l.propertyPath+" = :"+h}).join(" AND ")).map(o=>"("+o+")").join(" OR ");return i.from(e.entityMetadata.target,s).where(r).getRawMany()}},ki=class{constructor(e){this["@instanceof"]=Symbol.for("DataSource"),this.SelectQueryBuilder=cs,this.UpdateQueryBuilder=uh,this.DeleteQueryBuilder=hh,this.SoftDeleteQueryBuilder=dh,this.InsertQueryBuilder=fh,this.RelationQueryBuilder=ph,this.migrations=[],this.subscribers=[],this.entityMetadatas=[],this.name=e.name||"default",this.options=e,this.logger=new Fi().create(this.options.logger,this.options.logging),this.driver=new Ga().create(this),this.manager=this.createEntityManager(),this.namingStrategy=e.namingStrategy||new ba,this.metadataTableName=e.metadataTableName||"typeorm_metadata",this.queryResultCache=e.cache?new Li(this).create():void 0,this.relationLoader=new mo(this),this.relationIdLoader=new yo(this),this.isInitialized=!1}get isConnected(){return this.isInitialized}get sqljsManager(){if(!$.isSqljsEntityManager(this.manager))throw new v("SqljsEntityManager is only available for Sqljs databases.");return this.manager}setOptions(e){return Object.assign(this.options,e),(e.logger||e.logging)&&(this.logger=new Fi().create(e.logger||this.options.logger,e.logging||this.options.logging)),e.namingStrategy&&(this.namingStrategy=e.namingStrategy),e.cache&&(this.queryResultCache=new Li(this).create()),this}async initialize(){if(this.isInitialized)throw new Hr(this.name);await this.driver.connect(),this.queryResultCache&&await this.queryResultCache.connect(),ne.assign(this,{isInitialized:!0});try{await this.buildMetadatas(),await this.driver.afterConnect(),this.options.dropSchema&&await this.dropDatabase(),this.options.migrationsRun&&await this.runMigrations({transaction:this.options.migrationsTransactionMode}),this.options.synchronize&&await this.synchronize()}catch(e){throw await this.close(),e}return this}async connect(){return this.initialize()}async destroy(){if(!this.isInitialized)throw new zt(this.name);await this.driver.disconnect(),this.queryResultCache&&await this.queryResultCache.disconnect(),ne.assign(this,{isInitialized:!1})}async close(){return this.destroy()}async synchronize(e=!1){if(!this.isInitialized)throw new zt(this.name);e&&await this.dropDatabase(),await this.driver.createSchemaBuilder().build()}async dropDatabase(){let e=this.createQueryRunner();try{if(this.driver.options.type==="mssql"||L.isMySQLFamily(this.driver)||this.driver.options.type==="aurora-mysql"||L.isSQLiteFamily(this.driver)){let t=[];if(this.entityMetadatas.forEach(n=>{n.database&&t.indexOf(n.database)===-1&&t.push(n.database)}),t.length===0&&this.driver.database&&t.push(this.driver.database),t.length===0)await e.clearDatabase();else for(let n of t)await e.clearDatabase(n)}else await e.clearDatabase()}finally{await e.release()}}async runMigrations(e){if(!this.isInitialized)throw new zt(this.name);let t=new rs(this);return t.transaction=e&&e.transaction||"all",t.fake=e&&e.fake||!1,await t.executePendingMigrations()}async undoLastMigration(e){if(!this.isInitialized)throw new zt(this.name);let t=new rs(this);t.transaction=e&&e.transaction||"all",t.fake=e&&e.fake||!1,await t.undoLastMigration()}async showMigrations(){if(!this.isInitialized)throw new zt(this.name);return await new rs(this).showMigrations()}hasMetadata(e){return!!this.findMetadata(e)}getMetadata(e){let t=this.findMetadata(e);if(t=t||this.findMetadata(e[go]),!t)throw new ea(e);return t}getRepository(e){return this.manager.getRepository(e)}getTreeRepository(e){return this.manager.getTreeRepository(e)}getCustomRepository(e){return this.manager.getCustomRepository(e)}async transaction(e,t){return this.manager.transaction(e,t)}async query(e,t,n){if(n&&n.isReleased)throw new pi;let s=n||this.createQueryRunner();try{return await s.query(e,t)}finally{n||await s.release()}}createQueryBuilder(e,t,n){if(t){t=L.buildAlias(this.driver,t);let s=this.getMetadata(e);return new cs(this,n).select(t).from(s.target,t)}else return new cs(this,e)}createQueryRunner(e="master"){let t=this.driver.createQueryRunner(e),n=this.createEntityManager(t);return Object.assign(t,{manager:n}),t}getManyToManyMetadata(e,t){let n=this.getMetadata(e).findRelationWithPropertyPath(t);if(!n)throw new v(`Relation "${t}" was not found in ${e} entity.`);if(!n.isManyToMany)throw new v(`Relation "${e}#${t}" does not have a many-to-many relationship.You can use this method only on many-to-many relations.`);return n.junctionEntityMetadata}createEntityManager(e){return new $a().create(this,e)}findMetadata(e){return this.entityMetadatas.find(t=>t.target===e?!0:$.isEntitySchema(e)?t.name===e.options.name:typeof e=="string"?e.indexOf(".")!==-1?t.tablePath===e:t.name===e||t.tableName===e:ne.isObject(e)&&typeof e.name=="string"?e.name.indexOf(".")!==-1?t.tablePath===e.name:t.name===e.name||t.tableName===e.name:!1)}async buildMetadatas(){let e=new to(this),t=new Ta,n=ne.mixedListToArray(this.options.subscribers||[]),s=await e.buildSubscribers(n);ne.assign(this,{subscribers:s});let i=ne.mixedListToArray(this.options.entities||[]),r=await e.buildEntityMetadatas(i);ne.assign(this,{entityMetadatas:r});let o=ne.mixedListToArray(this.options.migrations||[]),c=await e.buildMigrations(o);ne.assign(this,{migrations:c}),t.validateMany(this.entityMetadatas.filter(l=>l.tableType!=="view"),this.driver);for(let l of r)$.isBaseEntityConstructor(l.target)&&l.target.useDataSource(this)}};function ze(){let a=Te.getGlobalVariable();return a.typeormMetadataArgsStorage||(a.typeormMetadataArgsStorage=new li),a.typeormMetadataArgsStorage}function tm(a,e){return function(t,n){let s;typeof a=="string"||typeof a=="function"?s=a:a&&(e=a,s=a.type),e||(e={});let i=Reflect&&Reflect.getMetadata?Reflect.getMetadata("design:type",t,n):void 0;if(!s&&i&&(s=i),!e.type&&s&&(e.type=s),e.type==="hstore"&&!e.hstoreType&&(e.hstoreType=i===Object?"object":"string"),typeof a=="function")ze().embeddeds.push({target:t.constructor,propertyName:n,isArray:i===Array||e.array===!0,prefix:e.prefix!==void 0?e.prefix:void 0,type:a});else{if(!e.type)throw new ma(t,n);e.unique===!0&&ze().uniques.push({target:t.constructor,columns:[n]}),ze().columns.push({target:t.constructor,propertyName:n,mode:"regular",options:e}),e.generated&&ze().generations.push({target:t.constructor,propertyName:n,strategy:typeof e.generated=="string"?e.generated:"increment"})}}}function nm(a,e){let t={},n;return a?(typeof a=="string"&&(n=a),ne.isObject(a)&&(n="increment",Object.assign(t,a))):n="increment",ne.isObject(e)&&Object.assign(t,e),function(s,i){t.type||(n==="increment"||n==="identity"?t.type=Number:n==="uuid"?t.type="uuid":n==="rowid"&&(t.type="int")),t.primary=!0,ze().columns.push({target:s.constructor,propertyName:i,mode:"regular",options:t}),ze().generations.push({target:s.constructor,propertyName:i,strategy:n})}}function sm(a){return function(e,t){ze().columns.push({target:e.constructor,propertyName:t,mode:"version",options:a||{}})}}function Jc(){return function(a){ze().entitySubscribers.push({target:a})}}function zc(a,e){let t=(ne.isObject(a)?a:e)||{},n=typeof a=="string"?a:t.name;return function(s){ze().tables.push({target:s,name:n,type:"regular",orderBy:t.orderBy?t.orderBy:void 0,engine:t.engine?t.engine:void 0,database:t.database?t.database:void 0,schema:t.schema?t.schema:void 0,synchronize:t.synchronize,withoutRowid:t.withoutRowid})}}var mh;mh=new Fs("TAON_CONTEXT");var yh;yh=new Fs("CURRENT_HOST_BACKEND_PORT");var gh;gh=new Fs("CURRENT_HOST_URL");var Dn="api";var bh="databases";var K;(function(a){a.DatabasesFolder=bh;let e;(function(i){i.ENTITY="ENTITY",i.CONTROLLER="CONTROLLER",i.REPOSITORY="REPOSITORY",i.PROVIDER="PROVIDER",i.SUBSCRIBER="SUBSCRIBER",i.MIGRATION="MIGRATION",i.MIDDLEWARE="MIDDLEWARE"})(e=a.ClassType||(a.ClassType={})),a.ClassTypeKey={[e.ENTITY]:"entities",[e.CONTROLLER]:"controllers",[e.REPOSITORY]:"repositories",[e.PROVIDER]:"providers",[e.SUBSCRIBER]:"subscribers",[e.MIGRATION]:"migrations",[e.MIDDLEWARE]:"middlewares"};class t{}a.DatabaseConfigTypeOrm=t;class n extends t{static from(r){return y.merge(new n,r)}get databaseConfigTypeORM(){let r=y.cloneDeep(this);return r.recreateMode&&(r.recreateMode==="DROP_DB+MIGRATIONS"?(r.synchronize=!0,r.dropSchema=!0):r.recreateMode==="PRESERVE_DATA+MIGRATIONS"&&(r.synchronize=!1,r.dropSchema=!1)),delete r.recreateMode,r}}a.DatabaseConfig=n;let s;(function(i){i.Rest=st})(s=a.Http||(a.Http={}))})(K||(K={}));var Hc=a=>{let e=a||{};e.methods=e.methods||{};for(let t in e.methods)if(e.methods.hasOwnProperty(t)){e.methods[t]=e.methods[t]||{};let n=e.methods[t].parameters||{};e.methods[t].parameters=n||{};for(let s in n)n.hasOwnProperty(s)&&(n[s]=n[s]||{})}return e};var bo=class{constructor(){this.KEYroomSubscribe="roomSubscribe",this.KEYroomUnsubscribe="roomUnsubscribe"}NAMESPACE(e){return`${e}-taonRealtimeNsp`}TABLE_CHANGE(e,t){return`${e}:listentablename${t}`}ROOM_NAME_CUSTOM(e,t){return`${e}:CustomRoomEvent${t}`}ROOM_SUBSCRIBE_CUSTOM(e){return`${e}:${this.KEYroomSubscribe}CustomRoomEvent`}ROOM_UNSUBSCRIBE_CUSTOM(e){return`${e}:${this.KEYroomUnsubscribe}CustomRoomEvent`}ROOM_NAME_UPDATE_ENTITY(e,t,n){return`${e}:room${y.camelCase(t)}${n}`.toLowerCase()}ROOM_SUBSCRIBE_ENTITY_UPDATE_EVENTS(e){return`${e}:${this.KEYroomSubscribe}EntityEvents`}ROOM_UNSUBSCRIBE_ENTITY_UPDATE_EVENTS(e){return`${e}:${this.KEYroomUnsubscribe}EntityEvents`}ROOM_NAME_UPDATE_ENTITY_PROPERTY(e,t,n,s){return`${e}:room${y.camelCase(t)}${y.camelCase(n)}${s}`.toLowerCase()}ROOM_SUBSCRIBE_ENTITY_PROPERTY_UPDATE_EVENTS(e){return`${e}:${this.KEYroomSubscribe}EntityPropertyEvents`}ROOM_UNSUBSCRIBE_ENTITY_PROPERTY_UPDATE_EVENTS(e){return`${e}:${this.KEYroomUnsubscribe}EntityPropertyEvents`}},I;(function(a){a.ctxInClassOrClassObj=Symbol(),a.classNameStaticProperty=Ee.ClassNameStaticProperty,a.fullClassNameStaticProperty="$$fullclassName$$",a.orignalClass=go,a.orignalClassClonesObj="$$originalClassClonesObj$$",a.classMethodsNames="$$classMethodsNames$$",a.REALTIME=new bo,a.metadata={className:"class:realname",options:{controller:"controller:options",entity:"entity:options",repository:"repository:options",provider:"provider:options",subscriber:"subscriber:options",migration:"migration:options"}},a.old={HAS_TABLE_IN_DB:Symbol(),MDC_KEY:"modeldataconfig",WEBSQL_REST_PROGRESS_FUN:Symbol(),WEBSQL_REST_PROGRESS_FUN_START:Symbol(),WEBSQL_REST_PROGRESS_FUN_DONE:Symbol(),WEBSQL_REST_PROGRESS_TIMEOUT:Symbol(),X_TOTAL_COUNT:"x-total-count",CIRCURAL_OBJECTS_MAP_BODY:"circuralmapbody",CIRCURAL_OBJECTS_MAP_QUERY_PARAM:"circuralmapbody",MAPPING_CONFIG_HEADER:"mappingheader",MAPPING_CONFIG_HEADER_BODY_PARAMS:"mhbodyparams",MAPPING_CONFIG_HEADER_QUERY_PARAMS:"mhqueryparams",ENDPOINT_META_CONFIG:"ng2_rest_endpoint_config",CLASS_DECORATOR_CONTEXT:"$$ng2_rest_class_context",SOCKET_MSG:"socketmessageng2rest",ANGULAR:{INPUT_NAMES:Symbol()},ERROR_MESSAGES:{CLASS_NAME_MATCH:'Please check if your "class name" matches  @Controller( className ) or @Entity( className )'}}})(I||(I={}));var wo=(function(a){return a.classNameVlidation=(e,t)=>(setTimeout(()=>{if(y.isUndefined(e))throw`[Taon]
      Please provide "className" property for each Controller and Entity:

          @Taon.Controller({ className: 'MyExampleCtrl'  })
          class MyExampleCtrl {
            ...
          }

          @Taon.Entity({ className: 'MyExampleEntity'  })
          class MyExampleEntity {
            ...
          }

    Notice that minified javascript code does not preserve
    Functions/Classes names -this is only solution to preserve classes names.

        `}),y.isUndefined(e)?t.name:e),a.checkIfMethodsWithReponseTYpeAlowed=(e,t)=>{let n="text or JSON";if(t.responseType)for(let s=0;s<e.length;s++){let i=e[s];if(i.path===t.path&&i.responseType!==t.responseType)throw new Error(`
  [taon] you can have 2 methods with same path but differetn reponseType-s

          ${i.methodName}( ... path: ${i.path} )  -> responseType: ${i.responseType||n}
          ${t.methodName}( ... path: ${t.path} ) -> responseType: ${t.responseType}

    Please change path name on of the methods.

        `)}},a.validateClassFunctions=(e,t,n,s)=>{if(y.isArray(e)&&e.filter(i=>!y.isFunction(i)).length>0)throw console.error("controllers",e),`

  Incorect value for property "controllers" inside Taon.Init(...)

  `;if(y.isArray(t)&&t.filter(i=>!y.isFunction(i)).length>0)throw console.error("entites",t),`

  Incorect value for property "entities" inside Taon.Init(...)

  `},a.preventUndefinedModel=(e,t)=>{if(y.isUndefined(e))throw`Bad update by id, config, id: ${t}`},a})(wo||{});var Z;(function(a){a.getClassFnFromObject=t=>{if(y.isUndefined(t)||y.isNull(t))return;if(t.constructor)return t.constructor;let n=Object.getPrototypeOf(t);return n&&n.constructor&&n.constructor.name!=="Object"?n.constructor:void 0},a.getName=t=>{if(t instanceof FormData)return"FormData";if(!t)throw console.error("OBJECT OR CLASS",t),new Error("Cannot get name from this object or class.");return(t[I.classNameStaticProperty]?t[I.classNameStaticProperty]:t?.constructor[I.classNameStaticProperty])||(y.isFunction(t)?ye.getName(t):void 0)},a.getOrginalClass=t=>{let n=t[I.orignalClass];return n?a.getOrginalClass(n):t},a.getFullInternalName=t=>{if(!t)throw new Error(`Cannot get name from: ${t}`);return(t[I.fullClassNameStaticProperty]?t[I.fullClassNameStaticProperty]:t?.constructor[I.fullClassNameStaticProperty])||void 0},a.getUniqueKey=t=>{let n=y.isFunction(t)?t:t.constructor;return Reflect.getMetadata(I.metadata.options.entity,n).uniqueKeyProp},a.isContextClassObject=t=>{if(!y.isObject(t)||y.isArray(t)||y.isRegExp(t)||y.isBuffer(t)||y.isArrayBuffer(t))return!1;if(y.isDate(t))return!0;let n=a.getName(t);return y.isString(n)&&n!=="Object"},a.setName=(t,n)=>{wo.classNameVlidation(n,t),t[I.classNameStaticProperty]=n},a.hasParentClassWithName=(t,n,s=[])=>{if(!t)return!1;s.push(t);let i=Object.getPrototypeOf(t);return y.isFunction(i)&&a.getName(i)===n?!0:a.hasParentClassWithName(i,n,s)};let e=["length","name","arguments","caller","constructor","apply","bind","call","toString","__defineGetter__","__defineSetter__","hasOwnProperty","__lookupGetter__","__lookupSetter__","isPrototypeOf","propertyIsEnumerable","valueOf","__proto__","toLocaleString"];a.asyncHandler=t=>(n,s,i)=>{Promise.resolve(t(n,s,i)).catch(i)},a.getMethodsNames=(t,n=[])=>{if(!t)return Kn.uniqArray(n);let s=y.isFunction(t),i=s?t:Object.getPrototypeOf(t),r=s?t?.prototype:t,o=Object.getPrototypeOf(r||{});return y.uniq([...Object.getOwnPropertyNames(r||{}),...Object.getOwnPropertyNames(o||{}),...Object.keys(r||{}),...Object.keys(o||{})]).filter(l=>!!l&&!e.includes(l)).filter(l=>typeof r[l]=="function").forEach(l=>n.push(l)),!i||!i.constructor||i?.constructor?.name==="Object"?Kn.uniqArray(n):a.getMethodsNames(Object.getPrototypeOf(i),n)},a.getControllerConfigs=(t,n=[],s)=>{if(!y.isFunction(t))throw`[typescript-class-helper][getControllerConfigs] Cannot get class config from: ${t}`;let i,r=Object.getPrototypeOf(t),o=r?a.getName(r):void 0,c=y.isFunction(r)&&o!=="";return i=Hc(a.getClassConfig(t)),n.push(i),c?a.getControllerConfigs(r,n,t):n},a.ensureClassConfig=t=>{let n=Reflect.getOwnMetadata(I.metadata.options.controller,t);if(!n){n={methods:{}};let s=Object.getPrototypeOf(t);if(s&&s!==Function.prototype){let i=Reflect.getMetadata(I.metadata.options.controller,s);if(i){let r={};for(let[o,c]of Object.entries(i.methods))r[o]=je(oe({},c),{parameters:oe({},c.parameters)});n=je(oe({},i),{methods:r})}}Reflect.defineMetadata(I.metadata.options.controller,n,t)}return n},a.ensureMethodConfig=(t,n)=>{let s=a.ensureClassConfig(t.constructor),i=s.methods[n?.toString()];return i||(i={methodName:n?.toString(),parameters:{}},s.methods[n?.toString()]=i),i},a.getClassConfig=t=>Reflect.getMetadata(I.metadata.options.controller,t)})(Z||(Z={}));var ji=class{constructor(e){this.ctx=e,this.DEFAULT_MIGRATION_TABLE_NAME="TAON_MIGRATION_META",this.MIGRATION_STATUS_COMPLETED="completed",this.MIGRATION_STATUS_PENDING="pending",this.table=new St({name:this.DEFAULT_MIGRATION_TABLE_NAME,columns:[{name:"id",type:"integer",isPrimary:!0,isGenerated:!0,generationStrategy:"increment"},{name:"name",type:"varchar",length:"255",isUnique:!0,isNullable:!1},{name:"context",type:"varchar",length:"255",isNullable:!1},{name:"applied_at",type:"timestamp",default:"CURRENT_TIMESTAMP",isNullable:!0},{name:"status",type:"varchar",length:"50",default:`'${this.MIGRATION_STATUS_COMPLETED}'`,isNullable:!1}]})}async ensureMigrationTableExists(){if(this.ctx.isRemoteHost||!this.ctx.connection)return;let e=this.ctx.connection.createQueryRunner();if(await e.connect(),await e.startTransaction(),await e.hasTable(this.DEFAULT_MIGRATION_TABLE_NAME)){this.ctx.logMigrations&&console.log(`Table ${this.DEFAULT_MIGRATION_TABLE_NAME} already exists.`),await e.commitTransaction(),await e.release();return}try{await e.createTable(this.table),await e.createIndex(this.DEFAULT_MIGRATION_TABLE_NAME,new Lt({name:"IDX_NAME",columnNames:["name"]})),await e.commitTransaction()}catch(n){this.ctx.logMigrations&&console.error("Transaction failed [ensureMigrationTableExists], rolling back:",n),await e.rollbackTransaction()}finally{await e.release()}}async logSelectALl(e,t){console.log(e,(await t.query(`SELECT * FROM ${this.DEFAULT_MIGRATION_TABLE_NAME} WHERE context = $1`,[this.ctx.contextName])).map(n=>n.name))}async revertMigrationToTimestamp(e){if(this.ctx.isRemoteHost||!this.ctx.connection)return;Cr.isValidTimestamp(e)||F.throw(`Invalid timestamp provided for migration revert: ${e}`);let n=this.ctx.getClassFunByArr(K.ClassType.MIGRATION).reverse().map(i=>Number(Cr.getTimestampFromClassName(Z.getName(i)))<=e?null:this.ctx.getInstanceBy(i)).filter(i=>!!i).map(i=>i).filter(i=>i.isReadyToRun()),s=this.ctx.connection.createQueryRunner();await s.connect();try{await s.startTransaction();let r=(await s.query(`SELECT name FROM ${this.DEFAULT_MIGRATION_TABLE_NAME}
         WHERE status = $1 AND context = $2`,[this.MIGRATION_STATUS_COMPLETED,this.ctx.contextName])).map(o=>o.name);for(let o of n){let c=Z.getName(o);if(!r.includes(c)){this.ctx.logMigrations&&console.warn(`Skipping migration not marked as applied: ${c}`);continue}this.ctx.logMigrations&&console.log(`Reverting migration: ${c} , context: ${this.ctx.contextName}`),await o.down(s),await s.query(`DELETE FROM ${this.DEFAULT_MIGRATION_TABLE_NAME} WHERE name = $1`,[c])}await s.commitTransaction(),this.ctx.logMigrations&&console.log(`Migrations successfully reverted to the specified timestamp ${e} .`)}catch(i){this.ctx.logMigrations&&console.error("Transaction failed, rolling back:",i),await s.rollbackTransaction()}finally{await s.release()}}async clearMigrationTable(){if(this.ctx.isRemoteHost||!this.ctx.connection)return;let e=this.ctx.connection.createQueryRunner();await e.connect(),await e.startTransaction();try{await e.clearTable(this.DEFAULT_MIGRATION_TABLE_NAME),await e.commitTransaction()}catch(t){this.ctx.logMigrations&&console.error("Transaction failed, rolling back:",t),await e.rollbackTransaction()}finally{await e.release()}}async markAllMigrationsAsApplied(){if(this.ctx.isRemoteHost||!this.ctx.connection)return;let t=this.ctx.getClassFunByArr(K.ClassType.MIGRATION).map(s=>this.ctx.getInstanceBy(s)).map(s=>s).filter(s=>s.isReadyToRun()),n=this.ctx.connection.createQueryRunner();await n.connect();try{await n.startTransaction();let i=(await n.query(`SELECT name FROM ${this.DEFAULT_MIGRATION_TABLE_NAME}`)).map(r=>r.name);for(let r of t){let o=Z.getName(r);if(i.includes(o)){this.ctx.logMigrations&&console.log(`Skipping already applied migration: ${o}`);continue}this.ctx.logMigrations&&console.log(`Marking migration as applied: ${o}`),await n.query(`INSERT INTO ${this.DEFAULT_MIGRATION_TABLE_NAME} (name, status, context, applied_at) VALUES ($1, $2, $3, CURRENT_TIMESTAMP)`,[o,this.MIGRATION_STATUS_COMPLETED,r.ctx.contextName])}await n.query(`UPDATE ${this.DEFAULT_MIGRATION_TABLE_NAME}
         SET status = $1, applied_at = CURRENT_TIMESTAMP
         WHERE status = $2`,[this.MIGRATION_STATUS_COMPLETED,this.MIGRATION_STATUS_PENDING]),await n.commitTransaction(),this.ctx.logMigrations&&console.log("All migrations marked as applied.")}catch(s){this.ctx.logMigrations&&console.error("Failed to mark all migrations as applied, rolling back:",s),await n.rollbackTransaction()}finally{await n.release()}}async runAllNotCompletedMigrations(){if(this.ctx.isRemoteHost||!this.ctx.connection)return;let t=this.ctx.getClassFunByArr(K.ClassType.MIGRATION).map(s=>this.ctx.getInstanceBy(s)).map(s=>s).filter(s=>s.isReadyToRun()),n=this.ctx.connection.createQueryRunner();await n.connect();try{await n.startTransaction();let s=await n.query(`SELECT name, status FROM ${this.DEFAULT_MIGRATION_TABLE_NAME} WHERE context = $1`,[this.ctx.contextName]),i=s.filter(r=>r.status===this.MIGRATION_STATUS_PENDING);for(let r of i){let o=t.find(c=>Z.getName(c)===r.name);if(!o){this.ctx.logMigrations&&console.warn(`Pending migration ${r.name} not found in loaded migrations.`);continue}this.ctx.logMigrations&&console.log(`Completing pending migration: ${r.name}`),await o.up(n),await n.query(`UPDATE ${this.DEFAULT_MIGRATION_TABLE_NAME}
           SET status = $1, applied_at = CURRENT_TIMESTAMP
           WHERE name = $2`,[this.MIGRATION_STATUS_COMPLETED,r.name])}for(let r of t){let o=Z.getName(r);if(s.some(c=>c.name===o)){this.ctx.logMigrations&&console.log(`Skipping already applied migration: ${o}`);continue}this.ctx.logMigrations&&console.log(`Applying new migration: ${o}`),await n.query(`INSERT INTO ${this.DEFAULT_MIGRATION_TABLE_NAME} (name, status, context, applied_at) VALUES ($1, $2, $3, NULL)`,[o,this.MIGRATION_STATUS_PENDING,this.ctx.contextName]);try{await r.up(n),await n.query(`UPDATE ${this.DEFAULT_MIGRATION_TABLE_NAME} SET status = '${this.MIGRATION_STATUS_COMPLETED}', applied_at = CURRENT_TIMESTAMP WHERE name = $1`,[o])}catch(c){throw this.ctx.logMigrations&&console.error(`Failed to apply migration: ${o}`,c),await n.query(`DELETE FROM ${this.DEFAULT_MIGRATION_TABLE_NAME} WHERE name = $1`,[o]),c}}await n.commitTransaction()}catch(s){this.ctx.logMigrations&&console.error("Transaction failed, rolling back:",s),await n.rollbackTransaction()}finally{await n.release()}}};var Ui=class a{static{this.instances=new Map}static resolve(e){if(a.instances.has(e))return a.instances.get(e);let t=[],n=new e(...t);return a.instances.set(e,n),n}static inject(e){return new Proxy({},{get:(t,n)=>{let s=a.instances.get(e)||a.resolve(e);return typeof s[n]=="function"?s[n].bind(s):s[n]},set:(t,n,s)=>{let i=a.instances.get(e)||a.resolve(e);return i[n]=s,!0}})}};var Kc=(a,e)=>{let{req:t,res:n}=e||{};return new Promise(async(s,i)=>{if(typeof a=="function"){let r=a;try{let o=await r(t,n);s(o)}catch(o){i(o)}}else i(`[taon] Not recognized type of response ${a}`)})};var Yc=wt(Go());var mt=(function(a){return a.fillUpTo=(e,t)=>y.times(t,n=>e.charAt(n)?e.charAt(n):" ").join(""),a.isGoodPath=e=>e&&typeof e=="string"&&e.trim()!=="",a.firstStringOrElemFromArray=e=>Array.isArray(e)?y.first(e):e,a.tryTransformParam=e=>{if(typeof e=="string"){let t=Number(e);if(!isNaN(t))return t;let n=e.trim().toLowerCase();if(n==="true")return!0;if(n==="false")return!1;try{return Yc.parse(e)}catch{return e}}return e},a.getExpressPath=(e,t)=>typeof t=="string"?`${e.calculatedPath}${t}`.replace(/\/$/,""):`${e.calculatedPath}${t.path}`.replace(/\/$/,""),a.defaultType=e=>{if(typeof e=="string")return"";if(typeof e=="boolean")return!1;if(Array.isArray(e))return{};if(typeof e=="object")return{}},a.parseJSONwithStringJSONs=(e,t=!1)=>{if(!y.isObject(e))return t&&console.error(`
        parseJSONwithStringJSONs(...)
        Parameter should be a object, but is ${typeof e}
        `,e),e;let n=y.cloneDeep(e);return Object.keys(n).forEach(s=>{let i=!1;try{let r=JSON.parse(n[s]);n[s]=r,i=!0}catch{i=!1}i&&(n[s]=a.parseJSONwithStringJSONs(n[s],!1))}),n},a.isPlainFileOrFolder=e=>/^([a-zA-Z]|\-|\_|\@|\#|\$|\!|\^|\&|\*|\(|\))+$/.test(e),a.ipcKeyNameResponse=(e,t,n)=>["response",Z.getName(e),t.methodName,t.type,n].join("--"),a.ipcKeyNameRequest=(e,t,n)=>["request",Z.getName(e),t.methodName,t.type,n].join("--"),a.websqlMocks=e=>({request:{},response:{status(s){return{send(i){}}},setHeader(s,i){e[s]=i}}}),a})(mt||{});var Vi=class{constructor(e){this.options=e,this.isListening=!1,this.observers=[]}startListenIfNotStarted(e){if(this.options.core.ctx.disabledRealtime){console.warn("[Taon][startListenIfNotStarted] sockets are disabled");return}if(!e){console.warn("[Taon][startListenIfNotStarted] invalid socket connection");return}if(!this.isListening){if(this.isListening=!0,this.options.customEvent){let t=I.REALTIME.ROOM_SUBSCRIBE_CUSTOM(this.options.core.ctx.contextName);e.emit(t,this.options.roomName)}else if(y.isString(this.options.property)){let t=I.REALTIME.ROOM_SUBSCRIBE_ENTITY_PROPERTY_UPDATE_EVENTS(this.options.core.ctx.contextName);e.emit(t,this.options.roomName)}else{let t=I.REALTIME.ROOM_SUBSCRIBE_ENTITY_UPDATE_EVENTS(this.options.core.ctx.contextName);e.emit(t,this.options.roomName)}e.on(this.options.roomName,t=>{this.update(t)})}}add(e){this.observers.push(e)}remove(e){if(this.observers=this.observers.filter(t=>t!==e),this.observers.length===0){this.isListening=!1;let{core:t,customEvent:n,roomName:s,property:i}=this.options,r=t.socketFE;n?r.emit(I.REALTIME.ROOM_UNSUBSCRIBE_CUSTOM(this.options.core.ctx.contextName),s):y.isString(i)?r.emit(I.REALTIME.ROOM_UNSUBSCRIBE_ENTITY_PROPERTY_UPDATE_EVENTS(this.options.core.ctx.contextName),s):r.emit(I.REALTIME.ROOM_UNSUBSCRIBE_ENTITY_UPDATE_EVENTS(this.options.core.ctx.contextName),s)}}update(e){this.observers.forEach(t=>{t.closed||t.next(e)})}};var ys=class{constructor(e){this.core=e,this.subsManagers={},this.core=e,e.ctx.disabledRealtime||this.init()}init(){let e={global:this.core.pathFor(),realtime:this.core.pathFor(I.REALTIME.NAMESPACE(this.core.ctx.contextName))};this.core.ctx.config.frontendHost&&this.core.ctx.config.frontendHost!==""&&this.core.ctx.isRunningInsideDocker?(this.core.ctx.logRealtime&&F.logInfo(`[${this.core.ctx.contextName}] USING FRONTEND HOST ${this.core.ctx.config.frontendHost} FOR REALTIME`),e.global=new URL(`${this.core.ctx.frontendHostUri.origin}${e.global.pathname}`),e.realtime=new URL(`${this.core.ctx.frontendHostUri.origin}${e.realtime.pathname}`)):this.core.ctx.logRealtime&&F.logInfo(`[${this.core.ctx.contextName}] Not using frontend host for realtime`),this.core.ctx.logRealtime&&console.info("[CLIENT] NAMESPACE GLOBAL ",e.global.href+` host: ${this.core.ctx.host}`),this.core.ctx.logRealtime&&console.info("[CLIENT] NAMESPACE REALTIME",e.realtime.href+` host: ${this.core.ctx.host}`),this.core.conectSocketFE=this.core.strategy.ioClient(e.global.origin,{path:e.global.pathname}),this.core.conectSocketFE.on&&this.core.conectSocketFE.on("connect",()=>{this.core.ctx.logRealtime&&console.info(`[CLIENT] connected to GLOBAL namespace ${e.global.pathname} of host: ${this.core.ctx.host}`)}),this.core.socketFE=this.core.strategy.ioClient(e.realtime.origin,{path:e.realtime.pathname}),this.core.socketFE.on&&this.core.socketFE.on("connect",()=>{this.core.ctx.logRealtime&&console.info(`[CLIENT] connected to REALTIME namespace ${e.realtime.pathname} host: ${this.core.ctx.host}`)})}listenChangesEntity(e,t){if(t=t||{},y.isObject(e)){let r=e;e=Z.getClassFnFromObject(e);let o=Z.getUniqueKey(e);o&&(t.idOrUniqValue=r[o])}let{property:n,customEvent:s}=t,i=!s&&Z.getName(e);if(y.isString(n)&&n.trim()==="")throw new Error(`[Taon][listenChangesEntity.. incorrect property '' for ${i}`);return new zn(r=>{if(this.core.ctx.disabledRealtime)return console.error(`[Taon][realtime rxjs] remove taon config flag:

        ...
        disabledRealtime: true
        ...

to use socket realtime connection;
        `),()=>{};let o;s?o=I.REALTIME.ROOM_NAME_CUSTOM(this.core.ctx.contextName,s):o=y.isString(n)?I.REALTIME.ROOM_NAME_UPDATE_ENTITY_PROPERTY(this.core.ctx.contextName,i,n,t.idOrUniqValue):I.REALTIME.ROOM_NAME_UPDATE_ENTITY(this.core.ctx.contextName,i,t.idOrUniqValue);let c={core:this.core,property:n,roomName:o,customEvent:s},l=this.getUniqueIdentifierForConnection(c);this.subsManagers[l]||(this.subsManagers[l]=new Vi(c));let u=this.subsManagers[l];return u.add(r),u.startListenIfNotStarted(this.core.socketFE),()=>{u.remove(r)}})}listenChangesEntityTable(e){let t=Z.getName(e);return this.listenChangesEntity(e,{customEvent:I.REALTIME.TABLE_CHANGE(this.core.ctx.contextName,t)})}listenChangesCustomEvent(e){return this.listenChangesEntity(void 0,{customEvent:e})}triggerCustomEvent(e,t){this.core.socketFE.emit(e,t)}getUniqueIdentifierForConnection(e){let t=new URL(e.core.ctx.host);return`${e.core.ctx.contextNameForCommunication}:${t.origin}|${e.roomName}|${e.property}|${e.customEvent}`}};var gs=class{constructor(e){this.core=e,this.core=e,!(e.ctx.disabledRealtime||this.core.ctx.isRemoteHost)&&this.init()}init(){this.core.ctx.config.frontendHost||console.warn(`[Taon][Realtime]

      Frontend host is not defined
      REALTIME COMMUNICATION WILL NOT WORK

      provide "frontendHost" property in your taon config

      `);let e=this.core.pathFor(),t=this.core.pathFor(I.REALTIME.NAMESPACE(this.core.ctx.contextName)),n={origin:this.core.ctx.frontendHostUri.origin,methods:this.core.allHttpMethods};this.core.connectSocketBE=this.core.strategy.ioServer(F.isWebSQL?this.core.ctx.uriOrigin:this.core.ctx.serverTcpUdp,{path:e.pathname,cors:n},this.core.ctx),this.core.ctx.logRealtime&&console.info(`[backend] CREATE GLOBAL NAMESPACE: '${this.core.connectSocketBE.path()}' , path: '${e.pathname}'`),this.core.connectSocketBE.on("connection",s=>{this.core.ctx.logRealtime&&console.info(`[backend] client connected to namespace "${e.pathname}",  host: ${this.core.ctx.host}`)}),this.core.socketBE=this.core.strategy.ioServer(F.isWebSQL||F.isElectron?this.core.ctx.uriOrigin:this.core.ctx.serverTcpUdp,{path:t.pathname,cors:n},this.core.ctx),this.core.ctx.logRealtime&&console.info(`[backend] CREATE REALTIME NAMESPACE: '${this.core.socketBE.path()}' , path: '${t.pathname}' `),this.core.socketBE.on("connection",s=>{this.core.ctx.logRealtime&&console.info(`[backend] client connected to namespace "${t.pathname}",  host: ${this.core.ctx.host}`),s.on(I.REALTIME.ROOM_SUBSCRIBE_CUSTOM(this.core.ctx.contextName),i=>{this.core.ctx.logRealtime&&console.info(`Joining room ${i} in namespace  REALTIME host: ${this.core.ctx.contextName}/${this.core.ctx.host}`),s.join(i)}),s.on(I.REALTIME.ROOM_SUBSCRIBE_ENTITY_UPDATE_EVENTS(this.core.ctx.contextName),i=>{this.core.ctx.logRealtime&&console.info(`[backend] Joining room ${i} in namespace  REALTIME host: ${this.core.ctx.contextName}/${this.core.ctx.host}`),s.join(i)}),s.on(I.REALTIME.ROOM_SUBSCRIBE_ENTITY_PROPERTY_UPDATE_EVENTS(this.core.ctx.contextName),i=>{this.core.ctx.logRealtime&&console.info(`[backend] Joining room ${i} in namespace REALTIME  host: ${this.core.ctx.contextName}/${this.core.ctx.host}`),s.join(i)}),s.on(I.REALTIME.ROOM_UNSUBSCRIBE_CUSTOM(this.core.ctx.contextName),i=>{this.core.ctx.logRealtime&&console.info(`[backend] Leaving room ${i} in namespace  REALTIME host: ${this.core.ctx.contextName}/${this.core.ctx.host}`),s.leave(i)}),s.on(I.REALTIME.ROOM_UNSUBSCRIBE_ENTITY_UPDATE_EVENTS(this.core.ctx.contextName),i=>{this.core.ctx.logRealtime&&console.info(`[backend] Leaving room ${i} in namespace REALTIME  host: ${this.core.ctx.contextName}/${this.core.ctx.host}`),s.leave(i)}),s.on(I.REALTIME.ROOM_UNSUBSCRIBE_ENTITY_PROPERTY_UPDATE_EVENTS(this.core.ctx.contextName),i=>{this.core.ctx.logRealtime&&console.info(`[backend] Leaving room ${i} in namespace REALTIME  host: ${this.core.ctx.contextName}/${this.core.ctx.host}`),s.leave(i)})})}triggerChanges(e,t,n,s,i){let r;if(!(this.core.ctx.disabledRealtime||this.core.ctx.isRemoteHost)){if(s)r=I.REALTIME.ROOM_NAME_CUSTOM(this.core.ctx.contextName,s);else{let o=e,c=!y.isFunction(e)&&y.isObject(e);c&&(o=Z.getClassFnFromObject(e));let l=Z.getUniqueKey(o);if(c&&(n=e[l]),!n){F.error(`[Taon][Realtime] Entity without iD ! ${Z.getName(o)} `,!0,!0);return}r=y.isString(t)?I.REALTIME.ROOM_NAME_UPDATE_ENTITY_PROPERTY(this.core.ctx.contextName,Z.getName(o),t,n):I.REALTIME.ROOM_NAME_UPDATE_ENTITY(this.core.ctx.contextName,Z.getName(o),n)}this.core.socketBE.in(r).emit(r,s?i:"")}}triggerEntityChanges(e,t){if(this.core.ctx.disabledRealtime){let n=Z.getName(e);console.warn(`[Taon][TriggerEntityChanges] Entity "${n}' is not realtime`);return}this.triggerChanges(e,void 0,t)}triggerEntityPropertyChanges(e,t,n){if(this.core.ctx.disabledRealtime){let s=Z.getName(e);console.warn(`[Taon][TriggerEntityPropertyChanges][property=${t}] Entity "${s}' is not realtime`);return}y.isArray(t)?t.forEach(s=>{this.triggerChanges(e,s,n)}):this.triggerChanges(e,t,n)}triggerEntityTableChanges(e){let t=Z.getName(e);if(this.core.ctx.disabledRealtime){console.warn(`[Taon][TriggerEntityTableChanges] Entity "${t}' is not realtime`);return}this.triggerChanges(e,void 0,void 0,I.REALTIME.TABLE_CHANGE(this.core.ctx.contextName,t))}triggerCustomEvent(e,t){this.triggerChanges(void 0,void 0,void 0,e,t)}listenChangesCustomEvent(e){let t=new Oe;return this.core.socketBE.on("connection",n=>{n.on(e,(s,...i)=>{t.next(s)})}),t.asObservable()}};var jt=class{constructor(e){this.ctx=e}get ioClient(){throw new Error("Not implemented")}ioServer(e,t){throw new Error("Not implemented")}};var Eo=class a{static{this.serverByContextName=new Map}static from(e){return a.serverByContextName.has(e)||a.serverByContextName.set(e,new a(e)),a.serverByContextName.get(e)}constructor(e){this.contextName=e,this.namespacesByName=new Map,a.serverByContextName.set(e,this)}of(e){return this.namespacesByName.has(e)||this.namespacesByName.set(e,new To(e,this)),this.namespacesByName.get(e)}},To=class{constructor(e,t){this.name=e,this.server=t,this.electronClients=new Set,this.roomsByRoomName={},this.namespaceEventHandlers={}}on(e,t){}off(e,t){}emit(e,...t){}to(e){let t=this.roomsByRoomName[e];return new Wi(t,this.name,!0)}in(e){let t=this.roomsByRoomName[e];return new Wi(t,this.name,!1)}join(e,t){this.roomsByRoomName[t]||(this.roomsByRoomName[t]=new Set),this.roomsByRoomName[t].add(e)}leave(e,t){this.roomsByRoomName[t]&&(this.roomsByRoomName[t].delete(e),this.roomsByRoomName[t].size===0&&delete this.roomsByRoomName[t])}path(){return this.name}get nsp(){let e=this;return{get name(){return e.name}}}},Wi=class{constructor(e,t,n=!1,s=null){this.electronClients=e,this.name=t,this.includeSender=n,this.sender=s}emit(e,...t){let n=`(${this.name}) "${e}"`;this.electronClients?.forEach(s=>{s.send(n,...t)})}},Co=class{get name(){return this.namespaceName}constructor(e){this.namespaceName=e,this.socketEventHandlers={},this.ipcRenderer=window.require("electron").ipcRenderer}on(e,t){this.socketEventHandlers[e]||(this.socketEventHandlers[e]=new Set),this.socketEventHandlers[e].add(t);let n=`(${this.name}) "${e}"`;if(this.ipcRenderer.on(n,(s,i)=>{t(i)}),e==="connect"){let s=`(${this.name}) "connection"`;this.ipcRenderer.send(s,this.name)}}off(e,t){if(!this.socketEventHandlers[e])return;t?this.socketEventHandlers[e].delete(t):delete this.socketEventHandlers[e];let n=`(${this.name}) "${e}"`;this.ipcRenderer.removeListener(n,s=>{t(s)})}emit(e,...t){let n=`(${this.name}) "${e}"`;this.ipcRenderer.send(n,...t)}},Qi=class extends jt{toString(){return"ipc"}constructor(e){super(e),this.ctx=e}ioServer(e,t){let n=t?.path||"/";return Eo.from(this.ctx.contextName).of(n)}get ioClient(){return(t,n)=>{let s=n?.path||"/";return new Co(s)}}};var Gi=class a{static{this.serverByUrl=new Map}static from(e){return a.serverByUrl.has(e)||a.serverByUrl.set(e,new a(e)),a.serverByUrl.get(e)}get allServers(){return Array.from(a.serverByUrl.values())}constructor(e){this.url=e,this.namespacesByName=new Map,a.serverByUrl.set(e,this)}of(e){return this.namespacesByName.has(e)||this.namespacesByName.set(e,new No(e,this)),this.namespacesByName.get(e)}path(){return this.url}},No=class{constructor(e,t){this.name=e,this.server=t,this.allSocketsForNamespace=new Set,this.socketByRoomName={},this.namespaceEventHandlers={}}on(e,t){this.namespaceEventHandlers[e]||(this.namespaceEventHandlers[e]=new Set),this.namespaceEventHandlers[e].has(t)||this.namespaceEventHandlers[e].add(t),e==="connection"&&setTimeout(()=>{this.emit("connection",this)})}emit(e,...t){this.allSocketsForNamespace?.forEach(n=>{n.emit(e,...t)})}connect(e){this.allSocketsForNamespace.add(e),e.namespaceInstance=this}to(e){let t=this.socketByRoomName[e];return new Ji(t,!0)}in(e){let t=this.socketByRoomName[e];return new Ji(t,!1)}joinRoom(e,t){this.socketByRoomName[e]||(this.socketByRoomName[e]=new Set),this.socketByRoomName[e].add(t)}leaveRoom(e,t){this.socketByRoomName[e]&&this.socketByRoomName[e].delete(t)}get nsp(){let e=this;return{get name(){return e.name}}}path(){return this.name}},Ji=class{constructor(e,t=!1,n=null){this.sockets=e,this.includeSender=t,this.sender=n}emit(e,...t){this.sockets?.forEach(n=>{(this.includeSender||n!==this.sender)&&n.emit(e,...t)})}},vo=class{get id(){return this.nsp.name}constructor(e,t){this.url=e,this.socketEventHandlers={};let[n,s]=[e,t.path||"/"],i=s||"/";Gi.from(e).of(i).connect(this)}get nsp(){let e=this;return{get name(){return e.namespaceInstance?.name}}}path(){return this.namespaceInstance?.name}on(e,t){this.socketEventHandlers[e]||(this.socketEventHandlers[e]=new Set),this.socketEventHandlers[e].add(t),e==="connect"&&setTimeout(()=>{this.emit("connect")})}emit(e,...t){if(e=e||"",e.includes(`:${I.REALTIME.KEYroomSubscribe}`)){let n=t[0];this.join(n)}else if(e.includes(`:${I.REALTIME.KEYroomUnsubscribe}`)){let n=t[0];this.leave(n)}else if(this.namespaceInstance){let n=this.namespaceInstance.namespaceEventHandlers[e]||[];for(let r of n)r&&r(...t);let s=Array.from(this.namespaceInstance.allSocketsForNamespace.values()).filter(r=>r!==this);for(let r of s){let o=r.socketEventHandlers[e];for(let c of o)c&&c(...t)}let i=this.socketEventHandlers[e]||[];for(let r of i)r&&r(...t)}}join(e){this.namespaceInstance.joinRoom(e,this)}leave(e){this.namespaceInstance.leaveRoom(e,this)}},zi=class extends jt{toString(){return"mock"}constructor(e){super(e),this.ctx=e}ioServer(e,t){return Gi.from(e||this.ctx.uriOrigin).of(t?.path||"/")}get ioClient(){return(t,n)=>new vo(t||this.ctx.uriOrigin,n)}};var ot=Object.create(null);ot.open="0";ot.close="1";ot.ping="2";ot.pong="3";ot.message="4";ot.upgrade="5";ot.noop="6";var bs=Object.create(null);Object.keys(ot).forEach(a=>{bs[ot[a]]=a});var ws={type:"error",data:"parser error"};var el=typeof Blob=="function"||typeof Blob<"u"&&Object.prototype.toString.call(Blob)==="[object BlobConstructor]",tl=typeof ArrayBuffer=="function",nl=a=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(a):a&&a.buffer instanceof ArrayBuffer,Es=({type:a,data:e},t,n)=>el&&e instanceof Blob?t?n(e):Zc(e,n):tl&&(e instanceof ArrayBuffer||nl(e))?t?n(e):Zc(new Blob([e]),n):n(ot[a]+(e||"")),Zc=(a,e)=>{let t=new FileReader;return t.onload=function(){let n=t.result.split(",")[1];e("b"+(n||""))},t.readAsDataURL(a)};function Xc(a){return a instanceof Uint8Array?a:a instanceof ArrayBuffer?new Uint8Array(a):new Uint8Array(a.buffer,a.byteOffset,a.byteLength)}var Ro;function sl(a,e){if(el&&a.data instanceof Blob)return a.data.arrayBuffer().then(Xc).then(e);if(tl&&(a.data instanceof ArrayBuffer||nl(a.data)))return e(Xc(a.data));Es(a,!1,t=>{Ro||(Ro=new TextEncoder),e(Ro.encode(t))})}var il="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",Ts=typeof Uint8Array>"u"?[]:new Uint8Array(256);for(let a=0;a<il.length;a++)Ts[il.charCodeAt(a)]=a;var rl=a=>{let e=a.length*.75,t=a.length,n,s=0,i,r,o,c;a[a.length-1]==="="&&(e--,a[a.length-2]==="="&&e--);let l=new ArrayBuffer(e),u=new Uint8Array(l);for(n=0;n<t;n+=4)i=Ts[a.charCodeAt(n)],r=Ts[a.charCodeAt(n+1)],o=Ts[a.charCodeAt(n+2)],c=Ts[a.charCodeAt(n+3)],u[s++]=i<<2|r>>4,u[s++]=(r&15)<<4|o>>2,u[s++]=(o&3)<<6|c&63;return l};var wh=typeof ArrayBuffer=="function",Cs=(a,e)=>{if(typeof a!="string")return{type:"message",data:al(a,e)};let t=a.charAt(0);return t==="b"?{type:"message",data:Eh(a.substring(1),e)}:bs[t]?a.length>1?{type:bs[t],data:a.substring(1)}:{type:bs[t]}:ws},Eh=(a,e)=>{if(wh){let t=rl(a);return al(t,e)}else return{base64:!0,data:a}},al=(a,e)=>{switch(e){case"blob":return a instanceof Blob?a:new Blob([a]);case"arraybuffer":default:return a instanceof ArrayBuffer?a:a.buffer}};var ol="",cl=(a,e)=>{let t=a.length,n=new Array(t),s=0;a.forEach((i,r)=>{Es(i,!1,o=>{n[r]=o,++s===t&&e(n.join(ol))})})},ll=(a,e)=>{let t=a.split(ol),n=[];for(let s=0;s<t.length;s++){let i=Cs(t[s],e);if(n.push(i),i.type==="error")break}return n};function ul(){return new TransformStream({transform(a,e){sl(a,t=>{let n=t.length,s;if(n<126)s=new Uint8Array(1),new DataView(s.buffer).setUint8(0,n);else if(n<65536){s=new Uint8Array(3);let i=new DataView(s.buffer);i.setUint8(0,126),i.setUint16(1,n)}else{s=new Uint8Array(9);let i=new DataView(s.buffer);i.setUint8(0,127),i.setBigUint64(1,BigInt(n))}a.data&&typeof a.data!="string"&&(s[0]|=128),e.enqueue(s),e.enqueue(t)})}})}var xo;function Hi(a){return a.reduce((e,t)=>e+t.length,0)}function Ki(a,e){if(a[0].length===e)return a.shift();let t=new Uint8Array(e),n=0;for(let s=0;s<e;s++)t[s]=a[0][n++],n===a[0].length&&(a.shift(),n=0);return a.length&&n<a[0].length&&(a[0]=a[0].slice(n)),t}function hl(a,e){xo||(xo=new TextDecoder);let t=[],n=0,s=-1,i=!1;return new TransformStream({transform(r,o){for(t.push(r);;){if(n===0){if(Hi(t)<1)break;let c=Ki(t,1);i=(c[0]&128)===128,s=c[0]&127,s<126?n=3:s===126?n=1:n=2}else if(n===1){if(Hi(t)<2)break;let c=Ki(t,2);s=new DataView(c.buffer,c.byteOffset,c.length).getUint16(0),n=3}else if(n===2){if(Hi(t)<8)break;let c=Ki(t,8),l=new DataView(c.buffer,c.byteOffset,c.length),u=l.getUint32(0);if(u>Math.pow(2,21)-1){o.enqueue(ws);break}s=u*Math.pow(2,32)+l.getUint32(4),n=3}else{if(Hi(t)<s)break;let c=Ki(t,s);o.enqueue(Cs(i?c:xo.decode(c),e)),n=0}if(s===0||s>a){o.enqueue(ws);break}}}})}var So=4;function ve(a){if(a)return Th(a)}function Th(a){for(var e in ve.prototype)a[e]=ve.prototype[e];return a}ve.prototype.on=ve.prototype.addEventListener=function(a,e){return this._callbacks=this._callbacks||{},(this._callbacks["$"+a]=this._callbacks["$"+a]||[]).push(e),this};ve.prototype.once=function(a,e){function t(){this.off(a,t),e.apply(this,arguments)}return t.fn=e,this.on(a,t),this};ve.prototype.off=ve.prototype.removeListener=ve.prototype.removeAllListeners=ve.prototype.removeEventListener=function(a,e){if(this._callbacks=this._callbacks||{},arguments.length==0)return this._callbacks={},this;var t=this._callbacks["$"+a];if(!t)return this;if(arguments.length==1)return delete this._callbacks["$"+a],this;for(var n,s=0;s<t.length;s++)if(n=t[s],n===e||n.fn===e){t.splice(s,1);break}return t.length===0&&delete this._callbacks["$"+a],this};ve.prototype.emit=function(a){this._callbacks=this._callbacks||{};for(var e=new Array(arguments.length-1),t=this._callbacks["$"+a],n=1;n<arguments.length;n++)e[n-1]=arguments[n];if(t){t=t.slice(0);for(var n=0,s=t.length;n<s;++n)t[n].apply(this,e)}return this};ve.prototype.emitReserved=ve.prototype.emit;ve.prototype.listeners=function(a){return this._callbacks=this._callbacks||{},this._callbacks["$"+a]||[]};ve.prototype.hasListeners=function(a){return!!this.listeners(a).length};var qe=typeof self<"u"?self:typeof window<"u"?window:Function("return this")();function Yi(a,...e){return e.reduce((t,n)=>(a.hasOwnProperty(n)&&(t[n]=a[n]),t),{})}var Ch=qe.setTimeout,Nh=qe.clearTimeout;function Mt(a,e){e.useNativeTimers?(a.setTimeoutFn=Ch.bind(qe),a.clearTimeoutFn=Nh.bind(qe)):(a.setTimeoutFn=qe.setTimeout.bind(qe),a.clearTimeoutFn=qe.clearTimeout.bind(qe))}var vh=1.33;function dl(a){return typeof a=="string"?Rh(a):Math.ceil((a.byteLength||a.size)*vh)}function Rh(a){let e=0,t=0;for(let n=0,s=a.length;n<s;n++)e=a.charCodeAt(n),e<128?t+=1:e<2048?t+=2:e<55296||e>=57344?t+=3:(n++,t+=4);return t}function fl(a){let e="";for(let t in a)a.hasOwnProperty(t)&&(e.length&&(e+="&"),e+=encodeURIComponent(t)+"="+encodeURIComponent(a[t]));return e}function pl(a){let e={},t=a.split("&");for(let n=0,s=t.length;n<s;n++){let i=t[n].split("=");e[decodeURIComponent(i[0])]=decodeURIComponent(i[1])}return e}var Zi=class extends Error{constructor(e,t,n){super(e),this.description=t,this.context=n,this.type="TransportError"}},At=class extends ve{constructor(e){super(),this.writable=!1,Mt(this,e),this.opts=e,this.query=e.query,this.socket=e.socket}onError(e,t,n){return super.emitReserved("error",new Zi(e,t,n)),this}open(){return this.readyState="opening",this.doOpen(),this}close(){return(this.readyState==="opening"||this.readyState==="open")&&(this.doClose(),this.onClose()),this}send(e){this.readyState==="open"&&this.write(e)}onOpen(){this.readyState="open",this.writable=!0,super.emitReserved("open")}onData(e){let t=Cs(e,this.socket.binaryType);this.onPacket(t)}onPacket(e){super.emitReserved("packet",e)}onClose(e){this.readyState="closed",super.emitReserved("close",e)}pause(e){}createUri(e,t={}){return e+"://"+this._hostname()+this._port()+this.opts.path+this._query(t)}_hostname(){let e=this.opts.hostname;return e.indexOf(":")===-1?e:"["+e+"]"}_port(){return this.opts.port&&(this.opts.secure&&+(this.opts.port!==443)||!this.opts.secure&&Number(this.opts.port)!==80)?":"+this.opts.port:""}_query(e){let t=fl(e);return t.length?"?"+t:""}};var bl="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz-_".split(""),Mo=64,xh={},ml=0,Xi=0,yl;function gl(a){let e="";do e=bl[a%Mo]+e,a=Math.floor(a/Mo);while(a>0);return e}function er(){let a=gl(+new Date);return a!==yl?(ml=0,yl=a):a+"."+gl(ml++)}for(;Xi<Mo;Xi++)xh[bl[Xi]]=Xi;var wl=!1;try{wl=typeof XMLHttpRequest<"u"&&"withCredentials"in new XMLHttpRequest}catch{}var El=wl;function Ao(a){let e=a.xdomain;try{if(typeof XMLHttpRequest<"u"&&(!e||El))return new XMLHttpRequest}catch{}if(!e)try{return new qe[["Active"].concat("Object").join("X")]("Microsoft.XMLHTTP")}catch{}}function Sh(){}var Mh=(function(){return new Ao({xdomain:!1}).responseType!=null})(),nr=class extends At{constructor(e){if(super(e),this.polling=!1,typeof location<"u"){let n=location.protocol==="https:",s=location.port;s||(s=n?"443":"80"),this.xd=typeof location<"u"&&e.hostname!==location.hostname||s!==e.port}let t=e&&e.forceBase64;this.supportsBinary=Mh&&!t,this.opts.withCredentials&&(this.cookieJar=void 0)}get name(){return"polling"}doOpen(){this.poll()}pause(e){this.readyState="pausing";let t=()=>{this.readyState="paused",e()};if(this.polling||!this.writable){let n=0;this.polling&&(n++,this.once("pollComplete",function(){--n||t()})),this.writable||(n++,this.once("drain",function(){--n||t()}))}else t()}poll(){this.polling=!0,this.doPoll(),this.emitReserved("poll")}onData(e){let t=n=>{if(this.readyState==="opening"&&n.type==="open"&&this.onOpen(),n.type==="close")return this.onClose({description:"transport closed by the server"}),!1;this.onPacket(n)};ll(e,this.socket.binaryType).forEach(t),this.readyState!=="closed"&&(this.polling=!1,this.emitReserved("pollComplete"),this.readyState==="open"&&this.poll())}doClose(){let e=()=>{this.write([{type:"close"}])};this.readyState==="open"?e():this.once("open",e)}write(e){this.writable=!1,cl(e,t=>{this.doWrite(t,()=>{this.writable=!0,this.emitReserved("drain")})})}uri(){let e=this.opts.secure?"https":"http",t=this.query||{};return this.opts.timestampRequests!==!1&&(t[this.opts.timestampParam]=er()),!this.supportsBinary&&!t.sid&&(t.b64=1),this.createUri(e,t)}request(e={}){return Object.assign(e,{xd:this.xd,cookieJar:this.cookieJar},this.opts),new tr(this.uri(),e)}doWrite(e,t){let n=this.request({method:"POST",data:e});n.on("success",t),n.on("error",(s,i)=>{this.onError("xhr post error",s,i)})}doPoll(){let e=this.request();e.on("data",this.onData.bind(this)),e.on("error",(t,n)=>{this.onError("xhr poll error",t,n)}),this.pollXhr=e}},tr=(()=>{class a extends ve{constructor(t,n){super(),Mt(this,n),this.opts=n,this.method=n.method||"GET",this.uri=t,this.data=n.data!==void 0?n.data:null,this.create()}create(){var t;let n=Yi(this.opts,"agent","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","autoUnref");n.xdomain=!!this.opts.xd;let s=this.xhr=new Ao(n);try{s.open(this.method,this.uri,!0);try{if(this.opts.extraHeaders){s.setDisableHeaderCheck&&s.setDisableHeaderCheck(!0);for(let i in this.opts.extraHeaders)this.opts.extraHeaders.hasOwnProperty(i)&&s.setRequestHeader(i,this.opts.extraHeaders[i])}}catch{}if(this.method==="POST")try{s.setRequestHeader("Content-type","text/plain;charset=UTF-8")}catch{}try{s.setRequestHeader("Accept","*/*")}catch{}(t=this.opts.cookieJar)===null||t===void 0||t.addCookies(s),"withCredentials"in s&&(s.withCredentials=this.opts.withCredentials),this.opts.requestTimeout&&(s.timeout=this.opts.requestTimeout),s.onreadystatechange=()=>{var i;s.readyState===3&&((i=this.opts.cookieJar)===null||i===void 0||i.parseCookies(s)),s.readyState===4&&(s.status===200||s.status===1223?this.onLoad():this.setTimeoutFn(()=>{this.onError(typeof s.status=="number"?s.status:0)},0))},s.send(this.data)}catch(i){this.setTimeoutFn(()=>{this.onError(i)},0);return}typeof document<"u"&&(this.index=a.requestsCount++,a.requests[this.index]=this)}onError(t){this.emitReserved("error",t,this.xhr),this.cleanup(!0)}cleanup(t){if(!(typeof this.xhr>"u"||this.xhr===null)){if(this.xhr.onreadystatechange=Sh,t)try{this.xhr.abort()}catch{}typeof document<"u"&&delete a.requests[this.index],this.xhr=null}}onLoad(){let t=this.xhr.responseText;t!==null&&(this.emitReserved("data",t),this.emitReserved("success"),this.cleanup())}abort(){this.cleanup()}}return a.requestsCount=0,a.requests={},a})();if(typeof document<"u"){if(typeof attachEvent=="function")attachEvent("onunload",Tl);else if(typeof addEventListener=="function"){let a="onpagehide"in qe?"pagehide":"unload";addEventListener(a,Tl,!1)}}function Tl(){for(let a in tr.requests)tr.requests.hasOwnProperty(a)&&tr.requests[a].abort()}var en=typeof Promise=="function"&&typeof Promise.resolve=="function"?e=>Promise.resolve().then(e):(e,t)=>t(e,0),Ns=qe.WebSocket||qe.MozWebSocket,sr=!0,Cl="arraybuffer";var Nl=typeof navigator<"u"&&typeof navigator.product=="string"&&navigator.product.toLowerCase()==="reactnative",ir=class extends At{constructor(e){super(e),this.supportsBinary=!e.forceBase64}get name(){return"websocket"}doOpen(){if(!this.check())return;let e=this.uri(),t=this.opts.protocols,n=Nl?{}:Yi(this.opts,"agent","perMessageDeflate","pfx","key","passphrase","cert","ca","ciphers","rejectUnauthorized","localAddress","protocolVersion","origin","maxPayload","family","checkServerIdentity");this.opts.extraHeaders&&(n.headers=this.opts.extraHeaders);try{this.ws=sr&&!Nl?t?new Ns(e,t):new Ns(e):new Ns(e,t,n)}catch(s){return this.emitReserved("error",s)}this.ws.binaryType=this.socket.binaryType,this.addEventListeners()}addEventListeners(){this.ws.onopen=()=>{this.opts.autoUnref&&this.ws._socket.unref(),this.onOpen()},this.ws.onclose=e=>this.onClose({description:"websocket connection closed",context:e}),this.ws.onmessage=e=>this.onData(e.data),this.ws.onerror=e=>this.onError("websocket error",e)}write(e){this.writable=!1;for(let t=0;t<e.length;t++){let n=e[t],s=t===e.length-1;Es(n,this.supportsBinary,i=>{let r={};sr||(n.options&&(r.compress=n.options.compress),this.opts.perMessageDeflate&&(typeof i=="string"?Buffer.byteLength(i):i.length)<this.opts.perMessageDeflate.threshold&&(r.compress=!1));try{sr?this.ws.send(i):this.ws.send(i,r)}catch{}s&&en(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){typeof this.ws<"u"&&(this.ws.close(),this.ws=null)}uri(){let e=this.opts.secure?"wss":"ws",t=this.query||{};return this.opts.timestampRequests&&(t[this.opts.timestampParam]=er()),this.supportsBinary||(t.b64=1),this.createUri(e,t)}check(){return!!Ns}};var rr=class extends At{get name(){return"webtransport"}doOpen(){typeof WebTransport=="function"&&(this.transport=new WebTransport(this.createUri("https"),this.opts.transportOptions[this.name]),this.transport.closed.then(()=>{this.onClose()}).catch(e=>{this.onError("webtransport error",e)}),this.transport.ready.then(()=>{this.transport.createBidirectionalStream().then(e=>{let t=hl(Number.MAX_SAFE_INTEGER,this.socket.binaryType),n=e.readable.pipeThrough(t).getReader(),s=ul();s.readable.pipeTo(e.writable),this.writer=s.writable.getWriter();let i=()=>{n.read().then(({done:o,value:c})=>{o||(this.onPacket(c),i())}).catch(o=>{})};i();let r={type:"open"};this.query.sid&&(r.data=`{"sid":"${this.query.sid}"}`),this.writer.write(r).then(()=>this.onOpen())})}))}write(e){this.writable=!1;for(let t=0;t<e.length;t++){let n=e[t],s=t===e.length-1;this.writer.write(n).then(()=>{s&&en(()=>{this.writable=!0,this.emitReserved("drain")},this.setTimeoutFn)})}}doClose(){var e;(e=this.transport)===null||e===void 0||e.close()}};var Oo={websocket:ir,webtransport:rr,polling:nr};var Ah=/^(?:(?![^:@\/?#]+:[^:@\/]*@)(http|https|ws|wss):\/\/)?((?:(([^:@\/?#]*)(?::([^:@\/?#]*))?)?@)?((?:[a-f0-9]{0,4}:){2,7}[a-f0-9]{0,4}|[^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,Oh=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"];function $n(a){if(a.length>2e3)throw"URI too long";let e=a,t=a.indexOf("["),n=a.indexOf("]");t!=-1&&n!=-1&&(a=a.substring(0,t)+a.substring(t,n).replace(/:/g,";")+a.substring(n,a.length));let s=Ah.exec(a||""),i={},r=14;for(;r--;)i[Oh[r]]=s[r]||"";return t!=-1&&n!=-1&&(i.source=e,i.host=i.host.substring(1,i.host.length-1).replace(/;/g,":"),i.authority=i.authority.replace("[","").replace("]","").replace(/;/g,":"),i.ipv6uri=!0),i.pathNames=Ph(i,i.path),i.queryKey=_h(i,i.query),i}function Ph(a,e){let t=/\/{2,9}/g,n=e.replace(t,"/").split("/");return(e.slice(0,1)=="/"||e.length===0)&&n.splice(0,1),e.slice(-1)=="/"&&n.splice(n.length-1,1),n}function _h(a,e){let t={};return e.replace(/(?:^|&)([^&=]*)=?([^&]*)/g,function(n,s,i){s&&(t[s]=i)}),t}var ar=(()=>{class a extends ve{constructor(t,n={}){super(),this.binaryType=Cl,this.writeBuffer=[],t&&typeof t=="object"&&(n=t,t=null),t?(t=$n(t),n.hostname=t.host,n.secure=t.protocol==="https"||t.protocol==="wss",n.port=t.port,t.query&&(n.query=t.query)):n.host&&(n.hostname=$n(n.host).host),Mt(this,n),this.secure=n.secure!=null?n.secure:typeof location<"u"&&location.protocol==="https:",n.hostname&&!n.port&&(n.port=this.secure?"443":"80"),this.hostname=n.hostname||(typeof location<"u"?location.hostname:"localhost"),this.port=n.port||(typeof location<"u"&&location.port?location.port:this.secure?"443":"80"),this.transports=n.transports||["polling","websocket","webtransport"],this.writeBuffer=[],this.prevBufferLen=0,this.opts=Object.assign({path:"/engine.io",agent:!1,withCredentials:!1,upgrade:!0,timestampParam:"t",rememberUpgrade:!1,addTrailingSlash:!0,rejectUnauthorized:!0,perMessageDeflate:{threshold:1024},transportOptions:{},closeOnBeforeunload:!1},n),this.opts.path=this.opts.path.replace(/\/$/,"")+(this.opts.addTrailingSlash?"/":""),typeof this.opts.query=="string"&&(this.opts.query=pl(this.opts.query)),this.id=null,this.upgrades=null,this.pingInterval=null,this.pingTimeout=null,this.pingTimeoutTimer=null,typeof addEventListener=="function"&&(this.opts.closeOnBeforeunload&&(this.beforeunloadEventListener=()=>{this.transport&&(this.transport.removeAllListeners(),this.transport.close())},addEventListener("beforeunload",this.beforeunloadEventListener,!1)),this.hostname!=="localhost"&&(this.offlineEventListener=()=>{this.onClose("transport close",{description:"network connection lost"})},addEventListener("offline",this.offlineEventListener,!1))),this.open()}createTransport(t){let n=Object.assign({},this.opts.query);n.EIO=So,n.transport=t,this.id&&(n.sid=this.id);let s=Object.assign({},this.opts,{query:n,socket:this,hostname:this.hostname,secure:this.secure,port:this.port},this.opts.transportOptions[t]);return new Oo[t](s)}open(){let t;if(this.opts.rememberUpgrade&&a.priorWebsocketSuccess&&this.transports.indexOf("websocket")!==-1)t="websocket";else if(this.transports.length===0){this.setTimeoutFn(()=>{this.emitReserved("error","No transports available")},0);return}else t=this.transports[0];this.readyState="opening";try{t=this.createTransport(t)}catch{this.transports.shift(),this.open();return}t.open(),this.setTransport(t)}setTransport(t){this.transport&&this.transport.removeAllListeners(),this.transport=t,t.on("drain",this.onDrain.bind(this)).on("packet",this.onPacket.bind(this)).on("error",this.onError.bind(this)).on("close",n=>this.onClose("transport close",n))}probe(t){let n=this.createTransport(t),s=!1;a.priorWebsocketSuccess=!1;let i=()=>{s||(n.send([{type:"ping",data:"probe"}]),n.once("packet",d=>{if(!s)if(d.type==="pong"&&d.data==="probe"){if(this.upgrading=!0,this.emitReserved("upgrading",n),!n)return;a.priorWebsocketSuccess=n.name==="websocket",this.transport.pause(()=>{s||this.readyState!=="closed"&&(h(),this.setTransport(n),n.send([{type:"upgrade"}]),this.emitReserved("upgrade",n),n=null,this.upgrading=!1,this.flush())})}else{let f=new Error("probe error");f.transport=n.name,this.emitReserved("upgradeError",f)}}))};function r(){s||(s=!0,h(),n.close(),n=null)}let o=d=>{let f=new Error("probe error: "+d);f.transport=n.name,r(),this.emitReserved("upgradeError",f)};function c(){o("transport closed")}function l(){o("socket closed")}function u(d){n&&d.name!==n.name&&r()}let h=()=>{n.removeListener("open",i),n.removeListener("error",o),n.removeListener("close",c),this.off("close",l),this.off("upgrading",u)};n.once("open",i),n.once("error",o),n.once("close",c),this.once("close",l),this.once("upgrading",u),this.upgrades.indexOf("webtransport")!==-1&&t!=="webtransport"?this.setTimeoutFn(()=>{s||n.open()},200):n.open()}onOpen(){if(this.readyState="open",a.priorWebsocketSuccess=this.transport.name==="websocket",this.emitReserved("open"),this.flush(),this.readyState==="open"&&this.opts.upgrade){let t=0,n=this.upgrades.length;for(;t<n;t++)this.probe(this.upgrades[t])}}onPacket(t){if(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing")switch(this.emitReserved("packet",t),this.emitReserved("heartbeat"),this.resetPingTimeout(),t.type){case"open":this.onHandshake(JSON.parse(t.data));break;case"ping":this.sendPacket("pong"),this.emitReserved("ping"),this.emitReserved("pong");break;case"error":let n=new Error("server error");n.code=t.data,this.onError(n);break;case"message":this.emitReserved("data",t.data),this.emitReserved("message",t.data);break}}onHandshake(t){this.emitReserved("handshake",t),this.id=t.sid,this.transport.query.sid=t.sid,this.upgrades=this.filterUpgrades(t.upgrades),this.pingInterval=t.pingInterval,this.pingTimeout=t.pingTimeout,this.maxPayload=t.maxPayload,this.onOpen(),this.readyState!=="closed"&&this.resetPingTimeout()}resetPingTimeout(){this.clearTimeoutFn(this.pingTimeoutTimer),this.pingTimeoutTimer=this.setTimeoutFn(()=>{this.onClose("ping timeout")},this.pingInterval+this.pingTimeout),this.opts.autoUnref&&this.pingTimeoutTimer.unref()}onDrain(){this.writeBuffer.splice(0,this.prevBufferLen),this.prevBufferLen=0,this.writeBuffer.length===0?this.emitReserved("drain"):this.flush()}flush(){if(this.readyState!=="closed"&&this.transport.writable&&!this.upgrading&&this.writeBuffer.length){let t=this.getWritablePackets();this.transport.send(t),this.prevBufferLen=t.length,this.emitReserved("flush")}}getWritablePackets(){if(!(this.maxPayload&&this.transport.name==="polling"&&this.writeBuffer.length>1))return this.writeBuffer;let n=1;for(let s=0;s<this.writeBuffer.length;s++){let i=this.writeBuffer[s].data;if(i&&(n+=dl(i)),s>0&&n>this.maxPayload)return this.writeBuffer.slice(0,s);n+=2}return this.writeBuffer}write(t,n,s){return this.sendPacket("message",t,n,s),this}send(t,n,s){return this.sendPacket("message",t,n,s),this}sendPacket(t,n,s,i){if(typeof n=="function"&&(i=n,n=void 0),typeof s=="function"&&(i=s,s=null),this.readyState==="closing"||this.readyState==="closed")return;s=s||{},s.compress=s.compress!==!1;let r={type:t,data:n,options:s};this.emitReserved("packetCreate",r),this.writeBuffer.push(r),i&&this.once("flush",i),this.flush()}close(){let t=()=>{this.onClose("forced close"),this.transport.close()},n=()=>{this.off("upgrade",n),this.off("upgradeError",n),t()},s=()=>{this.once("upgrade",n),this.once("upgradeError",n)};return(this.readyState==="opening"||this.readyState==="open")&&(this.readyState="closing",this.writeBuffer.length?this.once("drain",()=>{this.upgrading?s():t()}):this.upgrading?s():t()),this}onError(t){a.priorWebsocketSuccess=!1,this.emitReserved("error",t),this.onClose("transport error",t)}onClose(t,n){(this.readyState==="opening"||this.readyState==="open"||this.readyState==="closing")&&(this.clearTimeoutFn(this.pingTimeoutTimer),this.transport.removeAllListeners("close"),this.transport.close(),this.transport.removeAllListeners(),typeof removeEventListener=="function"&&(removeEventListener("beforeunload",this.beforeunloadEventListener,!1),removeEventListener("offline",this.offlineEventListener,!1)),this.readyState="closed",this.id=null,this.emitReserved("close",t,n),this.writeBuffer=[],this.prevBufferLen=0)}filterUpgrades(t){let n=[],s=0,i=t.length;for(;s<i;s++)~this.transports.indexOf(t[s])&&n.push(t[s]);return n}}return a.protocol=So,a})();var fg=ar.protocol;function vl(a,e="",t){let n=a;t=t||typeof location<"u"&&location,a==null&&(a=t.protocol+"//"+t.host),typeof a=="string"&&(a.charAt(0)==="/"&&(a.charAt(1)==="/"?a=t.protocol+a:a=t.host+a),/^(https?|wss?):\/\//.test(a)||(typeof t<"u"?a=t.protocol+"//"+a:a="https://"+a),n=$n(a)),n.port||(/^(http|ws)$/.test(n.protocol)?n.port="80":/^(http|ws)s$/.test(n.protocol)&&(n.port="443")),n.path=n.path||"/";let i=n.host.indexOf(":")!==-1?"["+n.host+"]":n.host;return n.id=n.protocol+"://"+i+":"+n.port+e,n.href=n.protocol+"://"+i+(t&&t.port===n.port?"":":"+n.port),n}var qo={};jl(qo,{Decoder:()=>Do,Encoder:()=>Io,PacketType:()=>ge,isPacketValid:()=>jh,protocol:()=>Al});var Ih=typeof ArrayBuffer=="function",Dh=a=>typeof ArrayBuffer.isView=="function"?ArrayBuffer.isView(a):a.buffer instanceof ArrayBuffer,Rl=Object.prototype.toString,$h=typeof Blob=="function"||typeof Blob<"u"&&Rl.call(Blob)==="[object BlobConstructor]",qh=typeof File=="function"||typeof File<"u"&&Rl.call(File)==="[object FileConstructor]";function Rs(a){return Ih&&(a instanceof ArrayBuffer||Dh(a))||$h&&a instanceof Blob||qh&&a instanceof File}function vs(a,e){if(!a||typeof a!="object")return!1;if(Array.isArray(a)){for(let t=0,n=a.length;t<n;t++)if(vs(a[t]))return!0;return!1}if(Rs(a))return!0;if(a.toJSON&&typeof a.toJSON=="function"&&arguments.length===1)return vs(a.toJSON(),!0);for(let t in a)if(Object.prototype.hasOwnProperty.call(a,t)&&vs(a[t]))return!0;return!1}function xl(a){let e=[],t=a.data,n=a;return n.data=Po(t,e),n.attachments=e.length,{packet:n,buffers:e}}function Po(a,e){if(!a)return a;if(Rs(a)){let t={_placeholder:!0,num:e.length};return e.push(a),t}else if(Array.isArray(a)){let t=new Array(a.length);for(let n=0;n<a.length;n++)t[n]=Po(a[n],e);return t}else if(typeof a=="object"&&!(a instanceof Date)){let t={};for(let n in a)Object.prototype.hasOwnProperty.call(a,n)&&(t[n]=Po(a[n],e));return t}return a}function Sl(a,e){return a.data=_o(a.data,e),delete a.attachments,a}function _o(a,e){if(!a)return a;if(a&&a._placeholder===!0){if(typeof a.num=="number"&&a.num>=0&&a.num<e.length)return e[a.num];throw new Error("illegal attachments")}else if(Array.isArray(a))for(let t=0;t<a.length;t++)a[t]=_o(a[t],e);else if(typeof a=="object")for(let t in a)Object.prototype.hasOwnProperty.call(a,t)&&(a[t]=_o(a[t],e));return a}var Ml=["connect","connect_error","disconnect","disconnecting","newListener","removeListener"],Al=5,ge=(function(a){return a[a.CONNECT=0]="CONNECT",a[a.DISCONNECT=1]="DISCONNECT",a[a.EVENT=2]="EVENT",a[a.ACK=3]="ACK",a[a.CONNECT_ERROR=4]="CONNECT_ERROR",a[a.BINARY_EVENT=5]="BINARY_EVENT",a[a.BINARY_ACK=6]="BINARY_ACK",a})(ge||{}),Io=class{constructor(e){this.replacer=e}encode(e){return(e.type===ge.EVENT||e.type===ge.ACK)&&vs(e)?this.encodeAsBinary({type:e.type===ge.EVENT?ge.BINARY_EVENT:ge.BINARY_ACK,nsp:e.nsp,data:e.data,id:e.id}):[this.encodeAsString(e)]}encodeAsString(e){let t=""+e.type;return(e.type===ge.BINARY_EVENT||e.type===ge.BINARY_ACK)&&(t+=e.attachments+"-"),e.nsp&&e.nsp!=="/"&&(t+=e.nsp+","),e.id!=null&&(t+=e.id),e.data!=null&&(t+=JSON.stringify(e.data,this.replacer)),t}encodeAsBinary(e){let t=xl(e),n=this.encodeAsString(t.packet),s=t.buffers;return s.unshift(n),s}},Do=class a extends ve{constructor(e){super(),this.reviver=e}add(e){let t;if(typeof e=="string"){if(this.reconstructor)throw new Error("got plaintext data when reconstructing a packet");t=this.decodeString(e);let n=t.type===ge.BINARY_EVENT;n||t.type===ge.BINARY_ACK?(t.type=n?ge.EVENT:ge.ACK,this.reconstructor=new $o(t),t.attachments===0&&super.emitReserved("decoded",t)):super.emitReserved("decoded",t)}else if(Rs(e)||e.base64)if(this.reconstructor)t=this.reconstructor.takeBinaryData(e),t&&(this.reconstructor=null,super.emitReserved("decoded",t));else throw new Error("got binary data when not reconstructing a packet");else throw new Error("Unknown type: "+e)}decodeString(e){let t=0,n={type:Number(e.charAt(0))};if(ge[n.type]===void 0)throw new Error("unknown packet type "+n.type);if(n.type===ge.BINARY_EVENT||n.type===ge.BINARY_ACK){let i=t+1;for(;e.charAt(++t)!=="-"&&t!=e.length;);let r=e.substring(i,t);if(r!=Number(r)||e.charAt(t)!=="-")throw new Error("Illegal attachments");n.attachments=Number(r)}if(e.charAt(t+1)==="/"){let i=t+1;for(;++t&&!(e.charAt(t)===","||t===e.length););n.nsp=e.substring(i,t)}else n.nsp="/";let s=e.charAt(t+1);if(s!==""&&Number(s)==s){let i=t+1;for(;++t;){let r=e.charAt(t);if(r==null||Number(r)!=r){--t;break}if(t===e.length)break}n.id=Number(e.substring(i,t+1))}if(e.charAt(++t)){let i=this.tryParse(e.substr(t));if(a.isPayloadValid(n.type,i))n.data=i;else throw new Error("invalid payload")}return n}tryParse(e){try{return JSON.parse(e,this.reviver)}catch{return!1}}static isPayloadValid(e,t){switch(e){case ge.CONNECT:return or(t);case ge.DISCONNECT:return t===void 0;case ge.CONNECT_ERROR:return typeof t=="string"||or(t);case ge.EVENT:case ge.BINARY_EVENT:return Array.isArray(t)&&(typeof t[0]=="number"||typeof t[0]=="string"&&Ml.indexOf(t[0])===-1);case ge.ACK:case ge.BINARY_ACK:return Array.isArray(t)}}destroy(){this.reconstructor&&(this.reconstructor.finishedReconstruction(),this.reconstructor=null)}},$o=class{constructor(e){this.packet=e,this.buffers=[],this.reconPack=e}takeBinaryData(e){if(this.buffers.push(e),this.buffers.length===this.reconPack.attachments){let t=Sl(this.reconPack,this.buffers);return this.finishedReconstruction(),t}return null}finishedReconstruction(){this.reconPack=null,this.buffers=[]}};function Bh(a){return typeof a=="string"}var Fh=Number.isInteger||function(a){return typeof a=="number"&&isFinite(a)&&Math.floor(a)===a};function Lh(a){return a===void 0||Fh(a)}function or(a){return Object.prototype.toString.call(a)==="[object Object]"}function kh(a,e){switch(a){case ge.CONNECT:return e===void 0||or(e);case ge.DISCONNECT:return e===void 0;case ge.EVENT:return Array.isArray(e)&&(typeof e[0]=="number"||typeof e[0]=="string"&&Ml.indexOf(e[0])===-1);case ge.ACK:return Array.isArray(e);case ge.CONNECT_ERROR:return typeof e=="string"||or(e);default:return!1}}function jh(a){return Bh(a.nsp)&&Lh(a.id)&&kh(a.type,a.data)}function He(a,e,t){return a.on(e,t),function(){a.off(e,t)}}var Uh=Object.freeze({connect:1,connect_error:1,disconnect:1,disconnecting:1,newListener:1,removeListener:1}),qn=class extends ve{constructor(e,t,n){super(),this.connected=!1,this.recovered=!1,this.receiveBuffer=[],this.sendBuffer=[],this._queue=[],this._queueSeq=0,this.ids=0,this.acks={},this.flags={},this.io=e,this.nsp=t,n&&n.auth&&(this.auth=n.auth),this._opts=Object.assign({},n),this.io._autoConnect&&this.open()}get disconnected(){return!this.connected}subEvents(){if(this.subs)return;let e=this.io;this.subs=[He(e,"open",this.onopen.bind(this)),He(e,"packet",this.onpacket.bind(this)),He(e,"error",this.onerror.bind(this)),He(e,"close",this.onclose.bind(this))]}get active(){return!!this.subs}connect(){return this.connected?this:(this.subEvents(),this.io._reconnecting||this.io.open(),this.io._readyState==="open"&&this.onopen(),this)}open(){return this.connect()}send(...e){return e.unshift("message"),this.emit.apply(this,e),this}emit(e,...t){if(Uh.hasOwnProperty(e))throw new Error('"'+e.toString()+'" is a reserved event name');if(t.unshift(e),this._opts.retries&&!this.flags.fromQueue&&!this.flags.volatile)return this._addToQueue(t),this;let n={type:ge.EVENT,data:t};if(n.options={},n.options.compress=this.flags.compress!==!1,typeof t[t.length-1]=="function"){let r=this.ids++,o=t.pop();this._registerAckCallback(r,o),n.id=r}let s=this.io.engine&&this.io.engine.transport&&this.io.engine.transport.writable;return this.flags.volatile&&(!s||!this.connected)||(this.connected?(this.notifyOutgoingListeners(n),this.packet(n)):this.sendBuffer.push(n)),this.flags={},this}_registerAckCallback(e,t){var n;let s=(n=this.flags.timeout)!==null&&n!==void 0?n:this._opts.ackTimeout;if(s===void 0){this.acks[e]=t;return}let i=this.io.setTimeoutFn(()=>{delete this.acks[e];for(let o=0;o<this.sendBuffer.length;o++)this.sendBuffer[o].id===e&&this.sendBuffer.splice(o,1);t.call(this,new Error("operation has timed out"))},s),r=(...o)=>{this.io.clearTimeoutFn(i),t.apply(this,o)};r.withError=!0,this.acks[e]=r}emitWithAck(e,...t){return new Promise((n,s)=>{let i=(r,o)=>r?s(r):n(o);i.withError=!0,t.push(i),this.emit(e,...t)})}_addToQueue(e){let t;typeof e[e.length-1]=="function"&&(t=e.pop());let n={id:this._queueSeq++,tryCount:0,pending:!1,args:e,flags:Object.assign({fromQueue:!0},this.flags)};e.push((s,...i)=>n!==this._queue[0]?void 0:(s!==null?n.tryCount>this._opts.retries&&(this._queue.shift(),t&&t(s)):(this._queue.shift(),t&&t(null,...i)),n.pending=!1,this._drainQueue())),this._queue.push(n),this._drainQueue()}_drainQueue(e=!1){if(!this.connected||this._queue.length===0)return;let t=this._queue[0];t.pending&&!e||(t.pending=!0,t.tryCount++,this.flags=t.flags,this.emit.apply(this,t.args))}packet(e){e.nsp=this.nsp,this.io._packet(e)}onopen(){typeof this.auth=="function"?this.auth(e=>{this._sendConnectPacket(e)}):this._sendConnectPacket(this.auth)}_sendConnectPacket(e){this.packet({type:ge.CONNECT,data:this._pid?Object.assign({pid:this._pid,offset:this._lastOffset},e):e})}onerror(e){this.connected||this.emitReserved("connect_error",e)}onclose(e,t){this.connected=!1,delete this.id,this.emitReserved("disconnect",e,t),this._clearAcks()}_clearAcks(){Object.keys(this.acks).forEach(e=>{if(!this.sendBuffer.some(n=>String(n.id)===e)){let n=this.acks[e];delete this.acks[e],n.withError&&n.call(this,new Error("socket has been disconnected"))}})}onpacket(e){if(e.nsp===this.nsp)switch(e.type){case ge.CONNECT:e.data&&e.data.sid?this.onconnect(e.data.sid,e.data.pid):this.emitReserved("connect_error",new Error("It seems you are trying to reach a Socket.IO server in v2.x with a v3.x client, but they are not compatible (more information here: https://socket.io/docs/v3/migrating-from-2-x-to-3-0/)"));break;case ge.EVENT:case ge.BINARY_EVENT:this.onevent(e);break;case ge.ACK:case ge.BINARY_ACK:this.onack(e);break;case ge.DISCONNECT:this.ondisconnect();break;case ge.CONNECT_ERROR:this.destroy();let n=new Error(e.data.message);n.data=e.data.data,this.emitReserved("connect_error",n);break}}onevent(e){let t=e.data||[];e.id!=null&&t.push(this.ack(e.id)),this.connected?this.emitEvent(t):this.receiveBuffer.push(Object.freeze(t))}emitEvent(e){if(this._anyListeners&&this._anyListeners.length){let t=this._anyListeners.slice();for(let n of t)n.apply(this,e)}super.emit.apply(this,e),this._pid&&e.length&&typeof e[e.length-1]=="string"&&(this._lastOffset=e[e.length-1])}ack(e){let t=this,n=!1;return function(...s){n||(n=!0,t.packet({type:ge.ACK,id:e,data:s}))}}onack(e){let t=this.acks[e.id];typeof t=="function"&&(delete this.acks[e.id],t.withError&&e.data.unshift(null),t.apply(this,e.data))}onconnect(e,t){this.id=e,this.recovered=t&&this._pid===t,this._pid=t,this.connected=!0,this.emitBuffered(),this.emitReserved("connect"),this._drainQueue(!0)}emitBuffered(){this.receiveBuffer.forEach(e=>this.emitEvent(e)),this.receiveBuffer=[],this.sendBuffer.forEach(e=>{this.notifyOutgoingListeners(e),this.packet(e)}),this.sendBuffer=[]}ondisconnect(){this.destroy(),this.onclose("io server disconnect")}destroy(){this.subs&&(this.subs.forEach(e=>e()),this.subs=void 0),this.io._destroy(this)}disconnect(){return this.connected&&this.packet({type:ge.DISCONNECT}),this.destroy(),this.connected&&this.onclose("io client disconnect"),this}close(){return this.disconnect()}compress(e){return this.flags.compress=e,this}get volatile(){return this.flags.volatile=!0,this}timeout(e){return this.flags.timeout=e,this}onAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.push(e),this}prependAny(e){return this._anyListeners=this._anyListeners||[],this._anyListeners.unshift(e),this}offAny(e){if(!this._anyListeners)return this;if(e){let t=this._anyListeners;for(let n=0;n<t.length;n++)if(e===t[n])return t.splice(n,1),this}else this._anyListeners=[];return this}listenersAny(){return this._anyListeners||[]}onAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.push(e),this}prependAnyOutgoing(e){return this._anyOutgoingListeners=this._anyOutgoingListeners||[],this._anyOutgoingListeners.unshift(e),this}offAnyOutgoing(e){if(!this._anyOutgoingListeners)return this;if(e){let t=this._anyOutgoingListeners;for(let n=0;n<t.length;n++)if(e===t[n])return t.splice(n,1),this}else this._anyOutgoingListeners=[];return this}listenersAnyOutgoing(){return this._anyOutgoingListeners||[]}notifyOutgoingListeners(e){if(this._anyOutgoingListeners&&this._anyOutgoingListeners.length){let t=this._anyOutgoingListeners.slice();for(let n of t)n.apply(this,e.data)}}};function tn(a){a=a||{},this.ms=a.min||100,this.max=a.max||1e4,this.factor=a.factor||2,this.jitter=a.jitter>0&&a.jitter<=1?a.jitter:0,this.attempts=0}tn.prototype.duration=function(){var a=this.ms*Math.pow(this.factor,this.attempts++);if(this.jitter){var e=Math.random(),t=Math.floor(e*this.jitter*a);a=(Math.floor(e*10)&1)==0?a-t:a+t}return Math.min(a,this.max)|0};tn.prototype.reset=function(){this.attempts=0};tn.prototype.setMin=function(a){this.ms=a};tn.prototype.setMax=function(a){this.max=a};tn.prototype.setJitter=function(a){this.jitter=a};var Bn=class extends ve{constructor(e,t){var n;super(),this.nsps={},this.subs=[],e&&typeof e=="object"&&(t=e,e=void 0),t=t||{},t.path=t.path||"/socket.io",this.opts=t,Mt(this,t),this.reconnection(t.reconnection!==!1),this.reconnectionAttempts(t.reconnectionAttempts||1/0),this.reconnectionDelay(t.reconnectionDelay||1e3),this.reconnectionDelayMax(t.reconnectionDelayMax||5e3),this.randomizationFactor((n=t.randomizationFactor)!==null&&n!==void 0?n:.5),this.backoff=new tn({min:this.reconnectionDelay(),max:this.reconnectionDelayMax(),jitter:this.randomizationFactor()}),this.timeout(t.timeout==null?2e4:t.timeout),this._readyState="closed",this.uri=e;let s=t.parser||qo;this.encoder=new s.Encoder,this.decoder=new s.Decoder,this._autoConnect=t.autoConnect!==!1,this._autoConnect&&this.open()}reconnection(e){return arguments.length?(this._reconnection=!!e,this):this._reconnection}reconnectionAttempts(e){return e===void 0?this._reconnectionAttempts:(this._reconnectionAttempts=e,this)}reconnectionDelay(e){var t;return e===void 0?this._reconnectionDelay:(this._reconnectionDelay=e,(t=this.backoff)===null||t===void 0||t.setMin(e),this)}randomizationFactor(e){var t;return e===void 0?this._randomizationFactor:(this._randomizationFactor=e,(t=this.backoff)===null||t===void 0||t.setJitter(e),this)}reconnectionDelayMax(e){var t;return e===void 0?this._reconnectionDelayMax:(this._reconnectionDelayMax=e,(t=this.backoff)===null||t===void 0||t.setMax(e),this)}timeout(e){return arguments.length?(this._timeout=e,this):this._timeout}maybeReconnectOnOpen(){!this._reconnecting&&this._reconnection&&this.backoff.attempts===0&&this.reconnect()}open(e){if(~this._readyState.indexOf("open"))return this;this.engine=new ar(this.uri,this.opts);let t=this.engine,n=this;this._readyState="opening",this.skipReconnect=!1;let s=He(t,"open",function(){n.onopen(),e&&e()}),i=o=>{this.cleanup(),this._readyState="closed",this.emitReserved("error",o),e?e(o):this.maybeReconnectOnOpen()},r=He(t,"error",i);if(this._timeout!==!1){let o=this._timeout,c=this.setTimeoutFn(()=>{s(),i(new Error("timeout")),t.close()},o);this.opts.autoUnref&&c.unref(),this.subs.push(()=>{this.clearTimeoutFn(c)})}return this.subs.push(s),this.subs.push(r),this}connect(e){return this.open(e)}onopen(){this.cleanup(),this._readyState="open",this.emitReserved("open");let e=this.engine;this.subs.push(He(e,"ping",this.onping.bind(this)),He(e,"data",this.ondata.bind(this)),He(e,"error",this.onerror.bind(this)),He(e,"close",this.onclose.bind(this)),He(this.decoder,"decoded",this.ondecoded.bind(this)))}onping(){this.emitReserved("ping")}ondata(e){try{this.decoder.add(e)}catch(t){this.onclose("parse error",t)}}ondecoded(e){en(()=>{this.emitReserved("packet",e)},this.setTimeoutFn)}onerror(e){this.emitReserved("error",e)}socket(e,t){let n=this.nsps[e];return n?this._autoConnect&&!n.active&&n.connect():(n=new qn(this,e,t),this.nsps[e]=n),n}_destroy(e){let t=Object.keys(this.nsps);for(let n of t)if(this.nsps[n].active)return;this._close()}_packet(e){let t=this.encoder.encode(e);for(let n=0;n<t.length;n++)this.engine.write(t[n],e.options)}cleanup(){this.subs.forEach(e=>e()),this.subs.length=0,this.decoder.destroy()}_close(){this.skipReconnect=!0,this._reconnecting=!1,this.onclose("forced close"),this.engine&&this.engine.close()}disconnect(){return this._close()}onclose(e,t){this.cleanup(),this.backoff.reset(),this._readyState="closed",this.emitReserved("close",e,t),this._reconnection&&!this.skipReconnect&&this.reconnect()}reconnect(){if(this._reconnecting||this.skipReconnect)return this;let e=this;if(this.backoff.attempts>=this._reconnectionAttempts)this.backoff.reset(),this.emitReserved("reconnect_failed"),this._reconnecting=!1;else{let t=this.backoff.duration();this._reconnecting=!0;let n=this.setTimeoutFn(()=>{e.skipReconnect||(this.emitReserved("reconnect_attempt",e.backoff.attempts),!e.skipReconnect&&e.open(s=>{s?(e._reconnecting=!1,e.reconnect(),this.emitReserved("reconnect_error",s)):e.onreconnect()}))},t);this.opts.autoUnref&&n.unref(),this.subs.push(()=>{this.clearTimeoutFn(n)})}}onreconnect(){let e=this.backoff.attempts;this._reconnecting=!1,this.backoff.reset(),this.emitReserved("reconnect",e)}};var xs={};function Ss(a,e){typeof a=="object"&&(e=a,a=void 0),e=e||{};let t=vl(a,e.path||"/socket.io"),n=t.source,s=t.id,i=t.path,r=xs[s]&&i in xs[s].nsps,o=e.forceNew||e["force new connection"]||e.multiplex===!1||r,c;return o?c=new Bn(n,e):(xs[s]||(xs[s]=new Bn(n,e)),c=xs[s]),t.query&&!e.query&&(e.query=t.queryKey),c.socket(t.path,e)}Object.assign(Ss,{Manager:Bn,Socket:qn,io:Ss,connect:Ss});var cr=class extends jt{toString(){return"socket-io"}constructor(e){super(e),this.ctx=e}ioServer(...e){}get ioClient(){return Ss}};var lr=class{constructor(e){this.ctx=e,this.allHttpMethods=["GET","POST","PUT","DELETE","PATCH","OPTIONS","HEAD"],this.ctx=e,this.strategy=this.resolveStrategy(),F.isWebSQL?(this.server=new gs(this),this.client=new ys(this)):(this.client=new ys(this),this.server=new gs(this))}resolveStrategy(){return this.ctx.mode==="backend-frontend(websql)"||this.ctx.mode==="backend-frontend(websql-electron)"?new zi(this.ctx):this.ctx.mode==="backend-frontend(ipc-electron)"?new Qi(this.ctx):new cr(this.ctx)}pathFor(e){let t=e||"";t=t==="/"?"":t;let n=this.ctx.contextNameForCommunication,s=`${Dn}/${n}/udp`;F.isElectron&&(s="");let i=`${this.ctx.uriOrigin}${this.ctx.uriPathnameOrNothingIfRoot}/${s}${s&&t?"-"+t:t}`;return new URL(i)}};var Vh=globalThis.ENV,Fn=class a{static get Instance(){return this._instance||(this._instance=new a),this._instance}constructor(){this.scrollableEnabled=!1,this.onEditMode=new Oe,this.onEditMode$=this.onEditMode.asObservable(),this.enabledTabs=[],a._instance=this,this.scrollableEnabled=!!Vh?.useGlobalNgxScrollbar}setEditMode(e){this.onEditMode.next(e)}setKeepWebsqlDbDataAfterReload(e){this.keepWebsqlDbDataAfterReload=e}hide(){this.draggablePopupMode=!1,this.adminPanelIsOpen=!1}show(){this.draggablePopupMode=!1,this.adminPanelIsOpen=!0}logout(){}};var ur=class{get sourceContext(){return this.cloneOptions?.sourceContext}get isRunOrRevertOnlyMigrationAppStart(){return!!(this.onlyMigrationRun||this.onlyMigrationRevertToTimestamp)}get realtimeClient(){return this.realtime.client}get realtimeServer(){return this.realtime.server}get logHttp(){return y.isObject(this.config?.logs)?!!this.config.logs.http:this.config?.logs===!0}get logRealtime(){return y.isObject(this.config?.logs)?!!this.config.logs.realtime:this.config?.logs===!0}get logFramework(){return y.isObject(this.config?.logs)?!!this.config.logs.framework:this.config?.logs===!0}get logRoutes(){return y.isObject(this.config?.logs)?!!this.config.logs.routes:this.config?.logs===!0}get logDb(){return y.isObject(this.config?.logs)?!!this.config.logs.db:this.config?.logs===!0}get logMigrations(){return y.isObject(this.config?.logs)?!!this.config.logs.migrations:this.config?.logs===!0}constructor(e,t,n){this.originalConfig=e,this.configFn=t,this.cloneOptions=n,this.USE_MARIADB_MYSQL_IN_DOCKER=!1,this.disabledRealtime=!1,this.inited=!1,this.dbMigrations=new ji(this),this.localInstaceObjSymbol=Symbol("localInstaceObjSymbol"),this.allClassesInstances={},this.classInstancesByNameObj={},this.objWithClassesInstancesArr={},this.activeRoutes=[],this.repos=new Map,this.skipWritingServerRoutes=!1,this.injectableTypesfromContexts=[K.ClassType.CONTROLLER,K.ClassType.PROVIDER,K.ClassType.MIDDLEWARE,K.ClassType.REPOSITORY,K.ClassType.SUBSCRIBER,K.ClassType.MIGRATION],this.allTypesfromContexts=[...this.injectableTypesfromContexts,K.ClassType.ENTITY],this.expressApp={},this.onlyMigrationRun=!1,this.onlyMigrationRevertToTimestamp=void 0,this.entitiesTriggers={},this.isRunningInsideDocker=!1,this.cloneClassWithNewMetadata=({TaonBaseClass:s,className:i,config:r,ctx:o,classType:c})=>(()=>{var h,d,f,p,m;return s[I.fullClassNameStaticProperty]===`${o.contextName}.${i}`?s:class extends s{constructor(){super(...arguments),this[m]=o}static{h=I.orignalClass,d=I.fullClassNameStaticProperty,f=I.classNameStaticProperty,p=I.ctxInClassOrClassObj,m=I.ctxInClassOrClassObj}static{this[h]=s}static{this[d]=`${o.contextName}.${i}`}static{this[f]=i}static{this[p]=o}static __getFullPathForClass__(x=[]){let S=this[I.fullClassNameStaticProperty];return x.push(S),this[I.orignalClass]&&this[I.orignalClass].__getFullPathForClass__&&this[I.orignalClass].__getFullPathForClass__(x),x.join("/")}static get fullPathForClass(){return this.__getFullPathForClass__()}}})(),this.cloneClassesObjWithNewMetadata=({classesInput:s,config:i,ctx:r,classType:o})=>{let c={};for(let u of Object.keys(s||{})){let h=s[u];h||F.error(`Class ${u} is not defined in context ${r.contextName}

        Please check if you have correct import in context file

        `);var l=Reflect.getMetadata(I.metadata.className,h);l=l||u,h[I.classNameStaticProperty]=l;let d=this.cloneClassWithNewMetadata({TaonBaseClass:h,className:l,config:i,ctx:r,classType:o});c[l]=d}return c},this.cloneOptions=this.cloneOptions||{},this.isRunningInsideDocker=lt.isRunningInDocker()}async init(e){let{initFromRecrusiveContextResovle:t,onlyMigrationRun:n,onlyMigrationRevertToTimestamp:s}=e||{};if(this.inited=!0,this.onlyMigrationRun=n,this.onlyMigrationRevertToTimestamp=s,this.config=this.configFn({}),y.isObject(this.config.database)&&(this.config.database=K.DatabaseConfig.from(this.config.database).databaseConfigTypeORM),this.config.host=this.host===null?void 0:this.host,this.cloneOptions.overrideHost&&!this.cloneOptions.useAsRemoteContext&&(this.config.host=this.cloneOptions.overrideHost),this.cloneOptions.overrideRemoteHost&&this.cloneOptions.useAsRemoteContext&&(this.config.host=this.cloneOptions.overrideRemoteHost),this.config.host&&!this.config.host.startsWith("http://")&&!this.config.host.startsWith("https://")&&F.throw(`[taon-config] Your${this.host?" remote":""} 'host' must start with http:// or https://`),y.isUndefined(this.config.useIpcWhenElectron)&&(this.config.useIpcWhenElectron=!0),this.skipWritingServerRoutes=y.isBoolean(this.config.skipWritingServerRoutes)?this.config.skipWritingServerRoutes:!1,this.config.host&&(this.mode="backend-frontend(tcp+udp)",this.mode="backend-frontend(websql)"),this.isRemoteHost&&(this.mode="remote-backend(tcp+udp)"),this.config.useIpcWhenElectron&&F.isElectron&&(F.isWebSQL?this.mode="backend-frontend(websql-electron)":this.mode="backend-frontend(ipc-electron)"),!this.mode&&!this.config.abstract&&F.error(`[taon][Context=${this.contextName}]: You need to provide host property or useIpcWhenElectron or mark it as abstract`,!1,!0),this.config.database===!0?(this.logFramework&&console.log(`

        ASSIGNING AUTO GENERATED DATABASE CONFIG

        `),this.databaseConfig=this.getAutoGeneratedConfig()):y.isObject(this.config.database)&&(this.logFramework&&console.log(`

        OVERRIDE DATABASE CONFIG FROM CONFIGURATION

        `),this.databaseConfig=this.getAutoGeneratedConfig(),Gt.Object(this.config.database,(i,r)=>{y.isNil(i)||y.isFunction(i)||y.isObject(i)||(this.logFramework&&console.info(`Overriding database config: ${r}=${i}`),y.set(this.databaseConfig,r,i))},{walkGetters:!1})),this.config.session){this.session=y.cloneDeep(this.config.session);let i=1e3*60*60*1;this.session.cookieMaxAge||(this.session.cookieMaxAge=i),It.defaults.withCredentials=!0}this.config.contexts=this.config.contexts||{},this.config.entities=this.config.entities||{},this.config.controllers=this.config.controllers||{},this.config.repositories=this.config.repositories||{},this.config.providers=this.config.providers||{},this.config.subscribers=this.config.subscribers||{},this.config.migrations=this.config.migrations||{},this.config.entities=oe(oe({},await this.getRecrusiveClassesfromContextsObj(K.ClassType.ENTITY)),this.config.entities),this.config.controllers=oe(oe({},await this.getRecrusiveClassesfromContextsObj(K.ClassType.CONTROLLER)),this.config.controllers),this.config.providers=oe(oe({},await this.getRecrusiveClassesfromContextsObj(K.ClassType.PROVIDER)),this.config.providers),this.config.middlewares=oe(oe({},await this.getRecrusiveClassesfromContextsObj(K.ClassType.MIDDLEWARE)),this.config.middlewares),this.config.subscribers=oe(oe({},await this.getRecrusiveClassesfromContextsObj(K.ClassType.SUBSCRIBER)),this.config.subscribers),this.config.repositories=oe(oe({},await this.getRecrusiveClassesfromContextsObj(K.ClassType.REPOSITORY)),this.config.repositories),this.config.migrations=oe(oe({},await this.getRecrusiveClassesfromContextsObj(K.ClassType.MIGRATION)),this.config.migrations),this.config.controllers=this.cloneClassesObjWithNewMetadata({classesInput:this.config.controllers,config:this.config,ctx:this,classType:K.ClassType.CONTROLLER}),this.config.repositories=this.cloneClassesObjWithNewMetadata({classesInput:this.config.repositories,config:this.config,ctx:this,classType:K.ClassType.REPOSITORY}),this.config.providers=this.cloneClassesObjWithNewMetadata({classesInput:this.config.providers,config:this.config,ctx:this,classType:K.ClassType.PROVIDER}),this.config.middlewares=this.cloneClassesObjWithNewMetadata({classesInput:this.config.middlewares,config:this.config,ctx:this,classType:K.ClassType.MIDDLEWARE}),this.config.subscribers=this.cloneClassesObjWithNewMetadata({classesInput:this.config.subscribers,config:this.config,ctx:this,classType:K.ClassType.SUBSCRIBER}),this.config.migrations=this.cloneClassesObjWithNewMetadata({classesInput:this.config.migrations,config:this.config,ctx:this,classType:K.ClassType.MIGRATION});for(let i of this.injectableTypesfromContexts)this.classInstancesByNameObj[i]={},this.objWithClassesInstancesArr[i]=[];for(let i of this.injectableTypesfromContexts)await this.createInstances(this.config[K.ClassTypeKey[i]],i);if(!this.isRunOrRevertOnlyMigrationAppStart&&(this.mode==="backend-frontend(tcp+udp)"&&!this.config.abstract&&await this.initCustomClientMiddlewares(),!this.config.abstract)){if(this.disabledRealtime=this.config.disabledRealtime,!this.host)throw`

            host is required for context initialization..
            (Or maybe you forgot mark ${this.config.contextName} context as abstract?)

          `;this.logRealtime&&F.info(`[ctx=${this.contextName}] Init Realtime for ${this.mode}`),this.realtime=new lr(this)}this.config.abstract?this.logFramework&&F.info(`[taon] Create abstract context: ${this.config.contextName}`):this.isRemoteHost?this.logFramework&&F.info(`[taon] Create context for remote host: ${this.config.host}`):this.logFramework&&F.info(`[taon] Create context for host: ${this.config.host}`),Object.keys(this.config).forEach(i=>{this.originalConfig[i]=this.config[i]})}getAutoGeneratedConfig(){this.logFramework&&console.log(`


         IS RUNNING IN DOCKER: ${this.isRunningInsideDocker}

    `);let e=K.DatabaseConfig.from({}),t=`${K.DatabasesFolder}/db-${this.contextName}.sqlite`;if(this.isRunningInsideDocker)this.USE_MARIADB_MYSQL_IN_DOCKER||(this.logFramework&&console.log(`

          USING GENERATED CONFIG FOR SQLJS IN DOCKER

          `),e=e=K.DatabaseConfig.from({location:t,type:"sqljs",useLocalForage:!1,recreateMode:"PRESERVE_DATA+MIGRATIONS",logging:!0}));else switch(this.logFramework&&F.info(`[taon][database] Automatically resolving database config for mode ${this.mode}`),this.mode){case"backend-frontend(ipc-electron)":e=K.DatabaseConfig.from({location:lt.isElectron?void 0:`db-${this.contextName}.sqlite`,type:"sqljs",recreateMode:"DROP_DB+MIGRATIONS",logging:this.logDb});break;case"backend-frontend(websql-electron)":case"backend-frontend(websql)":let s=!1;s=Fn.Instance?.keepWebsqlDbDataAfterReload,e=e=K.DatabaseConfig.from({location:`db-${this.contextName}.sqlite`,type:"sqljs",useLocalForage:!0,recreateMode:s?"PRESERVE_DATA+MIGRATIONS":"DROP_DB+MIGRATIONS",logging:this.logDb});break;case"backend-frontend(tcp+udp)":e=K.DatabaseConfig.from({database:`context-db-${this.contextName}`,location:t,type:"sqljs",recreateMode:"DROP_DB+MIGRATIONS",logging:this.logDb});break}return e.databaseConfigTypeORM}async startServer(){}displayRoutes(e){}get modeAllowsDatabaseCreation(){return this.mode==="backend-frontend(tcp+udp)"||this.mode==="backend-frontend(websql)"||this.mode==="backend-frontend(ipc-electron)"}async getRecrusiveClassesfromContextsObj(e){return(await this.getRecrusiveClassesfromContexts(e)).reduce((n,s)=>(n[Z.getName(s)]=s,n),{})}async getRecrusiveClassesfromContexts(e,t=[]){let n=Object.values(this.config.contexts||{});for(let s of n){let i=await s.__ref(),r=i.getClassFunBy(e);Object.values(this.cloneClassesObjWithNewMetadata({classesInput:r,config:this.config,ctx:this,classType:e})).forEach(c=>t.push(c)),await i.getRecrusiveClassesfromContexts(e,t)}return t}getClassInstanceObjBy(e){return this.classInstancesByNameObj[e]}getClassesInstancesArrBy(e){return this.objWithClassesInstancesArr[e]}inject(e,t){let n=Z.getName(e),s=t.locaInstanceConstructorArgs||[];if(this.isCLassType(K.ClassType.REPOSITORY,e)&&(t.localInstance=!0),t?.localInstance){let r=this.getClassFunByClassName(n),o="",c=y.first(s),l=c&&c();o=l&&Z.getName(l)||"",t.contextClassInstance[this.localInstaceObjSymbol]||(t.contextClassInstance[this.localInstaceObjSymbol]={});let u=n+(o?`.${o}`:""),h=t.contextClassInstance[this.localInstaceObjSymbol][u];if(h)return h;if(!r)throw new Error(`Not able to inject "${n}" inside context "${this.contextName}"

        Make sure they share the same context or import context where "${n}" is defined.

        `);let d=new r(...s);return t.contextClassInstance[this.localInstaceObjSymbol][u]=d,d}return this.allClassesInstances[n]}getInstanceBy(e){return this.inject(e,{localInstance:!1,parentInstanceThatWillGetInjectedStuff:this})}checkIfContextInitialized(){if(y.isUndefined(this.config))throw new Error(`Please check if your context has been initialized.

      // ...
      await Context.initialize();
      // ...


      `)}getClassFunBy(e){switch(this.checkIfContextInitialized(),e){case K.ClassType.CONTROLLER:return this.config.controllers;case K.ClassType.ENTITY:return this.config.entities;case K.ClassType.PROVIDER:return this.config.providers;case K.ClassType.MIDDLEWARE:return this.config.middlewares;case K.ClassType.REPOSITORY:return this.config.repositories;case K.ClassType.SUBSCRIBER:return this.config.subscribers;case K.ClassType.MIGRATION:return this.config.migrations}}isCLassType(e,t){return!!this.getClassFunBy(e)[Z.getName(t)]}getClassFunByClassName(e){for(let t of this.allTypesfromContexts){let n=this.config[K.ClassTypeKey[t]];if(n[e])return n[e]}}getClassFunByClass(e){let t=Z.getName(e);return this.getClassFunByClassName(t)}getClassFunByArr(e){return Object.values(this.getClassFunBy(e)||{})}async createInstances(e,t){for(let n of[...Object.values(e)]){let s=Ui.resolve(n),i=this.classInstancesByNameObj[t],r=Z.getName(n);i[r]=s,this.config[K.ClassTypeKey[t]][r]=n,this.objWithClassesInstancesArr[t].push(s),this.allClassesInstances[r]=s}}async initClasses(){if(!this.isRemoteHost){for(let e of this.getClassFunByArr(K.ClassType.ENTITY)){let t=await this.connection.getRepository(Z.getOrginalClass(e));this.repos.set(Z.getName(e),t)}for(let e of[K.ClassType.MIDDLEWARE,K.ClassType.PROVIDER,K.ClassType.REPOSITORY,K.ClassType.CONTROLLER,K.ClassType.ENTITY,K.ClassType.MIGRATION])for(let t of this.getClassFunByArr(e))y.isFunction(t._)&&await t._();for(let e of[K.ClassType.MIDDLEWARE,K.ClassType.PROVIDER,K.ClassType.REPOSITORY,K.ClassType.CONTROLLER,K.ClassType.MIGRATION])for(let t of this.getClassesInstancesArrBy(e))y.isFunction(t._)&&await t._()}}isActiveOn(e){let t=e[I.ctxInClassOrClassObj];return this===t}get frontendHostUri(){let e=this.config?.frontendHost?.startsWith("http")?this.config.frontendHost:`${globalThis?.location?.protocol||"http:"}//${this.config?.frontendHost}`;return new URL(e.replace(/\/$/,""))}get uri(){return this.host?new URL(this.host):void 0}get uriProtocol(){return this.uri?.protocol}get uriOrigin(){return this.uri?.origin}get uriPathname(){return this.uri?.pathname}get uriPathnameOrNothingIfRoot(){return this.uri?.pathname&&this.uri.pathname!=="/"?this.uri.pathname.replace(/\/$/,""):""}get uriPort(){return this.uri?.origin?.includes("localhost")?this.uri?.port:this.config?.hostPortNumber?.toString()}get port(){return this.uri?.port?Number(this.uriPort):void 0}get isHttpServer(){return this.uriProtocol==="https:"}get isRemoteHost(){return!!this.cloneOptions?.useAsRemoteContext}get contextName(){return this.config?.contextName||this.originalConfig?.contextName}get contextNameForCommunication(){let e=this.contextName;return this.isRemoteHost&&this.sourceContext?.contextName&&(e=this.sourceContext?.contextName),e}get contextType(){return this.config.abstract?"abstract":this.host?this.isRemoteHost?"remote":"normal":"invalid"}get cwd(){return this.config.cwd||process.cwd()}get activeContext(){return this.config.activeContext||null}get appId(){return this.config.appId}get publicAssets(){return this.config?.publicAssets||[]}get isProductionMode(){return this.config.productionMode}get host(){return this.config.host}get origin(){return this.uri?.origin}async initSubscribers(){if(this.isRemoteHost)return;let e=this.getClassFunByArr(K.ClassType.SUBSCRIBER);for(let t of e){let n=Reflect.getMetadata(I.metadata.options.subscriber,t);Jc()(t)}}async initEntities(){if(this.isRemoteHost)return;let e=this.getClassFunByArr(K.ClassType.ENTITY);for(let t of e){let n=Reflect.getMetadata(I.metadata.options.entity,t),s=y.isUndefined(n.createTable)?!0:n.createTable,i=Z.getName(t);s?(this.logDb&&console.info(`[taon][typeorm] create table for entity "${i}" ? '${s}'`),zc(i)(t)):this.logDb&&console.info(`[taon][typeorm] create table for entity "${i}" ? '${s}'`)}}async destroy(){this.connection&&(await this.connection?.destroy(),delete this.connection),this.serverTcpUdp&&(await new Promise(e=>{this.serverTcpUdp?.close(()=>{e(!0)})}),delete this.serverTcpUdp),delete this.expressApp}async initDatabaseConnection(){if(this.isRemoteHost||!this.databaseConfig)return;let e=this.getClassFunByArr(K.ClassType.ENTITY).map(i=>Z.getOrginalClass(i)),t=this.getClassFunByArr(K.ClassType.SUBSCRIBER),n=!1;y.isNil(this.databaseConfig.autoSave)?this.USE_MARIADB_MYSQL_IN_DOCKER?n=!this.isRunningInsideDocker:n=!0:n=this.databaseConfig.autoSave;let s=y.isObject(this.databaseConfig)?{type:this.databaseConfig.type,port:this.databaseConfig.databasePort,host:this.databaseConfig.databaseHost,database:this.databaseConfig.database,username:this.databaseConfig.databaseUsername,password:this.databaseConfig.databasePassword,useLocalForage:this.databaseConfig.useLocalForage,entities:e,subscribers:t,synchronize:this.isRunOrRevertOnlyMigrationAppStart?!1:this.databaseConfig.synchronize,autoSave:n,dropSchema:this.isRunOrRevertOnlyMigrationAppStart?!1:this.databaseConfig.dropSchema,logging:!!this.databaseConfig.logging,location:this.databaseConfig.location}:{};if(this.logFramework&&console.log(`[Context: "${this.contextName}"] dataSourceDbConfig`,s),this.modeAllowsDatabaseCreation&&this.databaseConfig){this.logDb&&this.logFramework&&F.info("[taon][database] prepare typeorm connection...");try{let i=new ki(s);this.connection=i,await this.connection.initialize()}catch(i){console.error(`[taon][typeorm] Error while initializing connection for ${this.contextName}, ERROR STARTED `),console.error(i?.stack||"< No stack trace > "),console.error(i?.message||i),console.error(`[taon][typeorm] Error while initializing connection for ${this.contextName}, ERROR ENDS `)}if(!this.connection?.isInitialized)throw console.log("WRONG CONFIG",s),new Error(`Something wrong with connection init in ${this.mode}`);(this.logDb||this.logFramework)&&(console.info(`

        CONTECTION OK for ${this.contextName} - ${this.mode}

        [taon][typeorm] db prepration done.. db initialize=${this.connection?.isInitialized}


        `,{"this.connection":!!this.connection}),console.log(`Database file location: ${this.connection.options.database}`))}else F.info(`[taon][typeorm] Not initing db for mode ${this.mode}`)}updateCalculatedPathsForControllers(e,t,n){let s=y.slice(e,1).reverse().map(r=>mt.isGoodPath(r.path)?r.path:r.className).join("/"),i=this.contextNameForCommunication;mt.isGoodPath(t.path)?t.calculatedPath=t.path:t.calculatedPath=`${this.uriPathnameOrNothingIfRoot}/${Dn}/${i}/tcp${s}/${Z.getName(n)}`.replace(/\/\//g,"/").split("/").reduce((r,o)=>y.last(r)===o?r:[...r,o],[]).join("/")}mergeControllerMethodsConfigs(e,t,n){let s=t.methods;y.slice(e,1).forEach(i=>{let r=y.cloneDeep(i.methods);for(let o in r)if(r.hasOwnProperty(o)&&!s[o]){let c=r[o];s[o]=c}})}async initControllersHook(e){if(this.isRunOrRevertOnlyMigrationAppStart)return;let t=this.getClassFunByArr(K.ClassType.CONTROLLER);for(let n of t){let s=this.getInstanceBy(n);y.isFunction(s.afterAllCtxInited)&&await s.afterAllCtxInited({ctxStorage:e})}}async initControllers(){if(this.isRunOrRevertOnlyMigrationAppStart)return;let e=this.getClassFunByArr(K.ClassType.CONTROLLER);for(let t of e){t[I.classMethodsNames]=Z.getMethodsNames(t);let n=Z.getControllerConfigs(t),s=n[0];this.updateCalculatedPathsForControllers(n,s,t),this.mergeControllerMethodsConfigs(n,s,t),s.calculatedMiddlewaresControllerObj={},[...n].reverse().forEach(r=>{y.isFunction(r.middlewares)&&(s.calculatedMiddlewaresControllerObj=r.middlewares({parentMiddlewares:s.calculatedMiddlewaresControllerObj,className(o){return Z.getName(t)}}))}),this.logHttp&&console.groupCollapsed(`[taon][express-server] routes [${s.className}]`);let i=Object.keys(s.methods);for(let r of i){let o=s.methods[r],c={};[...n].reverse().forEach(f=>{if(f.methods[r]){let p=f.methods[r];y.isFunction(p.middlewares)&&(c=p.middlewares({parentMiddlewares:c,className(m){return Z.getName(t)}}))}}),o.calculatedMiddlewaresMethodObj=oe(oe({},c),s.calculatedMiddlewaresControllerObj),o.calculatedMiddlewares=Object.values(o.calculatedMiddlewaresMethodObj||{});let l=o.type,u=this.isRunningInsideDocker||!this.frontendHostUri?.origin?.includes("localhost")?`${this.uriPathnameOrNothingIfRoot.replace(/\/$/,"")}/${Dn}/${this.contextName}`.replace(/\/\//,"/"):"",h=o.global?`${u}/${o.path?.replace(/\/$/,"")}`.replace(/\/\//,"/"):mt.getExpressPath(s,o);if(F.isNode||F.isWebSQL){let f=this.initServer(l,o,s,h,t);this.activeRoutes.push({expressPath:f.expressPath,method:f.method})}(F.isBrowser||this.isRemoteHost||F.isWebSQL)&&await this.initClient(t,l,o,h)}this.logHttp&&console.groupEnd()}}writeActiveRoutes(){if(this.isRemoteHost||this.isRunOrRevertOnlyMigrationAppStart)return;let e=Kn.uniqArray(this.activeRoutes.map(s=>`${s.method} ${s.expressPath}`)).map(s=>{let[i,r]=s.split(" ");return`
### ${y.startCase(y.last(r.split("/")))}
`+mt.fillUpTo(i.toUpperCase()+" ",10)+this.uriOrigin+r}),t=["",`#  ROUTES FOR HOST ${this.uriOrigin} `,...e].join(`
`),n=Ls([`routes/routes-${this.config.contextName}.rest`]);this.logFramework&&console.log(`[taon] routes file: ${n} `),this.logRoutes&&console.log(t)}get middlewares(){}async initCustomClientMiddlewares(){this.getClassesInstancesArrBy(K.ClassType.MIDDLEWARE).map(t=>t).filter(t=>y.isFunction(t.interceptClient)).forEach(t=>{let n=this.contextName,s=`${n}-${Z.getName(t)}`;Ge.request.interceptors.set(s,{intercept:({req:i,next:r})=>new URL(i.url).pathname.startsWith(`${this.uriPathnameOrNothingIfRoot}/${Dn}/${n}/`)?t.interceptClient({req:i,next:r}):r.handle(i)})})}async initCustomBackendMiddlewares(){}async initBackendMiddlewares(){}initServer(e,t,n,s,i){let r=t.calculatedMiddlewares.map(c=>{let l=this.getInstanceBy(c);if(l&&y.isFunction(l.interceptServerMethod))return Z.asyncHandler(async(h,d,f)=>{await l.interceptServerMethod({req:h,res:d,next:f},{methodName:t.methodName,expressPath:s,httpRequestType:t.type})})}).filter(c=>!!c),o=async(c,l,u)=>{let h=t.descriptor.value.apply(this.getInstanceBy(i),c);return await Kc(h,{req:l,res:u})};return F.isElectron,this.isRemoteHost||F.isWebSQL&&(this.expressApp[e.toLowerCase()]||(this.expressApp[e.toLowerCase()]=()=>{})),{expressPath:s,method:t.type}}sendError(e,t,n,s){}async initClient(e,t,n,s){let i=this;n.calculatedMiddlewares.map(D=>this.getInstanceBy(D)).filter(D=>y.isFunction(D.interceptClientMethod)).forEach(D=>{let J=`${Z.getName(D)}-${n.type?.toUpperCase()}-${s}`;Ge.request.methodsInterceptors.set(J,{intercept:({req:re,next:le})=>D.interceptClientMethod({req:re,next:le},{methodName:n.methodName,expressPath:s,httpRequestType:t})})});let c=globalThis,l=e.prototype[n.methodName];if(F.isElectron){let D=window.require("electron").ipcRenderer;e.prototype[n.methodName]=function(...q){let J=new Promise(async(re,le)=>{let ue={},{request:de,response:E}=mt.websqlMocks(ue);D.once(mt.ipcKeyNameResponse(e,n,s),(T,O)=>{let k=O;console.log({responseData:O});try{let V=k;k=new st.HttpResponse({body:void 0,isArray:void 0,method:n.type,url:`${i.uriOrigin}${n.path} `},F.isBlob(V)||y.isString(V)?V:JSON.stringify(V),Se.from(ue),void 0,()=>V),re(k)}catch(V){console.error(V),le(V)}}),D.send(mt.ipcKeyNameRequest(e,n,s),q)});return J.observable=Hn(J),{received:J,request(re){return J}}};return}let u=400,h=200,d=globalThis,f=d[I.old.WEBSQL_REST_PROGRESS_TIMEOUT]||u,p=d[I.old.WEBSQL_REST_PROGRESS_FUN];d[I.old.WEBSQL_REST_PROGRESS_FUN]||(d[I.old.WEBSQL_REST_PROGRESS_FUN]=new Oe),p=d[I.old.WEBSQL_REST_PROGRESS_FUN];let m=d[I.old.WEBSQL_REST_PROGRESS_FUN_START];d[I.old.WEBSQL_REST_PROGRESS_FUN_START]||(d[I.old.WEBSQL_REST_PROGRESS_FUN_START]=new Oe),m=d[I.old.WEBSQL_REST_PROGRESS_FUN_START];let x=d[I.old.WEBSQL_REST_PROGRESS_FUN_DONE];d[I.old.WEBSQL_REST_PROGRESS_FUN_DONE]||(d[I.old.WEBSQL_REST_PROGRESS_FUN_DONE]=new Oe),x=d[I.old.WEBSQL_REST_PROGRESS_FUN_DONE];let S=0;f>=u&&(S=Math.floor(f/h));let G=async()=>{m.next();for(let D=1;D<=S;D++){let q=Math.round(h*D/f*100);q>100&&(q=100),p.next(q),await new Promise((J,re)=>{setTimeout(()=>{J(void 0)},h)})}x.next()};e.prototype[n.methodName]=function(...D){let q=new Promise(async(J,re)=>{let le={},{request:ue,response:de}=mt.websqlMocks(le),E;try{E=await F.runSyncOrAsync({functionFn:l,context:this,arrayOfParams:D}),typeof E=="function"&&(E=await F.runSyncOrAsync({functionFn:E,context:this,arrayOfParams:[ue,de]})),typeof E=="function"&&(E=await F.runSyncOrAsync({functionFn:E,context:this,arrayOfParams:[ue,de]})),typeof E=="object"&&E?.received&&(E=await E.received);let T=E;E=new st.HttpResponse({body:void 0,isArray:void 0,method:n.type,url:`${i.uriOrigin}${n.path} `},F.isBlob(T)||y.isString(T)?T:JSON.stringify(T),Se.from(le),void 0,()=>T),await G(),J(E)}catch(T){await G(),console.error(T),re(T)}});if(q.observable=Hn(q),F.isWebSQL)return{received:q,request(J){return q}}},!F.isWebSQL&&(e.prototype[n.methodName]=function(...D){c[I.old.ENDPOINT_META_CONFIG]||(c[I.old.ENDPOINT_META_CONFIG]={}),c[I.old.ENDPOINT_META_CONFIG][i.uriOrigin]||(c[I.old.ENDPOINT_META_CONFIG][i.uriOrigin]={});let q=c[I.old.ENDPOINT_META_CONFIG],J;if(q[i.uriOrigin][s])J=q[i.uriOrigin][s];else{let T={};n.contentType&&!n.responseType?J=Ge.create(i.uriOrigin,s,I.old.MAPPING_CONFIG_HEADER,I.old.CIRCURAL_OBJECTS_MAP_BODY,Se.from({"Content-Type":n.contentType,Accept:n.contentType})):n.contentType&&n.responseType?J=Ge.create(i.uriOrigin,s,I.old.MAPPING_CONFIG_HEADER,I.old.CIRCURAL_OBJECTS_MAP_BODY,Se.from({"Content-Type":n.contentType,Accept:n.contentType,responsetypeaxios:n.responseType})):!n.contentType&&n.responseType?J=Ge.create(i.uriOrigin,s,I.old.MAPPING_CONFIG_HEADER,I.old.CIRCURAL_OBJECTS_MAP_BODY,Se.from({responsetypeaxios:n.responseType})):J=Ge.create(i.uriOrigin,s,I.old.MAPPING_CONFIG_HEADER,I.old.CIRCURAL_OBJECTS_MAP_BODY),q[i.uriOrigin][s]=J}let re=t.toLowerCase(),le={},ue={},de={};if(D.forEach((T,O)=>{let k;for(let V in n.parameters){let me=n.parameters[V];if(me.index===O){k=me;break}}if(!k){let V=`[${Jo.frameworkName}] Unable to resolve parameter at index ${O} for method ${n.methodName} at path ${s}.`;throw new Error(V)}if(k.paramType==="Path"&&(le[k.paramName]=T),k.paramType==="Query")if(k.paramName){let V=Nt.decode(T,!i.isProductionMode);V&&J.headers.set(`${I.old.MAPPING_CONFIG_HEADER_QUERY_PARAMS}${k.paramName} `,JSON.stringify(V)),ue[k.paramName]=T}else{let V=Nt.decode(T,!i.isProductionMode);V&&J.headers.set(I.old.MAPPING_CONFIG_HEADER_QUERY_PARAMS,JSON.stringify(V)),ue=y.cloneDeep(T)}if(k.paramType==="Header")if(k.paramName)k.paramName===I.old.MDC_KEY?J.headers.set(k.paramName,encodeURIComponent(JSON.stringify(T))):J.headers.set(k.paramName,T);else for(let V in T)J.headers.set(V,T[V]);if(k.paramType==="Cookie"&&Ge.Cookies.write(k.paramName,T,k.expireInSeconds),k.paramType==="Body")if(k.paramName){if(Z.getName(de)==="FormData")throw new Error(`[taon - framework] Don use param names when posting / putting FormData.
              Use this:
// ...
(@Taon.Http.Param.Body() formData: FormData) ...
// ...

instead
  // ...
  (@Taon.Http.Param.Body('${k.paramName}') formData: FormData) ...
// ...
`);let V=Nt.decode(T,!i.isProductionMode);V&&J.headers.set(`${I.old.MAPPING_CONFIG_HEADER_BODY_PARAMS}${k.paramName} `,JSON.stringify(V)),de[k.paramName]=T}else{let V=Nt.decode(T,!i.isProductionMode);V&&J.headers.set(I.old.MAPPING_CONFIG_HEADER_BODY_PARAMS,JSON.stringify(V)),de=T}}),typeof de=="object"&&Z.getName(de)!=="FormData"){let T=[];de=Ze.parse(Ze.stringify(de,void 0,void 0,O=>{T=O})),J.headers.set(I.old.CIRCURAL_OBJECTS_MAP_BODY,Ze.stringify(T))}if(typeof ue=="object"){let T=[];ue=Ze.parse(Ze.stringify(ue,void 0,void 0,O=>{T=O})),J.headers.set(I.old.CIRCURAL_OBJECTS_MAP_QUERY_PARAM,Ze.stringify(T))}return{get received(){return J.model(le)[re](de,[ue])},request(T){return J.model(le)[re](de,[ue],T)}}})}};var Ms=class a{constructor(){this.SPECIAL_APP_READY_MESSAGE=ln.SPECIAL_APP_READY_MESSAGE,this.taonEndpointContexts=new Map}static get Instance(){return a.instance||(a.instance=new a),a.instance}set(e){this.taonEndpointContexts.has(e.contextName)||this.taonEndpointContexts.set(e.contextName,e)}get arr(){return Array.from(this.taonEndpointContexts.values()).filter(e=>e.contextType==="normal")}getBy(e){return typeof e=="string"?this.taonEndpointContexts.get(e):this.taonEndpointContexts.get(e.contextName)}};globalThis.$$$ContextsEndpointStorage$$$=Ms.Instance;var Ib=a=>()=>Fo(a),Bo=(a,e)=>{e=e||{};let t=a({}),n=new ur(t,a,e);return{get contextName(){return t.contextName},get appId(){return t.appId},cloneAsRemote:i=>{i=i||{};let r=je(oe({},i),{sourceContext:n,useAsRemoteContext:!0});return Bo(a,r)},cloneAsNormal:i=>{i=i||{};let r=je(oe({},i),{sourceContext:n,useAsRemoteContext:!1});return Bo(a,r)},async __ref(){return n.inited||await n.init({initFromRecrusiveContextResovle:!0}),n},get __refSync(){return n},getClassInstance(i){return n.getInstanceBy(i)},getClass(i){return n.getClassFunByClass(i)},initialize:async i=>await new Promise(async(r,o)=>{setTimeout(async()=>{if(lt.isRunningInDocker()){let c=t?.activeContext||null;if(y.isString(c)&&c!==""&&c!==t?.contextName){console.warn(`[taon] Context ${n.contextName} is not active context, skipping initialization.`),r(n);return}}if(await n.init(oe({},i)),t.abstract)throw new Error("Abstract context can not be initialized");if(await n.initEntities(),await n.initSubscribers(),await n.initDatabaseConnection(),await n.dbMigrations.ensureMigrationTableExists(),await n.initControllers(),await n.startServer(),n.writeActiveRoutes(),await n.initClasses(),n.databaseConfig){let c=!1;c=Fn.Instance?.keepWebsqlDbDataAfterReload,c?!lt.isRunningInCliMode()&&F.info(`[taon] Keeping websql data after reload (context=${n.contextName}).`):F.info(`[taon] Dropping all tables and data (context=${n.contextName}).`),n.onlyMigrationRun?(n.logMigrations&&F.log(`[taon] Running only migrations (context=${n.contextName}).`),await n.dbMigrations.runAllNotCompletedMigrations()):n.onlyMigrationRevertToTimestamp?(n.logMigrations&&F.log(`[taon] Reverting migrations to timestamp ${n.onlyMigrationRevertToTimestamp} (context=${n.contextName}).`),await n.dbMigrations.revertMigrationToTimestamp(n.onlyMigrationRevertToTimestamp)):(n.logMigrations&&F.log(`[taon] Running all not applied migrations (context=${n.contextName}).`),await n.dbMigrations.runAllNotCompletedMigrations())}Ms.Instance.set(n),r(n)})}),get realtime(){return{get client(){return n.realtimeClient},get server(){return n.realtimeServer}}}}},Fo=a=>Bo(a,{useAsRemoteContext:!1});var Fb=wt(Pl());function _l(a){return function(e){Reflect.defineMetadata(I.metadata.options.provider,a,e),Reflect.defineMetadata(I.metadata.className,a?.className||e.name,e),Z.setName(e,a?.className||e.name)}}var Ln=class{async _(){}get __endpoint_context__(){return this[I.ctxInClassOrClassObj]}get ctx(){return this.__endpoint_context__}injectRepo(e){return this.__inject(void 0,{localInstance:!0,resolveClassFromContext:"TaonBaseRepository",locaInstanceConstructorArgs:[()=>e]})}injectCustomRepository(e){return this.__inject(e,{localInstance:!0,locaInstanceConstructorArgs:[()=>this.ctx.allClassesInstances[Z.getName(e)].entityClassResolveFn()]})}injectCustomRepo(e){return this.injectCustomRepository(e)}injectController(e){return this.__inject(e,{localInstance:!1})}injectSubscriber(e){return this.__inject(e,{localInstance:!1})}injectCtrl(e){return this.injectController(e)}injectMiddleware(e){return this.__inject(e,{localInstance:!1})}injectProvider(e){return this.__inject(e,{localInstance:!1})}__inject(e,t){t||(t={});let n=this;return new Proxy({},{get:(s,i)=>{let r=e&&e[I.ctxInClassOrClassObj],o=r||this.__endpoint_context__;if(t.resolveClassFromContext&&(e=o.getClassFunByClassName(t.resolveClassFromContext)),o){var c=o.inject(e,je(oe({},t),{contextClassInstance:n,parentInstanceThatWillGetInjectedStuff:this}));if(!c)throw new Error(`Not able to inject "${Z.getName(e)||e.name}" inside property "${i?.toString()}" on  class "${Z.getName(this)}".

              Please add "${Z.getName(e)||e.name}" to (entites or contorllers or providers or repositories or middlewares)

              `);return typeof c[i]=="function"?c[i].bind(c):c[i]}},set:(s,i,r)=>{let o=e&&e[I.ctxInClassOrClassObj],c=o||this.__endpoint_context__;if(t.resolveClassFromContext&&(e=c.getClassFunByClassName(t.resolveClassFromContext)),c){var l=c.inject(e,je(oe({},t),{contextClassInstance:n,parentInstanceThatWillGetInjectedStuff:this}));if(!l){let u=Z.getName(e)||e.name;throw new Error(`Not able to inject "${u}" inside property "${i?.toString()}" on  class "${Z.getName(this)}".

              Please add "${Z.getName(e)||e.name}" to (entites or contorllers or providers or repositories or middlewares)

              `)}l[i]=r}return!0}})}};var hr=class extends Ln{};var Il=(()=>{let a=class extends hr{async interceptServerMethod({req:t,res:n,next:s},{methodName:i,expressPath:r}){return this.middleware()(t,n,s)}uploadDir(){return Ls([this.ctx.cwd,"uploaded-files"])}storage(){}upload(){}middleware(){}};return a=Qe([_l({className:"TaonBaseFileUploadMiddleware"})],a),a})();var ie=(function(a){return a[a.DATA=0]="DATA",a[a.INFO=1]="INFO",a[a.WARN=2]="WARN",a[a.ERROR=3]="ERROR",a[a.SUCCESS=4]="SUCCESS",a[a.TASK_STARTED=5]="TASK_STARTED",a[a.TASK_DONE=6]="TASK_DONE",a[a.__NOTHING=7]="__NOTHING",a})(ie||{}),Ut={[ie.DATA]:"log",[ie.INFO]:"info",[ie.WARN]:"warn",[ie.ERROR]:"error",[ie.SUCCESS]:"success",[ie.TASK_STARTED]:"taskstarted",[ie.TASK_DONE]:"taskdone",[ie.__NOTHING]:""},Dl=[Ut[ie.DATA],Ut[ie.TASK_STARTED],Ut[ie.TASK_DONE],Ut[ie.INFO],Ut[ie.SUCCESS],Ut[ie.WARN],Ut[ie.ERROR]],Ot=class{static msg(e,t,n,s,i,r,o){if(o)return;let c="gray";if(i===ie.INFO&&(c="deepskyblue"),i===ie.ERROR&&(c="red"),i===ie.WARN&&(c="orange"),r){let l=r-n.length;if(l>0)for(let u=0;u<l;u++)n+=" "}if(ae.isBrowser)if(document.documentMode||/Edge/.test(navigator.userAgent)){if(typeof e=="string"){let u="[[ "+n+" ]] "+e+" ";t.unshift(u)}else{let u="[[ "+n+"]] ";t.push(e),t.unshift(u)}i===ie.INFO?console.info.apply(console,t):i===ie.ERROR?console.error.apply(console,t):i===ie.WARN?console.warn.apply(console,t):console.log.apply(console,t)}else{if(typeof e=="string"){let u="%c "+n+"  %c "+e+" ",h="background: "+s+";color:white; border: 1px solid "+s+"; ",d="border: 1px solid "+c+"; ";t.unshift(d),t.unshift(h),t.unshift(u)}else{let u="%c "+n+" ",h="background: "+s+";color:white; border: 1px solid "+c+"; ";t.push(e),t.unshift(h),t.unshift(u)}console.log.apply(console,t)}}},Lo=class{setLevel(e){return this._level=e,this}get isProductionMode(){return!this.developmentMode}setProductionMode(e){return this.developmentMode=!e,this}mute(){return this.isMuted=!0,this}constructor(e,t,n,s,i,r){this.name=e,this.color=t,this.developmentMode=n,this.allowed=s,this.isMuted=i,this.fixedWidth=r,this.d=(o,...c)=>this._data(o,c),this.er=(o,...c)=>this._error(o,c),this.i=(o,...c)=>this._info(o,c),this.w=(o,...c)=>this._warn(o,c),this.data=(o,...c)=>this._data(o,c),this.error=(o,...c)=>this._error(o,c),this.info=(o,...c)=>this._info(o,c),this.success=(o,...c)=>this._success(o,c),this.taskStarted=(o,...c)=>this._taskStarted(o,c),this.taskDone=(o,...c)=>this._taskDone(o,c),this.warn=(o,...c)=>this._warn(o,c)}onlyWhen(e){typeof e=="function"?this.isMuted=!e():typeof e=="boolean"&&(this.isMuted=!e)}_data(e,...t){return this.isMuted?this:this.allowed.length>=1&&ae.contain(this.allowed,ie.__NOTHING)&&!ae.contain(this.allowed,ie.DATA)?this:((this.allowed.length===0||ae.contain(this.allowed,ie.DATA))&&Ot.msg.apply(void 0,[e,...t,this.name,this.color,ie.DATA,this.fixedWidth,this.isProductionMode]),this)}_error(e,...t){return this.isMuted?this:this.allowed.length>=1&&ae.contain(this.allowed,ie.__NOTHING)&&!ae.contain(this.allowed,ie.ERROR)?this:((this.allowed.length===0||ae.contain(this.allowed,ie.ERROR))&&Ot.msg.apply(void 0,[e,...t,this.name,this.color,ie.ERROR,this.fixedWidth,this.isProductionMode]),this)}_info(e,...t){return this.isMuted?this:this.allowed.length>=1&&ae.contain(this.allowed,ie.__NOTHING)&&!ae.contain(this.allowed,ie.INFO)?this:((this.allowed.length===0||ae.contain(this.allowed,ie.INFO))&&Ot.msg.apply(void 0,[e,...t,this.name,this.color,ie.INFO,this.fixedWidth,this.isProductionMode]),this)}_success(e,...t){return this.isMuted?this:this.allowed.length>=1&&ae.contain(this.allowed,ie.__NOTHING)&&!ae.contain(this.allowed,ie.SUCCESS)?this:((this.allowed.length===0||ae.contain(this.allowed,ie.SUCCESS))&&Ot.msg.apply(void 0,[e,...t,this.name,this.color,ie.SUCCESS,this.fixedWidth,this.isProductionMode]),this)}_taskStarted(e,...t){return this.isMuted?this:this.allowed.length>=1&&ae.contain(this.allowed,ie.__NOTHING)&&!ae.contain(this.allowed,ie.TASK_STARTED)?this:((this.allowed.length===0||ae.contain(this.allowed,ie.TASK_STARTED))&&Ot.msg.apply(void 0,[e,...t,this.name,this.color,ie.TASK_STARTED,this.fixedWidth,this.isProductionMode]),this)}_taskDone(e,...t){return this.isMuted?this:this.allowed.length>=1&&ae.contain(this.allowed,ie.__NOTHING)&&!ae.contain(this.allowed,ie.TASK_DONE)?this:((this.allowed.length===0||ae.contain(this.allowed,ie.TASK_DONE))&&Ot.msg.apply(void 0,[e,...t,this.name,this.color,ie.TASK_DONE,this.fixedWidth,this.isProductionMode]),this)}_warn(e,...t){return this.isMuted?this:this.allowed.length>=1&&ae.contain(this.allowed,ie.__NOTHING)&&!ae.contain(this.allowed,ie.WARN)?this:((this.allowed.length===0||ae.contain(this.allowed,ie.WARN))&&Ot.msg.apply(void 0,[e,...t,this.name,this.color,ie.WARN,this.fixedWidth,this.isProductionMode]),this)}},$l=(()=>{class a{constructor(){this._logOnly=!1,this._logModules=!1,this.isDevelopmentMode=!0,this.modeIsSet=!1,this.fixedWidth=0,this.instances={},this.levels=[],this.modules=[]}static get instance(){return a._instance||(a._instance=new a),a._instance}static{this.Logger=Lo}static create(t,...n){return a.instance.create(t,...n)}static{this.consolelogfn={}}static disableLogs(t=ie.__NOTHING){Dl.reverse().find(n=>(this.consolelogfn[n]||(this.consolelogfn[n]=console[n]),console[n]=()=>{},n===Ut[t]))}static enableLogs(){Dl.forEach(t=>{console[t]=this.consolelogfn[t]})}setProductionMode(){if(this.modeIsSet)throw this.modeIsSet=!1,"[ng2-logger] Production mode is already set";this.modeIsSet=!0,setTimeout(()=>{this.modeIsSet&&console!==void 0&&console.clear!==void 0&&(console.clear(),console.log=()=>{},console.error=()=>{},console.warn=()=>{},console.info=()=>{})}),this.isDevelopmentMode=!1}onlyModules(...t){if(this._logModules)throw"[ng2-logger] You should use funcion onlyModules only once";this._logModules||(this._logModules=!0),t.length!==0&&(this.modules=t,this.muteAllOtherModules())}onlyLevel(...t){if(this._logOnly)throw"[ng2-logger] You should use funcion onlyLevel only once";this._logOnly||(this._logOnly=!0),this.levels=Array.isArray(t)?t:[t];for(let n in this.instances)if(this.instances.hasOwnProperty(n)){let s=this.instances[n];s.allowed=this.levels}}create(t,...n){let s;return Array.isArray(this.levels)&&this.levels.length>0&&(n=this.levels),this.instances[t]===void 0?(s=new a.Logger(t,ql(),this.isDevelopmentMode,n,this.isMutedModule(t),this.levels.length>0?this.fixedWidth:void 0),this.instances[t]=s):s=this.instances[t],s}isMutedModule(t){return this.modules.length==0?!1:!ae.contain(this.modules,t)}muteAllOtherModules(){for(var t in this.instances)ae.contain(this.modules,t)||this.instances[t].mute()}}return a})();function ql(){let a="012345".split(""),e="#";e+=a[Math.round(Math.random()*5)],a="0123456789ABCDEF".split("");for(let t=0;t<5;t++)e+=a[Math.round(Math.random()*15)];return e===void 0?ql():e}var Os=class{},kn=class a extends Os{constructor(e,t,n){super(),this._parenthesis=!1,this._negation=!1,this._sibling=e,this._child=t,this._chainType=n}$(){return this._parenthesis=!0,this}not(){return this._negation=!0,this}and(e){return new a(this,e,"and")}or(e){return new a(this,e,"or")}},jn=class extends Os{constructor(e,t,...n){super(),this._column=e,this._type=t,this._values=n}and(e){return new kn(this,e,"and")}or(e){return new kn(this,e,"or")}},dr=class{constructor(e,t,n=[]){this._table=e,this._name=t,this._modifiers=n}as(e){return new this.constructor(this._table,this._name,this._modifiers.concat({name:"as",params:e}))}isNull(){return new jn(this,"is-null")}isNotNull(){return new jn(this,"is-not-null")}},fr=class{constructor(e,t){this._column=e,this._direction=t}nullsFirst(){return this._nullsPosition="FIRST",this}nullsLast(){return this._nullsPosition="LAST",this}},jo=class extends Os{constructor(e,t,n){super(),this._column=e,this._type=t,this._otherColumn=n}and(e){return new kn(this,e,"and")}or(e){return new kn(this,e,"or")}},Uo=class extends dr{constructor(e,t,n=[]){super(e,t,n)}asc(){return new fr(this,"ASC")}desc(){return new fr(this,"DESC")}eq(e){return e instanceof dr?new jo(this,"eq",e):new jn(this,"eq",e)}ne(e){return new jn(this,"ne",e)}};var As=class{constructor(e,t){this._queryProcessor=e,this._tables=t,this._distinct=!1,this._conditions=[],this._groupBy=[],this._having=[],this._orderings=[],this._columns=[]}offset(e){return this._offset=e,this}limit(e){return this._limit=e,this}distinct(){return this._distinct=!0,this}where(...e){return this._conditions=e,this}groupBy(...e){return this._groupBy=e,this}having(...e){return this._having=e,this}orderBy(...e){return this._orderings=e,this}select(...e){return this._columns=e,this._action="select",this._queryProcessor(this)}},Vo=class{constructor(e,t,n){this._queryProcessor=e,this._table=t,this._conditions=n,this._columns=[]}update(e){return this._entity=e,this._action="update",this._queryProcessor(this)}delete(){return this._action="delete",this._queryProcessor(this)}count(){return this._columns=[this._table.$all.count()],this._action="select",this._queryProcessor(this).then(e=>e[0])}},Wo=class{constructor(e,t){this._queryProcessor=e,this._table=t,this._columns=[]}where(...e){return new Vo(this._queryProcessor,this._table,e)}insert(e){return this._entity=e,this._action="insert",this._queryProcessor(this)}deleteAll(){return this._action="delete",this._queryProcessor(this)}updateAll(e){return this._entity=e,this._action="update",this._queryProcessor(this)}countAll(){return this._columns=[this._table.$all.count()],this._action="select",this._queryProcessor(this).then(e=>e[0])}delete(e){return this._whereId(e).delete().then(t=>t>0)}update(e,t){return this._whereId(e).update(t).then(n=>n>0)}get(e){let t=this._whereId(e);return this._queryProcessor(oe({_action:"select"},t)).then(n=>n[0])}_whereId(e){let t=this._table.$id;return t instanceof Uo?this.where(t.eq(e)):this.where(...Object.keys(t).map(n=>this._table[n].eq(e[n])))}},Qo=class{constructor(e){this._queryProcessor=e}from(e,t,n){return n!=null?new As(this._queryProcessor,[e,t,n]):t!=null?new As(this._queryProcessor,[e,t]):new As(this._queryProcessor,[e])}table(e){return new Wo(this._queryProcessor,e)}};function ko(a){let e=Number(a);if(Number.isNaN(e))throw new Error("Invalid number parameter in SQL query: "+a);return e}function Wh(a){if(typeof a=="boolean")return a;if(a instanceof Boolean)return a.valueOf();if(a==="true")return!0;if(a==="false")return!1;throw new Error("Invalid boolean parameter in SQL query: "+a)}function Qh(a){if(a instanceof Date)return a;if(typeof a=="number"||a instanceof Number)return new Date(a);if(typeof a=="string"||a instanceof String){if(Number.isNaN(Date.parse(String(a))))throw new Error("Invalid date parameter in SQL query: "+a);return new Date(a)}throw new Error("Invalid date parameter in SQL query: "+a)}function Gh(a){if(typeof a=="string")return a;if(a instanceof String)return a.valueOf();throw new Error("Invalid string parameter in SQL query: "+a)}function Bl(a,e,t){return n;function n(E){if(E._action==="select")return u(E);if(E._action==="delete")return s(E);if(E._action==="update")return i(E);if(E._action==="insert")return o(E);throw new Error("Unknown query type:"+E._action)}function s(E){let T="DELETE FROM "+p(E._table);return T+=h(E._conditions),T}function i(E){let T="UPDATE "+p(E._table)+" SET ";return T+=r(E._table,E._entity),T+=h(E._conditions),T}function r(E,T){return Object.keys(T).sort().map(O=>{let k=T[O],V=E[O];return S(V)+" = "+ue(V,k)}).join(", ")}function o(E){let T=Array.isArray(E._entity)?E._entity:[E._entity],O=T.reduce((me,fe)=>(Object.keys(fe).forEach(we=>me.add(we)),me),new Set),k=Array.from(O).sort(),V="INSERT INTO "+p(E._table)+" ";return V+="("+k.map(me=>S(E._table[me])).join(", ")+")",V+=e.lineBreak+"VALUES ",V+=T.map(me=>l(E._table,me,k)).map(me=>"("+me+")").join(", "),V+=c(E),V}function c(E){return t==="pg"&&E._action==="insert"&&!Array.isArray(E._entity)&&E._table.$id&&E._table.$id._table&&E._table.$id._name?" RETURNING "+S(E._table.$id):""}function l(E,T,O){return O.map(k=>{let V=T[k],me=E[k];return ue(me,V)}).join(", ")}function u(E){let T="SELECT ";return E._distinct&&(T+="DISTINCT "),E._columns==null||E._columns.length===0?T+="*":T+=E._columns.map(O=>m(O)).join(", "),T+=e.lineBreak+"FROM ",E._tables?T+=E._tables.map(O=>O._parent?d(O):p(O)).join(", "):T+=p(E._table),T+=h(E._conditions),E._groupBy&&E._groupBy.length>0&&(T+=e.lineBreak+"GROUP BY ",T+=E._groupBy.map(O=>m(O)).join(", ")),T+=h(E._having,"HAVING"),E._orderings&&E._orderings.length>0&&(T+=e.lineBreak+"ORDER BY ",T+=E._orderings.map(O=>f(O)).join(", ")),E._limit!=null&&(T+=e.lineBreak+"LIMIT "+ko(E._limit)),E._offset!=null&&(T+=e.lineBreak+"OFFSET "+ko(E._offset)),T}function h(E,T="WHERE"){let O="";return E&&E.length>0&&(O+=e.lineBreak+T+" ",G(E),O+=E.map(k=>q(k,!0)).join(" AND ")),O}function d(E){let T=[];for(;E;)T.push(E),E=E._parent;let O=T[T.length-1],k=p(O);for(let V=T.length-2;V>=0;V-=2){let me=T[V]._table,fe=T[V]._modifier,we=T[V-1]._condition,Ae=m(we._otherColumn);k+=" "+fe.toUpperCase()+" JOIN "+p(me)+" ON "+J(we,Ae)}return k}function f(E){if(E._column){let T=m(E._column);return E._nullsPosition!=null&&(T+=" IS NULL "+(E._nullsPosition==="FIRST"?"DESC":"ASC")+", "+T),E._direction==="ASC"&&(T+=" ASC"),E._direction==="DESC"&&(T+=" DESC"),T}else return m(E)}function p(E){return e.nameEscape+E._$name+e.nameEscape}function m(E){let T="";return E._name==="*"&&E._modifiers.length>0&&E._modifiers[0].name==="count"||(T+=p(E._table)+"."),T+=S(E),x(T,E)}function x(E,T){return T._modifiers&&T._modifiers.forEach(O=>{let k=O.name;k==="lower"?E="LOWER("+E+")":k==="upper"?E="UPPER("+E+")":k==="count"?E="COUNT("+E+")":k==="sum"?E="SUM("+E+")":k==="avg"?E="AVG("+E+")":k==="min"?E="MIN("+E+")":k==="max"?E="MAX("+E+")":k==="as"&&(E=E+" AS "+e.nameEscape+O.params+e.nameEscape)}),E+""}function S(E){if(E._name==="*")return E._name;let T=typeof E._name=="string"?E._name:E._name.name;return e.nameEscape+T+e.nameEscape}function G(E){E.forEach(T=>{E.length>1&&T._sibling&&(T._parenthesis=!0),D(T)})}function D(E){E._sibling&&D(E._sibling),!E._sibling&&!E._child&&(E.__param=le(E)),E._child&&D(E._child)}function q(E,T=!1){if(!E._sibling&&!E._child)return J(E,E.__param);let O="";return E._child&&(O+=q(E._child)),E._sibling&&(O=q(E._sibling,T)+" "+E._chainType.toUpperCase()+" "+O),(E._parenthesis||(!T||E._negation)&&E._child)&&(O="( "+O+" )"),E._negation&&(O="NOT "+O),O}function J(E,T){let O=m(E._column);return O+=re(E,T),O}function re(E,T){switch(E._type){case"eq":return" = "+T;case"ne":return" <> "+T;case"lt":return" < "+T;case"gt":return" > "+T;case"lte":return" <= "+T;case"gte":return" >= "+T;case"is-null":return" IS NULL";case"is-not-null":return" IS NOT NULL";case"like":return" LIKE "+T;case"not-like":return" NOT LIKE "+T;case"in":return" IN ("+T+")";case"not-in":return" NOT IN ("+T+")";case"between":return" BETWEEN "+T;case"not-between":return" NOT BETWEEN "+T;default:return""}}function le(E){let T="";if(E._otherColumn)T=m(E._otherColumn);else{let O=k=>ue(E._column,k);E._type==="in"||E._type==="not-in"?T=E._values.map(k=>O(k)).join(", "):E._type==="between"||E._type==="not-between"?T=O(E._values[0])+" AND "+O(E._values[1]):E._type!=="is-null"&&E._type!=="is-not-null"&&(T=O(E._values[0]))}return T}function ue(E,T){return T==null?"NULL":a(de(E._type,T))}function de(E,T){return E==="number"?ko(T):E==="boolean"?Wh(T):E==="date"?Qh(T):E==="string"?Gh(T):T}}function Jh(a){return a==null?"NULL":typeof a=="string"||a instanceof String?`'${String(a)}'`:typeof a=="boolean"||a instanceof Boolean?String(a).toUpperCase():a instanceof Date?`'${a.toISOString()}'`:typeof a=="number"||a instanceof Number?String(a):`'${JSON.stringify(a)}'`}function zh(a){return typeof a=="object"&&!(a==null||a instanceof String||a instanceof Number||a instanceof Boolean||a instanceof Date)?JSON.stringify(a):a}var Hh=a=>"$"+a,Kh=a=>"?";function Yh(a,e,t){return e.push(zh(a)),t(e.length)}function Zh(a,e,t){let n=[],s=t==="mysql"?Kh:Hh;return{sql:Bl(r=>Yh(r,n,s),e,t)(a),params:n}}function Xh(a,e,t){return Bl(n=>Jh(n),e,t)(a)}var sw=$l.create("query processor"),ed={lineBreaks:!1,parameterized:!0,logging:!0,identifierQuote:'"'};function td(a,e={},t="pg"){let n=Object.assign({},ed,e),s={lineBreak:n.lineBreaks?`
`:" ",nameEscape:e.identifierQuote||(t==="mysql"?"`":'"')};return i=>{if(n.parameterized){let{sql:r,params:o}=Zh(i,s,t);return a.query(r,o)}else{let r=Xh(i,s,t);return a.query(r,void 0)}}}var pr=class extends Qo{constructor(e,t={}){super(td(e,t,"mysql"))}};function mr(a){return function(e){Reflect.defineMetadata(I.metadata.options.repository,a,e),Reflect.defineMetadata(I.metadata.className,a?.className||e.name,e),Z.setName(e,a?.className)}}var Fl=(()=>{let a=class extends Ln{};return a=Qe([mr({className:"TaonBaseCustomRepository"})],a),a})();var nd=["id"],Ll=(()=>{let a=class extends Fl{constructor(t){super(),this.REPOS_CACHE_KEY=Symbol("repository cache inside instance"),this.allowedTypesToUpdate=["simple-json","simple-array","json"],this.entityClassResolveFn=t}get dbQuery(){if(!this.__dbQuery){if(!this.ctx)return;let t=this.ctx?.connection;if(!t)throw new Error(`[TaonBaseRepository] Database not inited for context ${this.ctx?.contextName}`);this.__dbQuery=new pr(t)}return this.__dbQuery}get connection(){return this.ctx?.connection}get repository(){if(this[this.REPOS_CACHE_KEY])return this[this.REPOS_CACHE_KEY];let t=this.entityClassResolveFn(),n=Z.getName(t),s=this.ctx.repos.get(n);if(!s)throw`[TaonBaseRepository] Repository for entity "${n}"
      not found in context "${this.ctx?.contextName}".

      Is ${n} a Taon entity class ?

      OR

      If ${n} is a Taon Custom Repository, then use this:

      ...
       ${y.lowerFirst(n)} = injectCustomRepository(${n});
      ...

      `;return this[this.REPOS_CACHE_KEY]=s,this[this.REPOS_CACHE_KEY]}get target(){return this?.repository?.target}get repo(){return this.repository}get repositoryExists(){return!!this.repository}hasId(t){return this.repo.hasId(t)}getId(t){return this.repo.getId(t)}async save(t,n){let s=await this.repo.create(t);s=await this.repo.save(s,n);let{id:i}=s;return s=await this.repo.findOne({where:{id:i}}),s}create(t){return this.repo.create(t)}async bulkSave(t,n){let s=[];for(let i=0;i<t.length;i++){let r=t[i],o=await this.save(r,n);s.push(o)}return s}async bulkCreate(t,n){return this.bulkSave(t,n)}merge(t,...n){return this.repo.merge(t,...n)}preload(t){return this.repo.preload(t)}async remove(t){y.isObject(t)&&(t=t.id);let n=await this.repo.findOne({where:{id:t}});if(!n){F.warn(`[TaonBaseRepository] Entity "${Z.getName(this.repo.target)}" with id ${t} not found, cannot remove`);return}let s=n.id;return await this.repo.remove(n),n.id=s,n}async delete(t){return this.remove(t)}async deleteById(t){return this.remove(t)}async bulkRemove(t){t=t.map(s=>y.isObject(s)?s.id:s);let n=[];for(let s=0;s<t.length;s++){let i=t[s],r=await this.remove(i);n.push(r)}return n}async bulkDelete(t){return this.bulkRemove(t)}softRemove(t,n){return this.repo.softRemove(t,n)}recover(t,n){return this.repo.recover(t,n)}insert(t){return this.repo.insert(t)}async update(t){let{id:n}=t;return await this.updateById(n,t)}async updateById(t,n){let s=[];for(let r in n){let o=this.repo.metadata.ownColumns.find(c=>c.propertyName===r);y.isObject(n)&&n.hasOwnProperty(r)&&(typeof n[r]!="object"||this.allowedTypesToUpdate.includes(o?.type))&&!y.isUndefined(o)&&s.push(r)}for(let r=0;r<s.length;r++){let o=s[r];if(!nd.includes(o.toLowerCase())){let c=n[o];await this.repo.update({id:t},{[o]:c})}}return await this.repo.findOne({where:{id:t}})}async bulkUpdate(t){let n=[];for(let s=0;s<t.length;s++){let i=t[s],{id:r}=i,o=await this.updateById(r,i);n.push(o)}return{models:n}}upsert(t,n){return this.repo.upsert(t,n)}softDelete(t){return this.repo.softDelete(t)}restore(t){return this.repo.restore(t)}count(t){return this.repo.count(t)}countBy(t){return this.repo.countBy(t)}find(t){return this.repo.find(t)}findBy(t){return this.repo.findBy(t)}findAndCount(t){return this.repo.findAndCount(t)}findAndCountBy(t){return this.repo.findAndCountBy(t)}findByIds(t){return this.repo.findByIds(t)}findOne(t){return this.repo.findOne(t)}findOneBy(t){return this.repo.findOneBy(t)}findOneById(t){return this.repo.findOneById(t)}findOneOrFail(t){return this.repo.findOneOrFail(t)}findOneByOrFail(t){return this.repo.findOneByOrFail(t)}query(t,n){return this.repo.query(t,n)}createQueryBuilder(t,n){return this.repo.createQueryBuilder(t,n)}clear(){return this.repo.clear()}increment(t,n,s){return this.repo.increment(t,n,s)}decrement(t,n,s){return this.repo.decrement(t,n,s)}async getAll(){let t=await this.repo.count();return{models:await this.repo.find(),totalCount:t}}async getBy(t){return await await this.repo.findOne({where:{id:t}})}};return a=Qe([mr({className:"TaonBaseRepository"}),cn("design:paramtypes",[Function])],a),a})();var xw=Fo(()=>({contextName:"TaonBaseContext",abstract:!0,middlewares:{TaonBaseFileUploadMiddleware:Il},repositories:{TaonBaseRepository:Ll}}));export{Pl as a,ye as b,Gt as c,Nt as d,Gs as e,tm as f,nm as g,sm as h,zc as i,mh as j,yh as k,gh as l,I as m,wo as n,Z as o,Kc as p,Ib as q,Fo as r,Ln as s,Il as t,xw as u};
